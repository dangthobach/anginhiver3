Backbone.View.prototype.close=function(){if(this.onClose)this.onClose();this.childViews&&_.each(this.childViews,function(a){a.close()});for(var a in this)this.hasOwnProperty(a)&&"parent"!=a&&(this[a]instanceof Backbone.View||this[a]instanceof Backbone.Form)&&(this[a].close(),this[a]=null);this.undelegateEvents();this.stopListening();this.el=void 0;this.remove();this.afterClose&&this.afterClose()};Backbone.AssociatedModel.prototype.clone=function(a){return new this.constructor(this.toJSONFull(a))};
var ModalView=Backbone.View.extend({close:function(){}});Backbone.Flash.initialize({el:"#flashes",stayDuration:3E3});Backbone.Tastypie.csrfToken=$.cookie("csrftoken");Backbone.Collection.prototype.save=function(a){Backbone.sync("save",this,a)};Backbone.Form.validators.errMessages.required="This field is required.";
$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy(function(a){$(a.target).hasClass("ignoreEnforceFocus")||this.$element[0]===a.target||this.$element.has(a.target).length||this.$element.trigger("focus")},this))};Backbone.Collection.prototype.modelIds=function(){var a=[];this.forEach(function(b){a.push(b.id)});return a};
Backbone.Collection.prototype.byIdKeys=function(){var a=[],b;for(b in this._byId)this._byId.hasOwnProperty(b)&&a.push(b);return a};Array.prototype.insert=function(a,b){this.splice(a,0,b)};Date.locale={en:{month_names:"January February March April May June July August September October November December".split(" "),month_names_short:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")}};Date.prototype.getMonthName=function(a){a=a&&a in Date.locale?a:"en";return Date.locale[a].month_names[this.getMonth()]};
Date.prototype.getMonthNameShort=function(a){a=a&&a in Date.locale?a:"en";return Date.locale[a].month_names_short[this.getMonth()]};
var ROOT="/api/v1",TEMPLATES,ETM={current_scheme:{},last_scheme:{},scheme_changed:!0,is_logged_in:is_logged_in,is_mobile:is_mobile,is_tablet:is_tablet,is_premium:"undefined"!==typeof is_premium?is_premium:is_subscriber,is_staff:is_staff,is_superuser:is_superuser,is_embedded:!1,views:{},models:{},use_local_storage:!(is_logged_in||app),local_storage_failed:!1,currently_generating:!1,setup_user_profile:!1,logout_occurred:!1,LOW_FAT_PRESET_KEY:"low-fat",LOW_CARB_PRESET_KEY:"low-carb",HIGH_PROTEIN_PRESET_KEY:"high-protein",
GLUTEN_FREE_PRESET_KEY:"gluten-free",dispatcher:_.clone(Backbone.Events),toggleLocalStorage:function(){if(ETM.use_local_storage)try{localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage")}catch(a){ETM.use_local_storage=!1,ETM.local_storage_failed=!0,"undefined"!==typeof Storage&&(Storage.prototype._setItem=Storage.prototype.setItem,Storage.prototype.setItem=function(){}),alert('Your web browser does not support storing settings locally. In Mobile Safari, the most common cause of this is using "Private Browsing Mode".  In Chrome, the most common cause is using "Block sites from setting any data".  In Opera Mini, this feature is not available at all.  Some settings may not save or some features may not work properly for you.')}ETM.use_local_storage?
(Backbone.Model.prototype.local=!0,Backbone.Model.prototype.remote=!1,Backbone.Collection.prototype.local=!0,Backbone.Collection.prototype.remote=!1):(Backbone.Model.prototype.remote=!0,Backbone.Model.prototype.local=!1,Backbone.Collection.prototype.remote=!0,Backbone.Collection.prototype.local=!1);_errs.meta.local_storage=ETM.use_local_storage},loadTemplate:function(a){return Helper.createTemplateFunction(ETM.global_templates.filter(a).text())},loadNestedTemplate:function(a,b){var c=$(ETM.global_templates.filter(a).text());
return Helper.createTemplateFunction(_.unescape(c.filter(b).add(c.find(b)).html()))},loadTemplates:function(a){$.when($.get("/static_files/etm"+CLIENT_VERSION+".html",function(a){ETM.global_templates=$(a);ETM.global_templates.each(function(){var a=$(this).attr("id");a in ETM&&(ETM[a].prototype.template=Helper.createTemplateFunction($(this).text()))})})).done(a)},default_user_choices_list:[]};
ETM.Router=Backbone.Router.extend({routes:{"":"mainView","_=_":"mainView","#_=_":"mainView","?date=:date":"mainView","now-delivering/":"mainView","embedded-meal-planner(/)":"embeddedView","diet-plan/:calories/:diet_type(/)":"premadeMainView","diet-plan/:calories(/)":"premadeMainView","welcome/":"welcomeView","managed-welcome/":"managedWelcomeView","manager-welcome/":"managerWelcomeView","app/":"appView","account/":"userProfileView","account-management/accounts/":"accountManagementAccountsView","account-management/profile/":"accountManagementProfileView",
"account-management/edit-plans/":"accountManagementEditPlansView","account-management/email-plans/":"accountManagementEmailPlansView","account-management/resources/":"accountManagementResourcesView","account-management/saved-plans/":"accountManagementSavedPlansView","groceries/":"groceryListView","recurring-foods/":"recurringFoodView","diet/:id":"dietView","diet/:id/":"dietView","dietset/:id/":"dietSetView","create-free-profile/":"freeSignupView","create-free-and-premium-profile/":"freeSignupView",
"create-premium-profile/":"premiumSignupView","results/":"resultsView","results_app/":"resultsView","settings/":"mainView","settings/food-preferences/":"foodPreferencesView","settings/weekly-planner-layout/":"weeklySettingsView","settings/leftovers/":"leftoversView","settings/user-profile/":"userProfileView","settings/account-info/":"accountInfoView","settings/saved-plans/":"savedPlansView","settings/blocked-favorited/":"blockedAndFavoritedView","settings/invite-friends/":"inviteFriendsView","settings/affiliate/":"affiliateView"},
startWalkthrough:function(a){a.startOnHomePage()},updateCurrentView:function(a){this.currentView&&("function"===typeof this.currentView.beforeClose&&this.currentView.beforeClose(),this.currentView.unbind(),this.currentView.remove());this.currentView=a},redirectLoggedOutUsers:function(){ETM.is_logged_in||window.location.replace("http://"+window.location.host+"/user/login/")},initialize:function(){ETM.header_view=new ETM.HeaderView;this.renderHeader();ETM.$header_content=$("#header_container");ETM.$modal_content=
$("#modals");ETM.$content=$("#main_container");ETM.$sidebar_content=$("#sidebar_container");ETM.local_variables=new ETM.LocalVariables;ETM.local_variables.fetch();ETM.notifications=new ETM.NotificationViews({model:ETM.local_variables});ETM.food_info_object_list=new ETM.FoodInfoObjectList;ETM.food_object_modal=new ETM.FoodObjectModalView;ETM.generator_status=new ETM.GeneratorStatus;ETM.nutrition_profile_list=new ETM.NutritionProfileList;ETM.meal_type_list=new ETM.MealTypeList;ETM.favorite_foods_list=
new ETM.FavoriteFoodList;ETM.blocked_foods_list=new ETM.BlockedFoodList;ETM.recurring_foods_list=new ETM.RecurringFoodList;ETM.user_profiles_list=new ETM.UserProfileList;ETM.profile_completeness_list=new ETM.ProfileCompletenessList;ETM.diet_list=new ETM.DietList;ETM.diet_set_list=new ETM.BasicDietPlanSetList;ETM.selected_diet_list=new ETM.SelectedDietList;ETM.template_diet_list=new ETM.TemplateDietList;ETM.manager_profile=new ETM.ManagerProfile;ETM.meal_rating_list=new ETM.MealRatingList;ETM.meal_tag_list=
new ETM.MealTagList;this.listenTo(ETM.recurring_foods_list,"change add remove",function(){ETM.reload_food_pool=!0});ETM.sidebar_model=new ETM.Sidebar;ETM.sidebar_view=new ETM.SidebarView({model:ETM.sidebar_model});app||($("#food_object_modal_div").html(ETM.food_object_modal.render().el),ETM.$sidebar_content.html(ETM.sidebar_view.render().el));ETM.is_premium&&(ETM.groceries_and_pantry=new ETM.GroceriesAndPantry)},applyBlockedFoodListeners:function(){this.listenTo(ETM.blocked_foods_list,"add",function(a){var b=
"string"==typeof a.attributes.food?a.attributes.food:a.attributes.food.id,c=parseInt(parseIdFromResourceURI(b)),d=["u","c","b","s"];"string"!==typeof a.attributes.food&&_.has(a.attributes.food,"attributes")?_.contains(d,a.attributes.food.attributes.model)&&(ETM.reload_food_pool=!0):(blocked_food_info=ETM.food_info_object_list.get(b))&&_.contains(d,blocked_food_info.attributes.model)&&(ETM.reload_food_pool=!0);ETM.recently_blocked.push(c);googleanalytics("send","event","button","click","add_block");
amplitude.logEvent("add_block",{food_id:parseIdFromResourceURI(b)})});this.listenTo(ETM.blocked_foods_list,"remove",function(a){a="string"===typeof a.attributes.food?a.attributes.food:a.attributes.food.id;var b=parseInt(parseIdFromResourceURI(a)),b=ETM.recently_blocked.indexOf(b);-1!=b?ETM.recently_blocked.splice(b,1):ETM.reload_food_pool=!0;googleanalytics("send","event","button","click","remove_block");amplitude.logEvent("remove_block",{food_id:parseIdFromResourceURI(a)})})},applyProfileCompletenessListeners:function(){var a=
this;!1===ETM.current_profile_completeness.get("add_recurring_food")&&this.listenToOnce(ETM.recurring_foods_list,"add",function(){ETM.current_profile_completeness.save({add_recurring_food:!0},{patch:!0})});!1===ETM.current_profile_completeness.get("favorite_food")&&this.listenToOnce(ETM.favorite_foods_list,"add",function(){ETM.current_profile_completeness.save({favorite_food:!0},{patch:!0})});!1===ETM.current_profile_completeness.get("block_food")&&this.listenToOnce(ETM.blocked_foods_list,"add",function(){ETM.current_profile_completeness.save({block_food:!0},
{patch:!0})});!1===ETM.current_profile_completeness.get("customized_meal_types")&&(this.listenToOnce(ETM.meal_type_list,"add remove",function(){!1===ETM.current_profile_completeness.get("customized_meal_types")&&ETM.current_profile_completeness.save({customized_meal_types:!0},{patch:!0})}),ETM.meal_type_list.each(function(b){a.listenToOnce(b,"change",function(){!1===ETM.current_profile_completeness.get("customized_meal_types")&&ETM.current_profile_completeness.save({customized_meal_types:!0},{patch:!0})})}));
!1===ETM.current_profile_completeness.get("edited_food_preferences")&&this.listenToOnce(ETM.current_user_profile,"change:exclusions",function(){ETM.current_profile_completeness.save({edited_food_preferences:!0},{patch:!0})});!1===ETM.current_profile_completeness.get("set_weight_goal")&&(0<ETM.current_user_profile.attributes.weight_goal?ETM.current_profile_completeness.save({set_weight_goal:!0},{patch:!0}):this.listenToOnce(ETM.current_user_profile,"change:weight_goal",function(){ETM.current_profile_completeness.save({set_weight_goal:!0},
{patch:!0})}));ETM.is_premium&&!1===ETM.current_profile_completeness.get("setup_weekly_layout")&&ETM.template_diet_list.each(function(b){a.listenToOnce(b.get("diet"),"change",function(){!1===ETM.current_profile_completeness.get("setup_weekly_layout")&&ETM.current_profile_completeness.save({setup_weekly_layout:!0},{patch:!0})})})},renderHeader:function(){app||($("#fill_container").html(ETM.header_view.render().el),ETM.header_view.delegateEvents())},renderWeightModal:function(){ETM.weight_modal||app||
(ETM.weight_modal=new ETM.WeightModalView,ETM.weight_modal.rendered=!1);ETM.weight_modal.rendered||($("#update_weight_modal").html(ETM.weight_modal.render().el),ETM.weight_modal.delegateEvents(),ETM.weight_modal.rendered=!0)},setupUserProfile:function(){var a=ETM.user_profiles_list.at(0);"undefined"!=typeof a?ETM.current_user_profile=a:(ETM.current_user_profile=new ETM.UserProfile,ETM.user_profiles_list.add(ETM.current_user_profile));ETM.setup_user_profile=!0;_errs.meta.user_id=ETM.current_user_profile.attributes.user_id;
_errs.meta.username=ETM.current_user_profile.attributes.username},setupProfileCompleteness:function(){var a=ETM.profile_completeness_list.at(0);"undefined"!=typeof a?ETM.current_profile_completeness=a:(ETM.current_profile_completeness=new ETM.ProfileCompleteness,ETM.profile_completeness_list.add(ETM.current_profile_completeness))},runAfterUserDataFetch:function(a){var b=this;b.applyBlockedFoodListeners();ETM.is_premium||"create-premium-profile/"===Backbone.history.fragment?ETM.template_diet_list.fetch({success:function(c){0<
c.length&&c.add(c.remove(c.at(c.length-1),{silent:!0}),{at:0,silent:!0});b.setupUserProfile();b.setupProfileCompleteness();b.applyProfileCompletenessListeners();ETM.fetch_complete=!0;app||b.initializeHeaderView();ETM.meal_type_list.sort();a()}}):(b.setupUserProfile(),b.setupProfileCompleteness(),b.applyProfileCompletenessListeners(),ETM.fetch_complete=!0,app||b.initializeHeaderView(),ETM.meal_type_list.sort(),a())},loadUserDataV3:function(a,b){if(ETM.fetch_complete)a();else{var c=this,d=[ETM.nutrition_profile_list.fetch(),
ETM.meal_type_list.fetch(),ETM.meal_tag_list.fetch(),ETM.user_profiles_list.fetch(),ETM.favorite_foods_list.fetch(),ETM.blocked_foods_list.fetch(),ETM.profile_completeness_list.fetch()],e=JSON.parse(localStorage.getItem("food_info_object_ids"));e&&(ETM.food_info_object_list.add(e),d.push(ETM.food_info_object_list.fetch()));ETM.is_logged_in&&(d=d.concat([ETM.recurring_foods_list.fetch(),ETM.diet_set_list.fetch(),ETM.manager_profile.fetch(),ETM.meal_rating_list.fetch()]));$.when.all(d).then(function(b){c.runAfterUserDataFetch(a)},
function(d){ETM.local_storage_failed?"undefined"!=typeof b&&b||c.loadUserDataV3(a,!0):_errs.push(Error("Error fetching"+(ETM.is_logged_in?" logged in ":" logged out ")+"user information: "+d[2]+" - "+d[1]+" - "+d[0].status))})}},loadUserData:function(a,b){if(ETM.fetch_complete)a();else{var c=this,d=[ETM.nutrition_profile_list.fetch(),ETM.meal_type_list.fetch(),ETM.user_profiles_list.fetch(),ETM.favorite_foods_list.fetch(),ETM.blocked_foods_list.fetch(),ETM.profile_completeness_list.fetch()],e=JSON.parse(localStorage.getItem("food_info_object_ids"));
e&&(ETM.food_info_object_list.add(e),d.push(ETM.food_info_object_list.fetch()));ETM.is_logged_in&&(d=d.concat([ETM.recurring_foods_list.fetch(),ETM.diet_list.fetch(),ETM.diet_set_list.fetch(),ETM.manager_profile.fetch()]));$.when.all(d).then(function(d){c.runAfterUserDataFetch(a,b)},function(d){ETM.local_storage_failed?"undefined"!=typeof b&&b||c.loadUserData(a,!0):_errs.push(Error("Error fetching"+(ETM.is_logged_in?" logged in ":" logged out ")+"user information: "+d[2]+" - "+d[1]+" - "+d[0].status))})}},
loadManagedAccounts:function(a){null==ETM.managed_accounts||null==ETM.managed_external_accounts||null==ETM.manager_profile||null==ETM.manager_invited_users?(ETM.managed_accounts=new ETM.ManagedAccountList,ETM.managed_external_accounts=new ETM.ManagedExternalAccountList,ETM.manager_invited_users=new ETM.ManagerInvitedUserList,$.when(ETM.managed_accounts.fetch(),ETM.managed_external_accounts.fetch(),ETM.manager_invited_users.fetch()).done(function(){ETM.logged_in_header_view.addManagedAccountsEvents();
a()})):(ETM.logged_in_header_view.addManagedAccountsEvents(),a())},loadSelectedDiet:function(a){0<ETM.selected_diet_list.length?a():$.when(ETM.selected_diet_list.fetch()).done(function(){var b=ETM.selected_diet_list.at(0);"undefined"!=typeof b?ETM.current_diet=b.attributes.diet:(b=new ETM.SelectedDiet,ETM.current_diet=b.attributes.diet,ETM.selected_diet_list.add(b),b.save(null,{async:!1}));ETM.meal_type_list.sort();a()})},loadPublicDiet:function(a,b){var c=new ETM.Diet({id:a},{silent:!0});c.remote=
!0;c.fetch({async:!1,silent:!0,url:ROOT+"/publicdiet/"+a+"/"});c.calculateStats();ETM.current_diet=c;c=new ETM.SelectedDiet({diet:c});ETM.selected_diet_list.add(c);b()},initializeHeaderView:function(){if(ETM.is_logged_in)ETM.logged_in_header_view||(ETM.current_user_profile.hasManagerSubscription()?ETM.logged_in_header_view=new ETM.LoggedInManagerHeaderView:ETM.logged_in_header_view=new ETM.LoggedInHeaderView),ETM.$header_content.html(ETM.logged_in_header_view.render().el),ETM.logged_in_header_view.delegateEvents();
else{"undefined"!=typeof ETM.is_embedded&&ETM.is_embedded?ETM.free_header_view=new ETM.EmbeddedHeaderView:ETM.logged_in_header_view||(ETM.free_header_view=new ETM.LoggedOutHeaderView);ETM.$header_content.html(ETM.free_header_view.render().el);$.ajax({url:"https://platform.twitter.com/widgets.js",dataType:"script",cache:!0});try{FB.XFBML.parse()}catch(a){}ETM.free_header_view.delegateEvents()}},calendarView:function(a,b){var c=this,d=b,e=!1;this.loadUserDataV3(function(){ETM.is_premium||ETM.current_user_profile.attributes.welcome_complete||
(moment(ETM.current_user_profile.attributes.date_joined).isAfter(moment().subtract(2,"days"))?d=!0:e=!0);Helper.lockPageHeight();var a=new Date,b=!1;UrlFunctions.getUrlParameter("date")&&-1!=Backbone.history.fragment.indexOf("date")&&(a=Helper.parseDateString(UrlFunctions.getUrlParameter("date")),b=!0);var h=function(){ETM.calendar_list?b&&(ETM.calendar_list.selected_date=a):(ETM.calendar_list=new ETM.CalendarDietList([],{selected_date:a}),ETM.calendar_list.loadInitialDiets());ETM.logged_in_header_view.selectMenuItem(".diet_planner_nav");
ETM.calendar_view?(ETM.calendar_view.collection=ETM.calendar_list,ETM.calendar_view.selected_date=a):ETM.calendar_view=new ETM.CalendarView({collection:ETM.calendar_list});ETM.calendar_list.view=ETM.calendar_view;c.updateCurrentView(ETM.calendar_view);ETM.$content.html(ETM.calendar_view.render().el);ETM.calendar_view.delegateEvents();ETM.calendar_view.printDate();ETM.calendar_view.renderWeekOverview();ETM.calendar_view.loadAndRenderAppropriateView();var h=!1;if("undefined"!=typeof ETM.show_managed_account_welcome&&
ETM.show_managed_account_welcome)ETM.show_managed_account_welcome=!1,h=new ETM.ManagedAccountPremiumWelcomeModal;else if("undefined"!=typeof ETM.show_manager_account_welcome&&ETM.show_manager_account_welcome)ETM.show_manager_account_welcome=!1,h=new ETM.ManagerAccountPremiumWelcomeModal;else if(null!=d&&d)ETM.is_premium?($(".ss_fb_pixel").addClass("ss_fb_conversion"),$(".ld_fb_pixel").addClass("ld_fb_conversion"),$(".google_pixel").addClass("google_conversion"),h=new ETM.PremiumWelcomeModal):h=new ETM.FreeWelcomeModal;
else if(e)h=new ETM.FreeWelcomeChangesModal;else if(!ETM.local_variables.attributes.seen_beta_test_modal&&SHOW_BETA_SWITCH){var m=(new Date).getTime(),m=Date.parse(ETM.current_user_profile.attributes.date_joined)+6E8<m;if(ETM.is_premium&&m||!ETM.is_premium)h=new ETM.BetaTestModal,ETM.local_variables.save({seen_beta_test_modal:!0})}h&&($("#welcome_modal",ETM.$modal_content).html(h.render().el),h.$el.modal({backdrop:"static",show:!0}));Helper.unlockPageHeight()};_.has(ETM.current_user_profile.attributes,
"copied_selected_diet")&&!ETM.current_user_profile.attributes.copied_selected_diet?$.get("/cal/copy-selected-diet/"+Helper.convertDateToString(new Date)+"/",function(a){Helper.fixNullCaloriesInNutritionProfiles(function(){ETM.current_user_profile.attributes.copied_selected_diet=!0;h()})}):h()})},dietSetView:function(a){var b=this;this.loadUserDataV3(function(){function c(){ETM.diet_plan_set_view?(ETM.diet_plan_set_view.model=ETM.diet_plan_set,ETM.diet_plan_set_view.checkIfUserIsOwner()):ETM.diet_plan_set_view=
new ETM.DietPlanSetView({model:ETM.diet_plan_set});ETM.diet_plan_set.view=ETM.diet_plan_set_view;ETM.email_plan_set_modal&&(ETM.email_plan_set_modal.diet_set_id=ETM.diet_plan_set.attributes.id);ETM.logged_in_header_view&&ETM.logged_in_header_view.selectMenuItem();b.updateCurrentView(ETM.diet_plan_set_view);ETM.$content.html(ETM.diet_plan_set_view.render().el);ETM.diet_plan_set_view.delegateEvents();ETM.diet_plan_set_view.renderWeekOverview();ETM.diet_plan_set_view.loadAndRenderAppropriateView();Helper.unlockPageHeight()}
Helper.lockPageHeight();ETM.diet_plan_set&&ETM.diet_plan_set.attributes.id==a.slice(3)?c():ETM.is_logged_in?$.get("/weeklyplanner/check-owner/",{is_diet_set:!0,diet_id:a},function(b){b=JSON.parse(b)?ROOT+"/fulldietset/"+a+"/":ROOT+"/publicdietset/"+a+"/";ETM.diet_plan_set=new ETM.DietPlanSet({id:a});ETM.diet_plan_set.fetch({async:!1,url:b});ETM.diet_plan_set.setInitialSelectedDiet();c()}).fail(function(){ETM.$content.html("<div class='text-center big_top_margin big_bottom_spacer'><button class='btn btn-default' onclick='ETM.router.navigate(\"\", {trigger: true});'><span class='glyphicon glyphicon-arrow-left'></span> Back to the Planner</button><h1>Saved plan not found :(</h1></div>")}):
(diet_url=ROOT+"/publicdietset/"+a+"/",ETM.diet_plan_set=new ETM.DietPlanSet({id:a}),ETM.diet_plan_set.remote=!0,ETM.diet_plan_set.fetch({async:!1,url:diet_url}),ETM.diet_plan_set.setInitialSelectedDiet(),c())})},singleDietView:function(a){if(ETM.is_logged_in)return ETM.logged_in_header_view.selectMenuItem(".diet_planner_nav"),ETM.logged_in_free_day_view||(ETM.logged_in_free_day_view=new ETM.LoggedInFreeDayView({model:ETM.current_diet},{hide_prompts:a})),this.updateCurrentView(ETM.logged_in_free_day_view),
ETM.logged_in_free_day_view;ETM.logged_out_day_view||(ETM.logged_out_day_view=new ETM.LoggedOutDayView({model:ETM.current_diet},{hide_prompts:a}));this.updateCurrentView(ETM.logged_out_day_view);return ETM.logged_out_day_view},embeddedView:function(){var a=this;ETM.is_logged_in=!1;ETM.is_premium=!1;ETM.use_local_storage=!0;ETM.is_embedded=!0;a.loadUserDataV3(function(){a.loadSelectedDiet(function(){var b=a.singleDietView(!1);ETM.$content.html(b.render(!0).el);b.delegateEvents();b.single_day_view.printGraph();
ETM.is_mobile||$("#cal_input").focus()})})},mainView:function(a){var b=this;ETM.is_logged_in?this.calendarView(a):b.loadUserDataV3(function(){b.loadSelectedDiet(function(){var a=b.singleDietView(!1);ETM.$content.html(a.render(!0).el);a.delegateEvents();a.single_day_view.printGraph();b.focusGenerator()})})},focusGenerator:function(){if(1==UrlFunctions.getUrlParameter("generate")){var a=$("input[id=cal_input]");a.val(parseInt(UrlFunctions.getUrlParameter("cals")));a.trigger("change");$("select[name=diet_type]").val(decodeURI(UrlFunctions.getUrlParameter("diet_type")));
$("select[name=nummeals]").val(UrlFunctions.getUrlParameter("nummeals"));if(ETM.is_mobile)Helper.oneTimeTooltip($("#cal_input"),"top","Enter your desired calories and diet type, then hit Generate!",1E4);else if(0===ETM.logged_out_day_view.single_day_view.plan_stats_view.model.stats.calories)Helper.oneTimeTooltip($(".gen_button"),"top","Running the generator...",7E3),ETM.current_diet.generate();else Helper.oneTimeTooltip($(".gen_button"),"top","Click here to re-run the generator",4E3)}else ETM.is_mobile||
$("#cal_input").focus()},handleSpecialPremadeDiets:function(a,b){var c=ETM.current_diet.attributes.nutrition_profile;if(a)if(c.attributes.calories=a,c.scaleMacrosFromCalories(a,0),b===ETM.LOW_FAT_PRESET_KEY)c.attributes.max_fats=roundNumber(0.3*a/9,0),c.attributes.min_fats=0;else if(b===ETM.LOW_CARB_PRESET_KEY)c.attributes.max_carbs=roundNumber(0.3*a/9,0),c.attributes.min_carbs=0;else if(b===ETM.HIGH_PROTEIN_PRESET_KEY){var d=roundNumber(0.3*a/4,0);c.attributes.min_proteins=d;c.attributes.max_proteins=
2*d}else b===ETM.GLUTEN_FREE_PRESET_KEY&&(ETM.current_user_profile.attributes.exclusions='[{"value":"gluten","label":"Gluten"}]')},premadeMainView:function(a,b){var c=parseInt(a.split("-")[0]);null!=ETM.PRESET_DIET_SYNONYMS[b]&&(b=ETM.PRESET_DIET_SYNONYMS[b]);var d=this;ETM.is_logged_in?this.calendarView():d.loadUserDataV3(function(){d.loadSelectedDiet(function(){var a;ETM.is_logged_in?a=d.singleDietView(!1):(d.handleSpecialPremadeDiets(c,b),ETM.free_header_view.close(),ETM.free_header_view=new ETM.LoggedOutHeaderView(null,
{calories:c,diet_type:b,load_premade_diet:!0}),ETM.$header_content.html(ETM.free_header_view.render().el),ETM.free_header_view.delegateEvents(),ETM.logged_out_day_view||(ETM.logged_out_day_view=new ETM.LoggedOutDayView({model:ETM.current_diet},{hide_prompts:!1,calories:c,diet_type:b,load_premade_diet:!0})),d.updateCurrentView(ETM.logged_out_day_view),a=ETM.logged_out_day_view);ETM.$content.html(a.render(!0).el);a.delegateEvents();a.single_day_view.printGraph();ETM.is_mobile||$("#cal_input").focus()})})},
welcomeView:function(a){ETM.is_logged_in?(ETM.router.navigate("",{replace:!0}),this.calendarView(a,!0)):ETM.router.navigate("",{trigger:!0})},managedWelcomeView:function(a){ETM.show_managed_account_welcome=!0;this.welcomeView(a)},managerWelcomeView:function(a){ETM.show_manager_account_welcome=!0;this.welcomeView(a)},dietView:function(a){var b=this;b.loadUserDataV3(function(){b.loadPublicDiet(a,function(){var a=b.singleDietView(!0);a.single_day_view=new ETM.ReadOnlySingleDayView({model:ETM.current_diet});
ETM.$content.html(a.render(!0).el);a.delegateEvents();a.single_day_view.printGraph();ETM.logged_in_free_day_view=null;ETM.logged_out_day_view=null})})},recurringFoodView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){Helper.lockPageHeight();ETM.logged_in_header_view.selectMenuItem(".recurring_foods_nav");ETM.recurring_food_view||(ETM.recurring_food_view=new ETM.RecurringFoodSettingsView);a.updateCurrentView(ETM.recurring_food_view);ETM.$content.html(ETM.recurring_food_view.render().el);
ETM.recurring_food_view.delegateEvents();Helper.unlockPageHeight()})},renderSettingsHeader:function(a){ETM.logged_in_header_view.selectMenuItem(".settings_button");ETM.settings_header||(ETM.settings_header=new ETM.SettingsHeaderView);ETM.$content.html(ETM.settings_header.render().el);ETM.settings_header.delegateEvents();ETM.settings_header.selectMenuItem(a);ETM.$settings_content=$("#settings_content",ETM.settings_header.el)},foodPreferencesView:function(){this.redirectLoggedOutUsers();var a=this;
this.loadUserDataV3(function(){Helper.lockPageHeight();a.renderSettingsHeader(".food-preferences");ETM.food_preferences_view||(ETM.food_preferences_view=new ETM.FoodPreferencesView({model:ETM.current_user_profile}));a.updateCurrentView(ETM.food_preferences_view);ETM.$settings_content.html(ETM.food_preferences_view.render().el);ETM.food_preferences_view.delegateEvents();Helper.unlockPageHeight()})},weeklySettingsView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){Helper.lockPageHeight();
a.renderSettingsHeader(".weekly-planner-layout");if(ETM.is_premium){var b=new Date;ETM.calendar_list||(ETM.calendar_list=new ETM.CalendarDietList([],{selected_date:b}),ETM.calendar_list.loadInitialDiets());ETM.weekly_settings_view&&(ETM.weekly_settings_view.close(),ETM.weekly_settings_view=null);ETM.weekly_settings_view=new ETM.WeeklySettingsView({collection:ETM.template_diet_list});a.updateCurrentView(ETM.weekly_settings_view);ETM.$settings_content.html(ETM.weekly_settings_view.render().el);ETM.weekly_settings_view.delegateEvents()}else ETM.weekly_settings_teaser_view||
(ETM.weekly_settings_teaser_view=new ETM.WeeklySettingsTeaserView),a.updateCurrentView(ETM.weekly_settings_teaser_view),ETM.$settings_content.html(ETM.weekly_settings_teaser_view.render().el),ETM.weekly_settings_teaser_view.delegateEvents();Helper.unlockPageHeight()})},leftoversView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){Helper.lockPageHeight();a.renderSettingsHeader(".leftovers");if(ETM.is_premium){ETM.leftovers_view&&ETM.leftovers_view.single_template_diet!=
ETM.current_user_profile.attributes.single_template_diet&&(ETM.leftovers_view.close(),ETM.leftovers_view=null);if(!ETM.leftovers_view){var b=ETM.template_diet_list.getTemplateDietList();ETM.leftovers_view=new ETM.LeftoversView({collection:b});ETM.leftovers_view.single_template_diet=ETM.current_user_profile.attributes.single_template_diet}a.updateCurrentView(ETM.leftovers_view);ETM.$settings_content.html(ETM.leftovers_view.render().el);ETM.leftovers_view.delegateEvents()}else ETM.leftovers_teaser_view||
(ETM.leftovers_teaser_view=new ETM.LeftoversTeaserView),a.updateCurrentView(ETM.leftovers_teaser_view),ETM.$settings_content.html(ETM.leftovers_teaser_view.render().el),ETM.leftovers_teaser_view.delegateEvents();Helper.unlockPageHeight()})},userProfileView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){Helper.lockPageHeight();a.renderSettingsHeader(".user-profile");ETM.user_profile_view||(ETM.user_profile_view=new ETM.UserProfileView({model:ETM.current_user_profile}));
a.updateCurrentView(ETM.user_profile_view);ETM.$settings_content.html(ETM.user_profile_view.render().el);ETM.user_profile_view.delegateEvents();Helper.unlockPageHeight()})},accountInfoView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){a.renderSettingsHeader(".account-settings");ETM.account_info_view||(ETM.account_info_view=new ETM.AccountInfoView({model:ETM.current_user_profile}));a.updateCurrentView(ETM.account_info_view);ETM.$settings_content.html(ETM.account_info_view.render().el);
ETM.account_info_view.delegateEvents()})},savedPlansView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){a.renderSettingsHeader(".saved-plans");ETM.saved_plans_view||(ETM.saved_plans_view=new ETM.SavedPlansView({model:ETM.current_user_profile}));a.updateCurrentView(ETM.saved_plans_view);ETM.$settings_content.html(ETM.saved_plans_view.render().el);ETM.saved_plans_view.delegateEvents()})},blockedAndFavoritedView:function(){this.redirectLoggedOutUsers();var a=this;
this.loadUserDataV3(function(){Helper.lockPageHeight();a.renderSettingsHeader(".blocked-favorited");ETM.blocked_favorited_view||(ETM.blocked_favorited_view=new ETM.BlockedAndFavoritedView);a.updateCurrentView(ETM.blocked_favorited_view);ETM.$settings_content.html(ETM.blocked_favorited_view.render().el);ETM.blocked_favorited_view.delegateEvents();Helper.unlockPageHeight()})},savedRecipesView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){a.renderSettingsHeader(".saved-recipes");
ETM.saved_recipes_view||(ETM.saved_recipes_view=new ETM.SavedRecipesView({model:ETM.current_user_profile}));a.updateCurrentView(ETM.saved_recipes_view);ETM.$settings_content.html(ETM.saved_recipes_view.render().el);ETM.saved_recipes_view.delegateEvents()})},inviteFriendsView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){a.renderSettingsHeader(".invite-friends");ETM.invite_friends_view||(ETM.invite_friends_view=new ETM.InviteFriendsView({model:ETM.current_user_profile}));
a.updateCurrentView(ETM.invite_friends_view);ETM.$settings_content.html(ETM.invite_friends_view.render().el);$.ajax({url:"https://platform.twitter.com/widgets.js",dataType:"script",cache:!0});ETM.invite_friends_view.delegateEvents()})},affiliateView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){a.renderSettingsHeader(".affiliate");ETM.affiliate_view||(ETM.affiliate_view=new ETM.AffiliateView({model:ETM.current_user_profile}));a.updateCurrentView(ETM.affiliate_view);
ETM.$settings_content.html(ETM.affiliate_view.render().el);ETM.affiliate_view.delegateEvents()})},resultsView:function(){this.redirectLoggedOutUsers();var a=this;this.loadUserDataV3(function(){ETM.results_view?ETM.results_view.formatCalendarData():ETM.results_view=new ETM.ResultsView;$(".main_site_nav button").removeClass("active");a.updateCurrentView(ETM.results_view);ETM.$content.html(ETM.results_view.render().el);app&&$(".update_weight_button").hide();ETM.results_view.drawGraphs();ETM.results_view.delegateEvents()})},
groceryListView:function(){this.redirectLoggedOutUsers();var a=this;a.loadUserDataV3(function(){ETM.logged_in_header_view.selectMenuItem(".pantry_grocery_nav");ETM.is_premium?(ETM.grocery_pantry_view||(ETM.grocery_pantry_view=new ETM.GroceryAndPantryView({model:ETM.groceries_and_pantry})),ETM.grocery_pantry_view.render(),a.updateCurrentView(ETM.grocery_pantry_view),ETM.$content.html(ETM.grocery_pantry_view.el),ETM.grocery_pantry_view.delegateEvents(),ETM.grocery_pantry_view.initializeEvents(),ETM.grocery_pantry_view.loadAndRenderGroceryFoods()):
(ETM.grocery_pantry_teaser_view||(ETM.grocery_pantry_teaser_view=new ETM.GroceryAndPantryTeaserView),a.updateCurrentView(ETM.grocery_pantry_teaser_view),ETM.$content.html(ETM.grocery_pantry_teaser_view.render().el),ETM.grocery_pantry_teaser_view.delegateEvents())})},saveLocalStorageDietData:function(){var a=this,b=ETM.selected_diet_list.at(0);Helper.clearIDs(b);Helper.clearIDs(b.attributes.diet);b.attributes.diet.attributes.meals.forEach(function(a){a.attributes.foods.each(function(a){delete a.attributes.meal;
Helper.clearIDs(a)});Helper.clearIDs(a)});b.save(null,{success:function(c,d){_errs.meta.finished_saving_local_storage_diet=!0;Helper.deleteLocalStorageKeys();ETM.current_diet=b.attributes.diet;var e=!1;ETM.current_diet.attributes.meals.forEach(function(a){null==a.attributes.meal_type.attributes.id&&(e=!0)});var f=null==ETM.current_diet.attributes.id,g=null==ETM.current_diet.attributes.nutrition_profile.attributes.id;if(f||g||e)_errs.meta.current_diet=JSON.stringify(ETM.current_diet),_errs.meta.current_diet_null=
f,_errs.meta.nutrition_profile_null=g,_errs.meta.meal_type_id_null=e,_errs.push(Error("Local storage data still present"));ETM.current_user_profile.save({local_storage_load_complete:!0});ETM.free_signup_view=new ETM.FreeSignupView;ETM.free_signup_view.render();a.updateCurrentView(ETM.free_signup_view)},error:function(b,d,e){_errs.push(Error("Error saving local storage diet: "+e.url+" : "+d.status+" : "+d.statusText));Helper.deleteLocalStorageKeys();ETM.current_user_profile.attributes.local_storage_load_complete=
!0;ETM.fetch_complete=!1;ETM.selected_diet_list=new ETM.SelectedDietList;a.freeSignupView()}})},saveLocalStorageCollectionData:function(a,b){var c=this;ETM.use_local_storage=!1;ETM.toggleLocalStorage();ETM.current_user_profile.id=a;ETM.current_user_profile.attributes.resource_uri=b;var d=[ETM.current_user_profile.save()];ETM.meal_type_list.forEach(function(a){Helper.clearIDs(a);d.push(a.save())});ETM.nutrition_profile_list.forEach(function(a){Helper.clearIDs(a);null==a.attributes.calories&&(a.attributes.calories=
2E3);d.push(a.save(null,{validate:!1}))});ETM.blocked_foods_list.forEach(function(a){Helper.clearIDs(a);d.push(a.save())});ETM.favorite_foods_list.forEach(function(a){Helper.clearIDs(a);d.push(a.save())});$.when.all(d).then(function(a){_errs.meta.finished_saving_local_storage_collections=!0;c.saveLocalStorageDietData()},function(a){ETM.local_storage_failed||_errs.push(Error("Error saving"+(ETM.is_logged_in?" logged in ":" logged out ")+"user local storage information: "+a[2]+" - "+a[1]+" - "+a[0].status))})},
freeSignupView:function(){var a=this;ETM.user_profiles_list.fetch({async:!1});this.setupUserProfile();var b=ETM.current_user_profile.id,c=ETM.current_user_profile.attributes.resource_uri;ETM.current_user_profile.attributes.local_storage_load_complete||(_errs.meta.converting_local_storage_data=!0,ETM.use_local_storage=!0,ETM.toggleLocalStorage());this.loadUserDataV3(function(){ETM.use_local_storage&&(_errs.meta.loaded_user_data_from_local_storage=!0);a.loadSelectedDiet(function(){ETM.use_local_storage?
(_errs.meta.loaded_selected_diet_from_local_storage=!0,a.saveLocalStorageCollectionData(b,c)):(ETM.free_signup_view=new ETM.FreeSignupView,ETM.free_signup_view.render(),a.updateCurrentView(ETM.free_signup_view))})})},premiumSignupView:function(){var a=this;this.loadUserDataV3(function(){7!==ETM.template_diet_list.length?Helper.createTemplatesOnServer(function(){ETM.premium_signup_view=new ETM.PremiumSignupView;ETM.premium_signup_view.render();a.updateCurrentView(ETM.premium_signup_view)}):(ETM.premium_signup_view=
new ETM.PremiumSignupView,ETM.premium_signup_view.render(),a.updateCurrentView(ETM.premium_signup_view))})},appView:function(){},accountManagementEditPlansView:function(){var a=this;this.loadUserDataV3(function(){a.loadManagedAccounts(function(){ETM.logged_in_header_view.selectMenuItem(".manage_edit_plans");ETM.account_management_edit_plans_view||(ETM.account_management_edit_plans_view=new ETM.AccountManagementEditPlansView);a.updateCurrentView(ETM.account_management_edit_plans_view);ETM.$content.html(ETM.account_management_edit_plans_view.render().el);
ETM.account_management_edit_plans_view.delegateEvents()})})},accountManagementEmailPlansView:function(){var a=this;this.loadUserDataV3(function(){a.loadManagedAccounts(function(){ETM.logged_in_header_view.selectMenuItem(".manage_email_plans");ETM.account_management_email_plans_view||(ETM.account_management_email_plans_view=new ETM.AccountManagementEmailPlansView);a.updateCurrentView(ETM.account_management_email_plans_view);ETM.$content.html(ETM.account_management_email_plans_view.render().el);ETM.account_management_email_plans_view.delegateEvents()})})},
accountManagementAccountsView:function(){var a=this;this.loadUserDataV3(function(){a.loadManagedAccounts(function(){ETM.logged_in_header_view.selectMenuItem(".manage_accounts");ETM.account_management_accounts_view||(ETM.account_management_accounts_view=new ETM.AccountManagementAccountsView);a.updateCurrentView(ETM.account_management_accounts_view);ETM.$content.html(ETM.account_management_accounts_view.render().el);ETM.account_management_accounts_view.delegateEvents()})})},accountManagementSavedPlansView:function(){this.redirectLoggedOutUsers();
var a=this;this.loadUserDataV3(function(){a.loadManagedAccounts(function(){ETM.logged_in_header_view.selectMenuItem(".manage_saved_plans");ETM.saved_plans_view||(ETM.saved_plans_view=new ETM.SavedPlansView({model:ETM.current_user_profile}));a.updateCurrentView(ETM.saved_plans_view);ETM.$content.html('<div class="main_column slide_show_column content_container container manager_content_container"></div>');$(".main_column",ETM.$content).html(ETM.saved_plans_view.render().el);ETM.saved_plans_view.delegateEvents()})})},
accountManagementProfileView:function(){var a=this;this.loadUserDataV3(function(){a.loadManagedAccounts(function(){ETM.logged_in_header_view.selectMenuItem(".manage_profile");ETM.account_management_profile_view||(ETM.account_management_profile_view=new ETM.AccountManagementProfileView);a.updateCurrentView(ETM.account_management_profile_view);ETM.$content.html(ETM.account_management_profile_view.render().el);ETM.account_management_profile_view.delegateEvents()})})},accountManagementResourcesView:function(){var a=
this;this.loadUserDataV3(function(){a.loadManagedAccounts(function(){ETM.logged_in_header_view.selectMenuItem(".manager_resources");ETM.account_management_resources_view||(ETM.account_management_resources_view=new ETM.AccountManagementResourcesView);a.updateCurrentView(ETM.account_management_resources_view);ETM.$content.html(ETM.account_management_resources_view.render().el);ETM.account_management_resources_view.delegateEvents()})})}});
function initialize(a){ETM.toggleLocalStorage();!window.location.hash||"#_=_"!=window.location.hash&&"_=_"!=window.location.hash||(window.location.hash="");ETM.loadTemplates(function(){ETM.router=new ETM.Router;Backbone.history.start({pushState:!0});Backbone.history.on("route",sendPageview);null!=a&&a()});$(window).resize(function(){Helper.resizeSidebar()})}
function sendPageview(){var a=Backbone.history.getFragment();"undefined"!==typeof googleanalytics&&googleanalytics("send","pageview","/"+a);"undefined"!==typeof fbq&&fbq("track","PageView")}function logout(){ETM.current_scheme={};ETM.last_scheme={};ETM.scheme_changed=!0;ETM.views={};ETM.models={};ETM.currently_generating=!1;ETM.fetch_complete=!1;ETM.current_user_profile=null;ETM.calendar_list=null;ETM.groceries_and_pantry=null;ETM.logout_occurred=!0;ETM.router=new ETM.Router}
function stopRKey(a){a=a?a:event?event:null;var b=a.target?a.target:a.srcElement?a.srcElement:null;if(13==a.keyCode&&"text"==b.type)return!1}function findNextAvailableTitle(a,b){for(var c=2;null!=a.findWhere({title:b+c});)c++;return b+c}document.onkeypress=stopRKey;$(document).ajaxStart(function(){$("#spinner").show()}).ajaxStop(function(){$("#spinner").hide()});var Hello={world:function(){return"Hello"}};ETM.MAP_SEARCH_MEAL_CHOSEN="map_search";ETM.ALTERNATE_MEAL_CHOSEN="alternate_meal";
ETM.FSQUARE_CLIENT_ID="YBRPJX40G03UCIN2YDHNZQXE4OW1L2SDBHWPET0UFK2KXIPK";ETM.FSQUARE_CLIENT_SECRET="YOZIHNYJMG3GKAHBSDHZUWPMDJHDO4P1ZRHHZK41JMM1MN4T";ETM.FSQUARE_VERSION_DATE="20161026";ETM.FSQUARE_RESULT_LIMIT=50;ETM.FSQUARE_FOOD_CATEGORY="4d4b7105d754a06374d81259";ETM.FSQUARE_RESTAURANT_CATEGORY="4bf58dd8d48988d1c4941735";ETM.FSQUARE_FAST_FOOD_CATEGORY="4bf58dd8d48988d16e941735";ETM.FSQUARE_GROCERY_STORE_CATEGORY="4bf58dd8d48988d118951735";ETM.FSQUARE_BBQ_CATEGORY="4bf58dd8d48988d1df931735";
ETM.FSQUARE_BAGEL_CATEGORY="4bf58dd8d48988d179941735";ETM.FSQUARE_BAKERY_CATEGORY="4bf58dd8d48988d16a941735";ETM.FSQUARE_BURGER_CATEGORY="4bf58dd8d48988d16c941735";ETM.FSQUARE_CAFE_CATEGORY="4bf58dd8d48988d16d941735";ETM.FSQUARE_DELI_CATEGORY="4bf58dd8d48988d146941735";ETM.FSQUARE_DINER_CATEGORY="4bf58dd8d48988d147941735";ETM.FSQUARE_GASTROPUB_CATEGORY="4bf58dd8d48988d155941735";ETM.FSQUARE_DINER_CATEGORY="4bf58dd8d48988d147941735";ETM.FSQUARE_PIZZA_CATEGORY="4bf58dd8d48988d1ca941735";
ETM.FSQUARE_SALAD_CATEGORY="4bf58dd8d48988d1bd941735";ETM.FSQUARE_SANDWICH_CATEGORY="4bf58dd8d48988d1c5941735";ETM.FSQUARE_SEAFOOD_CATEGORY="4bf58dd8d48988d1ce941735";ETM.FSQUARE_SNACK_CATEGORY="4bf58dd8d48988d1c7941735";ETM.FSQUARE_SOUP_CATEGORY="4bf58dd8d48988d1dd931735";ETM.FSQUARE_STEAKHOUSE_CATEGORY="4bf58dd8d48988d1cc941735";ETM.FSQUARE_VEGAN_CATEGORY="4bf58dd8d48988d1d3941735";ETM.FSQUARE_SEARCH_CATEGORIES_1=""+ETM.FSQUARE_FOOD_CATEGORY;ETM.FSQUARE_SEARCH_CATEGORIES_2=""+ETM.FSQUARE_FAST_FOOD_CATEGORY;
ETM.FSQUARE_SEARCH_CATEGORIES_3=[ETM.FSQUARE_RESTAURANT_CATEGORY,ETM.FSQUARE_GROCERY_STORE_CATEGORY,ETM.FSQUARE_SANDWICH_CATEGORY,ETM.FSQUARE_BURGER_CATEGORY,ETM.FSQUARE_PIZZA_CATEGORY].join();ETM.FSQUARE_SPECIFIC_SEARCH_CATEGORIES=[ETM.FSQUARE_FOOD_CATEGORY,ETM.FSQUARE_RESTAURANT_CATEGORY,ETM.FSQUARE_FAST_FOOD_CATEGORY,ETM.FSQUARE_GROCERY_STORE_CATEGORY,ETM.FSQUARE_SANDWICH_CATEGORY,ETM.FSQUARE_PIZZA_CATEGORY,ETM.FSQUARE_BURGER_CATEGORY].join();
ETM.PRESET_DIET_TYPES=["atkins / ketogenic","paleo","mediterranean","vegetarian","vegan"];ETM.PRESET_DIET_SYNONYMS={"atkins-ketogenic":"atkins / ketogenic"};ETM.MIN_IMAGE_WIDTH=200;ETM.MIN_IMAGE_HEIGHT=200;ETM.MAX_IMAGE_WIDTH=2500;ETM.MAX_IMAGE_HEIGHT=2500;ETM.GLOBAL_CONTEXT_VARIABLES={CURRENT_SITE_URL:CURRENT_SITE_URL};ETM.NUTRIENT_LIST="price alanine alcohol arginine aspartic_acid betaine caffeine calcium calories carbs cholesterol choline copper cystine fats fiber fluoride folate fructose galactose glucose glutamic_acid glycine histidine hydroxyproline iron isoleucine lactose leucine lycopene lysine magnesium maltose manganese methionine monounsaturated_fats niacin phenylalanine phosphorus polyunsaturated_fats potassium proline proteins retinol riboflavin saturated_fats selenium serine sodium thiamine threonine trans_fats tryptophan tyrosine valine vit_a vit_b6 vit_b12 vit_c vit_d vit_d2 vit_d3 vit_e vit_k water zinc alpha_carotene beta_carotene pantothenic_acid vit_a_iu vit_d_iu starch sucrose sugar theobromine ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid total_omega_3 total_omega_6".split(" ");
ETM.GENERATOR_NUTRIENTS="carbs fats proteins fiber cholesterol sodium price calories".split(" ");
ETM.NUTRIENT_KEY={price:"p",alanine:"a",alcohol:"al",arginine:"ar",alpha_carotene:"ac",aspartic_acid:"as",betaine:"b",beta_carotene:"bc",caffeine:"c",calcium:"ca",calories:"cal",carbs:"cb",cholesterol:"ch",choline:"cho",copper:"co",cystine:"cy",fats:"f",fiber:"fi",fluoride:"fl",folate:"fo",fructose:"fr",galactose:"g",glucose:"gl",glutamic_acid:"glu",glycine:"gly",histidine:"h",hydroxyproline:"hy",iron:"fe",isoleucine:"i",lactose:"l",leucine:"le",lycopene:"ly",lysine:"lys",magnesium:"m",maltose:"ma",
manganese:"man",methionine:"me",monounsaturated_fats:"mo",niacin:"n",pantothenic_acid:"pa",phenylalanine:"ph",phosphorus:"pho",polyunsaturated_fats:"po",potassium:"pot",proline:"pr",proteins:"pro",retinol:"r",riboflavin:"ri",saturated_fats:"s",selenium:"se",serine:"ser",sodium:"so",starch:"st",sucrose:"suc",sugar:"su",theobromine:"the",thiamine:"t",threonine:"th",trans_fats:"tr",tryptophan:"try",tyrosine:"ty",valine:"v",vit_a_iu:"vaiu",vit_a:"va",vit_b6:"vb6",vit_b12:"vb12",vit_c:"vc",vit_d_iu:"vdiu",
vit_d:"vd",vit_d2:"vd2",vit_d3:"vd3",vit_e:"ve",vit_k:"vk",water:"w",zinc:"z",ala_fatty_acid:"ala",dha_fatty_acid:"dha",epa_fatty_acid:"epa",dpa_fatty_acid:"dpa",total_omega_3:"to3",total_omega_6:"to6"};
var AccountManagementHelper={toggleBulkActions:function(a,b){$("button",b).html('<span class="glyphicon glyphicon-option-vertical"></span> Actions ('+a.length+")");0==a.length?(b.prop("disabled","true"),b.addClass("disabled"),b.find(".btn").removeClass("btn-primary"),b.find(".btn").addClass("btn-default")):(b.prop("disabled",!1),b.removeClass("disabled"),b.find(".btn").removeClass("btn-default"),b.find(".btn").addClass("btn-primary"))}};
ETM.getNextBillingDate=function(a){$.ajax({url:"/payments/next-billing-date/",type:"GET",success:function(b){if(null!=b&&0<b.length){var c=new Date(0);c.setUTCSeconds(b);b=String(c.getMonthNameShort("en"));var d=String(c.getDate());a(b+" "+d+", "+c.getFullYear())}else a("")},error:function(){a("")}})};
var Helper={deleteCookie:function(a,b,c){document.cookie=encodeURIComponent(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; domain="+c:"")+(b?"; path="+b:"")},updateTemplateFromDiet:function(a,b){var c=a-1;-1===c&&(c=6);var d=b.clone();d.attributes.sandbox=0;Helper.clearIDs(d);d.attributes.meals=new ETM.MealList;b.attributes.meals.each(function(a,c){d.attributes.meals.add(new ETM.MealObject({diet_plan_id:b.id,meal_type:a.attributes.meal_type,meal_number:a.attributes.meal_number}))});ETM.template_diet_list.getTemplateDietForWeekday(c).attributes.diet.save(d.attributes,
{silent:!0})},createTemplatesOnServer:function(a){$.get("/weeklyplanner/create-templates/",function(b){b=JSON.parse(b);ETM.template_diet_list.reset();b.forEach(function(a){a=new ETM.TemplateDiet(a);ETM.template_diet_list.add(a,{silent:!0})});a()})},resizeSidebar:function(){try{var a=$(window).height(),b=$(".sidebar_list_container"),c=a-b.position().top;b.css("height",c+"px")}catch(d){}},deleteLocalStorageKeys:function(){Object.keys(localStorage).forEach(function(a){localStorage.removeItem(a)})},deleteLocalStorageKeysWithPrefix:function(a){var b=
a.length;Object.keys(localStorage).forEach(function(c){c.substring(0,b)==a&&localStorage.removeItem(c)})},deleteLocalStorageKeysWithOutPrefix:function(a){var b=a.length;Object.keys(localStorage).forEach(function(c){c.substring(0,b)!=a&&localStorage.removeItem(c)})},randomNumber:function(a){return Math.floor(Math.random()*a)},randomNumberInRange:function(a,b){var c=b-a;return Math.floor(Math.random()*c)+a},clearIDs:function(a){delete a.id;delete a.pk;a.attributes&&(delete a.attributes.id,delete a.attributes.diet_plan,
delete a.attributes.meal,delete a.attributes.resource_uri,delete a.attributes.pk)},clearIDsRecursive:function(a){Helper.clearIDs(a);if(a.attributes)for(var b in a.attributes){var c=a.attributes[b];c&&"object"===typeof c&&Helper.clearIDsRecursive(c)}},resetLocalFoodInfoIDs:function(a){localStorage.setItem("food_info_object_ids",JSON.stringify([]));var b=[];a.attributes.meals.each(function(a){a.attributes.foods.each(function(a){b.push({id:a.attributes.food.attributes.id})})});b.unique();localStorage.setItem("food_info_object_ids",
JSON.stringify(b))},resetMacroSettings:function(){var a=ETM.current_diet.attributes.nutrition_profile;100<!a.attributes.calories&&(a.attributes.calories=2E3);var b=a.attributes.calories;a.attributes.min_carbs=parseInt(0.2*b/4);a.attributes.max_carbs=parseInt(0.6*b/4);a.attributes.min_fats=parseInt(0.2*b/9);a.attributes.max_fats=parseInt(0.6*b/9);a.attributes.min_proteins=parseInt(0.2*b/4);a.attributes.max_proteins=parseInt(0.6*b/4);a.save();ETM.is_logged_in&&ETM.is_premium?ETM.calendar_view.single_day_view.renderNutritionTargets():
ETM.is_logged_in?ETM.logged_in_free_day_view.single_day_view.renderNutritionTargets():ETM.logged_out_day_view.single_day_view.renderNutritionTargets();$("#scheme_validation").hide()},convertDateToString:function(a){var b=String(a.getMonth()+1);1===b.length&&(b="0"+b);var c=String(a.getDate());1===c.length&&(c="0"+c);return a.getFullYear()+"-"+b+"-"+c},parseDateString:function(a){var b=a.indexOf("T");-1!=b&&(a=a.substr(0,b));a=a.split("-");return new Date(a[0],a[1]-1,a[2])},parseDateStringSlashes:function(a){a=
a.split("/");return new Date(a[2],a[0]-1,a[1])},days_between:function(a,b){var c=a.getTime(),d=b.getTime(),c=Math.abs(c-d);return Math.round(c/864E5)},retainPageHeight:function(a){Helper.lockPageHeight();a();Helper.unlockPageHeight()},lockPageHeight:function(){var a=$(".body-container"),b=a.height();a.css("min-height",b)},unlockPageHeight:function(){$(".body-container").css("min-height","")}};
Array.prototype.unique=function(){for(var a=this.concat(),b=0;b<a.length;++b)for(var c=b+1;c<a.length;++c)a[b]===a[c]&&a.splice(c--,1);return a};Helper.formatFoodAmount=function(a){return"number"==typeof a?100<a?a.toFixed(0):1<=a?0!=a.toFixed(1)%1?a.toFixed(1):a.toFixed(0):a.toPrecision(2):a};
jQuery(document).ajaxSend(function(a,b,c){function d(a){var b=null;if(document.cookie&&""!=document.cookie)for(var c=document.cookie.split(";"),d=0;d<c.length;d++){var e=jQuery.trim(c[d]);if(e.substring(0,a.length+1)==a+"="){b=decodeURIComponent(e.substring(a.length+1));break}}return b}function e(a){var b="//"+document.location.host,c=document.location.protocol+b;return a==c||a.slice(0,c.length+1)==c+"/"||a==b||a.slice(0,b.length+1)==b+"/"||!/^(\/\/|http:|https:).*/.test(a)}!/^(GET|HEAD|OPTIONS|TRACE)$/.test(c.type)&&
e(c.url)&&b.setRequestHeader("X-CSRFToken",d("csrftoken"))});Helper.calculateMacrosFromProfile=function(a,b){if(0<a.validationErrorsForCalculator(b).length)return!1;var c=Helper.calculateMacros(a.attributes.age,a.attributes.weight,a.attributes.height,a.attributes.gender,a.attributes.goal,a.attributes.bodyfat,a.attributes.activity_level,a.attributes.preset_diet,a.attributes.weight_goal,a.attributes.weight_goal_weekly_rate/7);null!=b&&b(c);return c};
Helper.calculateMacros=function(a,b,c,d,e,f,g,h,l,m){return"undefined"!==typeof IOS_APP_VERSION&&1.89<=IOS_APP_VERSION||"undefined"!==typeof ANDROID_APP_VERSION&&109<=ANDROID_APP_VERSION?Helper.calculateMacrosNew(a,b,c,d,e,f,g,h,l,m):Helper.calculateMacrosOld(a,b,c,d,e,f,g,h,l,m)};
Helper.calculateMacrosNew=function(a,b,c,d,e,f,g,h,l,m){var p;p=parseInt((10/2.2046*b+15.875*c-5*a+("M"===d?5:-161))*g);var n=c=a=0;d=!1;!isNaN(m)&&0>m&&(m=Math.abs(m));l&&l<b&&(m*=-1);if(null!=m&&0>m||"L"==e)if(a=1.5>g?0.1*b:1.7>g?0.3*b:1*b,c=0.3*b,n=g/1.7,n=10==f?1*b*n:20==f?0.8*b*n:30==f?0.6*b*n:0.8*b*n,null!=m&&0!=m)if(b=p+3400*m,b/=p,0.5>=b){d=!0;var s=0.5}else s=b;else s=0.8;else null!=m&&0<m||"G"==e?(a=1.5>g?0.8*b:1.7>g?1.5*b:1.8>g?2*b:3*b,c=0.5*b,n=10==f?1.2*b:20==f?1*b:30==f?0.8*b:1*b,null!=
m&&0!=m?(b=p+3500*m,s=b/=p):s=1.15):"M"==e&&(a=1.5>g?0.3*b:1.7>g?0.8*b:1.8>g?2*b:3*b,c=0.5*b,n=g/1.7,n=10==f?1.1*b*n:20==f?0.9*b*n:30==f?0.7*b*n:0.9*b*n,s=1);b=Math.max(Math.ceil(p*s),200);f=0.5*b/4;m=0.5*b/9;e=0.5*b/4;"atkins / ketogenic"==h?(a=0,f=40):"paleo"==h?150<a?(f=a,a=100):(100<a&&150>a&&(a=100),f=150):"mediterranean"==h?(a*=0.9,n*=0.9):"zone"==h?(a=Math.max(0,0.4*b/4-5),f=0.4*b/4+5,c=Math.max(0,0.3*b/9-3),m=0.3*b/9+3,n=Math.max(0,0.3*b/4-5),e=0.3*b/4+5):"vegetarian"==h?n*=0.8:"vegan"==h&&
(n*=0.6);"zone"!=h&&250<n&&(n=250);l=Helper.getCaloriesFromMacros(a,c,n);l>=b&&(h=4*a/l,g=9*c/l,l=4*n/l,0.2<h&&(a=(h-0.03)*b/4),0.2<g&&(c=(g-0.03)*b/9),0.2<l&&(n=(l-0.03)*b/4));a=roundNumber(a,0);c=roundNumber(c,0);n=roundNumber(n,0);f=roundNumber(f,0);m=roundNumber(m,0);e=roundNumber(e,0);a>=f&&(a=2>=a?0:roundNumber(0.75*f,0));c>=m&&(2>=n?n=0:c=roundNumber(0.75*m,0));n>=e&&(n=2>=n?0:roundNumber(0.75*e,0));return{calories:b,min_carbs:a,min_fats:c,min_proteins:n,max_carbs:f,max_fats:m,max_proteins:e,
capped_min_calories:d}};
Helper.calculateMacrosOld=function(a,b,c,d,e,f,g,h,l,m){var p;p=parseInt((10/2.2046*b+15.875*c-5*a+("M"===d?5:-161))*g);var n=c=a=0;d=!1;b=null!=l&&0!=l?l:b;if(null!=m&&0>m||"L"==e)if(a=1.5>g?0.1*b:1.7>g?0.3*b:1*b,c=0.3*b,n=g/1.7,n=10==f?1*b*n:20==f?0.8*b*n:30==f?0.6*b*n:0.8*b*n,null!=m&&0!=m)if(f=p+3400*m,f/=p,0.5>=f){d=!0;var s=0.5}else s=f;else s=0.8;else null!=m&&0<m||"G"==e?(a=1.5>g?0.8*b:1.7>g?1.5*b:1.8>g?2*b:3*b,c=0.5*b,n=10==f?1.2*b:20==f?1*b:30==f?0.8*b:1*b,null!=m&&0!=m?(f=p+3500*m,s=f/=
p):s=1.15):"M"==e&&(a=1.5>g?0.3*b:1.7>g?0.8*b:1.8>g?2*b:3*b,c=0.5*b,n=g/1.7,n=10==f?1.1*b*n:20==f?0.9*b*n:30==f?0.7*b*n:0.9*b*n,s=1);f=Math.max(Math.ceil(p*s),200);m=0.5*f/4;e=0.5*f/9;g=0.5*f/4;"atkins / ketogenic"==h?(a=0,m=40):"paleo"==h?150<a?(m=a,a=100):(100<a&&150>a&&(a=100),m=150):"mediterranean"==h?(a*=0.9,n*=0.9):"zone"==h?(a=Math.max(0,0.4*f/4-5),m=0.4*f/4+5,c=Math.max(0,0.3*f/9-3),e=0.3*f/9+3,n=Math.max(0,0.3*f/4-5),g=0.3*f/4+5):"vegetarian"==h?n*=0.8:"vegan"==h&&(n*=0.6);"zone"!=h&&250<
n&&(n=250);s=Helper.getCaloriesFromMacros(a,c,n);s>=f&&(h=4*a/s,p=9*c/s,s=4*n/s,0.2<h&&(a=(h-0.03)*f/4),0.2<p&&(c=(p-0.03)*f/9),0.2<s&&(n=(s-0.03)*f/4));a=roundNumber(a,0);c=roundNumber(c,0);n=roundNumber(n,0);m=roundNumber(m,0);e=roundNumber(e,0);g=roundNumber(g,0);a>=m&&(a=2>=a?0:roundNumber(0.75*m,0));c>=e&&(2>=n?n=0:c=roundNumber(0.75*e,0));n>=g&&(n=2>=n?0:roundNumber(0.75*g,0));return{calories:f,min_carbs:a,min_fats:c,min_proteins:n,max_carbs:m,max_fats:e,max_proteins:g,capped_min_calories:d}};
Helper.getCaloriesFromMacros=function(a,b,c){return 4*a+9*b+4*c};Helper.getMobileOperatingSystem=function(){var a=navigator.userAgent||navigator.vendor||window.opera;return a.match(/iPad/i)||a.match(/iPhone/i)||a.match(/iPod/i)?"iOS":a.match(/Android/i)?"Android":"unknown"};Helper.capitalizeFirstLetter=function(a){return a.charAt(0).toUpperCase()+a.slice(1)};
Helper.showNestedModal=function(a){var b=$("body");b.hasClass("modal-open")&&!b.hasClass("nested-modal-open")&&(b.addClass("nested-modal-open"),a.$el.one("hidden.bs.modal",function(a){setTimeout(function(){$("body").removeClass("nested-modal-open");$("body").addClass("modal-open")},100)}));a.$el.modal("show")};
Helper.getListOfNextDates=function(a){return day_list=[{val:0,label:"Current day, "+moment(a).format("dddd, MMM Do")},{val:1,label:"Tomorrow, "+moment(a).add(1,"days").format("dddd, MMM Do")},{val:2,label:moment(a).add(2,"days").format("dddd, MMM Do")},{val:3,label:moment(a).add(3,"days").format("dddd, MMM Do")},{val:4,label:moment(a).add(4,"days").format("dddd, MMM Do")},{val:5,label:moment(a).add(5,"days").format("dddd, MMM Do")},{val:6,label:moment(a).add(6,"days").format("dddd, MMM Do")}]};
Helper.getListOfNextDayNumbers=function(a,b){for(var c=[],d=0,e=a;e<b&&!(c.push({val:e,label:e===a?"Current plan, Day "+(a+1):"Day "+(e+1)}),d++,14<d);e++);return c};Helper.toHex=function(a){return("0"+Number(a).toString(16)).slice(-2).toUpperCase()};
Helper.hsvToRgb=function(a,b,c){var d,e,f;a=Math.max(0,Math.min(360,a));b=Math.max(0,Math.min(100,b));c=Math.max(0,Math.min(100,c));b/=100;c/=100;if(0==b)return d=b=c,[Math.round(255*d),Math.round(255*b),Math.round(255*c)];a/=60;d=Math.floor(a);e=a-d;a=c*(1-b);f=c*(1-b*e);e=c*(1-b*(1-e));switch(d){case 0:d=c;b=e;c=a;break;case 1:d=f;b=c;c=a;break;case 2:d=a;b=c;c=e;break;case 3:d=a;b=f;break;case 4:d=e;b=a;break;default:d=c,b=a,c=f}return"#"+Helper.toHex(Math.round(255*d))+Helper.toHex(Math.round(255*
b))+Helper.toHex(Math.round(255*c))};Helper.rgbColors=function(a){a=parseInt(a);if(2>a)throw Error("'t' must be greater than 1.");for(var b=360/(a-1),c=[],d=70,e=0;e<a;e++)d=90<d?70:d+10,c.push(Helper.hsvToRgb(b*e,d,d));return c};Helper.removePunctuationAndLowerCase=function(a){return a.replace(/[^\w]|_/g,"").replace(/\s+/g," ").toLowerCase()};
Helper.oneTimeTooltip=function(a,b,c,d){a.tooltip({placement:b,html:!0,title:c}).on("hidden.bs.tooltip",function(a){$(this).off("hidden.bs.tooltip");$(this).tooltip("destroy")});a.tooltip("show");setTimeout(function(){a.tooltip("hide")},d)};
Helper.oneTimePopover=function(a,b,c,d,e,f,g){e&&(c+="<div class='popover_footer'><div class='dismiss_popover btn btn-primary'>Okay, got it</div></div>");var h="";d&&(h=d);g=g||!1;a.popover({placement:b,html:!0,title:h,content:c,template:'<div class="popover '+(f||"")+'" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',trigger:"manual",viewport:{selector:"body",padding:0}}).on("hidden.bs.tooltip",function(a){$(this).off("hidden.bs.tooltip");
$(this).tooltip("destroy")}).on("shown.bs.popover",function(){var a=$(this);$(this).next(".popover").find(".dismiss_popover").click(function(b){g&&g();a.popover("hide")})});a.popover("show");e||setTimeout(function(){a.popover("hide")},3500)};Helper.fixNullCaloriesInNutritionProfiles=function(a){var b=0,c=[];ETM.nutrition_profile_list.each(function(a){if(3<=b)return!1;null==a.attributes.calories&&c.push(a.save({calories:2E3}));b++});$.when.all(c).then(function(b){a()})};
Helper.copyPermalink=function(a){var b=$("<input>");$("body").append(b);b.val(a.val()).select();try{document.execCommand("copy"),Helper.oneTimeTooltip(a,"top","Copied to clipboard",1E3)}catch(c){}b.remove()};
Helper.validateSingleDayDiet=function(){var a=[],b=[];ETM.current_diet.attributes.meals.forEach(function(b){var d=[];b.attributes.foods.forEach(function(a){d.push(a.attributes.food.attributes.resource_uri)});a.push(d)});_.each(a,function(a,d){0==a.length&&b.push("meal"+d);a.forEach(function(a){null==a&&b.push("food"+d)})});return b};
Helper.createTemplateFunction=function(a){var b=_.template(a);return function(a){if("undefined"===typeof a||null==a)a={};a=$.extend({},a,ETM.GLOBAL_CONTEXT_VARIABLES);return b(a)}};Helper.generateMealRatingHash=function(a,b){b=b||!1;var c=0;_.each(a,function(a){c+=Math.pow(a,2)});b&&(c*=b);return c};
ETM.AccountInfoView=Backbone.View.extend({events:{"change .first_name,.last_name":function(){var a=$(".first_name",this.el).val(),b=$(".last_name",this.el).val();this.model.attributes.first_name=a;this.model.attributes.last_name=b;try{this.model.attributes.full_name=a+" "+b}catch(c){}$.ajax({url:"/user/change-name/",data:{first_name:a,last_name:b},type:"POST",success:function(a){},error:function(a,b,c){console.log(b)}})}},render:function(){var a=this;this.$el.html(this.template({user:this.model.attributes,
has_pro_subscription:this.model.hasProSubscription(),has_manager_subscription:this.model.hasManagerSubscription(),has_android_subscription:this.model.hasAndroidSubscription(),has_ios_subscription:this.model.hasIosSubscription()}));this.model.isSubscriber()&&ETM.getNextBillingDate(function(b){$(".next_billing_date",a.el).html(b)});return this}});
ETM.AccountManagementAccountsView=Backbone.View.extend({events:{"click .select_all_account_checkboxes":function(a){$(".account_checkbox",this.el).prop("checked",$(a.currentTarget)[0].checked);this.toggleAccountBulkActionsButton()},"click .account_checkbox":function(a){this.toggleAccountBulkActionsButton()},"click .select_all_email_checkboxes":function(a){$(".external_email_checkbox",this.el).prop("checked",$(a.currentTarget)[0].checked);this.toggleEmailBulkActionsButton()},"click .invited_user_checkbox":function(a){this.toggleInvitedUsersBulkActionsButton()},
"click .select_all_invite_user_checkboxes":function(a){$(".invited_user_checkbox",this.el).prop("checked",$(a.currentTarget)[0].checked);this.toggleInvitedUsersBulkActionsButton()},"click .external_email_checkbox":function(a){this.toggleEmailBulkActionsButton()},"click .deny_new_account":function(a){a=$(a.currentTarget).data("index");var b=this.pending_accounts[a];b.save({link_deleted_date:new Date},{patch:!0});ETM.managed_accounts.remove(b);this.pending_accounts.splice(a,1);this.renderPendingAccounts()},
"click .accept_new_account":function(a){a=$(a.currentTarget).data("index");var b=this.pending_accounts[a];b.save({manager_approved:!0},{patch:!0});this.pending_accounts.splice(a,1);this.approved_accounts.push(b);this.renderPendingAccounts();this.renderApprovedAccounts()},"click .invite_account":function(){this.showInviteModal()},"click .create_accounts":function(){this.showCreateUsersModal()},"click .refresh_accounts":function(a){var b=this,c=$(a.currentTarget).ladda();c.ladda("start");$.when(ETM.managed_accounts.fetch(),
ETM.managed_external_accounts.fetch(),ETM.manager_invited_users.fetch()).done(function(){c.ladda("stop");b.render()})},"click .delete_external":function(a){var b=this;a=$(a.currentTarget).data("resource-uri");var c=ETM.managed_external_accounts.get(a);c.save({deleted_date:new Date},{success:function(){b.renderExternalAccounts();ETM.managed_external_accounts.remove(c)}})},"click .delete_invites":function(a){a=$("input.invited_user_checkbox:checked",this.el);var b=[];0<a.length&&a.each(function(a,d){var e=
$(this).data("id"),f=$(this).data("resource_uri");b.push(e);ETM.manager_invited_users.remove(f)});$.post({url:"/account-management/delete-invited-users/",data:{ids:JSON.stringify(b)}});this.renderInvitedAccounts()},"click .resend_invites":function(a){var b=[];a=$("input.invited_user_checkbox:checked",this.el);0<a.length&&a.each(function(a,d){b.push($(this).data("email"))});this.showInviteModal(b)},"click .stop_managing_accounts":function(a){var b=this;a=$("input.account_checkbox:checked",this.el);
var c=[];0<a.length&&a.each(function(a,e){var f=$(this).data("id"),g=$(this).data("index"),h=$(this).data("resource_uri");c.push(f);ETM.managed_accounts.remove(h);b.approved_accounts.splice(g,1)});$.post({url:"/account-management/stop-managing-users/",data:{ids:JSON.stringify(c)},success:function(){b.renderApprovedAccounts()}})},"click .edit_user_profile":function(a){a=$(a.currentTarget).data("user-id");$.ajax({url:"/account-management/query-client-user-ids/",data:{client_user_id:a},type:"POST",success:function(a){var c=
new ETM.UserProfile({id:a.user_profile_id},{silent:!0}),d=new ETM.NutritionProfile({id:a.nutrition_profile_id},{silent:!0});$.when(c.fetch(),d.fetch()).done(function(){a.user_profile=c;a.nutrition_profile=d;var e=new ETM.AccountManagementSetupUserProfileModalView;e.data=a;$("#manager_setup_profile_modal",ETM.$modal_content).html(e.render().el);e.$el.modal({backdrop:"static",show:!0})})},error:function(a,c,d){console.log(c)}})},"click .delete_external_accounts":function(a){a=$("input.external_email_checkbox:checked",
this.el);var b=[];0<a.length&&a.each(function(a,d){var e=$(this).data("id"),f=$(this).data("resource_uri");b.push(e);ETM.managed_external_accounts.remove(f)});$.post({url:"/account-management/delete-external-accounts/",data:{ids:JSON.stringify(b)}});this.renderExternalAccounts()},"click .add_email":"addEmail"},initialize:function(){this.pending_accounts_template=ETM.loadTemplate("#AccountManagementPendingAccountsTemplate");this.invited_accounts_template=ETM.loadTemplate("#AccountManagementInvitedAccountsTemplate");
this.approved_accounts_template=ETM.loadTemplate("#AccountManagementApprovedAccountsTemplate");this.external_accounts_template=ETM.loadTemplate("#AccountManagementExternalAccountsTemplate")},toggleAccountBulkActionsButton:function(){AccountManagementHelper.toggleBulkActions($("input.account_checkbox:checked",this.el),$(".account_bulk_actions_dropdown",this.el))},toggleEmailBulkActionsButton:function(){AccountManagementHelper.toggleBulkActions($("input.external_email_checkbox:checked",this.el),$(".email_bulk_actions_dropdown",
this.el))},toggleInvitedUsersBulkActionsButton:function(){AccountManagementHelper.toggleBulkActions($("input.invited_user_checkbox:checked",this.el),$(".invited_user_bulk_actions_dropdown",this.el))},render:function(){this.$el.html();this.renderAccounts();$(".approved_accounts_tooltip",this.el).tooltip({html:!0,placement:"right",title:"<div>Clients that you invite via email or that join your account via your personal link will be given Eat This Much Premium access while you are subscribed to a Pro subscription.  Once they have an account you can change their preferences, apply meal plans to their account, and send them emails with their plans.</div>"});
$(".email_only_accounts_tooltip",this.el).tooltip({html:!0,placement:"right",title:'<div>These clients will not receive a full Eat This Much account but will appear on the "Send emails" tab where you can send them customized meal plans via email.</div>'});return this},renderAccounts:function(){var a=this;this.approved_accounts=[];this.pending_accounts=[];ETM.managed_accounts.forEach(function(b){b.attributes.manager_approved?a.approved_accounts.push(b):a.pending_accounts.push(b)});this.$el.html(a.template());
this.renderPendingAccounts();this.renderInvitedAccounts();this.renderApprovedAccounts();this.renderExternalAccounts()},renderPendingAccounts:function(){$(".pending_accounts_table",this.el).empty();0<this.pending_accounts.length&&$(".pending_accounts_table",this.el).html(this.pending_accounts_template({pending_accounts:this.pending_accounts}))},renderInvitedAccounts:function(){$(".invited_accounts_table",this.el).empty();0<ETM.manager_invited_users.length&&$(".invited_accounts_table",this.el).html(this.invited_accounts_template({invited_users:ETM.manager_invited_users}))},
renderApprovedAccounts:function(){$(".approved_accounts_table",this.el).html(this.approved_accounts_template({approved_accounts:this.approved_accounts}))},renderExternalAccounts:function(){$(".external_accounts_table",this.el).empty();0<ETM.managed_external_accounts.length&&$(".external_accounts_table",this.el).html(this.external_accounts_template({external_accounts:ETM.managed_external_accounts}))},showInviteModal:function(a){var b=this,c=new ETM.AccountManagementInviteModalView;null!=a&&(c.initial_emails=
a);c.invite_completed_callback=function(){ETM.manager_invited_users.fetch({success:function(){b.renderInvitedAccounts()}})};$("#manager_invite_user_modal",ETM.$modal_content).html(c.render().el);c.$el.modal({backdrop:"static",show:!0})},showCreateUsersModal:function(a){var b=this;a=new ETM.AccountManagementCreateAccountsModalView;this.listenTo(a,"invite_user",function(a){b.showInviteModal([a])});$("#manager_create_users_modal",ETM.$modal_content).html(a.render().el);a.$el.one("hidden.bs.modal",function(a){$.when(ETM.managed_accounts.fetch()).done(function(){b.render()})});
a.$el.modal({backdrop:"static",show:!0})},validateEmail:function(a){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(a)},addEmail:function(){var a=this;$(".add_email_error",this.el).hide();var b=$('.add_email_form input[name="first_name"]',this.el),c=$('.add_email_form input[name="last_name"]',this.el),d=$('.add_email_form input[name="email"]',this.el),e=b.val(),f=c.val(),g=d.val();if(0!=
e.length&&0!=f.length&&0!=g.length&&this.validateEmail(g)){var h=new ETM.ManagedExternalAccount({first_name:e,last_name:f,client_email:g});h.save(null,{success:function(){ETM.managed_external_accounts.add(h);a.renderExternalAccounts();b.val("");c.val("");d.val("");b.focus()}})}else $(".add_email_error",this.el).show()}});
ETM.AccountManagementCreateAccountsModalView=ModalView.extend({className:"modal fade",events:{"input #id_email":function(a){var b=$("#id_username",this.el);b.prop("disabled")&&(0<=$(a.currentTarget).val().indexOf("@")?b.val($(a.currentTarget).val().split("@")[0]):b.val($(a.currentTarget).val()));b=$("#id_password1",this.el);b.prop("disabled")&&(0<=$(a.currentTarget).val().indexOf("@")?b.val($(a.currentTarget).val().split("@")[0]+this.random_number.toString()):b.val($(a.currentTarget).val()+this.random_number.toString()))},
"click .edit_username_button":function(a){a.preventDefault();$("#id_username",this.el).prop("disabled",!1)},"click .edit_password1_button":function(a){a.preventDefault();$("#id_password1",this.el).prop("disabled",!1)},"click .create_user":function(a){a.preventDefault();$(".form_errors",this.el).hide();var b=this;this.user_info={};$.each($(".user_form",this.el).serializeArray(),function(a,c){b.user_info[c.name]=c.value});this.user_info.username=$("#id_username",this.el).val();this.user_info.password1=
$("#id_password1",this.el).val();var c=$(a.currentTarget).ladda();c.ladda("start");$.ajax({url:"/account-management/create-user/",data:this.user_info,type:"POST",success:function(a){c.ladda("stop");b.signup_view=new ETM.AccountManagementCreateUsersSignupView(a);b.listenTo(b.signup_view,"signupComplete",function(){$(".account_management_create_accounts_body",b.el).html(b.created_user_template(b.user_info))},b);$(".account_management_create_accounts_body",b.el).html(b.signup_view.render().el)},error:function(a,
e,f){c.ladda("stop");400==a.status?$(".form_errors .alert",b.el).html(a.responseText+"<br/>Want to invite their account to join yours?  <button class='btn btn-info invite_existing_user' type='button'>Click here</button>"):$(".form_errors .alert",b.el).text(a.responseText);$(".form_errors",b.el).show()}})},"click .create_another_user":function(){this.renderForm()},"click .invite_existing_user":function(){var a=this,b=$("#id_email",this.el).val();this.$el.one("hidden.bs.modal",function(c){a.trigger("invite_user",
b)});this.$el.modal("hide")}},initialize:function(){this.random_number=Math.floor(100*Math.random())+1;this.create_user_form_template=ETM.loadNestedTemplate("#AccountManagementCreateAccountsModalView","#createUserForm");this.created_user_template=ETM.loadTemplate("#AccountManagementUserCreatedTemplate")},render:function(){this.$el.html(this.template({}));this.renderForm();return this},renderForm:function(){$(".account_management_create_accounts_body",this.el).html(this.create_user_form_template({}))}});
ETM.AccountManagementSetupUserProfileModalView=ETM.AccountManagementCreateAccountsModalView.extend({renderForm:function(a){var b=this;b.signup_view=new ETM.AccountManagementCreateUsersSignupView(this.data);b.listenTo(b.signup_view,"signupComplete",function(){b.$el.modal("hide")},b);$(".account_management_create_accounts_body",b.el).html(b.signup_view.render().el)}});
ETM.AccountManagementEditPlansView=Backbone.View.extend({events:{"click .select_all_account_checkboxes":function(a){$(".account_checkbox",this.el).prop("checked",$(a.currentTarget)[0].checked);this.toggleAccountBulkActionsButton()},"click .account_checkbox":function(a){this.toggleAccountBulkActionsButton()},"click .bulk_apply_sets":function(){var a=[],b=[],c=$("input.account_checkbox:checked",this.el);0<c.length&&c.each(function(c,e){a.push($(this).data("name"));b.push($(this).data("resource_uri"))});
this.showApplySetsModal(a,b)},"click .apply_sets":function(a){this.showApplySetsModal([$(a.currentTarget).data("name")],[$(a.currentTarget).data("resource_uri")])}},showApplySetsModal:function(a,b){var c=this;ETM.apply_sets_modal&&(ETM.apply_sets_modal.close(),ETM.apply_sets_modal=null);ETM.apply_sets_modal=new ETM.AccountManagementApplyDietSetsModalView;ETM.apply_sets_modal.account_names=a;ETM.apply_sets_modal.apply_set_callback=function(a,e,f){b.forEach(function(b){ETM.managed_accounts.get(b).set({active_set_end_date:moment(e).format("MM-DD"),
active_set_name:f,active_set_start_date:moment(a).format("MM-DD")});ETM.$content.html(c.render().el)})};$("#apply_sets_modal").html(ETM.apply_sets_modal.render().el);ETM.apply_sets_modal.showLoadDates();ETM.apply_sets_modal.$el.modal("show")},toggleAccountBulkActionsButton:function(){AccountManagementHelper.toggleBulkActions($("input.account_checkbox:checked",this.el),$(".account_bulk_actions_dropdown",this.el))},render:function(){var a=this;this.$el.html();this.approved_accounts=[];ETM.managed_accounts.forEach(function(b){b.attributes.manager_approved&&
a.approved_accounts.push(b)});this.$el.html(this.template({managed_accounts:this.approved_accounts}));return this}});
ETM.AccountManagementEmailPlansView=Backbone.View.extend({events:{"click .select_all_account_checkboxes":function(a){$(".account_checkbox",this.el).prop("checked",$(a.currentTarget)[0].checked);this.updateEmailButton()},"click .account_checkbox":function(a){this.updateEmailButton()},"click .print_email_plans":function(){var a=[],b=$("input.account_checkbox:checked",this.el);0<b.length&&b.each(function(b,d){a.push($(this).data("email"))});b=new ETM.ManagerEmailPlansModalView({emails:a});$("#manager_email_plans_modal",
ETM.$modal_content).html(b.render().el);$(".date_range_selector",b.el).data("kalendae").setSelected(getGrocerySyncDateString());b.$el.modal("show")}},updateEmailButton:function(){var a=$("input.account_checkbox:checked",this.el);$(".print_email_plans",this.el).html('<span class="glyphicon glyphicon-envelope"></span> Preview / Email ('+a.length+") / Print plans...")},render:function(){this.$el.html(this.template({managed_accounts:ETM.managed_accounts,managed_external_accounts:ETM.managed_external_accounts}));
return this}});
ETM.AccountManagementInviteModalView=ModalView.extend({className:"modal fade",events:{"click .copy_permalink":function(){Helper.copyPermalink($(".invite_permalink",this.el))},"click .invite_users":"inviteUsers"},initialize:function(){this.invite_completed_callback=null;this.initial_emails=[]},render:function(){this.$el.html(this.template({invite_link:window.location.origin+"/account-management/"+encodeURIComponent(ETM.current_user_profile.attributes.username)+"/join/",username:ETM.current_user_profile.attributes.username,logo_url:ETM.manager_profile.attributes.logo_url,
manager_fullname:ETM.current_user_profile.attributes.first_name+" "+ETM.current_user_profile.attributes.last_name,company_name:ETM.manager_profile.attributes.company_name}));this.renderForm();return this},renderForm:function(){this.form=(new Backbone.Form({schema:{invite_emails:{type:"TextArea",validators:["required"],editorAttrs:{placeholder:"Enter emails to invite (one per line)"}},manager_name:{type:"Text",validators:["required"],editorAttrs:{placeholder:"Your name here"}},personal_message_email:{type:"TextArea",
editorAttrs:{placeholder:"Add any personal message you'd like here"}}},template:Helper.createTemplateFunction($("#inviteUsersForm",this.el).html()),data:{manager_name:ETM.current_user_profile.attributes.full_name,invite_emails:this.initial_emails.join("\n")}})).render();$("#invite_users_form_div",this.el).html(this.form.el)},inviteUsers:function(a){var b=this;$(".invite_user_error",this.el).remove();var c=$(".invite_users",this.el).ladda();c.ladda("start");var d=this.form.validate();if(d){c.ladda("stop");
for(var e in d)$('[data-editors="'+e+'"]').append('<div class="invite_user_error alert alert-danger">'+d[e].message+"</div>")}else Helper.initializeButtonLoading(a.target),$.ajax({url:"/account-management/invite-users-via-email/",data:this.form.getValue(),type:"POST",success:function(a,d,e){c.ladda("stop");null!=b.invite_completed_callback&&b.invite_completed_callback();a?Backbone.trigger("flash",{message:a,type:"danger"}):b.$el.modal("hide")},error:function(a,b,d){c.ladda("stop")}})}});
Helper.initializeButtonLoading=function(a){};
ETM.AccountManagementProfileView=Backbone.View.extend({events:{"change .first_name,.last_name":function(){var a=$(".first_name",this.el).val(),b=$(".last_name",this.el).val();$.ajax({url:"/user/change-name/",data:{first_name:a,last_name:b},type:"POST",success:function(a){},error:function(a,b,e){console.log(b)}})},"change .company_name":function(){var a=$(".company_name",this.el).val();ETM.manager_profile.save({company_name:a},{patch:!0})},"change .receive_status_emails":function(){var a=$(".receive_status_emails",
this.el).prop("checked");$.post({url:"/account-management/change-status-email-preferences/",data:{receive_manager_status_emails:a}})}},render:function(){var a=this;this.$el.html(this.template({first_name:ETM.current_user_profile.attributes.first_name,last_name:ETM.current_user_profile.attributes.last_name,company_name:ETM.manager_profile.attributes.company_name,receive_status_emails_checked:ETM.manager_profile.attributes.receive_status_emails?"checked":"",card_last4:ETM.current_user_profile.attributes.subscription.card_last4,
current_subscription_type:ETM.current_user_profile.attributes.subscription.price,unsubscribed:ETM.current_user_profile.attributes.subscription.unsubscribed}));ETM.current_user_profile.isSubscriber()&&ETM.getNextBillingDate(function(b){$(".next_billing_date",a.el).html(b)});$("#"+ETM.current_user_profile.attributes.subscription.price,this.el).addClass("active");this.renderForm();this.create_logo_uploader();return this},renderForm:function(){this.form=(new Backbone.Form({template:Helper.createTemplateFunction($("#accountManagementProfileForm",
this.el).html())})).render();$(".account_management_profile_form",this.el).html(this.form.el);null!=ETM.manager_profile.attributes.logo_url&&this.setLogoHtml();$(".logo_tooltip",this.el).tooltip({html:!0,title:"<div class='drip_tooltip_content'><p>This logo will appear at the top of emailed plans as well as at the top of meal plans on the site for any users you manage.  The logo should be at least 200x200 pixels.</p></div>"});$(".receive_status_emails_tooltip",this.el).tooltip({html:!0,title:"<div class='drip_tooltip_content'><p>Weekly status emails will contain information about pending account connections, accounts whose meal plan sets are ending, and accounts that disconnected.</p></div>"})},
setLogoHtml:function(){$(".cropped_manager_logo_img",this.el).html('<img src="https://images.eatthismuch.com/site_media/'+ETM.manager_profile.attributes.logo_url+'"/>')},create_logo_uploader:function(){var a=this;ETM.displayImageSelectModal($(".manager_logo_fileapi_div",this.el),function(b){a.modal&&a.modal.close();a.modal=new ETM.ManagerLogoImageCropModalView;$("#upload_image_modal",ETM.$modal_content).html(a.modal.render(b).el);a.modal.show()})}});
ETM.AccountManagementResourcesView=Backbone.View.extend({render:function(){this.$el.html(this.template({}));return this}});ETM.AddMealObject=Backbone.Model.extend({});
ETM.AddMealTypeModal=ModalView.extend({className:"modal fade",events:{"click .add_meal":"addMeal","click .create_new_meal_type":"openMealTypeModal"},render:function(){this.$el.html(this.template({}));return this},initialize:function(){this.add_meal_object=new ETM.AddMealObject({meal_type:ETM.meal_type_list.at(0).id,new_meal_days:[0,1,2,3,4,5,6],new_meal_index:"end"});this.new_meal=new ETM.MealObject},renderForm:function(a){this.add_meal_object.attributes.new_meal_days=ETM.current_user_profile.attributes.single_template_diet?
[0]:"undefined"!=typeof a?[a]:[0,1,2,3,4,5,6];this.form=(new Backbone.Form({schema:{meal_type:{type:"Select",validators:["required"],options:ETM.meal_type_list.getMealTypeNameAndIds()},new_meal_index:{type:"Select",validators:["required"],options:[{val:"end",label:"At the end of the day"},{val:"beginning",label:"At the beginning of the day"},{val:1,label:"After meal 1"},{val:2,label:"After meal 2"},{val:3,label:"After meal 3"},{val:4,label:"After meal 4"},{val:5,label:"After meal 5"},{val:6,label:"After meal 6"},
{val:7,label:"After meal 7"},{val:8,label:"After meal 8"}]},new_meal_days:{type:"Checkboxes",validators:["required"],options:[{val:6,label:"Sun"},{val:0,label:"Mon"},{val:1,label:"Tue"},{val:2,label:"Wed"},{val:3,label:"Thu"},{val:4,label:"Fri"},{val:5,label:"Sat"}]}},model:this.add_meal_object,template:Helper.createTemplateFunction($("#addMealsToWeekForm",this.el).html())})).render();$("#add_meal_form",this.el).html(this.form.el);ETM.current_user_profile.attributes.single_template_diet&&$(".which_days_section",
this.el).hide()},openMealTypeModal:function(a){a.preventDefault();this.$el.modal("hide");this.form.commit();this.new_meal.attributes.meal_type=this.add_meal_object.attributes.meal_type;this.create_meal_type?(this.create_meal_type.model=new ETM.MealType,this.create_meal_type.meal=this.new_meal):(this.create_meal_type=new ETM.EditMealTypeView({model:new ETM.MealType},{meal:this.new_meal}),this.listenTo(this.create_meal_type,"closedModal",function(){this.$el.modal("show")},this),this.listenTo(this.new_meal,
"switchedMealTypes",function(){this.$el.modal("show");this.renderForm();$("#new_meal_type select option:last-child",this.el).attr("selected","selected")},this));$("#edit_meal_type_modal",ETM.$modal_content).html(this.create_meal_type.render().el);this.create_meal_type.renderForm();this.create_meal_type.delegateEvents();this.create_meal_type.$el.modal("show")},addMeal:function(a){a.preventDefault();$(".new_meal_validation_error",this.el).remove();var b=this;a=this.form.commit();this.new_meal.attributes.meal_type=
this.add_meal_object.attributes.meal_type;if(0==this.add_meal_object.attributes.new_meal_days.length)$("#new_meal_days").before("<div class='alert alert-danger new_meal_validation_error'>You must select at least one day to add this meal to.</div>");else if("undefined"===typeof a)this.add_meal_object.get("new_meal_days").forEach(function(a){var c=ETM.template_diet_list.getTemplateDietForWeekday(parseInt(a)),f=b.add_meal_object.attributes.new_meal_index,f="end"===f?c.attributes.diet.attributes.meals.length:
"beginning"===f?0:parseInt(f),g=new ETM.MealObject({meal_type:b.new_meal.attributes.meal_type,meal_number:f,diet_plan:c.attributes.diet.id});9>c.attributes.diet.attributes.num_meals&&g.save(null,{url:"/api/v1/reordermeal/",success:function(a,b){c.attributes.diet.attributes.meals.add(g,{at:f})}})}),b.$el.modal("hide");else for(var c in a)$('[data-editors="'+c+'"]').append('<div class="alert alert-danger new_meal_validation_error" style="float:left">'+a[c].message+"</div>")}});
ETM.AffiliateView=Backbone.View.extend({events:{"change .affiliate_timespan":"loadAffiliateGraph"},render:function(){this.$el.html(this.template({is_premium:ETM.is_premium,is_logged_in:ETM.is_logged_in,user:ETM.current_user_profile.attributes}));this.loadAffiliateGraph();return this},loadAffiliateGraph:function(){var a=this,b=$(".affiliate_timespan",this.el).val();Helper.lockPageHeight();$("#affiliate_graph_div",this.el).hide();$("#graph_spinner",this.el).show();$.post("/affiliate/data/",{timespan:b},
function(b){b=JSON.parse(b);var d=new Date(b.start_date),e=new Date(b.end_date);start_date2=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),0,0));end_date2=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),0,0));start_date2.setHours(start_date2.getHours()+24);start_date2.setUTCHours(0);end_date2.setHours(end_date2.getHours()+24);end_date2.setUTCHours(0);d=b.graph_data;b={};for(var f in d)if("charge"==f||"signup"==f||0!=Object.keys(d[f]).length)for(e=new Date(start_date2.getTime());e<=
end_date2;e.setDate(e.getDate()+1)){var g=e.getDate(),h=e.getMonth()+1,l=e.getFullYear(),g=h+"-"+g+"-"+l,h=0;d[f].hasOwnProperty(g)&&(h=d[f][g]);"signup"!=f&&(h/=100);b.hasOwnProperty(f)?b[f].push([new Date(e.getTime()),h]):b[f]=[[new Date(e.getTime()),h]]}d=[];e=0;for(f in b)d.push({label:f.charAt(0).toUpperCase()+f.slice(1),data:b[f]}),"signup"==f&&(d[e].yaxis=2),e++;$("#graph_spinner",a.el).hide();$("#affiliate_graph_div",a.el).show();Helper.unlockPageHeight();f=1;b="day";180<d[0].data.length?
(f=1,b="month"):90<d[0].data.length?(f=14,b="day"):30<d[0].data.length&&(f=7,b="day");a.printFlotGraph(d,{xaxis:{mode:"time",tickSize:[f,b],tickLength:0,axisLabel:"Date",axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelPadding:10,color:"black"},yaxes:[{position:"left",color:"black",axisLabel:"Volume ($USD)",axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,tickDecimals:2,min:0,axisLabelPadding:10},{position:"right",color:"black",axisLabel:"Signups",tickSize:1,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,
min:0,tickDecimals:0,axisLabelPadding:3}],legend:{noColumns:1,labelBoxBorderColor:"#000000",position:"nw"},grid:{hoverable:!0,borderWidth:1,backgroundColor:{colors:["#ffffff","#f5f5fc"]}}})})},printFlotGraph:function(a,b){$.plot($("#affiliate_graph_div",this.el),a,b);$("#affiliate_graph_div",this.el).UseTooltip()},printAffiliateGraph:function(a){nv.addGraph(function(){var b=nv.models.lineChart();b.xAxis.axisLabel("Date").rotateLabels(-45).tickFormat(function(a){return d3.time.format("%b %d")(new Date(a))});
b.yAxis.axisLabel("$").tickFormat(d3.format("d"));d3.select("#affiliate_graph_div svg").datum(a).transition().duration(500).call(b);return b})}});function gd(a,b,c){return(new Date(a,b-1,c)).getTime()}var monthNames="January February March April May June July August September October November December".split(" "),previousPoint=null,previousLabel=null;
$.fn.UseTooltip=function(){$(this).bind("plothover",function(a,b,c){if(c){if(previousLabel!=c.series.label||previousPoint!=c.dataIndex){previousPoint=c.dataIndex;previousLabel=c.series.label;$("#tooltip").remove();a=c.datapoint[1];b=c.series.color;var d=new Date(c.datapoint[0]),d=monthNames[d.getMonth()]+" "+d.getDate(),e="";"Charge"==c.series.label?e="$":"Refund"==c.series.label?e="$":"Chargeback"==c.series.label?e="$":"Signup"==c.series.label&&(e="signup(s)");showTooltip(c.pageX,c.pageY,b,"<strong>"+
c.series.label+"</strong><br>"+d+" : <strong>"+("Signup"==c.series.label?"<strong>"+a+"</strong> "+e+"":"$<strong>"+a+"</strong>")+"")}}else $("#tooltip").remove(),previousPoint=null})};function showTooltip(a,b,c,d){$('<div id="tooltip">'+d+"</div>").css({position:"absolute",display:"none",top:b-40,left:a-120,border:"2px solid "+c,padding:"3px","font-size":"9px","border-radius":"5px","background-color":"#fff",opacity:0.9}).appendTo("body").fadeIn(200)}
ETM.BlockedAndFavoritedView=Backbone.View.extend({events:{},render:function(){this.$el.html(this.template());this.renderFoodLists();return this},renderFoodLists:function(){var a=this;$.when(ETM.blocked_foods_list.loadFoodInfoObjects(),ETM.favorite_foods_list.loadFoodInfoObjects()).done(function(){a.blocked_foods=new ETM.BlockedFoodListView({collection:ETM.blocked_foods_list,el:$(".blocked_foods",a.el)});a.favorite_foods=new ETM.SimpleFoodListView({collection:ETM.favorite_foods_list,el:$(".favorite_foods",
a.el)});a.blocked_foods.render();a.favorite_foods.render()})}});
ETM.CalendarCarouselItem=Backbone.View.extend({tagName:"li",className:"calendar_item",events:{click:"selectedDate"},selectedDate:function(){ETM.calendar_list.selected_date=this.date;ETM.calendar_view.loadAndRenderAppropriateView();ETM.calendar_view.calendar_carousel.selectActiveItem();ETM.calendar_view.calendar_carousel.render()},initialize:function(a){this.date=a.date;this.date_string=Helper.convertDateToString(a.date);this.listenToCalendar();this.listenToGenerator();if("object"===typeof this.model&&
this.model.attributes.currently_generating||"generating"===this.model)this.currently_generating=!0},listenToCalendar:function(){var a=this;this.listenTo(ETM.calendar_list,this.date_string,function(b){a.currently_generating=!1;if("object"===typeof b&&b.attributes.currently_generating||"generating"===b)a.currently_generating=!0;a.model=b;a.render()})},listenToGenerator:function(){var a=this;this.listenTo(ETM.generator_status,"weeklyProgressUpdated",function(b){a.currently_generating&&("SUCCESS"===b?
($(".loading_percent",a.el).html("Finishing..."),a.currently_generating=!1):"ERROR"===b?($(".loading_percent",a.el).html(""),$(".generating_diet_preview",a.el).html(""),$(".loading_status",a.el).html("Error :(")):$(".loading_percent",a.el).html(ETM.generator_status.getCurrentProgressShort()))})},percentColors:[{pct:0,color:{r:211,g:211,b:211}},{pct:1,color:{r:30,g:144,b:255}}],getColorForPercentage:function(a){for(var b=1;b<this.percentColors.length-1&&!(a<this.percentColors[b].pct);b++);var c=this.percentColors[b-
1],b=this.percentColors[b];a=(a-c.pct)/(b.pct-c.pct);var d=1-a;return"rgb("+[Math.floor(c.color.r*d+b.color.r*a),Math.floor(c.color.g*d+b.color.g*a),Math.floor(c.color.b*d+b.color.b*a)].join()+")"},render:function(){var a=!1,b=moment().isSame(moment(this.date),"day"),c=!ETM.is_premium&&moment(this.date).isAfter(moment(),"day"),d=0,e=null,f=!0;if("object"===typeof this.model&&this.model.attributes.diet){var g=this.model.attributes.diet.attributes.num_meals;this.model.attributes.diet.attributes.meals.each(function(a,
b){b<g&&(a.attributes.eaten?d+=a.stats.calories:f=!1)});e=this.model.attributes.diet.attributes.nutrition_profile}this.currently_generating&&(a=ETM.generator_status.getCurrentProgressShort());this.$el.html(this.template({model:this.model,nutrition_profile:e,date:this.date_string,print_date_title:moment(this.date).format("dddd"),print_date_number:moment(this.date).format("D"),today:b,is_future_and_free:c,generator_progress:a,tracked_calories:roundNumber(d,0),fully_tracked:f}));"object"===typeof this.model&&
this.model.attributes.diet&&(f?$(".adherence_preview",this.el).css("color","DarkSeaGreen"):$(".adherence_preview",this.el).css("color",this.getColorForPercentage(d/e.attributes.calories,0)));return this}});moment.lang("en",{calendar:{lastDay:"[Yesterday]",sameDay:"[Today]",nextDay:"[Tomorrow]",lastWeek:" ",nextWeek:" ",sameElse:" "}});
ETM.CalendarCarousel=Backbone.View.extend({className:"date_carousel",initialize:function(){this.calendar_item_list=[];this.calendar_item_index={}},moveForward:function(a){for(var b=this.parent.collection.getCarouselDateList(),c=b[0],b=b[b.length-1],d=1;d<=a;d++){var e=addDays(b,d),f=addDays(c,d-1);this.addCarouselItem(e,"end");this.removeCarouselItem(f,"beginning")}},moveBack:function(a){for(var b=this.parent.collection.getCarouselDateList(),c=b[0],b=b[b.length-1],d=1;d<=a;d++){var e=addDays(c,-1*
d),f=addDays(b,-1*(d-1));this.addCarouselItem(e,"beginning");this.removeCarouselItem(f,"end")}},addCarouselItem:function(a,b){var c=this.parent.collection.getCalendarDiet(a),c=new ETM.CalendarCarouselItem({date:a,model:c});"beginning"===b?($(".calendar_list_elements",this.el).prepend(c.render().el),this.calendar_item_list.unshift(c)):($(".calendar_list_elements",this.el).append(c.render().el),this.calendar_item_list.push(c));this.calendar_item_index[Helper.convertDateToString(a)]=c},removeCarouselItem:function(a,
b){if("beginning"===b)var c=this.calendar_item_list.splice(0,1)[0];else"end"===b&&(c=this.calendar_item_list.pop());c.close();delete this.calendar_item_index[Helper.convertDateToString(a)]},selectActiveItem:function(){$(".active_date",this.el).removeClass("active_date");var a=Helper.convertDateToString(this.parent.collection.selected_date);$("."+a,this.el).parent().addClass("active_date")},updateCarousel:function(){for(var a=0;a<this.calendar_item_list.length;++a)this.calendar_item_list[a].render()},
renderCarouselDay:function(a){for(var b,c=0;c<this.calendar_item_list.length;++c){var d=this.calendar_item_list[c];if(d.date_string===a){b=d;break}}b&&b.render()},updateCarouselDay:function(a,b){for(var c,d=0;d<this.calendar_item_list.length;++d){var e=this.calendar_item_list[d];if(e.date_string===a){c=e;break}}c&&(c.model=b,c.render())},render:function(){var a=this;this.$el.html(this.template());var b=this.parent.collection.getCarouselDateList();0<this.calendar_item_list.length&&(_.each(this.calendar_item_list,
function(a){a.undelegateEvents();a.close()}),this.calendar_item_list=[],this.parent.collection.getDietsFromStartAndEndDate(b[0],b[b.length-1]));_.each(b,function(b){a.addCarouselItem(b,"end")});this.selectActiveItem();return this}});function addDays(a,b){var c=new Date(a.valueOf());c.setDate(c.getDate()+b);return c}ETM.BlankCarouselItem=Backbone.View.extend({tagName:"li",className:"blank_calendar_item"});
ETM.DietPlanSetCarouselItem=Backbone.View.extend({tagName:"li",className:"calendar_item",events:{click:"selectPlan"},selectPlan:function(){ETM.diet_plan_set.selected_plan!==this.plan_id&&(ETM.diet_plan_set.selected_plan=this.plan_id,ETM.diet_plan_set_view.loadAndRenderAppropriateView(),ETM.diet_plan_set_view.calendar_carousel.render())},initialize:function(a){this.plan_id=a.plan_id;this.plan_index=a.plan_index},render:function(){var a=null;"object"===typeof this.model&&(a=this.model.attributes.nutrition_profile);
this.$el.html(this.template({model:this.model,nutrition_profile:a,plan_index:this.plan_index,plan_id:this.plan_id}));return this}});
ETM.DietPlanSetCarousel=Backbone.View.extend({events:{"click .next_date_button":"loadNextDate","click .previous_date_button":"loadPreviousDate"},buffer_range:7,selected_index:3,initialize:function(a){this.diet_plan_item_list=[];this.diet_plan_item_index={}},loadNextDate:function(){var a=this.parent.model.getSelectedDietIndex();a+1<this.parent.model.attributes.diets.length&&(this.parent.model.selected_plan=this.parent.model.attributes.diets.at(a+1).get("id"),this.parent.loadAndRenderAppropriateView(),
this.render())},loadPreviousDate:function(){var a=this.parent.model.getSelectedDietIndex();0<a&&(this.parent.model.selected_plan=this.parent.model.attributes.diets.at(a-1).get("id"),this.parent.loadAndRenderAppropriateView(),this.render())},printPlanHeader:function(){var a=this.parent.model.get("title"),b=this.parent.model.getIndexFromID(this.parent.model.selected_plan),c=this.parent.model.attributes.diets.length;$(".selected_plan_label",this.el).html("Day "+(b+1)+" of "+c+", "+a);$(".selected_plan_title",
this.el).html(a)},addCarouselItem:function(a){var b=this.parent.model.attributes.diets.at(a);a=new ETM.DietPlanSetCarouselItem({plan_id:b.attributes.id,plan_index:a,model:b});$(".calendar_list_elements",this.el).append(a.render().el);this.diet_plan_item_list.push(a);this.diet_plan_item_index[b.attributes.id]=a},addBlankCarouselItem:function(){var a=new ETM.BlankCarouselItem;$(".calendar_list_elements",this.el).append(a.render().el)},selectActiveItem:function(){$(".active_date",this.el).removeClass("active_date");
$("."+this.parent.model.selected_plan,this.el).parent().addClass("active_date")},updateCarousel:function(){for(var a=0;a<this.diet_plan_item_list.length;++a)this.diet_plan_item_list[a].render()},renderCarouselDay:function(a){for(var b,c=0;c<this.diet_plan_item_list.length;++c){var d=this.diet_plan_item_list[c];if(d.date_string===a){b=d;break}}b&&b.render()},updateCarouselDay:function(a,b){for(var c,d=0;d<this.diet_plan_item_list.length;++d){var e=this.diet_plan_item_list[d];if(e.date_string===a){c=
e;break}}c&&(c.model=b,c.render())},render:function(){this.$el.html(this.template());0<this.diet_plan_item_list.length&&this.clearDietPlanItemList();for(var a=this.buffer_range-this.selected_index-1,b=this.parent.model.getIndexFromID(this.parent.model.selected_plan),c=b+a,a=b-a;a<=c;a++)0>a?this.addBlankCarouselItem():a>this.parent.model.attributes.diets.length-1?this.addBlankCarouselItem():this.addCarouselItem(a);this.selectActiveItem();this.printPlanHeader();return this},clearDietPlanItemList:function(){_.each(this.diet_plan_item_list,
function(a){a.undelegateEvents();a.close()});this.diet_plan_item_list=[]}});
ETM.CalendarView=Backbone.View.extend({events:{"click .next_date_button":"loadNextDate","click .previous_date_button":"loadPreviousDate","click .regenerate_weeks_meals_btn":"openRegenerateWeekModal","click .premium_intro":function(){ETM.router.startWalkthrough(ETM.premium_intro)},"click .free_overview":function(){ETM.router.startWalkthrough(ETM.free_overview)},"click .close-show-walkthrough":function(){$(".walkthrough-prompt").remove();ETM.current_user_profile.save({show_walkthrough_prompt:!1},{patch:!0})},
"click .switchToWeeklyPlanner":function(){ETM.router.navigate("settings/weekly-planner-layout/",{trigger:!0})},"click .close-weekly-layout-changes":function(a){this.weekly_layout_changes_hidden=!0},"click .hide-weekly-layout-changes":function(a){ETM.local_variables.addHiddenApplyChangesDate(this.collection.selected_date);this.toggleWeeklyLayoutAlert()},"click .apply-weekly-layout-changes":function(a){a.preventDefault();amplitude.logEvent("planner_update_weekly_layout");Helper.updateTemplateFromDiet(this.collection.selected_date.getDay(),
ETM.current_diet);this.toggleWeeklyLayoutAlert()},"click .calendar_today_button":function(a){a.preventDefault();ETM.calendar_list.selected_date=new Date;this.calendar_carousel.render();this.calendar_carousel.selectActiveItem();this.loadAndRenderAppropriateView()},"click .link_to_share":function(){ETM.router.navigate("settings/invite-friends/",{trigger:!0})},"click .hide_invite_notification":function(){this.show_invite_notification=!1}},initializeEvents:function(){this.listenTo(ETM.generator_status,
"updateCarousel",function(){this.calendar_carousel.updateCarousel()},this);this.listenTo(this,"meal_eaten_update",function(){this.calendar_carousel.renderCarouselDay(Helper.convertDateToString(ETM.calendar_list.selected_date))},this)},initialize:function(){this.show_invite_notification=!0;ETM.is_premium&&(ETM.current_user_profile.attributes.currently_generating&&(ETM.StatusTracker.init(),this.collection.listenToWeeklyPlannerComplete()),ETM.email_plans_modal||(ETM.email_plans_modal=new ETM.EmailPlansModalView,
$("#email_plans_modal").html(ETM.email_plans_modal.render().el)));this.weekly_layout_changes_hidden=!1},openRegenerateWeekModal:function(){amplitude.logEvent("regenerate_week_planner_modal");this.regenerate_week_modal||(this.regenerate_week_modal=new ETM.RegenerateWeekModalView,$("#regenerate_week_modal",ETM.$modal_content).html(this.regenerate_week_modal.render().el));this.regenerate_week_modal.$el.modal("show");this.regenerate_week_modal.delegateEvents();this.regenerate_week_modal.checkPantryStatus()},
loadNextDate:function(){this.calendar_carousel.moveForward(1);this.collection.selected_date=addDays(this.collection.selected_date,1);this.loadAndRenderAppropriateView();this.calendar_carousel.selectActiveItem()},loadPreviousDate:function(){this.calendar_carousel.moveBack(1);this.collection.selected_date=addDays(this.collection.selected_date,-1);this.loadAndRenderAppropriateView();this.calendar_carousel.selectActiveItem()},openDatePicker:function(){},printDate:function(){$(".date_label",this.el).html(moment(this.collection.selected_date).format("MMMM Do, YYYY"));
$(".weekday_plan_title",this.el).html(moment(this.collection.selected_date).format("dddd")+"'s meal plan")},render:function(){this.$el.html(this.template({current_weekday:getWeekday(this.collection.selected_date.getDay()),email_weekday:getWeekday(ETM.current_user_profile.attributes.shopping_day-1),show_walkthrough:ETM.current_user_profile.attributes.show_walkthrough_prompt,show_invite_notification:this.show_invite_notification}));return this},loadAndRenderAppropriateView:function(){this.printDate();
var a=this.collection.getCurrentDiet();Helper.convertDateToString(this.collection.selected_date);!ETM.is_premium&&moment(this.collection.selected_date).isAfter(moment(),"day")?(ETM.current_diet=null,this.renderLockedPremiumView()):"generating"===a||"object"===typeof a&&a.attributes.currently_generating?(ETM.current_diet=null,this.renderGeneratingView()):"blank"===a||"object"===typeof a&&null==a.attributes.diet?(ETM.current_diet=null,this.renderNoDietView()):"object"===typeof a&&(a.attributes.diet.calculateStats(),
ETM.current_diet=a.get("diet"),this.renderDayView(a),0==a.attributes.diet.stats.calories&&this.single_day_view.showMealsAndStats())},updateWeeklyLayoutAlert:function(){if(ETM.is_premium){var a=ETM.current_diet,b=this.collection.selected_date.getDay(),b=ETM.template_diet_list.getTemplateDietAtIndex(b).attributes.diet,c=[];if(null!=a&&null!=b){a.getNumberOfActiveMeals()!=b.getNumberOfActiveMeals()&&c.push("\u2022 your number of meals");a.attributes.nutrition_profile.id!=b.attributes.nutrition_profile.id&&
c.push("\u2022 your nutrition profile");for(var d=0;d<a.getNumberOfActiveMeals()&&d<b.getNumberOfActiveMeals();d++){var e=a.attributes.meals.at(d),f=b.attributes.meals.at(d);e.attributes.meal_type.id!=f.attributes.meal_type.id&&c.push("\u2022 your meal type for meal "+(d+1))}}this.toggleWeeklyLayoutAlert(c)}},toggleWeeklyLayoutAlert:function(a){var b=ETM.notifications.model.isApplyChangesHiddenForDate(this.collection.selected_date);if(null!=a&&0<a.length&&!this.weekly_layout_changes_hidden&&!b){var b=
ETM.loadTemplate("#CalendarUpdateWeeklyLayoutAlertTemplate"),c="this change",d="does";1<a.length&&(c="these changes",d="do");var e;e=ETM.current_user_profile.attributes.single_template_diet?"this day":moment(this.collection.selected_date).format("dddd");$(".updateWeeklyLayoutAlert",this.el).html(b({change_text:a.join("<br/>"),num_changes_text:c,do_does_text:d,day_of_week:e}));$(".updateWeeklyLayoutAlert",this.el).show()}else $(".updateWeeklyLayoutAlert",this.el).hide()},renderDayView:function(a){Helper.lockPageHeight();
this.removeOldViews();this.single_day_view=new ETM.SingleDayView({model:a.get("diet")});$(".single_day_view",this.el).html(this.single_day_view.render(!0).el);this.single_day_view.printGraph();var b=parseInt(UrlFunctions.getUrlParameter("food_id"));b&&(this.single_day_view.highlightFoods(b),window.history.replaceState&&window.history.replaceState(null,document.title,"/"));this.applyDietListeners(a);Helper.unlockPageHeight();this.updateWeeklyLayoutAlert()},applyDietListeners:function(a){var b=this;
this.listenTo(this.single_day_view.plan_header_view,"dietLoad",function(c){a.save({diet:c});b.updateWeeklyLayoutAlert();b.applyDietListeners(a);this.calendar_carousel.updateCarousel()});this.listenTo(a.get("diet"),"switchedNutritionProfiles",function(){b.updateWeeklyLayoutAlert()},this);this.listenTo(a.get("diet"),"change:num_meals",function(){b.updateWeeklyLayoutAlert()},this);a.get("diet").get("meals").forEach(function(a){b.listenTo(a,"switchedMealTypes",function(){b.updateWeeklyLayoutAlert()},
this)});this.listenTo(a.get("diet"),"change:nutrition_profile nutritionProfileUpdated",function(){this.calendar_carousel.updateCarousel()},this);this.listenTo(a.get("diet"),"updateStats finishedGenerating",function(){this.calendar_carousel.renderCarouselDay(a.get("date"))},this);this.listenTo(a.get("diet"),"deleteCalendarDiet",function(){Helper.lockPageHeight();delete ETM.calendar_list.date_index[a.attributes.date];a.destroy();ETM.current_diet=null;this.renderNoDietView();this.no_diet_view.trigger("updateCarousel",
"blank");Helper.unlockPageHeight()},this)},renderNoDietView:function(){this.removeOldViews();this.no_diet_view=new ETM.NoDietView({parent:this});this.listenTo(this.no_diet_view,"updateCarousel",function(a){this.calendar_carousel.updateCarouselDay(Helper.convertDateToString(ETM.calendar_list.selected_date),a)},this);$(".single_day_view",this.el).html(this.no_diet_view.render().el);this.no_diet_view.delegateEvents();this.updateWeeklyLayoutAlert()},renderLockedPremiumView:function(){this.removeOldViews();
this.locked_date_view=new ETM.LockedPremiumDayView({parent:this});this.listenTo(this.locked_date_view,"updateCarousel",function(a){this.calendar_carousel.updateCarouselDay(Helper.convertDateToString(ETM.calendar_list.selected_date),a)},this);$(".single_day_view",this.el).html(this.locked_date_view.render().el);this.locked_date_view.delegateEvents();this.updateWeeklyLayoutAlert()},renderGeneratingView:function(){this.removeOldViews();this.generating_view=new ETM.GeneratingDietView({parent:this});this.listenTo(this.generating_view,
"updateCarousel",function(a){this.calendar_carousel.updateCarouselDay(Helper.convertDateToString(ETM.calendar_list.selected_date),a)},this);$(".single_day_view",this.el).html(this.generating_view.render().el);this.generating_view.delegateEvents();this.updateWeeklyLayoutAlert()},renderWeekOverview:function(){this.calendar_carousel||(this.calendar_carousel=new ETM.CalendarCarousel,this.calendar_carousel.parent=this);$(".calendar_carousel",this.el).html(this.calendar_carousel.render().el);this.calendar_carousel.delegateEvents()},
removeOldViews:function(){this.stopListening();this.initializeEvents();this.no_diet_view&&(this.no_diet_view.close(),this.no_diet_view=null);this.generating_view&&(this.generating_view.close(),this.generating_view=null);this.single_day_view&&(this.single_day_view.close(),this.single_day_view=null)}});
ETM.DietPlanSetView=Backbone.View.extend({events:{"click .premium_intro":function(){ETM.router.startWalkthrough(ETM.premium_intro)},"click .free_overview":function(){ETM.router.startWalkthrough(ETM.free_overview)},"click .share_diet_set_btn":"openShareModal","click .import_diet_set_btn":"openImportModal"},initializeEvents:function(){this.listenTo(ETM.generator_status,"updateCarousel",function(){this.calendar_carousel&&this.calendar_carousel.updateCarousel()},this)},initialize:function(){ETM.is_premium&&
(ETM.email_plan_set_modal?ETM.email_plan_set_modal.diet_set_id=this.model.attributes.id:ETM.email_plan_set_modal=new ETM.EmailPlanSetModalView({diet_set_id:this.model.attributes.id}));this.checkIfUserIsOwner()},checkIfUserIsOwner:function(){this.user_is_owner=this.model.attributes.diet_set_owner_username===ETM.current_user_profile.attributes.username},openImportModal:function(){this.import_diet_set_modal||(this.import_diet_set_modal=ETM.is_premium?new ETM.ImportDietSetModalView({model:this.model}):
new ETM.ImportSingleDietModalView({model:this.model}),$("#import_diet_set_modal",ETM.$modal_content).html(this.import_diet_set_modal.render().el));this.import_diet_set_modal.$el.modal("show");this.import_diet_set_modal.delegateEvents();ETM.is_premium||this.import_diet_set_modal.selectCurrentDiet()},openShareModal:function(){this.share_diet_set_modal||(this.share_diet_set_modal=new ETM.ShareDietModalView({model:this.model}));$("#share_diet_set_modal",ETM.$modal_content).html(this.share_diet_set_modal.render().el);
this.share_diet_set_modal.$el.modal("show");this.share_diet_set_modal.delegateEvents()},render:function(){this.$el.html(this.template({user_is_owner:this.user_is_owner,model:this.model}));return this},printPlanTitle:function(){$(".selected_plan_title",this.el).html("Day "+(this.model.getSelectedDietIndex()+1)+" meal plan")},loadAndRenderAppropriateView:function(){var a=this.model.getSelectedDiet();"blank"===a||"object"===typeof a&&null==a?(ETM.current_diet=null,this.renderNoDietView()):"object"===
typeof a&&(a.calculateStats(),ETM.current_diet=a,this.renderDayView(a),0==a.stats.calories&&this.single_day_view.showMealsAndStats());this.printPlanTitle()},renderDayView:function(a){Helper.lockPageHeight();this.removeOldViews();this.single_day_view=this.user_is_owner?new ETM.SingleDayView({model:a}):new ETM.ReadOnlySingleDayView({model:a});$(".single_day_view",this.el).html(this.single_day_view.render(!0).el);this.single_day_view.printGraph();this.applyDietListeners(a);Helper.unlockPageHeight()},
applyDietListeners:function(a){this.listenTo(a,"change:nutrition_profile nutritionProfileUpdated",function(){this.calendar_carousel&&this.calendar_carousel.updateCarousel()},this);this.listenTo(a,"change:num_meals",function(){this.calendar_carousel&&this.calendar_carousel.updateCarousel()},this);this.listenTo(a,"updateStats finishedGenerating",function(){this.calendar_carousel&&this.calendar_carousel.updateCarousel()},this);this.listenTo(a,"deleteDietFromSet",function(){Helper.lockPageHeight();var b=
ETM.diet_plan_set.getSelectedDietIndex();a.destroy();ETM.diet_plan_set.setSelectedDietByIndex(b);this.loadAndRenderAppropriateView();this.calendar_carousel.render();Helper.unlockPageHeight()},this)},renderNoDietView:function(){this.removeOldViews();this.no_diet_view=new ETM.NoDietView({parent:this});this.listenTo(this.no_diet_view,"updateCarousel",function(a){this.calendar_carousel.updateCarouselDay(Helper.convertDateToString(ETM.calendar_list.selected_date),a)},this);$(".single_day_view",this.el).html(this.no_diet_view.render().el);
this.no_diet_view.delegateEvents();this.updateWeeklyLayoutAlert()},renderWeekOverview:function(){1>=this.model.attributes.num_diets||(this.calendar_carousel||(this.calendar_carousel=new ETM.DietPlanSetCarousel,this.calendar_carousel.parent=this),$(".calendar_navigation_box",this.el).html(this.calendar_carousel.render().el),this.calendar_carousel.delegateEvents())},removeOldViews:function(){this.stopListening();this.initializeEvents();this.no_diet_view&&(this.no_diet_view.close(),this.no_diet_view=
null);this.generating_view&&(this.generating_view.close(),this.generating_view=null);this.single_day_view&&(this.single_day_view.close(),this.single_day_view=null)}});ETM.ShareDietModalView=ModalView.extend({className:"modal fade",events:{"click .copy_permalink":function(){Helper.copyPermalink($(".share_diet_permalink",this.el))}},render:function(){this.$el.html(this.template({model:this.model}));return this}});
ETM.ImportDietSetModalView=ModalView.extend({className:"modal fade",events:{"click .import_diet_set":"importDietSet","click .view_saved_plans":"viewSavedPlans"},render:function(){this.$el.html(this.template({model:this.model}));return this},importDietSet:function(){var a=this,b=$("#diet_title",this.el).val().trim();if(!b||/^\s*$/.test(b))b=this.model.attributes.title;b={diet_set_id:this.model.attributes.id,title:b};$(".ajax_progress",this.el).show();$(".footer_buttons",this.el).hide();$(".ajax_failure",
this.el).hide();$.post("/weeklyplanner/import-diet-set/",b,function(b){var d=[ETM.nutrition_profile_list.fetch(),ETM.meal_type_list.fetch()];$.when.all(d).then(function(d){d=JSON.parse(b);ETM.diet_set_list.add(d);$(".ajax_progress",a.el).hide();$(".ajax_success",a.el).show()})})},viewSavedPlans:function(){this.$el.modal("hide");ETM.router.navigate("settings/saved-plans/",{trigger:!0})}});
ETM.ImportSingleDietModalView=ModalView.extend({className:"modal fade",events:{"click .import_diet_set":"importSingleDietFromSet","click .view_saved_plans":"viewSavedPlans"},render:function(){this.$el.html(this.template({model:this.model}));return this},selectDietAtIndex:function(a){$(".select_diet_from_set",this.el).val(ETM.diet_plan_set.attributes.diets.at(a).get("id"))},selectCurrentDiet:function(){$(".select_diet_from_set",this.el).val(ETM.diet_plan_set.selected_plan.toString())},importSingleDietFromSet:function(){var a=
this,b=parseInt($(".select_diet_from_set",this.el).val()),c=$("#diet_title",this.el).val().trim();if(!c||/^\s*$/.test(c))c=this.model.attributes.title;var d=ETM.diet_plan_set.getIndexFromID(b),b={selected_diet_id:b,title:c,description:"Day "+(d+1)+" plan from "+this.model.attributes.title};$(".ajax_progress",this.el).show();$(".footer_buttons",this.el).hide();$(".ajax_failure",this.el).hide();$.post("/weeklyplanner/import-diet-from-set/",b,function(b){var c=[ETM.nutrition_profile_list.fetch(),ETM.meal_type_list.fetch()];
$.when.all(c).then(function(c){c=JSON.parse(b);ETM.diet_set_list.add(c);$(".ajax_progress",a.el).hide();$(".ajax_success",a.el).show()})})},viewSavedPlans:function(){this.$el.modal("hide");ETM.router.navigate("settings/saved-plans/",{trigger:!0})}});
ETM.GeneratingDietView=Backbone.View.extend({events:{},initialize:function(a){this.parent=a.parent;this.listenTo(ETM.generator_status,"weeklyProgressUpdated",function(a){"SUCCESS"===a?$(".loading_percent",this.el).html("Finishing..."):"ERROR"===a?($(".diet_currently_generating h4",this.el).html('Uh oh, something went wrong generating.  <button class="regenerate_weeks_meals_btn btn btn-default" style="float:none">Retry<span class="glyphicon glyphicon-random"></span></button>'),$(".loading_percent",
this.el).html(""),$(".loading_status",this.el).html("")):$(".loading_percent",this.el).html(ETM.generator_status.getCurrentProgress())},this)},render:function(){this.$el.html(this.template({generator_progress:ETM.generator_status.getCurrentProgress()}));return this}});
ETM.NoDietView=Backbone.View.extend({events:{"click .load_saved_plan":"loadSavedDiet","click .load_template_plan":"loadFromTemplate","click .load_previous_plan":"loadPreviousPlan","click .load_previous_blank_plan":"loadPreviousBlankPlan"},initialize:function(a){this.parent=a.parent;this.listening_for_load=!1;this.temp_calendar_event=new ETM.CalendarDiet({date:this.parent.collection.selected_date,diet:ETM.current_diet})},loadSavedDiet:function(){ETM.load_plans_modal||(ETM.load_plans_modal=new ETM.LoadPlansModalView);
$("#load_plans_modal").html(ETM.load_plans_modal.render().el);ETM.load_plans_modal.showLoadDates();ETM.load_plans_modal.delegateEvents();ETM.load_plans_modal.$el.modal("show");googleanalytics("send","event","button","click","load_diet");amplitude.logEvent("load_diet")},loadDiet:function(a){var b=ETM.calendar_list.findWhere({date:Helper.convertDateToString(ETM.calendar_list.selected_date)});null==b&&(b=new ETM.CalendarDiet);b.attributes.diet=a;b.attributes.date=Helper.convertDateToString(ETM.calendar_list.selected_date);
b.save(null,{async:!1});ETM.current_diet=b.attributes.diet;ETM.calendar_list.date_index[Helper.convertDateToString(ETM.calendar_list.selected_date)]=b;ETM.diet_list.add(b.attributes.diet);this.trigger("updateCarousel",b);_errs.meta.loaded_diet_np=JSON.stringify(a.attributes.nutrition_profile);_errs.meta.loaded_diet_np_null=null==a.attributes.nutrition_profile;ETM.calendar_view.renderDayView(b)},loadFromTemplate:function(){var a=ETM.template_diet_list.getTemplateDietAtIndex(this.parent.collection.selected_date.getDay()).attributes.diet.clone();
Helper.clearIDs(a);a.attributes.meals.each(function(a){Helper.clearIDs(a)});this.loadDiet(a);this.parent.single_day_view.showMealsAndStats()},loadPreviousPlan:function(){this.loadPreviousDiet(!1)},loadPreviousBlankPlan:function(){this.loadPreviousDiet(!0)},loadPreviousDiet:function(a){var b=this;$.get("/cal/previous-diet/"+Helper.convertDateToString(ETM.calendar_list.selected_date)+"/",function(c){"No calendar diet"==c?b.loadDiet(new ETM.Diet):(c=new ETM.Diet(JSON.parse(c)),Helper.clearIDs(c),c.attributes.meals.each(function(b){Helper.clearIDs(b);
a?(b.attributes.foods.reset([]),b.attributes.eaten=!1):(b.attributes.eaten=!1,b.attributes.foods.each(function(a){Helper.clearIDs(a);a.attributes.is_leftovers=!1;a.attributes.has_leftovers=!1;a.attributes.leftovers_from=null;a.attributes.makes_leftovers_for.reset([])}))}),b.loadDiet(c));b.parent.single_day_view.showMealsAndStats()})},render:function(){this.$el.html(this.template({current_weekday:getWeekday(this.parent.collection.selected_date.getDay()),email_weekday:getWeekday(ETM.current_user_profile.attributes.shopping_day-
1)}));return this}});ETM.LockedPremiumDayView=Backbone.View.extend({events:{},initialize:function(a){this.parent=a.parent;this.listening_for_load=!1;this.temp_calendar_event=new ETM.CalendarDiet({date:this.parent.collection.selected_date,diet:ETM.current_diet})},render:function(){this.$el.html(this.template());return this}});function getWeekday(a){-1===a&&(a=6);return"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" ")[a]}
function getTemplateWeekday(a){return"Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" ")[a]}
ETM.CustomFoodFormView=ModalView.extend({className:"modal fade",id:"custom_food_modal",events:{"click .show_optional_fields":"showCustomFields","click .show_optional_sugars":"showSugarFields","click .show_optional_fats":"showFatFields","click #save_custom_food":"saveFood",'change input[name="carbs"]':"inputChanged",'change input[name="fats"]':"inputChanged",'change input[name="proteins"]':"inputChanged",'blur input[name="calories"]':"formCaloriesChanged","keyup .percent_rda_input input":"rdaValueChanged",
"keyup #optional_custom_fields .custom_value":"micronutrientChanged","click .resetMacros":function(a){a.preventDefault();this.carbs=this.fats=this.proteins=null;this.macro_calories=this.form_calories;a=this.form_calories/3-4*this.proteins-9*this.fats;var b=this.form_calories/3-4*this.proteins-4*this.carbs;this.updateInputs(a,b);this.updateSlider(a,b);this.compareCaloriesAndMacros()},"click .resetCalories":function(a){a.preventDefault();this.form_calories=this.macro_calories;$("#calories",this.el).val(this.form_calories);
this.compareCaloriesAndMacros()},"click .i_dont_care":function(a){a.preventDefault();this.ignore_macro_calorie_difference=!0;this.compareCaloriesAndMacros()},"change #restaurant_name":function(a){this.restaurant_enabled&&0==$("#description",this.el).val().toLowerCase().indexOf("ate out")&&$("#description",this.el).val("Ate out at "+$(a.currentTarget).val())}},initialize:function(){this.ignore_macro_calorie_difference=this.restaurant_enabled=!1;this.food_id=null},render:function(){this.carbs=this.fats=
this.proteins=this.form_calories=this.macro_calories=null;this.$el.html(this.template());this.$el.modal({show:!1});this.renderForm();this.renderSliders();this.toggleInputsAndSliders();this.toggleTooltips();return this},toggleTooltips:function(){$(".grams_per_serving_tooltip",this.el).tooltip({title:"<div class='text-left'>Enter the gram weight of a serving of the actual food. This will let you convert between grams and servings.<br/><br/>Conversions:<br/>1 oz = 28.35 g<br/>1 lb = 453.6 g<br/>1 tbsp = 15 g (liquid)<br/>1 tsp = 5 g (liquid)</div>",
html:!0,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div style="margin-left:-20px;margin-right:-20px;" class="tooltip-inner"></div></div>',animation:!0,placement:"top",delay:{show:100,hide:0}})},showCustomFields:function(){$("#optional_custom_fields",this.el).slideToggle(200)},showSugarFields:function(){console.log("show sugar fields!");$("#optional_sugar_fields",this.el).slideToggle(200)},showFatFields:function(){console.log("show fat fields!");$("#optional_fat_fields",
this.el).slideToggle(200)},loadFood:function(a){var b="calcium choline copper fiber folate iron magnesium manganese niacin phosphorus riboflavin selenium sodium thiamine vit_a vit_b6 vit_b12 vit_c vit_d vit_e vit_k zinc".split(" ");this.food_id=a.attributes.id;$("#gram_weight_1_amount",this.el).val(a.attributes.weights[1].amount);$("#gram_weight_1_description",this.el).val(a.attributes.weights[1].description);a.attributes.accurate_grams&&$("#gram_weight_1",this.el).val(a.attributes.weights[1].grams);
$("#food_name",this.el).val(a.attributes.food_name);$("#description",this.el).val(a.attributes.description);var c=a.attributes.weights[1].grams/100;for(key in a.attributes.nutrition)if(_.has(a.attributes.nutrition,key)&&null!=a.attributes.nutrition[key]){var d=roundNumber(a.attributes.nutrition[key]*c,2);$("#"+key,this.el).val(d);-1!==b.indexOf(key)&&(0<d?(d=roundNumber(100*(d/nutrient_dictionary[key].daily_value),1),$("#"+key+"-rda",this.el).val(d)):0===d?$("#"+key+"-rda",this.el).val(0):$("#"+key+
"-rda",this.el).val(""))}100<=a.attributes.food_group&&$("#food_group",this.el).val(a.attributes.food_group.toString());is_staff&&(!0==a.attributes.curated&&$("#yes_curated",this.el).prop("checked",!0),$("#model",this.el).val(a.attributes.model))},renderForm:function(){this.form=(new Backbone.Form({schema:{restaurant_name:{type:"Text"},food_name:{type:"Text",editorAttrs:{maxlength:100},validators:["required"]},description:{type:"Text",editorAttrs:{maxlength:400}},calories:{type:"Text",validators:["required"]},
proteins:{type:"Text",validators:["required"]},fats:{type:"Text",validators:["required"]},carbs:{type:"Text",validators:["required"]}},data:{description:this.restaurant_enabled?"Ate out":""},templateData:{restaurant:this.restaurant_enabled,is_staff:is_staff},template:ETM.loadNestedTemplate("#CustomFoodFormTemplate",".custom_food_form_template")})).render();$(".ate_out_form",this.el).html(this.form.el)},renderSliders:function(){var a=this;this.slider=$(".3_way_macro_slider",this.el);this.slider.slider({range:!0,
min:0,max:this.macro_calories,step:0.01,values:[0,0],slide:function(b,c){a.updateInputs(c.values[0],c.values[1]-c.values[0])}});this.slider.css("background-color","#ff9000");$(".ui-widget-header",this.el).css("background","none");$(".ui-slider-range",this.el).css("background-color","#3aae4e");this.slider.append('<div class="right_slider_third"></div>')},formCaloriesChanged:function(a){if((this.form_calories=parseInt($(a.currentTarget).val()))&&!this.macro_calories){this.macro_calories=this.form_calories;
a=this.form_calories/3-4*this.proteins-9*this.fats;var b=this.form_calories/3-4*this.proteins-4*this.carbs;this.updateInputs(a,b);this.updateSlider(a,b)}this.toggleInputsAndSliders();this.compareCaloriesAndMacros()},toggleInputsAndSliders:function(){if(this.form_calories||this.macro_calories)return this.slider.slider("enable"),!0;this.slider.slider("disable");return!1},compareCaloriesAndMacros:function(){if(0<=this.form_calories&&0<=this.macro_calories&&20<Math.abs(this.form_calories-this.macro_calories)&&
!this.ignore_macro_calorie_difference){var a=ETM.loadTemplate("#AteOutAlertTemplate"),b=$(".cal_macros_warning",this.el);b.html(a({form_calories:this.form_calories,macro_calories:this.macro_calories}));$(".calorie_warning_tooltip",b).tooltip({title:"<div class='text-left'>Our algorithms depend on the Calorie and macronutrient numbers lining up, with 4 Calories per gram carbs and protein, and 9 per gram fat.<br/><br/>You can either massage the food's numbers until they line up (food labels are often allowed a 20% margin of error on their numbers), or ignore this warning and risk slightly worse generator results if you use this in recipes or as a recurring food.</div>",
template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div style="margin-left:-20px;margin-right:-20px;" class="tooltip-inner"></div></div>',animation:!0,html:!0,placement:"top",delay:{show:100,hide:0}});b.show();return!1}$(".cal_macros_warning",this.el).hide();return!0},inputChanged:function(){var a=4*parseInt($('input[name="carbs"]',this.el).val()),b=9*parseInt($('input[name="fats"]',this.el).val()),c=4*parseInt($('input[name="proteins"]',this.el).val());this.macro_calories=
a+b+c;0<=a&&0<=b&&0<=c&&!this.form_calories&&(this.form_calories=this.macro_calories,$("#calories",this.el).val(this.form_calories));this.updateSlider(a,b);this.compareCaloriesAndMacros()},updateInputs:function(a,b){this.carbs=Math.round(a/4);this.fats=Math.round(b/9);this.proteins=Math.round((this.macro_calories-a-b)/4);$('input[name="carbs"]',this.el).val(this.carbs);$('input[name="fats"]',this.el).val(this.fats);$('input[name="proteins"]',this.el).val(this.proteins);$(".right_slider_third",this.el).css("width",
(100*(this.macro_calories-a-b)/this.macro_calories).toFixed(2)+"%")},updateSlider:function(a,b){this.slider.slider("option","values",[a,a+b]);this.slider.slider("option","max",this.macro_calories);$(".right_slider_third",this.el).css("width",(100*(this.macro_calories-a-b)/this.macro_calories).toFixed(2)+"%")},rdaValueChanged:function(a){var b=$(a.currentTarget).attr("id").split("-")[0];a=parseFloat($(a.currentTarget).val());0<a?(a=roundNumber(a/100*nutrient_dictionary[b].daily_value,2),$("#"+b,this.el).val(a)):
0===a?$("#"+b).val(0):$("#"+b,this.el).val("")},micronutrientChanged:function(a){var b=$(a.currentTarget).attr("name");-1!=="calcium choline copper fiber folate iron magnesium manganese niacin phosphorus riboflavin selenium sodium thiamine vit_a vit_b6 vit_b12 vit_c vit_d vit_e vit_k zinc".split(" ").indexOf(b)&&(a=parseFloat($(a.currentTarget).val()),0<a?(a=roundNumber(100*(a/nutrient_dictionary[b].daily_value),2),$("#"+b+"-rda",this.el).val(a)):0===a?$("#"+b+"-rda").val(0):$("#"+b+"-rda",this.el).val(""))},
saveFood:function(){$(".alert.alert-danger",this.el).remove();var a=this.form.validate();if(!this.compareCaloriesAndMacros()||"undefined"!==typeof a&&a)for(var b in a)$('[data-editors="'+b+'"]').append('<div class="alert alert-danger" style="float:left">'+a[b].message+"</div>");else{a=$(".custom_food_form",this.el).serializeObject();delete a.restaurant_name;a.food_group="null"!=a.food_group?parseInt(a.food_group):null;b=100;var c=parseFloat(a.gram_weight_1);!isNaN(c)&&0<c?(b=c,a.accurate_grams=!0):
a.accurate_grams=!1;a.weights=[{grams:100,amount:100,description:"grams"},{grams:b,amount:parseFloat(a.gram_weight_1_amount),description:a.gram_weight_1_description}];delete a.gram_weight_1;delete a.gram_weight_1_amount;delete a.gram_weight_1_description;a.nutrition={};b=100/b;for(c=0;c<ETM.NUTRIENT_LIST.length;c++){var d=ETM.NUTRIENT_LIST[c];"undefined"!==typeof a[d]&&0!==a[d].length&&(a.nutrition[d]=roundNumber(roundNumber(parseFloat(a[d]),2)*b,10));delete a[d]}a.id=this.food_id;if(null!=a.id){b=
this.model.get(ROOT+"/food/"+a.id+"/");try{b.save(a,{success:function(a){var b=ETM.food_info_object_list.get(a.id);b&&b.set(a.toJSON());(b=ETM.sidebar_view.custom_foods_view.collection.food_info_object_list.get(a.id))&&b.set(a.toJSON());ETM.sidebar_view.showCustomFoods()}})}catch(e){$.extend(_errs.meta,{food_save_resource_uri:ROOT+"/food/"+a.id+"/",collection_ids:this.model.modelIds().toString()});_errs.push(e);$(".custom_form_validation",this.el).append('<div class="alert alert-danger" style="float:left">Error saving custom food</div>');
return}}else b=this.model.create(a,{wait:!0,at:0,success:function(){ETM.sidebar_view.showCustomFoods()}});this.$el.modal("hide")}return!1}});ETM.AteOutFormView=ETM.CustomFoodFormView.extend({initialize:function(){this.restaurant_enabled=!0}});function getNodePosition(a){for(var b=left=0;a;)a.tagName?(b+=a.offsetTop,left+=a.offsetLeft,a=a.offsetParent):a=a.parentNode;return[b,left]}var previous_calories=0;
ETM.EditNutritionTargetsModalView=ModalView.extend({className:"macro_selection modal fade",id:"edit_nutrition_modal",events:{"click #nutrition_profile_save_changes":"saveChanges"},initialize:function(a,b){"undefined"!==typeof b&&(this.diet=b.diet)},render:function(){this.$el.html(this.template(this.model));this.$el.modal({show:!1});this.editNutrition=new ETM.EditNutritionTargetsView({model:this.model},{diet:this.diet});$(".modal-body",this.el).html(this.editNutrition.render().el);this.listenTo(this.editNutrition,
"openNutritionCalculator",this.openNutritionCalculator,this);this.listenTo(this.editNutrition,"switchedNutritionProfiles nutritionProfileUpdated",this.saveChangesComplete,this);return this},saveChanges:function(a){a&&a.preventDefault();this.editNutrition.saveChanges()},saveChangesComplete:function(){this.$el.modal("hide");this.diet.trigger("nutritionProfileUpdated")},openNutritionCalculator:function(){var a=this;this.$el.modal("hide");this.$el.one("hidden.bs.modal",function(){a.trigger("openNutritionCalculator")})},
updateNutritionTargets:function(){this.editNutrition.renderForm();this.editNutrition.renderSliders();this.editNutrition.toggleInputsAndSliders()}});
ETM.EditNutritionTargetsView=Backbone.View.extend({events:{"change .macro_scheme_radio":"changeMacroScheme","click #remove_nutrition_profile_delete":"removeDelete","click .cholesterol_check":"triggerCholesterolInput","click .sodium_check":"triggerSodiumInput","click #increase_macro_maximums":"increaseMacroMaximums","click #decrease_macro_minimums":"decreaseMacroMinimums","click #open_nutrition_calculator":"openNutritionCalculator","change #nutrition_profile_title input":"updateTitle","change #nutrition_profile_description input":"updateDescription",
"change #2nd_cal_input input":"caloriesChangedCheck","change #fats div input":"updateFats","change #carbs div input":"updateCarbs","change #proteins div input":"updateProteins","click .replace-button":function(a){var b=this;a.preventDefault();ETM.nutrition_profile_list.filter(function(a){return a.attributes.title===b.form.getValue().title&&!a.deleted&&(null==b.model.attributes.user_id||a.attributes.user_id==b.model.attributes.user_id)&&a.id!==b.model.id}).forEach(function(a){a.save({title:findNextAvailableTitle(ETM.nutrition_profile_list,
a.attributes.title)},{validate:!1})});$(".nutrition_profile_error",this.el).remove()}},initialize:function(a,b){"undefined"!==typeof b&&(this.diet=b.diet)},openNutritionCalculator:function(a){a.preventDefault();this.trigger("openNutritionCalculator")},caloriesChangedCheck:function(){var a=roundNumber(parseInt($("#2nd_cal_input input",this.el).val()),0),b=this.model.attributes.calories;a!=b&&(this.model.set("calories",a),this.changeCalories(a,b))},updateTitle:function(){var a=$("#nutrition_profile_title input",
this.el).val();a!=this.model.attributes.title&&this.model.set("title",a)},updateDescription:function(){var a=$("#nutrition_profile_description input",this.el).val();a!=this.model.attributes.description&&this.model.set("description",a)},removeDelete:function(a){a.preventDefault();this.model.attributes.deleted=!1;ETM.nutrition_profile_list.findWhere({id:this.model.attributes.id}).attributes.deleted=!1;this.model.save();this.toggleSaveButton()},toggleSaveButton:function(){this.model.attributes.deleted?
($("#nutrition_profile_save_changes",this.el).hide(),$("#deleted_nutrition_profile_warning",this.el).html("<div class='alert alert-danger'>This nutrition profile was previously deleted.<button class='btn btn-default' id='remove_nutrition_profile_delete'>Undo the delete</button></div>")):($("#deleted_nutrition_profile_warning",this.el).html(""),$("#nutrition_profile_save_changes",this.el).show())},increaseMacroMaximums:function(a){a.preventDefault();a=roundNumber(this.model.attributes.max_carbs,0);
for(var b=roundNumber(this.model.attributes.max_proteins,0),c=roundNumber(this.model.attributes.max_fats,0),d=4*a+9*c+4*b,e=roundNumber(this.model.attributes.calories,0),d=e-d;0<d;)a+1<=e/4&&(a+=1,d-=4),b+1<=e/4&&(b+=1,d-=4),c+1<=e/9&&(c+=1,d-=9);this.model.set({max_carbs:a,max_fats:c,max_proteins:b});this.renderMacroInputs();this.renderSliders()},decreaseMacroMinimums:function(a){a.preventDefault();a=roundNumber(this.model.attributes.min_carbs,0);for(var b=roundNumber(this.model.attributes.min_proteins,
0),c=roundNumber(this.model.attributes.min_fats,0),d=4*a+9*c+4*b,e=roundNumber(this.model.attributes.calories,0),d=d-e;0<d;)0<=a-1&&(a-=1,d-=4),0<=b-1&&(b-=1,d-=4),0<=c-1&&(c-=1,d-=9);this.model.set({min_carbs:a,min_proteins:b,min_fats:c});this.renderMacroInputs();this.renderSliders()},updateCarbs:function(){this.updateSliders(this.carbs_slider,this.min_carbs_input,this.max_carbs_input,"carbs")},updateFats:function(){this.updateSliders(this.fats_slider,this.min_fats_input,this.max_fats_input,"fats")},
updateProteins:function(){this.updateSliders(this.proteins_slider,this.min_proteins_input,this.max_proteins_input,"proteins")},render:function(){this.$el.html(this.template(this.model));this.renderForm();this.renderSliders();return this},renderForm:function(){this.form=(new Backbone.Form({model:this.model,template:Helper.createTemplateFunction($("#editNutritionFormTemplate",this.el).html())})).render();$("#editForm",this.el).html(this.form.el);this.min_carbs_input=$("#carbs .min_input input",this.el);
this.min_fats_input=$("#fats .min_input input",this.el);this.min_proteins_input=$("#proteins .min_input input",this.el);this.max_carbs_input=$("#carbs .max_input input",this.el);this.max_fats_input=$("#fats .max_input input",this.el);this.max_proteins_input=$("#proteins .max_input input",this.el);this.changeMacroScheme();this.triggerCholesterolInput();this.triggerSodiumInput();this.toggleSaveButton()},renderMacroInputs:function(){this.min_carbs_input.val(roundNumber(this.model.attributes.min_carbs,
0));this.min_fats_input.val(roundNumber(this.model.attributes.min_fats,0));this.min_proteins_input.val(roundNumber(this.model.attributes.min_proteins,0));this.max_carbs_input.val(roundNumber(this.model.attributes.max_carbs,0));this.max_fats_input.val(roundNumber(this.model.attributes.max_fats,0));this.max_proteins_input.val(roundNumber(this.model.attributes.max_proteins,0))},renderSliders:function(){var a=this;this.carbs_slider=$("#carbs_range .macro_slider",this.el);this.fats_slider=$("#fats_range .macro_slider",
this.el);this.proteins_slider=$("#proteins_range .macro_slider",this.el);this.max_carbs_bound=$(".max_carbs_bound",this.el);this.max_fats_bound=$(".max_fats_bound",this.el);this.max_proteins_bound=$(".max_proteins_bound",this.el);this.max_carbs_bound.text(roundNumber(this.model.attributes.calories/4,0));this.carbs_slider.slider({range:!0,min:0,max:roundNumber(this.model.attributes.calories/4,0),step:0.01,values:[this.model.attributes.min_carbs,this.model.attributes.max_carbs],slide:function(b,c){a.updateInputs(c.values,
a.min_carbs_input,a.max_carbs_input,"carbs")}});this.max_fats_bound.text(roundNumber(this.model.attributes.calories/9,0));this.fats_slider.slider({range:!0,min:0,max:roundNumber(this.model.attributes.calories/9,0),step:1,values:[this.model.attributes.min_fats,this.model.attributes.max_fats],slide:function(b,c){a.updateInputs(c.values,a.min_fats_input,a.max_fats_input,"fats")}});this.max_proteins_bound.text(roundNumber(this.model.attributes.calories/4,0));this.proteins_slider.slider({range:!0,min:0,
max:roundNumber(this.model.attributes.calories/4,0),step:1,values:[this.model.attributes.min_proteins,this.model.attributes.max_proteins],slide:function(b,c){a.updateInputs(c.values,a.min_proteins_input,a.max_proteins_input,"proteins")}});this.checkIfValidCalories()},toggleInputsAndSliders:function(){if(!this.model.attributes.calories||10>this.model.attributes.calories)return $(".macro_slider",this.el).slider("disable"),$(".min_input input",this.el).prop("disabled",!0),$(".max_input input",this.el).prop("disabled",
!0),!1;$(".macro_slider",this.el).slider("enable");$(".min_input input",this.el).prop("disabled",!1);$(".max_input input",this.el).prop("disabled",!1);return!0},checkIfValidCalories:function(){var a=4*roundNumber(this.model.attributes.min_carbs,0)+9*roundNumber(this.model.attributes.min_fats,0)+4*roundNumber(this.model.attributes.min_proteins,0),b=4*roundNumber(this.model.attributes.max_carbs,0)+9*roundNumber(this.model.attributes.max_fats,0)+4*roundNumber(this.model.attributes.max_proteins,0),c=
roundNumber(this.model.attributes.calories,0);if(a>c)return $(".min_macro_validation").show(),$(".min_macro_validation").html('<div class="alert alert-danger">The minimum possible calories from your macros <strong>('+a+")</strong> is greater than your desired calories <strong>("+c+')</strong>.<br/><strong>  Decrease some of your macro minimums or click the button.</strong>  <button class="btn btn-default" id="decrease_macro_minimums">Decrease macro minimums</button></div>'),!1;$(".min_macro_validation").hide();
if(b<c)return $(".max_macro_validation").show(),$(".max_macro_validation").html('<div class="alert alert-danger">The maximum possible calories from your macros <strong>('+b+")</strong> is smaller than your desired calories <strong>("+c+')</strong>.<strong>  Increase some of your macro maximums.</strong>  <button class="btn btn-default" id="increase_macro_maximums">Increase macro maximums</button></div>'),!1;$(".max_macro_validation").hide();return!0},updateInputs:function(a,b,c,d){var e=a[0];a=a[1];
e!=this.model.get("min_"+d)&&(b.val(roundNumber(e,0)),this.model.set("min_"+d,e),this.checkIfValidCalories());a!=this.model.get("max_"+d)&&(c.val(roundNumber(a,0)),this.model.set("max_"+d,a),this.checkIfValidCalories())},updateSliders:function(a,b,c,d){b=b.val();c=c.val();if(b!=this.model.get("min_"+d)||c!=this.model.get("max_"+d))a.slider("option","values",[b,c]),this.model.set("min_"+d,b),this.model.set("max_"+d,c),this.checkIfValidCalories()},changeCalories:function(a,b){this.toggleInputsAndSliders()&&
(this.model.scaleMacrosFromCalories(a,b),this.renderMacroInputs(),this.renderSliders())},changeMacroScheme:function(){"grams"==this.form.getValue().macro_scheme?($(".macro_ranges",this.el).show(),$(".macro_percents",this.el).hide()):($(".macro_ranges",this.el).hide(),$(".macro_percents",this.el).show())},triggerCholesterolInput:function(){$('[data-editors="watch_cholesterol"] input',this.el).is(":checked")?$('[data-editors="cholesterol"] input',this.el).removeAttr("disabled"):$('[data-editors="cholesterol"] input',
this.el).attr("disabled",!0)},triggerSodiumInput:function(){$('[data-editors="watch_sodium"] input',this.el).is(":checked")?$('[data-editors="sodium"] input',this.el).removeAttr("disabled"):$('[data-editors="sodium"] input',this.el).attr("disabled",!0)},saveChanges:function(){var a=this;$(".nutrition_profile_error",this.el).remove();var b=this.form.commit({validate:!0});"undefined"===typeof b&&this.checkIfValidCalories()?(b=!ETM.use_local_storage&&"undefined"===typeof this.model.attributes.id,null==
a.diet?this.model.save(null,{success:function(b,d){a.trigger("nutritionProfileUpdated")}}):b?this.model.save(null,{success:function(b,d){a.diet.attributes.nutrition_profile=a.model;ETM.nutrition_profile_list.add(a.model);a.diet.update_nutrition_profile=!0;a.diet.save(null,{patch:!0});delete a.diet.update_nutrition_profile;a.trigger("switchedNutritionProfiles")}}):a.diet.attributes.nutrition_profile.save(a.model.attributes,{success:function(b,d){a.trigger("nutritionProfileUpdated");a.diet.attributes.nutrition_profile.id!=
a.model.id&&(a.diet.attributes.nutrition_profile=a.model,a.diet.update_nutrition_profile=!0,a.diet.save(null,{patch:!0}),delete a.diet.update_nutrition_profile,a.trigger("switchedNutritionProfiles"))}})):a.renderErrors(b);return!1},renderErrors:function(a){for(var b in a)("macro_scheme"===b?$("#macro_scheme_errors"):$('[data-editors="'+b+'"]')).append('<div class="alert alert-danger nutrition_profile_error" style="float:left">'+a[b].message+"</div>"),$("fieldset",this.form.el).append('<div class="alert alert-danger nutrition_profile_error">'+
a[b].message+"</div>")}});
ETM.EmailPlansModalView=ModalView.extend({className:"modal fade",events:{"click .preview_plans_submit":"previewPlan","click .print_plans_submit":"printGroceries","click .download_pdf_submit":"downloadPlanPdf","click .email_plans_submit":"emailGroceries"},initialize:function(){this.end_date=this.start_date=0},getSavedPrintSettings:function(){var a=ETM.notifications.model.get("print_settings");"undefined"===typeof a&&(a={include_grocery_list:!0,include_meal_plans:!0,include_full_recipes:!0,print_format:"standard"});
return a},savePrintSettings:function(a){ETM.local_variables.save({print_settings:{include_grocery_list:a.include_grocery_list,include_meal_plans:a.include_meal_plans,include_full_recipes:a.include_full_recipes,print_format:a.print_format}})},render:function(){this.$el.html(this.template({start_date:this.start_date,end_date:this.end_date,print_settings:this.getSavedPrintSettings()}));this.initializeCalendar();this.applyTooltips();this.$el.modal({show:!1});this.applyCheckboxEvents();return this},applyTooltips:function(){$(".calendar_selector_tooltip",
this.el).tooltip({placement:"bottom",title:"Click below to open a calendar and then either click a single day or click two dates to form a range."})},initializeCalendar:function(){$(".date_range_selector",this.el).kalendae({mode:"range",months:2,useYearNav:!1})},setCalendarDate:function(a){$(".date_range_selector",this.el).data("kalendae").setSelected(getGrocerySyncDateString())},applyCheckboxEvents:function(){var a=this;$("#include_meal_plans",this.el).change(function(){$(this).is(":checked")?$("#include_full_recipes",
a.el).prop("disabled",!1):$("#include_full_recipes",a.el).prop("disabled",!0)})},previewPlan:function(){this.generatePlanSummary("preview")},printGroceries:function(){this.generatePlanSummary("print")},emailGroceries:function(){this.generatePlanSummary("email")},downloadPlanPdf:function(){var a=this,b=this.generatePostDict("pdf"),c;_.has(this,"diet_set_id")?(b.diet_set_id=this.diet_set_id,c="/print-email-diet-set/"):(b.date_range=$(".date_range_selector",this.el).data("kalendae").getSelected(),c=
"/print-email-groceries/");$(".print_email_progress",this.el).show();$(".email_footer_buttons",this.el).hide();$(".print_failure",this.el).hide();$(".preview_failure",this.el).hide();amplitude.logEvent("download_plan_pdf",b);var d=new XMLHttpRequest;d.open("POST",c,!0);d.responseType="blob";d.setRequestHeader("X-CSRFToken",function(a){var b=null;if(document.cookie&&""!=document.cookie)for(var c=document.cookie.split(";"),d=0;d<c.length;d++){var l=jQuery.trim(c[d]);if(l.substring(0,a.length+1)==a+
"="){b=decodeURIComponent(l.substring(a.length+1));break}}return b}("csrftoken"));d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onreadystatechange=function(){4==d.readyState&&200==d.status&&($(".download_success",a.el).show(),$(".print_email_progress",a.el).hide(),setTimeout(function(){$(".email_footer_buttons",a.el).show();$(".download_success",a.el).hide();a.$el.modal("hide")},800))};d.onload=function(a){a=d.response;var b=document.createElement("a");b.href=window.URL.createObjectURL(a);
b.download="EatThisMuch-MealPlan-"+moment().format("YYYY-MM-DD")+".pdf";b.click()};d.send($.param(b))},generatePostDict:function(a){var b=$("#include_grocery_list",this.el).is(":checked"),c=$("#include_meal_plans",this.el).is(":checked"),d=$("#include_full_recipes",this.el).is(":checked"),e=$("input[type=radio][name=print_format]:checked",this.el).val();return{action:a,include_grocery_list:b,include_meal_plans:c,include_full_recipes:d,print_format:e}},generatePlanSummary:function(a){var b=this,c=
this.generatePostDict(a);this.savePrintSettings(c);var d;_.has(this,"diet_set_id")?(c.diet_set_id=this.diet_set_id,d="/print-email-diet-set/"):(c.date_range=$(".date_range_selector",this.el).data("kalendae").getSelected(),d="/print-email-groceries/");amplitude.logEvent("print_plan",c);$(".print_email_progress",this.el).show();$(".email_footer_buttons",this.el).hide();$(".print_failure",this.el).hide();$(".preview_failure",this.el).hide();$.post(d,c,function(d){$(".print_email_progress",b.el).hide();
if("print"===a){var f=ETM.generatePrintTitle(c);ETM.writeContentToDocument(d,f,!0)?($(".email_footer_buttons",b.el).show(),b.$el.modal("hide")):($(".print_failure",b.el).show(),setTimeout(function(){$(".email_footer_buttons",b.el).show()},2E3))}else"email"===a?($(".download_success",b.el).show(),setTimeout(function(){$(".email_footer_buttons",b.el).show();$(".download_success",b.el).hide();b.$el.modal("hide")},800)):"preview"===a&&(f=ETM.generatePrintTitle(c),ETM.writeContentToDocument(d,f,!1)?$(".email_footer_buttons",
b.el).show():($(".preview_failure",b.el).show(),setTimeout(function(){$(".email_footer_buttons",b.el).show()},2E3)))}).fail(function(){$(".print_email_progress",b.el).hide();$(".email_footer_buttons",b.el).show();Backbone.trigger("flash",{message:"Error generating plans, check your date range.",type:"danger"})})}});
ETM.EmailPlanSetModalView=ETM.EmailPlansModalView.extend({initialize:function(a){this.diet_set_id=a.diet_set_id},render:function(){this.$el.html(this.template({print_settings:this.getSavedPrintSettings()}));this.$el.modal({show:!1});this.applyCheckboxEvents();return this}});
ETM.ManagerEmailPlansModalView=ETM.EmailPlansModalView.extend({events:{"click .preview_edit_email":function(){this.savePrintSettings(this.generatePostDict());$(".generate_email_form",this.el).submit();this.$el.modal("hide")}},initialize:function(a){this.end_date=this.start_date=0;null!=a.emails&&(this.emails=a.emails)},applyDietSourceEvents:function(){var a=this;$("input[type=radio][name=meal_plan_source]",this.el).change(function(){a.showDietSource()})},showDietSource:function(){"use_calendar"===
$("input[type=radio][name=meal_plan_source]:checked",this.el).val()?($(".date_range_selector_div",this.el).show(),$(".diet_set_label",this.el).hide(),$("#date_range_select",this.el).show(),$("#diet-select",this.el).hide()):($(".date_range_selector_div",this.el).hide(),$(".diet_set_label",this.el).show(),$("#date_range_select",this.el).hide(),$("#diet-select",this.el).show())},render:function(){this.$el.html(this.template({start_date:this.start_date,end_date:this.end_date,emails:this.emails,diet_sets:ETM.diet_set_list,
print_settings:this.getSavedPrintSettings()}));this.initializeCalendar();this.applyTooltips();this.applyCheckboxEvents();this.applyDietSourceEvents();this.showDietSource();$(".diet_sets_tooltip",this.el).tooltip({html:!0,placement:"right",title:"<div>You can save multiple diets in your calendar as 'Meal plan sets' by choosing 'Save meal plans' in the Diet actions on the planner page. </div>"});return this}});
ETM.writeContentToDocument=function(a,b,c){var d;d="toolbar=yes,location=no,directories=yes,menubar=yes,scrollbars=yes,width=800, height=800, left=50, top=25,_blank";"Microsoft Internet Explorer"!=navigator.appName&&(d="");d=window.open("","",d);try{return d.document.open(),d.document.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'),d.document.write("<head><title>"+b+"</title>"),c?d.document.write('</head><body style="padding:0;margin-top:0 !important;margin-bottom:0!important;"   onLoad="self.print();">'):
d.document.write('</head><body style="padding:0;margin-top:0 !important;margin-bottom:0!important;">'),d.document.write(a),d.document.write("</body></html>"),d.document.close(),d.focus(),!0}catch(e){return!1}};ETM.generatePrintTitle=function(a){var b="";return b=a.include_meal_plans&&a.include_grocery_list?"Your meal plan and grocery list, by Eat This Much":a.include_grocery_list?"Your grocery list, by Eat This Much":"Your meal plan, by Eat This Much"};var tooltip_show_delay=250;
ETM.recently_blocked=[];ETM.reload_food_pool=!1;
ETM.FoodObjectView=Backbone.View.extend({tagName:"li",className:function(){return ETM.is_mobile&&!ETM.is_tablet?"mobile_diet_draggable diet_draggable row":"diet_draggable row"},events:{"click .food_refresh":"shuffleFood","click .food_repeat":"openRecurringFoodModal","click .food_delete":"deleteFood","click a.destroy":"clear","keyup .mod_input":"updateAmount","change .list_selector":"updateUnits","click .favorite_food":function(a){$(a.currentTarget).prop("disabled")||this.model.toggleFavorite($(a.currentTarget))},
"click .food_eaten":"toggleEaten","click .block_food":function(a){$(a.currentTarget).prop("disabled")||this.model.toggleBlock($(a.currentTarget))},"click .food_image a":"openFoodModal"},initialize:function(){this.applyFoodListeners();this.listenTo(this.model,"modalUpdated",function(){this.render();this.updateTooltip();this.$el.tooltip("hide")},this);this.listenTo(this.model,"modelDeleted",function(){this.remove()},this);this.listenTo(this.model,"imageUpdated",function(a){this.model.get("food").attributes.images.add(a);
this.render()},this);this.listenTo(this.model,"foodChanged",function(){this.render();this.updateTooltip();this.model.get("food").get("is_recipe")&&this.applyIngredientsLookup();this.applyFoodListeners();this.$el.tooltip("hide")},this);this.listenTo(this.model,"removeFoodObjectListeners",function(){this.stopListening(this.model.attributes.food)},this);this.listenTo(this.model,"disableHover",function(){this.$el.unbind("mouseenter mouseleave tooltip")},this);this.listenTo(this.model,"disableEvents",
function(){this.undelegateEvents()},this);this.listenTo(this.model,"enableHover",function(){this.render()},this);this.listenTo(this.model,"highlightFood",function(){this.flashFoodBackground()},this);this.listenTo(this.model,"enableTooltip",function(){this.applyTooltip()},this);this.listenTo(this.model,"enableEvents",function(){this.delegateEvents()},this);this.listenTo(this.model,"showRecurring",function(){$(".repeat_item",this.el).addClass("is_recurring");$(".repeat_item .food_repeat",this.el).show()},
this);this.listenTo(this.model,"hideRecurring",function(){$(".repeat_item",this.el).removeClass("is_recurring");$(".repeat_item .food_repeat",this.el).hide()},this)},applyFoodListeners:function(){this.listenTo(this.model.attributes.food,"addFavorite",function(){this.model.is_favorite=!0;$(".favorite_food",this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeFavorite",function(){this.model.is_favorite=!1;$(".favorite_food",this.el).removeClass("active")},this);this.listenTo(this.model.attributes.food,
"addBlock",function(){this.model.is_blocked=!0;$(".block_food",this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeBlock",function(){this.model.is_blocked=!1;$(".block_food",this.el).removeClass("active")},this)},openRecurringFoodModal:function(a){a.preventDefault();this.recurring_food_modal=new ETM.RecurringFoodModalView({model:this.model});$("#recurring_foods_modal",ETM.$modal_content).html(this.recurring_food_modal.render().el);Helper.showNestedModal(this.recurring_food_modal)},
openFoodModal:function(){this.$el.tooltip("hide");ETM.food_object_modal.loadFood(this.model)},openStaticFoodModal:function(){this.$el.tooltip("hide");ETM.food_object_modal.loadFood(this.model);$(".food_refresh_modal",ETM.food_object_modal.model_view.el).hide();$(".remove_item_modal",ETM.food_object_modal.model_view.el).hide()},deleteFood:function(){this.$el.tooltip("destroy");this.model.destroy();this.remove()},flashFoodBackground:function(){var a=this;setTimeout(function(){$(".food_box",a.el).animate({"background-color":"#fdb94f"},
400).animate({"background-color":"#ffffff"},400).animate({"background-color":"#fdb94f"},400).animate({"background-color":"#ffffff"},400).animate({"background-color":"#fdb94f"},400).delay(1E3).animate({"background-color":"#ffffff"},2E3)},1)},updateAmount:function(){var a=$(".mod_input",this.el).val(),a=-1!=a.indexOf("/")?parseFractionToFloat(a):roundNumber(parseFloat(a),2);isNaN(a)&&(a=0);this.model.updateFoodAmount(a);this.updateViewStaticAmounts();this.updateTooltip()},updateUnits:function(){var a=
parseInt($(".list_selector",this.el).val());this.model.updateFoodUnits(a);this.updateViewStaticAmounts();this.updateAmountInput();this.updateTooltip()},updateAmountInput:function(){$(".mod_input",this.el).val(Helper.formatFoodAmount(this.model.static_amount))},updateViewStaticAmounts:function(){this.updateStaticAmountAndUnits();$(".static_amount",this.el).html(Helper.formatFoodAmount(this.model.static_amount));$(".static_units",this.el).html(this.model.static_units);this.printGramReadout()},printGramReadout:function(){if(this.model.attributes.food.attributes.is_basic_food&&
this.model.attributes.food.attributes.accurate_grams)if(0!=this.model.attributes.units){var a=this.model.gram_amount,b="grams";999<a?(a=Helper.formatFoodAmount(a/1E3),b="kg"):a=Helper.formatFoodAmount(a);$(".gram_printout",this.el).html(a+" "+b)}else $(".gram_printout",this.el).html("")},render:function(){this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();this.model.image=this.model.attributes.food.getDisplayImage();var a=ETM.is_mobile&&!ETM.is_tablet?ETM.loadTemplate("#MobileFoodObjectView")(this.model):
ETM.is_tablet?ETM.loadTemplate("#MobileTabletFoodObjectView")(this.model):this.template(this.model);this.$el.html(a);this.$el.unbind("mouseenter mouseleave");this.applyHoverEffects();this.applyTooltip();this.printGramReadout();ETM.is_mobile||this.applyButtonTooltips();return this},applyButtonTooltips:function(){var a=$(".remove_item",this.el),b=$(".refresh_item",this.el),c=$(".repeat_item",this.el),d=$(".block_item",this.el),e=$(".favorite_food",this.el),f=500;ETM.is_logged_in&&(f=1E3);f={placement:"top",
delay:{show:f,hide:100}};a.attr("data-original-title")||(f.title="Remove this food",a.tooltip(f));b.attr("data-original-title")||(f.title="Regenerate this food",b.tooltip(f));c.attr("data-original-title")||(f.title="Set this food to recur",c.tooltip(f));d.attr("data-original-title")||(f.title="Block this food",d.tooltip(f));e.attr("data-original-title")||(f.title="Add to favorites",e.tooltip(f))},shuffleFood:function(a){var b=this;_.has(b.model.attributes,"meal")&&!ETM.currently_generating&&(ETM.currently_generating=
!0,$(a.currentTarget).stop(),a.currentTarget.style.opacity=0.5,$(a.currentTarget).attr("disabled","true"),clearTimeout(tooltip_timer),clearTimeout(update_ingredients_timer),this.stopListening(this.model.attributes.food),(this.model.attributes.is_leftovers||this.model.attributes.has_leftovers)&&ETM.calendar_list&&$(".food_refresh",this.el).html("<img src='/static_files/gray_spinner.gif'/>"),this.model.shuffleFood(function(a){b.$el.mouseover();clearTimeout(tooltip_timer);clearTimeout(update_ingredients_timer);
$(".food_refresh",b.el).html("<span class='glyphicon glyphicon-random'></span>");if(a){if("Found no results"===a)var d="<strong>No leftovers found.</strong><br/><br/>Try regenerating or removing some other foods to change the plan's nutrition.<br/><br/>Or, to regenerate without leftovers, delete this food and regenerate the meal to add new foods.";else"No date"===a&&(d="<strong>Hold up!</strong><br/><br/>We don't support refreshing leftovers in saved meal plans yet.<br/><br/>If you want to get new suggestions, delete this food and regenerate the meal to add new foods.");
$(".refresh_item",b.el).tooltip("destroy");setTimeout(function(){$(".food_icons",b.el).tooltip({placement:"top",html:!0,title:d}).tooltip("show").on("hidden.bs.tooltip",function(a){$(this).off("hidden.bs.tooltip");$(this).tooltip("destroy")})},100)}"function"==typeof b.runAfterShuffle&&b.runAfterShuffle()}))},updateStaticAmountAndUnits:function(){this.model.static_amount=this.model.getStaticAmount();this.model.static_units=this.model.getStaticUnits()},selectorHTML:function(){for(var a="<select class='list_selector form-control'>",
b=0;b<this.model.attributes.food.attributes.weights.length;b++)if(0!=b||!1!==this.model.attributes.food.attributes.accurate_grams&&null!=this.model.attributes.food.attributes.accurate_grams)a+="<option value="+b,b==this.model.attributes.units&&(a+=" selected"),a+=">"+this.model.attributes.food.attributes.weights[b].description+"</option>";return a+"</select>"},applyHoverEffects:function(){this.timer2=this.timer1=null;var a=this,b=$(".mod_input",this.el),c=$(".mod_units",this.el),d=$(".mod_prep",this.el),
e=$(".food_link_text_hide",this.el),f=$(".food_refresh",this.el),g=$(".block_food",this.el),h=$(".food_delete",this.el),l=$(".food_repeat",this.el),m=$(".mod_prep_static",this.el),p=$(".static_div",this.el);this.$el.hover(function(){b.unbind("blur");clearTimeout(a.timer1);clearTimeout(a.timer2);p.hasClass("remain_visible")||(p.fadeOut(100),m.fadeOut(100));c.fadeIn(100);d.fadeIn(100);e.fadeIn(100);f.fadeIn(100);g.fadeIn(100);h.fadeIn(100);l.fadeIn(100)},function(){b.is(":focus")?b.blur(function(){a.timer2=
setTimeout(function(){p.hasClass("remain_visible")||(p.fadeIn(200),m.fadeIn(200));c.fadeOut(100);d.fadeOut(100);e.fadeOut(100);f.fadeOut(100);g.fadeOut(100);h.fadeOut(100);a.model.is_recurring||l.fadeOut(100)},200);clearTimeout(a.timer1);b.unbind("blur")}):a.timer1=setTimeout(function(){p.hasClass("remain_visible")||(p.fadeIn(200),m.fadeIn(200));c.fadeOut(100);d.fadeOut(100);e.fadeOut(100);f.fadeOut(100);g.fadeOut(100);h.fadeOut(100);a.model.is_recurring||l.fadeOut(100)},900)})},getTooltipPlacement:function(){return ETM.is_mobile?
"top":"right"},applyTooltip:function(){this.$el.tooltip("destroy");this.$el.tooltip({title:this.tooltipHTML(),html:!0,animation:!1,placement:this.getTooltipPlacement(),trigger:"hover focus",delay:{show:tooltip_show_delay,hide:0}});this.model.attributes.food.attributes.is_recipe&&this.applyIngredientsLookup()},applyIngredientsLookup:function(){var a=this,b=this.model.attributes.food,c=_.has(this.model.attributes.food.attributes,"missing_ids")&&_.has(this.model.attributes.food.attributes,"missing_ingredients");
this.$el.hover(function(){if(b.hasOwnProperty("tooltip_ingredients"))update_ingredients_timer=setTimeout(function(){a.updateTooltip()},tooltip_show_delay+1);else{var d=b.attributes.id,e=c?grabPantrySidebarIngredients(d):grabIngredients(d);!1==e?tooltip_timer=setTimeout(function(){c?$.post("/food/fetch_sidebar_pantry_ingredients/",{recipe_ids:JSON.stringify([d])},function(c){all_pantry_sidebar_ingredients[d]=JSON.parse(c);b.tooltip_ingredients=all_pantry_sidebar_ingredients[d];a.updateTooltip()}):
$.post("/food/fetch_ingredients/",{recipe_ids:JSON.stringify([d])},function(c){all_ingredients[d]=JSON.parse(c);b.tooltip_ingredients=all_ingredients[d];a.updateTooltip()})},tooltip_show_delay+150):(b.tooltip_ingredients=e,setTimeout(function(){a.updateTooltip()},tooltip_show_delay+1))}},function(){clearTimeout(tooltip_timer);clearTimeout(update_ingredients_timer)})},updateTooltip:function(){try{var a=this.$el.next().find(".tooltip-arrow"),b=a.offset().top-a.parent().offset().top,c=parseFloat(this.$el.next().css("top").replace(/(^\d+)(.+$)/i,
"$1")),d=this.$el.next().innerHeight();this.$el.attr("title",this.tooltipHTML()).tooltip("fixTitle").data("bs.tooltip").$tip.find(".tooltip-inner").html(this.tooltipHTML());var e=$(window).scrollTop(),f=this.$el.next().offset().top-e,g=this.$el.next().innerHeight();f+g>window.innerHeight||ETM.is_mobile?(d=g-d,this.$el.next().css("top",c-d+"px"),ETM.is_mobile||a.css("top",b+d+5+"px")):a.css("top",b+5+"px")}catch(h){}},tooltipHTML:function(){var a=this.model.attributes.food,b=this.model.attributes.food.attributes,
c=b.food_name,d=b.description,e=this.model.stats,f="";if(b.is_recipe){var d=_.has(this.model.attributes.food.attributes,"number_of_ingredients")&&_.has(this.model.attributes.food.attributes,"missing_ingredients"),g="<div class='tooltip_units'>"+b.prep_time+" mins prep, "+b.cook_time+" mins cook</div>",c='<div class="sb_tooltip_title">'+c+"</div>";if(a.hasOwnProperty("tooltip_ingredients"))var h=this.model.getServingAmount(),a=d?"<hr class='ingredients_bar'/><div class='recipe_ingredients'>"+pantrySidebarIngredientsHTML(a,
h,b.number_servings)+"</div>":"<hr class='ingredients_bar'/><div class='recipe_ingredients'>"+ingredientsHTML(a.tooltip_ingredients,h,b.number_servings)+"</div>";else a="<hr class='ingredients_bar'/><div class='recipe_ingredients'><img src='/static_files/ttp_spinner.gif'/></div>"}else g="",c='<div class="sb_tooltip_title">'+c+'</div><div class="sb_tooltip_desc">'+d+"</div>",a="",_.has(this.model.attributes,"origin_string")&&0<this.model.attributes.origin_string.length&&(f="<hr class='ingredients_bar'/><div class='grocery_origin'>"+
this.model.attributes.origin_string+"</div>");d="";0<e.price?(d='<div class="tt_macro tooltip_price"><div class="tt_macro_name">Est. Price</div><div class="tt_macro_amt">$'+roundNumber(e.price,2).toFixed(2)+"</div></div>",b.is_recipe&&b.missing_prices&&(d+="<div>*Some missing price info</div>")):d="No price info";b="<div class='tooltip_units'>Per "+Helper.formatFoodAmount(this.model.attributes.amount*b.weights[this.model.attributes.units].amount)+" "+b.weights[this.model.attributes.units].description+
"</div>";e='<div class="tt_macro tooltip_carbs"><div class="tt_macro_name">Carbs</div><div class="tt_macro_amt">'+roundNumber(e.carbs,1)+'g</div></div><div class="tt_macro tooltip_fats"><div class="tt_macro_name">Fat</div><div class="tt_macro_amt">'+roundNumber(e.fats,1)+'g</div></div><div class="tt_macro tooltip_proteins"><div class="tt_macro_name">Protein</div><div class="tt_macro_amt">'+roundNumber(e.proteins,1)+'g</div></div><div class="tt_macro tooltip_calories"><div class="tt_macro_name">Calories</div><div class="tt_macro_amt">'+
roundNumber(e.calories,1)+"</div></div>"+d;return'<div class="tooltip_box">'+c+g+b+e+a+f+"</div>"}});
ETM.FoodListView=Backbone.CollectionView.extend({tagName:"ul",sortable:!0,selectable:!1,sortableOptions:function(){return ETM.is_mobile?{connectWith:".meal_foods",handle:".draggable_handle",placeholder:"list_placeholder",axis:"y",tolerance:"pointer"}:{connectWith:".meal_foods",placeholder:"list_placeholder",axis:"y",tolerance:"pointer"}},initialize:function(a){Backbone.CollectionView.prototype.initialize.apply(this,arguments);"undefined"!=typeof ETM.current_profile_completeness&&!1===ETM.current_profile_completeness.attributes.drag_food&&
this.listenToOnce(this,"sortStop",function(a,c){ETM.finish_profile_completeness_key("drag_food")})},emptyListCaption:"<div class='row'><div class='col-xs-10 col-xs-offset-2 empty_meal_box'>There are no foods in this meal. <a target='_blank' href='http://help.eatthismuch.com/knowledge_base/topics/why-is-the-generator-leaving-some-of-my-meals-empty'>Why is this?</a></div></div>",modelView:ETM.FoodObjectView});
ETM.RestaurantFoodObjectView=ETM.FoodObjectView.extend({className:function(){return"row"},events:_.extend({},ETM.FoodObjectView.prototype.events,{"click .food_image a":"openStaticFoodModal","click .report_food_icon":"reportFoodModal"}),reportFoodModal:function(){var a=new ETM.RestaurantReportModalView({model:this.model.attributes.food});$("#report_food_modal_div").html(a.render().el);Helper.showNestedModal(a)},openStaticFoodModal:function(){this.$el.tooltip("hide");ETM.food_object_modal.loadFood(this.model);
$(".food_refresh_modal",ETM.food_object_modal.model_view.el).hide();$(".remove_item_modal",ETM.food_object_modal.model_view.el).hide()},applyHoverEffects:function(){this.timer2=this.timer1=null;var a=this,b=$(".food_link_text_hide",this.el);this.$el.hover(function(){clearTimeout(a.timer1);clearTimeout(a.timer2);b.fadeIn(100)},function(){a.timer1=setTimeout(function(){b.fadeOut(100)},900)})}});
ETM.RestaurantFoodListView=Backbone.CollectionView.extend({tagName:"ul",sortable:!1,selectable:!1,emptyListCaption:"<div class='row'><div class='col-xs-10 col-xs-offset-1 empty_meal_box'>There are no foods for this restaurant.</div></div>",modelView:ETM.RestaurantFoodObjectView});
ETM.SimpleFoodObjectView=Backbone.View.extend({tagName:"li",className:"diet_draggable row",events:{"click .food_delete":function(){this.remove();this.model.destroy()}},render:function(){var a=ETM.food_info_object_list.get(this.model.attributes.food),a=this.template({food_name:a.attributes.food_name,image:a.getDisplayImage()});this.$el.html(a);this.applyHoverEffects();return this},applyHoverEffects:function(){this.timer2=this.timer1=null;var a=this,b=$(".food_delete",this.el);this.$el.hover(function(){clearTimeout(a.timer1);
clearTimeout(a.timer2);b.fadeIn(100)},function(){a.timer1=setTimeout(function(){b.fadeOut(100)},900)})}});
ETM.BlockedFoodObjectView=ETM.SimpleFoodObjectView.extend({events:{"click .food_delete":function(){"string"===typeof this.model.attributes.food?(split_string=this.model.attributes.food.split("/"),integer_id=parseInt(split_string[split_string.length-2])):integer_id=this.model.attributes.food.attributes.id;if(_.contains(ETM.recently_blocked,integer_id)){var a=ETM.recently_blocked.indexOf(integer_id);ETM.recently_blocked.splice(a,1)}else ETM.reload_food_pool=!0;this.remove();this.model.destroy()}}});
ETM.SimpleFoodListView=Backbone.CollectionView.extend({model:ETM.SimpleFoodObjectView,tagName:"ul",sortable:!0,selectable:!1,sortableOptions:{connectWith:".meal_foods",placeholder:"list_placeholder",axis:"y",tolerance:"pointer"},emptyListCaption:"<div class='row'><div class='col-xs-11 col-xs-offset-1 empty_meal_box'>There are no foods in this list</div></div>",modelView:ETM.SimpleFoodObjectView});ETM.BlockedFoodListView=ETM.SimpleFoodListView.extend({modelView:ETM.BlockedFoodObjectView});
function parseFractionToFloat(a){a=a.split(" ");if(1<a.length){var b=a[1].split("/");0===b[1].length&&(b[1]=1);return+a[0]+b[0]/b[1]}b=a[0].split("/");return 1<b.length?(0===b[1].length&&(b[1]=1),b[0]/b[1]):b[0]}var mixin={getKeys:function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c);return b}};mixin.getFractionObject=function(){for(var a={0:"0",1:"1"},b=20,c=21,d;--b;){for(;1<--c;)d=(b/c).toFixed(3),1>d&&(a[d]=b+"/"+c);c=21}a.keys=mixin.getKeys(a);return function(){return a}}();
mixin.getClosestNum=function(a,b){if("object"!==typeof a||!a.hasOwnProperty("length")||isNaN(b))return!1;for(var c=a.length,d=c-1,e=Math.abs(+b-a[d]),f;c--;)f=Math.abs(+b-a[c]),f<e&&(e=f,d=c);return a[d]};
mixin.getFractionFromDecimal=function(a){if(isNaN(a)||!isFinite(a))return!1;if(!/\./.test(a))return a;var b=mixin.getFractionObject(),c=a.toString().match(/(\d+)(\.\d+)/),b=b[mixin.getClosestNum(b.keys,Math.abs(+c[2]))],d=0<a||"0"==b&&1>Math.abs(a)?"":"-";if("0"==b)return a;1<Math.abs(a)&&(b=isNaN(b)?+c[1]+" "+b:+c[1]+ +b);return d+b};
mixin.old_getFractionFromDecimal=function(a){if(isNaN(a)||!isFinite(a))return!1;if(!/\./.test(a))return a;var b=mixin.getFractionObject(),c=a.toString().match(/(\d+)(\.\d+)/),b=b[mixin.getClosestNum(b.keys,Math.abs(+c[2]))],d=0<a||"0"==b&&1>Math.abs(a)?"":"-";1<Math.abs(a)&&(b=isNaN(b)?+c[1]+" "+b:+c[1]+ +b);return d+b};
ETM.FoodObjectModalView=ModalView.extend({className:"modal fade",id:"food_object_modal",tagName:"div",initialize:function(){this.ingredients_scale="to_cook";this.editing_old_recipe=this.has_different_scale_to_cook=!1},addTooltips:function(){$(".image_upload_tooltip",this.el).tooltip({placement:"right",title:'<p align="left">Images you upload will only be immediately viewable by you, however we reserve the right  to make images viewable by everyone.</p>',html:!0})},render:function(){this.$el.html(this.template());
this.$el.modal({show:!1});this.addTooltips();return this},loadFood:function(a,b){b||Helper.showNestedModal(this);this.ingredients_scale="to_cook";this.model=a;this.model.ingredients_scale=this.ingredients_scale;this.has_different_scale_to_cook=!1;this.model.get("food").get("is_recipe")?(this.model.getAmountToCook()!=this.model.getServingAmount()&&(this.has_different_scale_to_cook=!0),this.model.has_different_scale_to_cook=this.has_different_scale_to_cook,this.model_view=new ETM.FoodObjectModalRecipeView({model:this.model})):
(this.model.has_different_scale_to_cook=this.has_different_scale_to_cook,this.model_view=new ETM.FoodObjectModalBasicView({model:this.model}));this.model_view.parent=this;$(".modal-dialog",this.el).html(this.model_view.render().el);this.model_view.delayPrintGraph()}});
ETM.FoodObjectModalBasicView=ETM.FoodObjectView.extend({className:"modal-content",tagName:"div",events:{"click .food_refresh_modal":"shuffleFood","click .remove_item_modal":"deleteFood","click .recurring_icon_modal":"openRecurringFoodModal","click .add_recurring_button":"openRecurringFoodModal","click .add_leftovers":"openAddLeftoversModal","keyup .food_control_panel .mod_input":"updateAmount","change .food_control_panel .list_selector":"updateUnits","click .favorite_icon_modal":function(a){$(a.currentTarget).prop("disabled")||
this.model.toggleFavorite($(a.currentTarget))},"click .food_eaten":"toggleEaten","click .block_icon_modal":function(a){$(a.currentTarget).prop("disabled")||this.model.toggleBlock($(a.currentTarget))},"click .expand_modal_nutrition":"expandNutrition","click .ingredients_scale_options .scaled_servings":"scaledIngredientsToEat","click .ingredients_scale_options .unscaled_servings":"unscaledIngredients","click .ingredients_scale_options .cook_scaled_servings":"scaledIngredientsToCook","click .admin_edit_basic_food":"adminEditBasicFood",
"click .save_basic_food_tags":"saveBasicFoodTags","click .copy_permalink":function(){Helper.copyPermalink($(".recipe_permalink",this.el))},"click .report_food_btn":"reportFoodModal","click .ingredient_origin_link":"navToIngredientOrigin"},addTooltips:function(){$(".personalize_tooltip",this.el).tooltip({placement:"bottom",title:"This lets you create a new version of the recipe that will automatically replace the original anytime you generate a meal plan.<br/><br/>This is useful if you want to substitute any ingredients, or add some more and see how the nutrition adds up.",
html:!0});$(".image_upload_tooltip",this.el).tooltip({placement:"bottom",title:'<p align="left">Images you upload will only be immediately viewable by you, however we reserve the right to make your image the default (viewable by everyone).</p>',html:!0})},render:function(){this.updateStaticAmountAndUnits();this.$el.html(this.template({model:this.model,image:this.model.attributes.food.getDisplayImage(),amino_acids:ETM.amino_acids,fatty_acids:ETM.fatty_acids,vits_and_mins:ETM.vits_and_mins,nutrient_names:ETM.nutrient_names,
grocery_origin:this.groceryOriginLinks(),selector_html:this.selectorHTML()}));this.printFoodStats();this.create_uploader();this.addTooltips();this.renderAdminTags();this.renderCuratorSection();return this},navToIngredientOrigin:function(a){a.preventDefault();var b=$(a.currentTarget).data("date");a=$(a.currentTarget).data("food_id");this.parent.$el.modal("hide");ETM.router.navigate("?date="+b+"&food_id="+a,{trigger:!0})},groceryOriginLinks:function(){if(_.has(this.model.attributes,"origin_json")&&
3<this.model.attributes.origin_json.length){var a=JSON.parse(this.model.attributes.origin_json);grocery_origin="<ul>";string_list=this.model.attributes.origin_string.split("<hr>");origin_index=0;a.forEach(function(a){grocery_origin=grocery_origin+"<li>"+(a.amount+" "+a.units+" <strong>"+a.food_name+"</strong> ("+a.date+")")+" <a data-date='"+a.date+"' data-food_id='"+a.food_id+"' class='ingredient_origin_link' href='javascript:void(0)'>[View in plan]</a></li>";origin_index++});return grocery_origin+=
"</ul>"}return!1},renderCuratorSection:function(){if(this.isUsingCurator()){var a=new ETM.FoodChangesListView({model:this.model});a.food_object_modal=this;$(".curator_div",this.el).html(a.render().el)}},isUsingCurator:function(){return!0==ETM.current_user_profile.get("is_staff")&&Backbone.history&&_.has(Backbone.history,"fragment")&&-1!==Backbone.history.fragment.indexOf("curator")?!0:!1},reportFoodModal:function(){var a=new ETM.FoodReportModalView({model:this.model.attributes.food});$("#report_food_modal_div").html(a.render().el);
Helper.showNestedModal(a)},create_uploader:function(){var a=this;ETM.displayImageSelectModal($(".food_upload_image",this.el),function(b){a.modal&&a.modal.close();a.modal=new ETM.FoodImageCropModalView({model:a.model});$("#upload_image_modal",ETM.$modal_content).html(a.modal.render(b).el);a.modal.show();$("#upload_image_modal",ETM.$modal_content).one("hidden.bs.modal",function(a){setTimeout(function(){$("body").addClass("modal-open")},100)})})},openAddLeftoversModal:function(a){a.preventDefault();
this.add_leftover_modal||(this.add_leftover_modal=new ETM.LeftoversAddModalView({model:this.model}));this.add_leftover_modal.parent_modal=this;$("#add_leftovers_modal",ETM.$modal_content).html(this.add_leftover_modal.render().el);Helper.showNestedModal(this.add_leftover_modal)},runAfterShuffle:function(){this.parent.loadFood(this.model,!0);this.updateIngredientAmounts();this.model.trigger("modalUpdated")},expandNutrition:function(){$(".nutrition_info",this.el).slideToggle(100)},initialize:function(){this.listenTo(this.model.attributes.food,
"addFavorite",function(){this.model.is_favorite=!0;$(".food_control_panel .favorite_food",this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeFavorite",function(){this.model.is_favorite=!1;$(".food_control_panel .favorite_food",this.el).removeClass("active")},this);this.listenTo(this.model.attributes.food,"addBlock",function(){this.model.is_blocked=!0;$(".food_control_panel .block_food",this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeBlock",
function(){this.model.is_blocked=!1;$(".food_control_panel .block_food",this.el).removeClass("active")},this);this.listenTo(this.model,"imageUpdated",function(){this.parent.$el.parent().addClass("modal-open")},this)},updateAmount:function(){var a=$(".mod_input",this.el).val(),a=-1!=a.indexOf("/")?parseFractionToFloat(a):roundNumber(parseFloat(a),2);isNaN(a)&&(a=0);this.model.updateFoodAmount(a);this.updateStaticAmountAndUnits();this.printFoodStats();this.updateScaleSelector();this.updateIngredientAmounts();
this.model.trigger("modalUpdated")},updateIngredientAmounts:function(){this.model.get("food").get("is_recipe")&&null!=this.model.get("food").get("ingredients")&&($(".scaled_servings",this.el).hasClass("active")?this.scaledIngredientsToEat():$(".cook_scaled_servings",this.el).hasClass("active")?this.scaledIngredientsToCook():this.unscaledIngredients())},updateAmountInput:function(){$(".food_control_panel .mod_input",this.el).val(Helper.formatFoodAmount(this.model.static_amount))},updateUnits:function(){var a=
parseInt($(".list_selector",this.el).val());this.model.updateFoodUnits(a);this.updateStaticAmountAndUnits();this.updateAmountInput();this.updateScaleSelector();this.printFoodStats();this.model.trigger("modalUpdated")},deleteFood:function(){this.parent.$el.modal("hide");this.model.destroy();this.model.trigger("modelDeleted")},printFoodStats:function(){$("#serving_size",this.el).html(Helper.formatFoodAmount(this.model.static_amount)+" "+this.model.static_units);var a=this.model.get("amount")*this.model.get("food").attributes.weights[this.model.get("units")].grams;
$("#serving_grams",this.el).html(roundNumber(a,2));for(var a=this.model.stats,b=new DailyRecommended,c=0;c<all_nutrients.length;c++){var d;d=0==b[all_nutrients[c]]?"-":Math.ceil(100*(a[all_nutrients[c]]/b[all_nutrients[c]]))+"%";$("#"+all_nutrients[c],this.el).html(Math.round(a[all_nutrients[c]]*Math.pow(10,1))/Math.pow(10,1));$("#"+all_nutrients[c],this.el).next(".amount_units").html(micro_units[c]);$("#"+all_nutrients[c]+"_dv",this.el).html(d)}b=roundNumber(a.carbs-a.fiber,1);0>b&&(b=0);$("#net_carbs",
this.el).html(b).next(".amount_units").html("g");$("#calories",this.el).html(roundNumber(a.calories,1));$("#fat_cals",this.el).html(roundNumber(9*a.fats,1));$("#fat_cal_percent",this.el).html(roundNumber(100*(9*a.fats/a.calories),1));a=getStatsHTML(a);$("#modal_day_stats .stats_output",this.el).html(a)},delayPrintGraph:function(){var a=this;setTimeout(function(){a.printGraph()},150)},printGraph:function(){var a=4*this.model.stats.carbs+4*this.model.stats.proteins+9*this.model.stats.fats,b=$("#modal_cumulative_graph",
this.el);if(0>=a)b.html("");else{var c=roundNumber(100*(4*this.model.stats.carbs/a),2),d=roundNumber(100*(9*this.model.stats.fats/a),2),a=roundNumber(100*(4*this.model.stats.proteins/a),2);$.plot(b,[{label:"Carbs",data:c,color:"#ff9000"},{label:"Protein",data:a,color:"#479ff3"},{label:"Fat",data:d,color:"#3aae4e"}],{series:{pie:{startAngle:0,show:!0,radius:1,label:{show:!0,radius:0.5,formatter:function(a,b){return'<div style="font-size:7pt;text-align:center;padding:2px;color:white;">'+a+"<br/>"+Math.round(b.percent)+
"%</div>"},threshold:0.1}}},legend:{show:!1}})}},updateScaleSelector:function(){var a=Helper.formatFoodAmount(this.model.static_amount)+" "+this.model.static_units;25<a.length&&(a=a.slice(0,20)+"...");$(".current_serving_amount",this.el).html(a)},updateServingDescription:function(){if(_.has(this.model,"amount_to_cook")&&this.model.amount_to_cook!=this.model.getServingAmount()){$(".amount_to_prepare",this.el).html(this.model.amount_to_cook+" servings");var a="Prepare a total of "+this.model.amount_to_cook+
" servings";_.has(this.model,"family_scale")&&1<this.model.family_scale&&(a+=", each of your "+this.model.family_scale+" family members eats "+this.model.getServingAmount(),a=1<this.model.attributes.amount?a+" servings":a+" serving");_.has(this.model,"leftovers_servings")&&0<this.model.leftovers_servings&&(a+=", save "+this.model.leftovers_servings,a=1<this.model.attributes.amount?a+" servings for leftovers":a+" serving for leftovers")}else a="";$(".long_serving_description",this.el).html(a)},scaledIngredientsToEat:function(){this.parent.ingredients_scale=
"to_eat";this.model.getAmountToCook();this.updateServingDescription();var a=0,a=1==this.model.get("units")?this.model.get("amount"):this.model.attributes.amount*this.model.attributes.food.attributes.weights[this.model.attributes.units].grams/this.model.attributes.food.attributes.weights[1].grams;this.setIngredientScale(a);this.printFoodStats()},scaledIngredientsToCook:function(){this.model.getAmountToCook();this.updateServingDescription();this.parent.ingredients_scale="to_cook";this.setIngredientScale(this.model.amount_to_cook);
this.printFoodStats()},unscaledIngredients:function(){this.model.getAmountToCook();this.updateServingDescription();this.parent.ingredients_scale="original";this.setIngredientScale(this.model.get("food").get("number_servings"));this.printFoodStats()},setIngredientScale:function(a){this.model.scaleIngredients(a);_.has(this,"ingredients_list_view")?this.ingredients_list_view.render():console.log("DOESN'T HAVE INGREDIENTS LIST VIEW")},adminEditBasicFood:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;
ETM.sidebar_view.custom_food_form=new ETM.CustomFoodFormView({model:ETM.food_info_object_list});ETM.sidebar_view.custom_food_form.parent=this;$("#food_form_modal",this.el).html(ETM.sidebar_view.custom_food_form.render());ETM.sidebar_view.custom_food_form.food_id=this.model.attributes.food.attributes.id;ETM.sidebar_view.custom_food_form.loadFood(this.model.attributes.food);ETM.sidebar_view.custom_food_form.$el.modal("show")},renderAdminTags:function(){$("#food_tags",this.el).val(this.model.get("food").get("extra_tags"))},
saveBasicFoodTags:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;$(".save_basic_food_tags",a.el).attr("disabled",!0);var b=$("#food_tags",this.el).val();$.ajax({url:"/admin/food/save_tags/"+this.model.get("food").get("id"),data:{extra_tags:b},type:"POST",success:function(c){$(".save_tags_errors",a.el).html("<span class='text-success'>Success!</span>");a.model.attributes.food.attributes.extra_tags=b;$(".save_basic_food_tags",a.el).attr("disabled",!1)},error:function(b,
d,e){$(".save_tags_errors",a.el).html("<span class='text-danger'>Shit, an error!</span>");$(".save_basic_food_tags",a.el).attr("disabled",!1);console.log(d);console.log(e)}})}});
ETM.IngredientObjectView=ETM.FoodObjectView.extend({events:function(){return _.extend({},ETM.FoodObjectView.prototype.events,{"change .preparation_text":"changePreparationText"})},initialize:function(){ETM.is_mobile&&(this.template=ETM.loadTemplate("#MobileIngredientObjectView"))},changePreparationText:function(){this.model.attributes.preparation=$(".preparation_text",this.el).val();$(".static_preparation_text",this.el).text(this.model.attributes.preparation)},render:function(){this.updateStaticAmountAndUnits();
this.model.selector_html=this.selectorHTML();var a=this.template({model:this.model,image:this.model.attributes.food.getDisplayImage()});this.$el.html(a);this.applyTooltip();this.applyHoverEffects();this.printGramReadout();return this}});ETM.vits_and_mins="vit_a vit_b6 vit_b12 vit_c vit_d vit_d2 vit_d3 vit_e vit_k caffeine calcium iron magnesium phosphorus zinc copper fluoride manganese selenium retinol lycopene thiamine riboflavin niacin folate choline betaine water".split(" ");ETM.amino_acids="tryptophan threonine isoleucine leucine lysine methionine cystine phenylalanine tyrosine valine arginine histidine alanine aspartic_acid glutamic_acid glycine proline serine hydroxyproline".split(" ");
ETM.fatty_acids="ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid total_omega_3 total_omega_6".split(" ");
ETM.nutrient_names={vit_e:"Vitamin E",copper:"Copper",saturated_fats:"Saturated fats",alanine:"Alanine",vit_a:"Vitamin A",glycine:"Glycine",vit_d:"Vitamin D",proteins:"Proteins",valine:"Valine",vit_k:"Vitamin K",phenylalanine:"Phenylalanine",polyunsaturated_fats:"Polyunsaturated fats",zinc:"Zinc",galactose:"Galactose",isoleucine:"Isoleucine",lysine:"Lysine",alcohol:"Alcohol",serine:"Serine",vit_c:"Vitamin C",selenium:"Selenium",caffeine:"Caffeine",folate:"Folate",leucine:"Leucine",methionine:"Methionine",
choline:"Choline",vit_b6:"Vitamin B6",trans_fats:"Trans fats",vit_d2:"Vitamin D2",vit_d3:"Vitamin D3",proline:"Proline",price:"Price",cystine:"Cystine",glucose:"Glucose",aspartic_acid:"Aspartic acid",niacin:"Niacin",fiber:"Fiber",monounsaturated_fats:"Monounsaturated fats",maltose:"Maltose",potassium:"Potassium",hydroxyproline:"Hydroxyproline",arginine:"Arginine",fats:"Fats",glutamic_acid:"Glutamic acid",fructose:"Fructose",tryptophan:"Tryptophan",threonine:"Threonine",histidine:"Histidine",phosphorus:"Phosphorus",
vit_b12:"Vitamin B12",carbs:"Carbs",lycopene:"Lycopene",lactose:"Lactose",retinol:"Retinol",sodium:"Sodium",calories:"Calories",manganese:"Manganese",betaine:"Betaine",calcium:"Calcium",riboflavin:"Riboflavin",thiamine:"Thiamine",magnesium:"Magnesium",iron:"Iron",cholesterol:"Cholesterol",tyrosine:"Tyrosine",fluoride:"Fluoride",water:"Water",alpha_carotene:"Alpha Carotene",beta_carotene:"Beta Carotene",pantothenic_acid:"Pantothenic acid",vit_a_iu:"Vitamin A IU",vit_d_iu:"Vitamin D IU",starch:"Starch",
sucrose:"Sucrose",sugar:"Sugar",theobromine:"Theobromine",ala_fatty_acid:"Alpha Lipoic Acid (ALA)",dha_fatty_acid:"Docosahexaenoic acid (DHA)",epa_fatty_acid:"Eicosapentaenoic acid (EPA)",dpa_fatty_acid:"Docosapentaenoic acid (DPA)",total_omega_3:"Total Omega 3",total_omega_6:"Total Omega 6"};
var all_nutrients="alanine alcohol arginine aspartic_acid betaine caffeine calcium calories carbs cholesterol choline copper cystine fats fiber fluoride folate fructose galactose glucose glutamic_acid glycine histidine hydroxyproline iron isoleucine lactose leucine lycopene lysine magnesium maltose manganese methionine monounsaturated_fats niacin phenylalanine phosphorus polyunsaturated_fats potassium proline proteins retinol riboflavin saturated_fats selenium serine sodium thiamine threonine trans_fats tryptophan tyrosine valine vit_a vit_b6 vit_b12 vit_c vit_d vit_d2 vit_d3 vit_e vit_k water zinc price alpha_carotene beta_carotene pantothenic_acid vit_a_iu vit_d_iu starch sucrose sugar theobromine ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid total_omega_3 total_omega_6".split(" "),daily_rec=
[0,0,0,0,0,0,1E3,0,0,0,550,2,0,0,25,0,400,0,0,0,0,0,0,0,8,0,0,0,0,0,350,0,2,0,0,20,0,1E3,0,0,0,0,0,1.7,0,70,0,2400,1.5,0,0,0,0,0,900,1.3,2.4,60,15,0,0,15,120,0,15,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0],micro_units="g;g;g;g;mg;mg;mg;kcal;g;mg;mg;mg;g;g;g;\u03bcg;\u03bcg;g;g;g;g;g;g;g;mg;g;g;g;\u03bcg;g;mg;g;mg;g;g;mg;g;mg;g;mg;g;g;\u03bcg;mg;g;\u03bcg;g;mg;mg;g;g;g;g;g;\u03bcg RAE;mg;\u03bcg;mg;\u03bcg;\u03bcg;\u03bcg;mg;\u03bcg;g;mg;USD;\u03bcg;\u03bcg;mg;IU;IU;g;g;g;mg;g;g;g;g;g;g".split(";");
function DailyRecommended(){for(var a=0;a<all_nutrients.length;a++)this[all_nutrients[a]]=daily_rec[a]}
ETM.FoodPreferencesView=Backbone.View.extend({events:{"change #preset_diet_selector select":"presetDietChanged","click .nav-list-item":"updateFilterTokens","click .sub-list-item":"updateFilterSublistTokens","click #clear_food_filters":"clearFoodFilters","change .niche_substitution_checks input":"substitutionsChanged","change .generator_focus input, .daily_price_limit input, .limit_price input, .daily_price_limit select":function(){this.loadFromForm();this.saveFoodPreferences()},"click .limit_price input":"toggleDailyPriceLimit",
"change .food_pref_nutrition_profiles select":function(){var a=$("#preset_diet_selector select",this.el).val();this.macro_changes_view.renderMacroChanges(a)}},initialize:function(){this.waiting_to_save=null;this.save_delay=2E3;this.exclusions_array=[];this.substitutions_array=[];this.cuisines_array=[];this.show_macro_changes=!0;this.diet_descriptions={anything:"The anything diet has no restrictions.",paleo:"The paleo diet suggests that you eat only what a person in a hunter-gatherer society would eat. This is a roundabout way of cutting out processed foods and many sources of carbs.",
vegetarian:"The vegetarian diet will cut out meats from your meal plans.",vegan:"The vegan diet will cut out all animal products from your meal plans.","atkins / ketogenic":"The atkins diet involves eating few enough carbs to put your body into ketosis, where you use fats as your primary energy source.",mediterranean:"The mediterranean diet is inspired by the dietary patterns of Mediterranean cultures. It focuses on consumption of fruits, vegetables, fish, some dairy, and few meats. The generator does not portion your foods as specifically as a strict mediterranean diet suggests, but it will cut many of the restricted foods."};
this.macro_changes_view=new ETM.MacroChangesView;var a=this;this.diet_filters={anything:[],paleo:["Grains","Legumes","Starchy Vegetables","Soy","Dairy"],vegetarian:["Red Meat","Poultry","Fish","Shellfish"],vegan:"Red Meat;Poultry;Fish;Shellfish;Dairy;Eggs;Mayo;Honey".split(";"),"atkins / ketogenic":["Grains","Legumes","Starchy Vegetables","Fruit"],mediterranean:["Red Meat","Fruit juice","Starchy Vegetables"]};try{this.exclusions_array=JSON.parse(this.model.attributes.exclusions)}catch(b){}try{var c=
JSON.parse(this.model.attributes.substitution_filters),d={KetoSubs:"KS",PaleoSubs:"PS",GlutenFreeSubs:"GS",VeganDairySubs:"VD",VeganMeatSubs:"VM"};_.each(c,function(b){a.substitutions_array.push(d[b])})}catch(e){try{this.substitutions_array=this.model.attributes.substitution_filters.split(",")}catch(f){}}this.schema={preset_diet:{type:"Select",options:"anything;paleo;vegetarian;vegan;atkins / ketogenic;mediterranean".split(";")},search_filters:"Text",preset_filters1:{type:"NavList",options:[{label:"Red Meat",
subList:["Beef","Pork/Bacon","Lamb","Veal"]},{label:"Poultry",subList:["Chicken","Turkey"]},{label:"Fish",subList:["Salmon","Tuna","Tilapia","Sardines","Trout & Snapper"]},{label:"Shellfish"},{label:"Eggs"},{label:"Mayo"},{label:"Honey"}]},preset_filters2:{type:"NavList",options:[{label:"Soy",subList:["Tofu","Soy Milk"]},{label:"Grains",subList:"Breakfast Cereals;Pastas;Breads;Rice;Oatmeal;Sugar".split(";")},{label:"Legumes",subList:["Beans","Lentils","Peas"]},{label:"Starchy Vegetables",subList:["Potatoes & yams",
"Corn"]}]},preset_filters3:{type:"NavList",options:[{label:"Vegetables",subList:"Artichoke Asparagus Beets Broccoli Carrots Sprouts Celery Peppers Tomato Eggplant".split(" ")},{label:"Fats & Nuts",subList:["Avocado","Peanuts","Almonds","Walnuts","Pecans"]}]},preset_filters4:{type:"NavList",options:[{label:"Dairy",subList:"Milk;Cream;Cheese;Yogurt;Cottage Cheese;Whey Powder".split(";")},{label:"Fruit",subList:"Apple;Banana;Grapes;Orange;Strawberries;Raspberries;Blueberries;Fruit juice".split(";")}]},
allergies1:{type:"NavList",options:[{label:"Gluten"},{label:"Tree Nuts"},{label:"Peanut"}]},allergies2:{type:"NavList",options:[{label:"Dairy"},{label:"Eggs"},{label:"Soy"}]},allergies3:{type:"NavList",options:[{label:"Fish"},{label:"Shellfish"}]},limit_price:{type:"Checkbox"},daily_price_limit:{type:"Select",value_type:"Number",options:[5,8,10,15,20,25]}};is_premium&&(this.schema.generator_focus={type:"SegmentedRadio",value_type:"Number",options:[{val:0,label:"Balanced"},{val:1,label:"Variety"},
{val:2,label:"Macros"},{val:3,label:"Groceries"}]})},toggleDailyPriceLimit:function(){$(".daily_price_limit select",this.el).prop("disabled",!this.form.getValue().limit_price)},render:function(){this.$el.html(this.template({show_macro_changes:this.show_macro_changes}));this.renderForm();return this},renderForm:function(){var a=this.model.clone();this.form=(new Backbone.Form({model:a,schema:this.schema,template:Helper.createTemplateFunction($("#foodPreferencesFormTemplate",this.el).html())})).render();
$(".food_preferences_form",this.el).html(this.form.el);a=this.model.get("preset_diet");$("#preset_diet_selector",this.el).val(a);this.updateDietExcludes(a);this.updateDietDescription();this.setupTokenField();this.printSubstitutionFilters();this.applySubstituteTooltips();this.toggleDailyPriceLimit();this.applyPriceAndComplexityTooltips();$(".generator_focus_tooltip",this.form.el).tooltip({placement:"left",html:!0,title:this.model.generator_focus_toolip_text()});this.show_macro_changes&&($(".macro_changes_view",
this.el).html(this.macro_changes_view.render().el),this.macro_changes_view.delegateEvents(),this.macro_changes_view.renderMacroChanges(a))},updateDietDescription:function(){var a=this.model.get("preset_diet");$(".diet_description",this.el).html(this.diet_descriptions[a])},updateDietExcludes:function(a){var b=this;$(".disabled-filter").removeClass("disabled-filter");a&&"anything"!==a?($("#diet_filters",this.el).html(a[0].toUpperCase()+a.slice(1)+" excludes: <strong>"+this.diet_filters[a].join(", ")+
"</strong>"),this.diet_filters[a].forEach(function(a){a=$('a[data-value="'+a.toLowerCase()+'"]',b.el);a.addClass("disabled-filter");a.hasClass("nav-list-item")&&a.siblings(".sub-list-item").addClass("disabled-filter")})):$("#diet_filters",this.el).html("")},setupTokenField:function(){var a=this;this.tokenfield_selector=$("#tokenfield",this.el);this.tokenfield_selector.tokenfield({autocomplete:{source:function(a,c){var d=$.ui.autocomplete.filter(foodPreferencesDict,a.term);c(d.slice(0,10))},delay:100},
showAutocompleteOnFocus:!1});this.tokenfield_selector.on("tokenfield:createtoken",function(b){var c=$(this).tokenfield("getTokens");$.each(c,function(c,e){e.value===b.attrs.value.toLowerCase()&&($(".token-input",a.el).val(""),b.preventDefault())});c=$('a[data-value="'+b.attrs.value.toLowerCase()+'"]',a.el);c.addClass("list-item-on");c.hasClass("nav-list-item")&&(c.siblings(".sub-list-item.list-item-on").each(function(){var b=$(this).text().replace("-","").trim();a.tokenfield_selector.tokenfield("removeToken",
b)}),c.siblings(".sub-list-item").addClass("list-item-on"))});this.tokenfield_selector.on("tokenfield:removetoken",function(b){null!=b.attrs.value&&(b=$('a[data-value="'+b.attrs.value.toLowerCase()+'"]',a.el),b.removeClass("list-item-on"),b.hasClass("nav-list-item")&&b.siblings(".sub-list-item").removeClass("list-item-on"))});this.tokenfield_selector.tokenfield("setTokens",this.exclusions_array);this.tokenfield_selector.on("tokenfield:createdtoken tokenfield:editedtoken tokenfield:removedtoken",function(b){a.exclusions_array=
a.tokenfield_selector.tokenfield("getTokens");a.model.set("exclusions",JSON.stringify(a.exclusions_array));null==a.waiting_to_save?a.saveFoodPreferences():a.waiting_to_save||(a.waiting_to_save=!0,setTimeout(function(){a.saveFoodPreferences()},a.save_delay))})},presetDietChanged:function(){$(".preset_diet_error",this.el).remove();var a=$("#preset_diet_selector select",this.el).val();$(".diet_description",this.el).html(this.diet_descriptions[a]);this.setSubstitutionsFromPresetDiet(a);this.updateDietExcludes(a);
this.show_macro_changes&&this.macro_changes_view.renderMacroChanges(a);this.saveFoodPreferences()},setSubstitutionsFromPresetDiet:function(a){var b={"":[],anything:[],paleo:["KS","PS"],vegetarian:["VM"],vegan:["VD","VM"],"atkins / ketogenic":["KS"],mediterranean:[]};try{this.substitutions_array=b[a],this.model.attributes.substitution_filters=this.substitutions_array.join()}catch(c){this.model.attributes.substitution_filters=[],$.extend(_errs.meta,{selected_diet_type:a}),_errs.push(c)}this.printSubstitutionFilters()},
substitutionsChanged:function(){var a=this;this.substitutions_array=[];$(".niche_substitution_checks :checkbox:checked",this.el).each(function(){a.substitutions_array.push($(this).attr("name"))});this.model.attributes.substitution_filters=this.substitutions_array.join();null==a.waiting_to_save?a.saveFoodPreferences():a.waiting_to_save||(a.waiting_to_save=!0,setTimeout(function(){a.saveFoodPreferences()},a.save_delay))},printSubstitutionFilters:function(){var a=this;$(".niche_substitution_checks input",
this.el).each(function(){$(this).prop("checked",!1)});this.substitutions_array&&_.each(this.substitutions_array,function(b){$(".niche_substitution_checks [name='"+b+"']",a.el).prop("checked",!0)})},cuisineSelectionChanged:function(){},loadFromForm:function(){var a=this.form.getValue();this.model.attributes.limit_price=a.limit_price;this.model.attributes.daily_price_limit=a.daily_price_limit;is_premium&&(this.model.attributes.generator_focus=a.generator_focus)},saveFoodPreferences:function(){this.waiting_to_save=
!1;var a=$("#preset_diet_selector select",this.el).val();if(null==this.diet_filters[a])return $("#preset_diet_selector").parent().append("<div class='preset_diet_error alert alert-danger col-xs-8 col-xs-offset-2'>Please select a valid preset diet</div>"),!1;a!=this.model.attributes.preset_diet&&(this.model.attributes.preset_diet=a);this.model.save();return!0},updateFilterTokens:function(a){if(!$(a.currentTarget).hasClass("disabled-filter")){var b=$(a.currentTarget).text(),c=$(a.currentTarget).data("value");
$(a.currentTarget).hasClass("list-item-on")?this.tokenfield_selector.tokenfield("createToken",{value:c,label:b}):this.tokenfield_selector.tokenfield("removeToken",b)}},clearFoodFilters:function(a){a.preventDefault();this.tokenfield_selector.tokenfield("setTokens",[]);$(".list-item-on",this.el).removeClass("list-item-on");this.exclusions_array=null;this.model.attributes.exclusions=null;this.saveFoodPreferences()},applySubstituteTooltips:function(){$(".niche_substitution_checks [name='KS']",this.el).parent().popover({content:"Allows recipes that use ingredients like almond meal instead of flour, lettuce wraps instead of tortillas, and Stevia instead of sugar.",
trigger:"hover",container:"body",animation:!0,placement:"top",delay:{show:100,hide:0}});$(".niche_substitution_checks [name='PS']",this.el).parent().popover({content:"Allows recipes that use ingredients like coconut products instead of dairy, and almond butter instead of peanut butter.",trigger:"hover",container:"body",animation:!0,placement:"top",delay:{show:100,hide:0}});$(".niche_substitution_checks [name='GS']",this.el).parent().popover({content:"Allows recipes that replace wheat/barley/rye based ingredients with gluten-free alternatives. (Make sure you also exclude gluten down below)",
trigger:"hover",container:"body",animation:!0,placement:"top",delay:{show:100,hide:0}});$(".niche_substitution_checks [name='VD']",this.el).parent().popover({content:"Allows recipes that use soy/rice/almond ingredients where dairy might otherwise be used (including rice protein instead of whey protein).",trigger:"hover",container:"body",animation:!0,placement:"top",delay:{show:100,hide:0}});$(".niche_substitution_checks [name='VM']",this.el).parent().popover({content:"Allows recipes that use vegan meat substitutes in place of animal meat products.",
trigger:"hover",container:"body",animation:!0,placement:"top",delay:{show:100,hide:0}})},applyPriceAndComplexityTooltips:function(){$(".price_limit_tooltip",this.el).popover({placement:"top",html:!0,trigger:"hover",content:'<p align="left"><span class="text-primary glyphicon glyphicon-info-sign"></span> Our price data isn\'t <span style="font-style:italic;">super</span> accurate yet, and local prices vary significantly. However, setting a low limit serves the purpose of excluding generally more expensive foods.</p>'})},
updateFilterSublistTokens:function(a){var b=this;if(!$(a.currentTarget).hasClass("disabled-filter")){var c=$(a.currentTarget).text().replace("-","").trim(),d=$(a.currentTarget).data("value"),e=$(a.currentTarget).hasClass("list-item-on"),f=$(a.currentTarget).siblings(".nav-list-item"),g=f.hasClass("list-item-on"),h=0==$(a.currentTarget).siblings(".sub-list-item").not(".list-item-on").length;e?h?(a={currentTarget:f},f.addClass("list-item-on"),b.updateFilterTokens(a)):this.tokenfield_selector.tokenfield("createToken",
{value:d,label:c}):g?(a=$(a.currentTarget).siblings(".sub-list-item.list-item-on"),this.tokenfield_selector.tokenfield("removeToken",f.text()),a.each(function(){var a=$(this).text().replace("-","").trim(),c=$(this).data("value");b.tokenfield_selector.tokenfield("createToken",{value:c,label:a})})):this.tokenfield_selector.tokenfield("removeToken",c)}},beforeClose:function(){this.waiting_to_save&&this.saveFoodPreferences()}});foodPreferencesDict="Red Meat;Poultry;Fish;Dairy & Eggs;Soy Products;Grains;Legumes;Fruit;Starchy Vegetables;Vegetables;Fats & Nuts;Beef;Pork/Bacon;Lamb;Veal;Chicken;Turkey;Salmon;Tuna;Tilapia;Sardines;Trout & Snapper;Shellfish;Milk;Cream;Eggs;Mayo;Cheese;Yogurt;Cottage cheese;Whey powder;Tofu;Soy milk;Breakfast cereals;Pastas;Breads;Rice;Oatmeal;Sugar;Beans;Lentils;Peas;Apple;Banana;Grapes;Orange;Strawberries;Raspberries;Blueberries;Fruit juice;Potatoes & yams;Corn;Artichoke;Asparagus;Beets;Broccoli;Carrots;Sprouts;Celery;Peppers;Tomato;Eggplant;Avocado;Peanuts;Almonds;Walnuts;Pecans".split(";");
ETM.FoodReportModalView=ModalView.extend({className:"modal fade",events:{"click .send_report":"sendReport"},render:function(){this.$el.html(this.template({food_name:this.model.attributes.food_name,slug:this.model.attributes.slug}));this.renderForm();return this},renderForm:function(){this.form=(new Backbone.Form({schema:{preset_reasons:{type:"Select",validators:["required"],value_type:"Number",options:[{val:3,label:"Incorrect nutrition information"},{val:10,label:"Bad picture"},{val:11,label:"Tasted bad :("},
{val:0,label:"Other reason"}]},custom_reason:{type:"Text",editorAttrs:{maxlength:100}}},template:Helper.createTemplateFunction($("#report_food_form",this.el).html())})).render();$("#report_food_form_container",this.el).html(this.form.el)},sendReport:function(){$(".report_error",this.el).remove();var a=this.form.validate();if("0"===this.form.getValue("preset_reasons")){var b=this.form.getValue("custom_reason");b&&""!==b||(a||(a={}),a.custom_reason={message:"This field is required.",type:"required"})}if(a)for(var c in a)$('[data-editors="'+
c+'"]').append('<div class="report_error alert alert-danger">'+a[c].message+"</div>");else $(".report_error",this.el).empty(),(new ETM.ReportFood(this.form.getValue())).save({food:this.model.attributes.resource_uri}),this.$el.modal("hide")}});
ETM.RestaurantReportModalView=ETM.FoodReportModalView.extend({renderForm:function(){this.form=(new Backbone.Form({schema:{preset_reasons:{type:"Select",validators:["required"],options:[{val:12,label:"Food shouldn't be recommended in meals"},{val:15,label:"Food shown for wrong restaurant"},{val:13,label:"Food discontinued by restaurant"},{val:14,label:"Bad meal pairing"},{val:3,label:"Incorrect nutrition information"},{val:10,label:"Bad picture"},{val:11,label:"Tasted bad :("},{val:0,label:"Other reason"}]},
custom_reason:{type:"TextArea",editorAttrs:{maxlength:2048}}},template:Helper.createTemplateFunction($("#report_food_form",this.el).html())})).render();$("#report_food_form_container",this.el).html(this.form.el)}});
ETM.FreeSignupView=Backbone.View.extend({events:{},initialize:function(a){this.user_profile=ETM.current_user_profile;this.user_profile_view_options={shopping_day_enabled:!1,autosave:!1,display_weight_goal:!0};this.nutrition_profile=ETM.current_diet.attributes.nutrition_profile;this.diet=ETM.current_diet;this.element=document},render:function(){this.renderStep1();return this},hideSteps:function(){$(".step_1_div",this.element).hide();$(".step_2_div",this.element).hide();$(".step_3_div",this.element).hide()},
renderStep1:function(a){a&&a.preventDefault();this.hideSteps();$(".step_1_div",this.element).show();null==this.user_profile_view&&(this.user_profile_view=new ETM.UserProfileView({model:this.user_profile},this.user_profile_view_options));this.user_profile_view.render();$(".preset-diet-info",this.user_profile_view.el).show();$(".user_profile_suggestion, .user_profile_title",this.user_profile_view.el).hide();$(".profile_completeness_display",this.user_profile_view.el).parent().hide();a=$(".signup_user_profile",
this.element);a.html(this.user_profile_view.el);a.append('<br/><button type="button" class="btn btn-large btn-primary next_step_2 col-sm-offset-4 col-sm-4 next_step">Next step \u2192</button>');$("#save_profile",this.element).hide();this.user_profile_view.delegateEvents();var b=this;$(".next_step_2",this.element).one("click",function(){b.completeStep1()})},applyMacroChanges:function(){this.food_preferences_view.macro_changes_view.applyMacroChanges()},renderStep2:function(a){a&&a.preventDefault();
this.hideSteps();$(".step_2_div",this.element).show();null!=this.food_preferences_view&&this.food_preferences_view.undelegateEvents();this.food_preferences_view=new ETM.FoodPreferencesView({model:this.user_profile});this.food_preferences_view.render();this.food_preferences_view.substitutions_array&&0!=this.food_preferences_view.substitutions_array.length||"anything"==this.user_profile.attributes.preset_diet||this.food_preferences_view.setSubstitutionsFromPresetDiet(this.user_profile.attributes.preset_diet);
this.applyMacroChanges();a=$(".signup_food_preferences",this.element);a.html(this.food_preferences_view.el);a.append('<br/><button type="button" class="btn btn-large btn-primary next_step_3 col-sm-offset-4 col-sm-4 next_step">Next step \u2192</button>');$(".food_preferences_save_changes",this.element).hide();this.food_preferences_view.delegateEvents();$("body").velocity("scroll",300);var b=this;$(".next_step_3",this.element).one("click",function(){b.completeStep2()});$(".step_1, .back_to_step_1",
this.element).one("click",function(){b.renderStep1()})},renderStep3:function(a){a&&a.preventDefault();this.hideSteps();$(".step_3_div",this.element).show();this.initializeEditNutrition();$("body",this.element).velocity("scroll",300);var b=this;$(".finish_signup",this.element).on("click",function(){b.completeStep3()});$(".step_1",this.element).one("click",function(){b.renderStep1()});$(".step_2, .back_to_step_2",this.element).one("click",function(){b.renderStep2()})},initializeEditNutrition:function(){null==
this.editNutrition&&(this.editNutrition=new ETM.EditNutritionTargetsView({model:this.nutrition_profile},{diet:this.diet}));var a=$(".signup_nutrition_targets",this.element);a.html(this.editNutrition.render().el);a.append('<button type="button" class="btn btn-large btn-primary finish_signup col-sm-offset-4 col-sm-4 next_step" data-loading-text="Saving..."> Finish signup \u2192 </button>');this.editNutrition.delegateEvents();this.listenTo(this.editNutrition,"openNutritionCalculator",this.showNutritionCalculator,
this);null==this.nutritionCalculator&&(this.nutritionCalculator=new ETM.NutritionCalculatorView({model:this.user_profile},{nutrition_profile:this.nutrition_profile,go_back_enabled:!0,show_profile_alert:!1}));this.listenTo(this.nutritionCalculator,"useCalculatedSettings",this.showEditNutrition,this);this.listenTo(this.nutritionCalculator,"openEditNutritionTargets",this.showEditNutritionModal,this);$("#nutrition_calculator_modal",ETM.$modal_content).html(this.nutritionCalculator.render().el);this.nutritionCalculator.delegateEvents();
this.showEditNutrition()},showEditNutrition:function(){this.editNutrition.renderForm();this.editNutrition.renderSliders();this.editNutrition.toggleInputsAndSliders()},showNutritionCalculator:function(){this.nutritionCalculator.$el.modal("show")},completeStep1:function(){var a=this;this.user_profile_view.saveProfile()?this.renderStep2():($(".signup_user_profile",this.element).append("<div class='user_profile_errors wide_user_profile_error alert alert-danger inline'>There were some errors with saving your profile, please scroll up to fix them before continuing.</div>"),
$(".next_step_2",this.element).one("click",function(){a.completeStep1()}))},completeStep2:function(){var a=this;if(this.food_preferences_view.saveFoodPreferences())this.renderStep3();else $(".next_step_3",this.element).one("click",function(){a.completeStep2()})},completeStep3:function(){this.user_profile.save({show_walkthrough_prompt:!0,initial_signup_complete:!0},{patch:!0,async:!1});this.listenTo(this.editNutrition,"nutritionProfileUpdated",this.signupComplete,this);this.editNutrition.saveChanges()},
signupComplete:function(){$("#finish_free_signup_form",this.element).submit()}});
ETM.AccountManagementCreateUsersSignupView=ETM.FreeSignupView.extend({events:{},initialize:function(a){this.user_id=a.user_id;this.user_profile_id=a.user_profile_id;this.nutrition_profile_id=a.nutrition_profile_id;null!=a.user_profile?this.user_profile=a.user_profile:(this.user_profile=new ETM.UserProfile,this.user_profile.attributes.user_id=this.user_id,this.user_profile.id=ROOT+"/userprofile/"+this.user_profile_id+"/",this.user_profile.attributes.resource_uri=ROOT+"/userprofile/"+this.user_profile_id+
"/",this.user_profile.attributes.id=this.user_profile_id);this.user_profile_view_options={shopping_day_enabled:!1,autosave:!1,display_weight_goal:!1};null!=a.nutrition_profile?this.nutrition_profile=a.nutrition_profile:(this.nutrition_profile=new ETM.NutritionProfile,this.nutrition_profile.attributes.user_id=this.user_id,this.nutrition_profile.attributes.resource_uri=ROOT+"/nutritionprofile/"+this.nutrition_profile_id+"/",this.nutrition_profile.id=ROOT+"/nutritionprofile/"+this.nutrition_profile_id+
"/",this.nutrition_profile.attributes.id=this.nutrition_profile_id);this.diet=null;this.element=this.el},render:function(){this.$el.html(this.template({}));this.renderStep1();return this},applyMacroChanges:function(){var a=Helper.calculateMacrosFromProfile(this.user_profile);a&&(delete a.capped_min_calories,this.nutrition_profile.set(a))},initializeEditNutrition:function(){null==this.editNutrition&&(this.editNutrition=new ETM.EditNutritionTargetsView({model:this.nutrition_profile}));var a=$(".signup_nutrition_targets",
this.el);a.html(this.editNutrition.render().el);a.append('<button type="button" class="btn btn-large btn-primary finish_signup col-sm-offset-4 col-sm-4 next_step" data-loading-text="Saving..."> Finish signup \u2192 </button>');this.editNutrition.delegateEvents();this.listenTo(this.editNutrition,"openNutritionCalculator",this.showNutritionCalculator,this);null==this.nutritionCalculator&&(this.nutritionCalculator=new ETM.NutritionCalculatorView({model:this.user_profile},{nutrition_profile:this.nutrition_profile,
go_back_enabled:!0,show_profile_alert:!1}));this.listenTo(this.nutritionCalculator,"useCalculatedSettings",this.showEditNutrition,this);this.listenTo(this.nutritionCalculator,"openEditNutritionTargets",this.showEditNutritionModal,this);$("#nutrition_calculator_modal",ETM.$modal_content).html(this.nutritionCalculator.render().el);this.nutritionCalculator.delegateEvents();this.showEditNutrition()},signupComplete:function(){this.trigger("signupComplete")}});
ETM.GroceryAndPantryTeaserView=Backbone.View.extend({render:function(){this.$el.html(this.template());return this}});
ETM.GroceryAndPantryObjectView=ETM.IngredientObjectView.extend({events:{"click .food_delete":"deleteFood","click a.destroy":"clear","keyup .mod_input":"updateAmount","change .list_selector":"updateUnits","click .food_link a":"openFoodModal","change .food_checkbox input":"toggleSelected","click .food_image a":"openFoodModal"},initialize:function(){this.listenTo(this.model,"modalUpdated",function(){this.render();this.updateTooltip();this.$el.tooltip("hide")},this);this.listenTo(this.model,"imageUpdated",
function(a){this.model.attributes.food.attributes.images.add(a);this.render()},this);ETM.is_mobile&&(this.template=ETM.loadTemplate("#MobileGroceryObjectView"))},render:function(){ETM.IngredientObjectView.prototype.render.apply(this,arguments);$(".food_checkbox input",this.el).is(":checked")&&$(".food_box",this.el).addClass("blueHighlight");return this},applyHoverEffects:function(){if(ETM.is_mobile){this.timer2=this.timer1=null;var a=this,b=$(".mod_input",this.el),c=$(".mod_units",this.el),d=$(".food_link_text_hide",
this.el),e=$(".food_refresh",this.el),f=$(".block_food",this.el),g=$(".food_delete",this.el),h=$(".food_repeat",this.el),l=$(".static_div",this.el);$(".food_image, .food_name, .food_units",this.el).hover(function(){b.unbind("blur");clearTimeout(a.timer1);clearTimeout(a.timer2);l.hasClass("remain_visible")||l.fadeOut(100);c.fadeIn(100);d.fadeIn(100);e.fadeIn(100);f.fadeIn(100);g.fadeIn(100);h.fadeIn(100)},function(){b.is(":focus")?b.blur(function(){a.timer2=setTimeout(function(){l.hasClass("remain_visible")||
l.fadeIn(200);c.fadeOut(100);d.fadeOut(100);e.fadeOut(100);f.fadeOut(100);g.fadeOut(100);a.model.is_recurring||h.fadeOut(100)},200);clearTimeout(a.timer1);b.unbind("blur")}):a.timer1=setTimeout(function(){l.hasClass("remain_visible")||l.fadeIn(200);c.fadeOut(100);d.fadeOut(100);e.fadeOut(100);f.fadeOut(100);g.fadeOut(100);a.model.is_recurring||h.fadeOut(100)},900)})}else ETM.IngredientObjectView.prototype.applyHoverEffects.apply(this,arguments)},toggleSelected:function(a){this.model.is_selected=$(a.target).is(":checked");
this.model.is_selected?$(a.currentTarget).parent().parent().parent().addClass("blueHighlight"):$(a.currentTarget).parent().parent().parent().removeClass("blueHighlight")}});
ETM.GroceryAndPantryListView=ETM.FoodListView.extend({modelView:ETM.GroceryAndPantryObjectView,emptyListCaption:"<div class='row'><div class='col-xs-11 col-xs-offset-1 empty_meal_box empty_category'>There are no foods in this category</div></div>",sortableOptions:function(){return ETM.is_mobile?{connectWith:".grocery_foods_list",handle:".draggable_handle",placeholder:"list_placeholder",axis:null,tolerance:"pointer"}:{connectWith:".grocery_foods_list",placeholder:"list_placeholder",axis:null,tolerance:"pointer"}},
initialize:function(a){null!=a&&null!=a.category&&(this.category=a.category);ETM.FoodListView.prototype.initialize.apply(this,arguments)},render:function(){ETM.FoodListView.prototype.render.apply(this,arguments);this.$el.prepend('<li class="grocery_categories">'+this.category+'</li><hr class="grocery_divider"/>');this.$el.sortable({items:"li:not(.grocery_categories,.not-sortable)"});return this}});
ETM.GroceryAndPantryCategoriesView=Backbone.View.extend({tagName:"ul",initialize:function(){this.collection.comparator=this.comparator;this.collection_views=[];this.categories={100:"Dairy Products",200:"Spices and Herbs",300:"Baby Foods",400:"Fats and Oils",500:"Poultry Products",600:"Soups, Sauces, and Gravies",700:"Sausages and Luncheon Meats",800:"Breakfast Cereals",900:"Fruits and Fruit Juices",1E3:"Pork Products",1100:"Vegetables and Vegetable Products",1200:"Nut and Seed Products",1300:"Beef Products",
1400:"Beverages",1500:"Finfish and Shellfish Products",1600:"Soy and Legume Products",1700:"Lamb, Veal, and Game Products",1800:"Baked Products",1900:"Sweets",2E3:"Cereal Grains and Pasta",2100:"Fast Foods",2200:"Meals, Entrees, and Sidedishes",2500:"Snacks",3500:"Ethnic Foods",3600:"Restaurant Foods",9999:"Uncategorized"};this.collection.sort()},comparator:function(a){return isNumber(a.get("food").get("food_group"))&&0!==a.get("food").get("food_group")?a.get("food").get("food_group"):9999},render:function(){var a=
this;this.collection_views.forEach(function(a){a.close()});this.collection.comparator=null;var b=0,c;this.collection.forEach(function(d,f){var g=d.attributes.food.attributes.food_group;if("undefined"===typeof g||null===g||0===g)g=9999;if(g>b){b=g;c=new ETM.GroceryFoodList([d],{foods_are_owned:a.collection.foods_are_owned});var h=$('<div class="grocery_foods_list" />');h.appendTo(a.$el);a.collection_views.push((new ETM.GroceryAndPantryListView({collection:c,category:a.categories[g],el:h})).render())}else c.add(d)});
if(0==this.collection.length){c=new ETM.GroceryFoodList([],{foods_are_owned:a.collection.foods_are_owned});var d=$('<div class="grocery_foods_list" />');d.appendTo(a.$el);a.collection_views.push((new ETM.GroceryAndPantryListView({collection:c,category:"Empty",el:d})).render())}this.enableEvents();return this},enableEvents:function(){var a=this;a.collection_views.forEach(function(b){a.listenTo(b.collection,"add",function(b){a.collection.add(b)},a);a.listenTo(b.collection,"remove",function(b){a.collection.remove(b)},
a)})}});
ETM.GroceryAndPantryView=Backbone.View.extend({events:{"click .open_food_bank":function(){ETM.sidebar_view.toggleFoodBank()},"click .move_to_pantry_list":function(){this.moveFoods("grocery_to_pantry")},"click .move_to_grocery_list":function(){this.moveFoods("pantry_to_grocery")},"click .select_all":"selectAll","click .refresh_groceries":function(){$(".date_range_selector",ETM.reset_groceries_modal.el).data("kalendae").setSelected(getGrocerySyncDateString());ETM.reset_groceries_modal.$el.modal("show")},"click .email_groceries":function(){$(".date_range_selector",
ETM.email_plans_modal.el).data("kalendae").setSelected(getGrocerySyncDateString());ETM.email_plans_modal.$el.modal("show")},"click .delete_selected_groceries":function(){this.deleteSelected("grocery_list_view")},"click .delete_selected_pantry":function(){this.deleteSelected("pantry_list_view")},"click .remove_eaten_foods":"removeEatenFoods","click .order_with_instacart":"openInstacartModal"},initialize:function(){this.remove_eaten_foods_is_disabled=!1;ETM.email_plans_modal||(ETM.email_plans_modal=
new ETM.EmailPlansModalView,$("#email_plans_modal").html(ETM.email_plans_modal.render().el));ETM.reset_groceries_modal||(ETM.reset_groceries_modal=new ETM.ResetGroceriesModalView,$("#reset_groceries_modal").html(ETM.reset_groceries_modal.render().el))},initializeEvents:function(){this.listenTo(this.model,"reloadGroceryList",function(){this.render();this.loadAndRenderGroceryFoods()},this)},render:function(){this.$el.html(this.template({last_updated_eaten_foods:generateShortPantryUpdateString()}));
this.renderExplanations();this.applyGroceryTooltip();return this},applyGroceryTooltip:function(){$(".ingredient_substitutions_tooltip",this.el).popover({placement:"left",html:!0,trigger:"hover",content:'<p align="left"><span class="text-primary glyphicon glyphicon-info-sign"></span> We currently make a few conservative ingredient substitutions automatically, like between chunky/smooth peanut butter and salted/unsalted butter, but don\'t be afraid to make your own! Many foods in your grocery list can likely be swapped without changing the nutrition values significantly (different milks, cheeses, oils, spices, lean vegetables, etc).</p>'})},
openInstacartModal:function(){this.instacart_modal||(this.instacart_modal=new ETM.InstacartModal);$("#instacart_modal").html(this.instacart_modal.render().el);this.instacart_modal.delegateEvents();this.instacart_modal.$el.modal("show");ETM.analytics.logInstacartOpenModal()},renderExplanations:function(){var a=generatePantryUpdateString();$(".pantry_update_help",this.el).popover({title:"<strong>Updating the pantry</strong>",container:"body",content:"<p>"+a+"</p><hr/><p>Whenever your pantry is updated, foods are deducted from it to account for all of your meal plans up to the end of yesterday. This way, you can edit today's meal plan as much as you want and then it will be accounted for if you update the pantry tomorrow.</p><p>You should only manually edit the pantry to add extra foods you own or to subtract foods that were eaten outside of the meal plans. If you want to account for foods eaten through the meal plans, let it happen automatically the day after.</p> <p>For more info, check out the Knowledge Base in the Help section at the top of the page.</p>",
trigger:"hover",placement:"right",html:!0});$(".grocery_sync_help",this.el).popover({title:"<strong>Resetting the grocery list</strong>",container:"body",content:"<p>Resetting your grocery list lets you change the date range of meal plans it uses, and also lets you undo any changes to the grocery list that you may have made manually.</p><p>Anytime you view the grocery list, it will automatically update to match your meal plans. However, if you manually modify an item in your grocery list (like change the amount, add it from the food bank, or delete it), that ingredient will no longer be automatically updated when your meal plans change. Resetting will force the grocery list to exactly reflect your meal plans again.</p>",
trigger:"hover",placement:"right",html:!0})},renderGroceries:function(){Helper.lockPageHeight();this.model.grocery_list.calculateStats();this.grocery_list_view&&(this.grocery_list_view.undelegateEvents(),this.grocery_list_view.close());this.pantry_list_view&&(this.pantry_list_view.undelegateEvents(),this.pantry_list_view.close());this.pantry_list_view=new ETM.GroceryAndPantryCategoriesView({collection:this.model.pantry_list,el:$(".pantry_list",this.el)});this.grocery_list_view=new ETM.GroceryAndPantryCategoriesView({collection:this.model.grocery_list,
el:$(".grocery_list",this.el)});this.grocery_list_view.render();this.pantry_list_view.render();Helper.unlockPageHeight();$(".pantry_start_date",this.el).text(moment(this.model.attributes.current_start_date).format("MMM Do"));$(".pantry_end_date",this.el).text(moment(this.model.attributes.current_end_date).format("MMM Do"));$(".sync_text",this.el).text("Synced:");$(".pantry_loading_spinner",this.el).hide();$(".grocery_list",this.el).show();$(".pantry_list",this.el).show()},moveFoods:function(a){var b,
c,d=this;"grocery_to_pantry"===a?(b="grocery_list_view",c="pantry_list_view"):"pantry_to_grocery"===a&&(b="pantry_list_view",c="grocery_list_view");a=_.filter(this[b].collection.models,function(a){return a.is_selected});a.forEach(function(a){a.attributes.owned=d[c].collection.foods_are_owned});$(".select_all",this.el).prop("checked",!1);if(0<a.length){var e="";_.each(a,function(a){a.is_selected=!1;""!=e&&(e+=",");e+=a.attributes.id.toString()});Helper.lockPageHeight();$.ajax({url:"/pantry/update_set/",
data:{ids:e,foods_are_owned:this[c].collection.foods_are_owned?1:0},type:"POST",success:function(a){},error:function(a,b,c){console.log(b)}});this[b].collection.remove(a,{silent:!0});this[b].render();this[c].collection.add(a,{silent:!0});this[c].collection.comparator=this[c].comparator;this[c].collection.sort({silent:!0});this[c].render();Helper.unlockPageHeight()}},removeEatenFoods:function(){var a=this;moment().format("YYYY-MM-DD")===ETM.current_user_profile.attributes.last_updated_eaten_foods?
this.notifyPantryUpToDate():this.remove_eaten_foods_is_disabled||($(".remove_eaten_foods",this.el).prop("disabled",!0),this.remove_eaten_foods_is_disabled=!0,amplitude.logEvent("remove_eaten_foods"),$.ajax({url:"/update-pantry/",type:"GET",success:function(b){a.remove_eaten_foods_is_disabled=!1;$(".remove_eaten_foods",a.el).prop("disabled",!1);"Already up to date"===b?a.notifyPantryUpToDate():(ETM.current_user_profile.attributes.last_updated_eaten_foods=moment().format("YYYY-MM-DD"),a.renderExplanations(),
ETM.grocery_pantry_view.render(),ETM.grocery_pantry_view.loadAndRenderGroceryFoods())},error:function(b,c,d){console.log(c);a.remove_eaten_foods_is_disabled=!1;$(".remove_eaten_foods",a.el).prop("disabled",!1)}}))},notifyPantryUpToDate:function(){var a=$(".already_up_to_date",self.el);a.show();a.effect("shake",{distance:4});setTimeout(function(){a.fadeOut(500)},2E3)},deleteSelected:function(a){var b=_.filter(this[a].collection.models,function(a){return a.is_selected}),c="";_.each(b,function(a){""!=
c&&(c+=",");c+=a.attributes.id.toString()});Helper.lockPageHeight();$.ajax({url:"/pantry/delete_set/",data:{ids:c},type:"POST",success:function(a){},error:function(a,b,c){console.log(b)}});this[a].collection.remove(b,{silent:!0});this[a].render();Helper.unlockPageHeight()},loadAndRenderGroceryFoods:function(){var a=this;$(".grocery_list",this.el).hide();$(".pantry_list",this.el).hide();$(".pantry_loading_spinner",this.el).show();this.model.loadFoods(function(){a.renderGroceries()})},selectAll:function(a){var b;
b=$(a.target).hasClass("select_all_grocery")?$(".grocery_list .food_checkbox input"):$(".pantry_list .food_checkbox input");$(a.target).is(":checked")?b.prop("checked",!0):b.prop("checked",!1);b.trigger("change")}});
function generatePantryUpdateString(){var a=ETM.current_user_profile.attributes.last_updated_eaten_foods,b=moment().format("YYYY-MM-DD"),c=moment().add(-1,"days").format("YYYY-MM-DD");return a===b?"Your pantry has been updated today to account for all meals from yesterday and earlier.":a===c?"Your pantry was last updated yesterday, so updating now will deduct foods from just yesterday's meal plan.":"The pantry will be updated to account for any meals from "+moment(ETM.current_user_profile.attributes.last_updated_eaten_foods).format("MMM Do")+
" to the end of yesterday."}
function pantryUpdateStringRegenerateWeekModal(){var a=ETM.current_user_profile.attributes.last_updated_eaten_foods,b=moment().format("YYYY-MM-DD"),c=moment().add(-1,"days").format("YYYY-MM-DD");return a===b?"Your pantry has been updated today to account for all meals from yesterday and earlier.":a===c?"Regenerating the week will automatically update your pantry. Your pantry was last updated yesterday, so updating now will deduct foods from just yesterday's meal plan.":"Regenerating the week will automatically update your pantry to account for any meals from "+
moment(ETM.current_user_profile.attributes.last_updated_eaten_foods).format("MMM Do")+" to the end of yesterday."}function generateShortPantryUpdateString(){var a=ETM.current_user_profile.attributes.last_updated_eaten_foods,b=moment().format("YYYY-MM-DD"),c=moment().add(-1,"days").format("YYYY-MM-DD");return a===b?"Today":a===c?"Yesterday":moment(ETM.current_user_profile.attributes.last_updated_eaten_foods).format("MMM Do")}
ETM.ResetGroceriesModalView=ModalView.extend({className:"modal fade",events:{"click .reset_groceries_submit":"resetGroceries"},initialize:function(){this.end_date=this.start_date=0},render:function(){this.$el.html(this.template({start_date:this.start_date,end_date:this.end_date}));this.$el.modal({show:!1});$(".date_range_selector",this.el).kalendae({mode:"range",months:2,useYearNav:!1});return this},resetGroceries:function(a){var b=this;a=$(".date_range_selector",this.el).data("kalendae").getSelected();
$(".reset_error",this.el).hide();$(".reset_progress",this.el).show();$(".reset_footer_buttons",this.el).hide();amplitude.logEvent("reset_groceries");$.ajax({url:"/reset-groceries/",data:{date_range:a},type:"POST",success:function(a){"Successfully reset"===a&&($(".reset_progress",b.el).hide(),$(".reset_success",b.el).show(),ETM.grocery_pantry_view.render(),ETM.grocery_pantry_view.loadAndRenderGroceryFoods(),setTimeout(function(){$(".reset_footer_buttons",b.el).show();$(".reset_success",b.el).hide();
b.$el.modal("hide")},800))},error:function(a,d,e){console.log(d);$(".reset_footer_buttons",b.el).show();$(".reset_progress",b.el).hide();$(".reset_error",b.el).show()}})}});
ETM.InstacartModal=ModalView.extend({className:"modal fade",events:{"click .reset_groceries_submit":"resetGroceries"},initialize:function(){},render:function(){this.$el.html(this.template({instacart_url:this.generateInstacartUrl(),show_refresh_warning:85<ETM.groceries_and_pantry.grocery_list.models.length}));this.$el.modal({show:!1});return this},generateFullInstacartUrl:function(){var a="https://www.instacart.com/store/partner_recipe?",a=a+"description="+encodeURIComponent("For your meal plans from "+
moment(ETM.grocery_pantry_view.model.attributes.current_start_date).format("MMM Do")+" to "+moment(ETM.grocery_pantry_view.model.attributes.current_end_date).format("MMM Do")),a=a+"&image_url="+encodeURIComponent("https://www.eatthismuch.com/static_files/images/orange_etm_logo.png"),a=a+"&partner_name=eatthismuch",a=a+"&utm_campaign=eatthismuch_grocerylist&utm_source=partner_eatthismuch&utm_medium=recipe_api";ETM.groceries_and_pantry.grocery_list.each(function(b){a=a+"&ingredients%5B%5D="+encodeURIComponent(b.attributes.food.attributes.food_name)});
ETM.groceries_and_pantry.grocery_list.each(function(b){var c=String(b.static_amount)+" "+b.static_units+" "+b.attributes.food.attributes.food_name;0<b.attributes.food.attributes.description.length&&(c=c+" ("+b.attributes.food.attributes.description+")");a=a+"&quantity%5B%5D="+encodeURIComponent(c)});return a+="&title=Your+Eat+This+Much+Grocery+List"},generateInstacartUrl:function(){var a=(document.location.origin?document.location.origin:"https://www.eatthismuch.com")+"/pantry/formatted-groceries/"+
ETM.current_user_profile.attributes.unsubscribe_string.slice(0,8)+ETM.current_user_profile.attributes.user_id+"/?t="+Math.round((new Date).getTime()/1E3),a="https://www.instacart.com/store/partner_recipe?url="+encodeURIComponent(a);return a+="&utm_campaign=eatthismuch_grocerylist&utm_source=partner_eatthismuch&utm_medium=recipe_api&partner_name=eatthismuch"}});
function getNextGroceryShoppingDay(){var a=parseInt(ETM.current_user_profile.attributes.shopping_day)+1;7==a&&(a=0);moment().day()>a&&(a+=7);return moment().day(a)}function getDefaultDateRangeString(){var a=getNextGroceryShoppingDay();return moment().format("MM/DD/YYYY")+" - "+a.format("MM/DD/YYYY")}
function getGrocerySyncDateString(){return ETM.groceries_and_pantry?moment(ETM.groceries_and_pantry.attributes.current_start_date).format("MM/DD/YYYY")+" - "+moment(ETM.groceries_and_pantry.attributes.current_end_date).format("MM/DD/YYYY"):getDefaultDateRangeString()}function getCurrentCalendarDateRangeString(){return moment(ETM.calendar_list.selected_date).format("MM/DD/YYYY")+" - "+moment(ETM.calendar_list.selected_date).format("MM/DD/YYYY")}
function isNumber(a){return!isNaN(parseFloat(a))&&isFinite(a)}ETM.HeaderView=Backbone.View.extend({events:{},initialize:function(){},render:function(){this.$el.html(this.template());return this},selectMenuItem:function(a){$("#profile_nav .nav li").removeClass("active");a&&$("."+a).addClass("active")}});
ETM.LoggedOutHeaderView=Backbone.View.extend({initialize:function(a,b){this.premade_diet_type=this.premade_calories=this.load_premade_diet=!1;"undefined"!==typeof b&&(this.load_premade_diet=null!=b.load_premade_diet?b.load_premade_diet:!1,this.premade_calories=b.calories,this.premade_diet_type=b.diet_type)},render:function(){this.$el.html(this.template({load_premade_diet:this.load_premade_diet,premade_calories:this.premade_calories,premade_diet_type:this.premade_diet_type,sale_enabled:sale_enabled,
sale_percent:sale_percent,is_mobile:is_mobile,mobile_os:Helper.getMobileOperatingSystem()}));return this}});ETM.EmbeddedHeaderView=Backbone.View.extend({render:function(){this.$el.html(this.template({}));return this}});
ETM.LoggedInHeaderView=Backbone.View.extend({events:{"click .diet_planner_nav":"openDietPlanner","click .recurring_foods_nav":"openRecurringFoods","click .food-preferences":"openFoodPreferences","click .pantry_grocery_nav":"openGroceryList","click .weekly-planner-layout":"openPlannerLayout","click .leftovers":"openLeftovers","click .user-profile":"openUserProfile","click .account-settings":"openAccountSettings","click .saved-plans":"openSavedPlans","click .blocked-favorited":"openBlockedFavorited",
"click .saved-recipes":"openSavedRecipes","click .invite-friends":"openInviteFriends","click .affiliate":"openAffiliate","click .update_weight":"openWeightModal","click .get_it_to_100":"openUserProfile","click .update_shopping_date":"openUserProfile","click .view_results_button":"openResultsView"},initialize:function(){var a=this;this.listenTo(ETM.current_user_profile,"change:weight",function(){$(".profile_weight_update > span").html(lastWeightUpdateString())});this.listenTo(ETM.current_user_profile,
"change:shopping_day",function(){$(".profile_next_grocery_date > span").html(getNextGroceryShoppingDay().format("dddd, MMM Do"))});100>ETM.current_profile_completeness.getCompletenessPercent()&&this.listenTo(ETM.current_profile_completeness,"change",function(){var a=ETM.current_profile_completeness.getCompletenessPercent();$(".profile_completeness_status .label").html(a+"%");100===a&&$(".get_it_to_100").html("Nice!")});ETM.current_user_profile.hasManagerSubscription()&&(this.listenTo(ETM.manager_profile,
"change:logo_url",function(){a.renderManagerLogo()}),this.manager_client_summary_template=ETM.loadTemplate("#HeaderViewManagerClientSummaryTemplate"),this.manager_logo_template=ETM.loadTemplate("#HeaderViewManagerLogoTemplate"))},addManagedAccountsEvents:function(){var a=this;ETM.current_user_profile.hasManagerSubscription()&&this.listenTo(ETM.managed_accounts,"change",function(){ETM.current_user_profile.set({num_active_clients:ETM.managed_accounts.where({manager_approved:!0}).length,num_pending_clients:ETM.managed_accounts.where({manager_approved:!1}).length});
a.renderManagerClientSummary()})},render:function(){this.$el.html(this.template({is_premium:ETM.is_premium,user_profile:ETM.current_user_profile,weight_last_updated:lastWeightUpdateString(),next_grocery_date:getNextGroceryShoppingDay().format("dddd, MMM Do")}));ETM.current_user_profile.hasManagerSubscription()&&(this.renderManagerClientSummary(),this.renderManagerLogo());return this},renderManagerClientSummary:function(){"undefined"!=typeof app&&app||$(".manager_client_summary",this.el).html(this.manager_client_summary_template({user_profile:ETM.current_user_profile}))},
renderManagerLogo:function(){$(".manager_logo_header",this.el).html(this.manager_logo_template())},openWeightModal:function(){ETM.router.renderWeightModal();ETM.weight_modal.$el.modal("show");setTimeout('$(".weight_input_field").focus()',400)},openDietPlanner:function(){ETM.router.navigate("",{trigger:!0})},openRecurringFoods:function(){ETM.router.navigate("recurring-foods/",{trigger:!0})},openFoodPreferences:function(){ETM.router.navigate("settings/food-preferences/",{trigger:!0})},openGroceryList:function(){ETM.router.navigate("groceries/",
{trigger:!0})},openPlannerLayout:function(){ETM.router.navigate("settings/weekly-planner-layout/",{trigger:!0})},openLeftovers:function(){ETM.router.navigate("settings/leftovers/",{trigger:!0})},openUserProfile:function(){ETM.router.navigate("settings/user-profile/",{trigger:!0})},openAccountSettings:function(){ETM.router.navigate("settings/account-info/",{trigger:!0})},openSavedPlans:function(){ETM.router.navigate("settings/saved-plans/",{trigger:!0})},openBlockedFavorited:function(){ETM.router.navigate("settings/blocked-favorited/",
{trigger:!0})},openSavedRecipes:function(){ETM.router.navigate("settings/saved-recipes/",{trigger:!0})},openInviteFriends:function(){ETM.router.navigate("settings/invite-friends/",{trigger:!0})},openAffiliate:function(){ETM.router.navigate("settings/affiliate/",{trigger:!0})},openResultsView:function(){ETM.router.navigate("results/",{trigger:!0})},selectMenuItem:function(a){$(".manager_nav .btn, .main_site_nav .btn",this.el).removeClass("active");a&&$(a,this.el).addClass("active")}});
ETM.LoggedInManagerHeaderView=ETM.LoggedInHeaderView.extend({events:function(){return _.extend({},ETM.LoggedInHeaderView.prototype.events,{"click .manage_accounts":function(){ETM.router.navigate("account-management/accounts/",{trigger:!0})},"click .manage_profile":function(){ETM.router.navigate("account-management/profile/",{trigger:!0})},"click .manage_edit_plans":function(){ETM.router.navigate("account-management/edit-plans/",{trigger:!0})},"click .manage_email_plans":function(){ETM.router.navigate("account-management/email-plans/",
{trigger:!0})},"click .manage_saved_plans":function(){ETM.router.navigate("account-management/saved-plans/",{trigger:!0})},"click .manager_resources":function(){ETM.router.navigate("account-management/resources/",{trigger:!0})},"click .manager_saved_plans":function(){ETM.router.navigate("account-management/saved-plans/",{trigger:!0})},"click .manage_open_planner":function(){ETM.router.navigate("",{trigger:!0})}})},selectMenuItem:function(a){$(".manager_nav .btn, .main_site_nav .btn, .manager_planner_nav .btn",
this.el).removeClass("active");a&&(-1==a.indexOf("manage")?($(".manage_open_planner",this.el).addClass("active"),$(".manager_planner_header",this.el).show()):$(".manager_planner_header",this.el).hide(),$(a,this.el).addClass("active"))}});ETM.SettingsHeaderView=ETM.LoggedInHeaderView.extend({selectMenuItem:function(a){$(".profile_nav li",this.el).removeClass("active");a&&$(a,this.el).addClass("active")}});
ETM.displayImageSelectModal=function(a,b,c,d,e,f){null==c&&(c=ETM.MIN_IMAGE_WIDTH);null==d&&(d=ETM.MIN_IMAGE_HEIGHT);null==e&&(e=ETM.MAX_IMAGE_WIDTH);null==f&&(f=ETM.MAX_IMAGE_HEIGHT);var g={minWidth:c,minHeight:d,maxWidth:e,maxHeight:f};a.fileapi({url:"* unused but required by library *",accept:"image/*",imageSize:g,elements:{active:{show:".js-upload",hide:".js-browse"},progress:".js-progress"},onSelect:function(a,c){var d=c.files[0];FileAPI.support.transform?c.other.length?(d=c.other[0].errors)&&
(null!=d.minWidth?alert("Please select an image at least "+g.minWidth+" pixels wide."):null!=d.minHeight?alert("Please select an image at least "+g.minHeight+" pixels high."):null!=d.maxWidth?alert("Please select an image at most "+g.maxWidth+" pixels wide."):null!=d.maxHeight?alert("Please select an image at most "+g.maxHeight+" pixels high."):alert("Unable to select image.  Reason: "+d)):d&&b(d):alert("Your browser does not support Flash :(")}})};
ETM.ImageCropModalView=Backbone.View.extend({className:"modal",events:{"click .start-upload":function(){this.$el.modal("hide");this.onUpload()},"click .cancel-upload":function(){this.$el.modal("hide")},"click .move_mode_button":function(){this.cropper_element.cropper("setDragMode","move")},"click .crop_mode_button":function(){this.cropper_element.cropper("setDragMode","crop")},"click .zoom_in_button":function(){this.cropper_element.cropper("zoom",0.1)},"click .zoom_out_button":function(){this.cropper_element.cropper("zoom",
-0.1)},"click .move_left_button":function(){this.cropper_element.cropper("move",-10,0)},"click .move_right_button":function(){this.cropper_element.cropper("move",10,0)},"click .move_up_button":function(){this.cropper_element.cropper("move",0,-10)},"click .move_down_button":function(){this.cropper_element.cropper("move",0,10)},"click .rotate_left_button":function(){this.cropper_element.cropper("rotate",-45)},"click .rotate_right_button":function(){this.cropper_element.cropper("rotate",45)},"click .reset_button":function(){this.cropper_element.cropper("reset")}},
initialize:function(){this.aspect_ratio=4/3;this.cropped_image_callback=null},render:function(a){this.file=a;this.$el.html(this.template());this.addCropper(a);return this},addCropper:function(a){var b=this,c=new FileReader;c.addEventListener("load",function(){var a='<img class="temp_image" src="'+c.result+'"/>';$(".js-img",b.el).html(a);b.cropper_element=$(".js-img img",this.el);b.cropper_element.cropper({aspectRatio:b.aspect_ratio,maxSize:[ETM.MAX_IMAGE_WIDTH,ETM.MAX_IMAGE_HEIGHT],minSize:[ETM.MIN_IMAGE_WIDTH,
ETM.MIN_IMAGE_HEIGHT]})},!1);c.readAsDataURL(a)},onUpload:function(){},show:function(){this.$el.modal({backdrop:"static",show:!0})}});
ETM.FoodImageCropModalView=ETM.ImageCropModalView.extend({onUpload:function(){var a=this,b=this.cropper_element.cropper("getCroppedCanvas",{width:1200,height:900}).toDataURL("image/jpeg");null!=this.cropped_image_callback&&this.cropped_image_callback(b);var c=$(".cropped_image:first");c.html('<div><img class="image_upload_spinner" src="/static_files/big_spinner.gif"/></div>');var d=new ETM.FoodImage({image:b,food_id:a.model.attributes.food.attributes.id,user_id:ETM.current_user_profile.attributes.id});
"undefined"!=typeof d.attributes.food_id&&d.attributes.food_id?d.save(null,{success:function(b){c.html('<img src="https://images.eatthismuch.com'+b.attributes.image+'"/>');a.model.trigger("imageUpdated",d)}}):(c.html('<img src="'+b+'"/>'),a.model.trigger("imageUpdated",d))}});
ETM.ManagerLogoImageCropModalView=ETM.ImageCropModalView.extend({initialize:function(){this.aspect_ratio=1;this.upload_logo=!0},onUpload:function(){var a=this.cropper_element.cropper("getCroppedCanvas",{width:300,height:300}).toDataURL("image/jpeg");null!=this.cropped_image_callback&&this.cropped_image_callback(a);var b=$(".cropped_manager_logo_img:first");b.html('<img src="/static_files/download_spinner.gif"/>');this.upload_logo?$.ajax({url:"/account-management/add-logo/",data:{image:a},type:"POST",
success:function(a){b.html('<img src="https://images.eatthismuch.com/site_media/'+a+'"/>');ETM.manager_profile.set("logo_url",a)},error:function(a,b,e){}}):b.html('<img src="'+a+'"/>')}});ETM.InviteFriendsView=Backbone.View.extend({render:function(){this.$el.html(this.template({is_premium:ETM.is_premium,is_logged_in:ETM.is_logged_in,user:ETM.current_user_profile.attributes}));return this}});
ETM.LeftoversViewOld=Backbone.View.extend({events:{"change .enable_leftovers input":function(a){ETM.current_user_profile.save({use_leftovers:$(a.currentTarget).is(":checked"),leftovers_source_meal_type_id:ETM.meal_type_list.get(this.source_meal_type_id).attributes.id,leftovers_destination_meal_type_id:ETM.meal_type_list.get(this.destination_meal_type_id).attributes.id},{patch:!0})},"change .source_meal_type select":function(a){this.source_meal_type_id=$(a.currentTarget).val();ETM.current_user_profile.save({leftovers_source_meal_type_id:ETM.meal_type_list.get(this.source_meal_type_id).attributes.id},
{patch:!0});this.renderForm()},"change .destination_meal_type select":function(a){this.destination_meal_type_id=$(a.currentTarget).val();ETM.current_user_profile.save({leftovers_destination_meal_type_id:ETM.meal_type_list.get(this.destination_meal_type_id).attributes.id},{patch:!0});this.renderForm()}},initialize:function(){var a=ETM.meal_type_list.findWhere({id:ETM.current_user_profile.attributes.leftovers_source_meal_type_id}),b=ETM.meal_type_list.findWhere({id:ETM.current_user_profile.attributes.leftovers_destination_meal_type_id});
this.source_meal_type=a?a:ETM.meal_type_list.findWhere({title:"Dinner"});this.destination_meal_type=b?b:ETM.meal_type_list.findWhere({title:"Lunch"});null!=this.source_meal_type&&null!=this.destination_meal_type?this.source_meal_type_id=this.source_meal_type.id:1<ETM.meal_type_list.length?(this.source_meal_type=ETM.meal_type_list.at(ETM.meal_type_list.length-1),this.source_meal_type_id=this.source_meal_type.id,this.destination_meal_type=ETM.meal_type_list.at(0)):(null==this.source_meal_type&&(this.source_meal_type=
ETM.meal_type_list.create({title:"Dinner"},{async:!1})),this.source_meal_type_id=this.source_meal_type.id,null==this.destination_meal_type&&(this.destination_meal_type=ETM.meal_type_list.create({title:"Lunch"},{async:!1})));this.destination_meal_type_id=this.destination_meal_type.id},render:function(){this.$el.html(this.template());this.renderForm();return this},renderForm:function(){var a=this,b={enable_leftovers:ETM.current_user_profile.attributes.use_leftovers,source_meal_type:this.source_meal_type_id,
destination_meal_type:this.destination_meal_type_id},c=[],d=[];ETM.meal_type_list.forEach(function(b){b.id==a.destination_meal_type_id||b.attributes.deleted||c.push({val:b.id,label:b.attributes.title});b.id==a.source_meal_type_id||b.attributes.deleted||d.push({val:b.id,label:b.attributes.title})});this.form=(new Backbone.Form({data:b,schema:{enable_leftovers:{type:"Checkbox"},source_meal_type:{type:"Select",validators:["required"],options:c},destination_meal_type:{type:"Select",validators:["required"],
options:d}},template:ETM.loadTemplate("#LeftoversFormTemplate"),templateData:{source_meal_type:ETM.meal_type_list.get(this.source_meal_type_id).attributes.title,destination_meal_type:ETM.meal_type_list.get(this.destination_meal_type_id).attributes.title}})).render();$(".leftover_form",this.el).html(this.form.el)}});ETM.LeftoversTeaserView=Backbone.View.extend({render:function(){this.$el.html(this.template());return this}});
ETM.LeftoversView=Backbone.View.extend({events:{"click .add_leftovers_chain":"addLeftoversChain","change .enable_leftovers input":function(a){ETM.current_user_profile.save({use_leftovers:$(a.currentTarget).is(":checked")},{patch:!0})}},initialize:function(){this.leftovers_template_diet_list_view=new ETM.LeftoversTemplateDietListView({collection:this.collection})},addLeftoversChain:function(){var a=this;$(".add_leftovers_chain",this.el).prop("disabled",!0);var b=$(".new_leftovers_chain_form",this.el);
b.hide();var c=new ETM.LeftoversChain;c.chain_color_int=Helper.randomNumberInRange(5,10);this.new_chain_form=new ETM.LeftoversChainForm({model:c});this.listenTo(this.new_chain_form,"cancelEdits",function(){b.slideUp("fast",function(){a.new_chain_form.remove();a.new_chain_form=null;$(".add_leftovers_chain",a.el).prop("disabled",!1)})},this);this.listenTo(this.new_chain_form,"saveEdits",function(c){b.slideUp("fast",function(){a.new_chain_form.remove();a.new_chain_form=null;$(".add_leftovers_chain",
a.el).prop("disabled",!1);ETM.leftovers_chain_list.add(c)})},this);b.html(this.new_chain_form.render().el);b.slideDown("fast")},render:function(){var a=this;this.$el.html(this.template());this.renderForm();ETM.leftovers_chain_list?a.renderChainList():(ETM.leftovers_chain_list=new ETM.LeftoversChainList,ETM.leftovers_chain_list.fetch({success:function(b,c,d){_.each(b.models,function(b,c){b.chain_color_int=c;b.leftovers_view=a});!1===ETM.current_profile_completeness.get("setup_leftovers")&&b.listenToOnce(b,
"add remove",function(){!1===ETM.current_profile_completeness.get("setup_leftovers")&&ETM.current_profile_completeness.save({setup_leftovers:!0},{patch:!0})});a.renderChainList()}}));return this},renderChainList:function(){this.leftovers_chain_list_view=new ETM.LeftoversChainListView({collection:ETM.leftovers_chain_list,el:$(".leftovers_chain_list",this.el)});this.leftovers_chain_list_view.render();this.renderWeekPreview(ETM.leftovers_chain_list)},onClose:function(){this.stopListening();this.leftovers_chain_list_view.close();
this.leftovers_template_diet_list_view.close();this.leftovers_template_diet_list_view=this.leftovers_chain_list_view=null},renderWeekPreview:function(a){var b=this;this.collection.linkLeftoversMeals(a);$(".leftovers_week_preview",this.el).html(this.leftovers_template_diet_list_view.render().el);setTimeout(function(){b.leftovers_template_diet_list_view.drawLeftoversLines(a)},50)},renderForm:function(){$(".enable_leftovers input",this.el).prop("checked",ETM.current_user_profile.attributes.use_leftovers)}});
ETM.LeftoversChainForm=Backbone.View.extend({events:{"click .cancel_edits":"cancelForm","click .save_edits":"saveForm","change input, select":"updateWeekPreview"},className:function(){_.has(this.model,"chain_color_int")||(this.model.chain_color_int=ETM.leftovers_chain_list.findUnusedChainColorInt());return"leftovers_chain_color leftovers_chain_color_"+this.model.chain_color_int},initialize:function(){this.original_model=this.model.clone()},updateWeekPreview:function(){if("undefined"===typeof this.form.commit({validate:!0})){var a=
ETM.leftovers_chain_list.clone();if(this.model.id)for(var b=0;b<a.models.length;b++){if(a.models[b].id===this.model.id){a.models[b]=this.model;break}}else a.add(this.model);ETM.leftovers_view.renderWeekPreview(a)}},resetWeekPreview:function(){ETM.leftovers_view.renderWeekPreview(ETM.leftovers_chain_list)},cancelForm:function(a){a.preventDefault();this.model=this.original_model;this.resetWeekPreview();this.trigger("cancelEdits")},saveForm:function(a,b){null!=a&&a.preventDefault();var c=this;$(".leftovers_validation_error",
this.el).remove();var d=this.form.commit({validate:!0});if("undefined"===typeof d)return $(".save_edits",this.el).prop("disabled",!0),$(".save_buttons_div",this.el).append('<span class="spinner" style="margin-left:20px"><img src="/static_files/spinner.gif"/></span>'),$(".spinner",this.el).show(),this.model.save(null,{success:function(a){c.trigger("saveEdits",a);$(".spinner",c.el).hide();b&&b()}}),!0;for(var e in d)d.hasOwnProperty(e)&&$('[data-editors="'+e+'"]').append('<div class="alert alert-danger leftovers_validation_error" style="float:left">'+
d[e].message+"</div>");return!1},render:function(){this.$el.html(this.template());this.renderForm();this.updateWeekPreview();return this},renderForm:function(){this.model.schema.parent_meal_type={type:"Select",validators:["required"],options:ETM.meal_type_list.getMealTypeNameAndIds()};this.model.schema.child_meal_types={type:"MultipleSelect",validators:["required"],options:ETM.meal_type_list.getMealTypeNameAndIds()};this.form=(new Backbone.Form({model:this.model,schema:this.model.schema,template:Helper.createTemplateFunction($("#leftoversFormTemplate",
this.el).html())})).render();$(".leftovers_form_div",this.el).html(this.form.el)}});
ETM.LeftoversChainView=Backbone.View.extend({tagName:"li",className:function(){_.has(this.model,"chain_color_int")||(this.model.chain_color_int=ETM.leftovers_chain_list.findUnusedChainColorInt());return"leftovers_chain_color leftovers_chain_color_"+this.model.chain_color_int},events:{"click .delete_leftovers_chain":"deleteLeftoversChain","click .edit_leftovers_chain":"editLeftoversChain"},initialize:function(){},render:function(){this.$el.html(this.template(this.model.attributes));return this},deleteLeftoversChain:function(){this.remove();
this.model.destroy();ETM.leftovers_view.renderWeekPreview(ETM.leftovers_chain_list)},editLeftoversChain:function(){var a=this;$(".view_chain_row",this.el).slideUp("fast");var b=$(".edit_chain_row",this.el);b.hide();form_model=this.model.clone();form_model.chain_color_int=this.model.chain_color_int;this.edit_chain_form=new ETM.LeftoversChainForm({model:form_model});this.listenTo(this.edit_chain_form,"cancelEdits",function(){b.slideUp("fast",function(){a.edit_chain_form.remove();a.render()})},this);
this.listenTo(this.edit_chain_form,"saveEdits",function(c){this.model.set(c.attributes);ETM.leftovers_view.renderWeekPreview(ETM.leftovers_chain_list);b.slideUp("fast",function(){a.edit_chain_form.remove();a.render();$(".view_chain_row",a.el).slideDown("fast")})},this);this.listenTo(ETM.leftovers_view,"");b.html(this.edit_chain_form.render().el);$(".new_chain_spacer",this.edit_chain_form.el).hide();b.slideDown("fast")}});
ETM.LeftoversChainListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,emptyListCaption:function(){var a=ETM.meal_type_list.findWhere({id:ETM.current_user_profile.attributes.leftovers_source_meal_type_id}),b=ETM.meal_type_list.findWhere({id:ETM.current_user_profile.attributes.leftovers_destination_meal_type_id});return ETM.current_user_profile.attributes.use_leftovers&&null!=a&&null!=b?"<div class='alert alert-warning text-center'> You are still using the old leftovers settings - "+
a.attributes.title+" will generate leftovers for "+b.attributes.title+" the next day.</div><div class='text-center'>Click  '<span class='glyphicon glyphicon-plus'></span> Add leftovers pattern' to start using the new leftovers<hr/></div>":"<div class='text-center'>Click  '<span class='glyphicon glyphicon-plus'></span> Add leftovers pattern' to start using leftovers<hr/></div>"},modelView:ETM.LeftoversChainView});
ETM.LeftoversMealView=Backbone.View.extend({tagName:"li",className:function(){var a="leftovers_template_meal label";_.has(this.model,"chain_color_int")&&(a=a+" meal_label_"+this.model.chain_color_int);return a},attributes:function(){attributes={};_.has(this.model,"leftovers_order")&&(attributes["data-leftovers-order"]=this.model.leftovers_order);_.has(this.model,"group_number")&&(attributes["data-group-number"]=this.model.group_number);return attributes},events:{},initialize:function(){this.model.leftovers_view=
this},getCoordinates:function(a,b){var c=this.$el.offset(),d=this.$el.outerWidth(),e=this.$el.outerHeight(),f={x:0,y:0};"top"===a?(f.x=c.left-b.left+0.5*d,f.y=c.top-b.top+0.15*e):"bottom"===a?(f.x=c.left-b.left+0.5*d,f.y=c.top-b.top+0.85*e):"left"===a?(f.x=c.left-b.left+0.05*d,f.y=c.top-b.top+0.5*e):"right"===a&&(f.x=c.left-b.left+0.9*d,f.y=c.top-b.top+0.5*e);return f},render:function(){this.$el.html(this.template({meal_type_name:this.model.attributes.meal_type.attributes.title}));return this}});
ETM.LeftoversMealListView=Backbone.CollectionView.extend({tagName:"ul",sortable:!1,selectable:!1,emptyListCaption:"<div class='empty_meal_box'>There are no meals in this day</div>",modelView:ETM.LeftoversMealView});DAY_LIST="Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" ");WEEK_STARTS_DAY_LIST="Tuesday Wednesday Thursday Friday Saturday Sunday Monday".split(" ");
ETM.LeftoversTemplateDietView=Backbone.View.extend({className:"daily_template_column template_column",tagName:"div",initializeTemplateMeals:function(){this.leftovers_template_meals=new ETM.LeftoversMealListView({collection:this.model.attributes.diet.attributes.meals,el:$(".leftovers_template_meals",this.el)})},render:function(){this.$el.html(this.template({template_day:DAY_LIST[this.model.attributes.weekday],is_shopping_day:ETM.current_user_profile.get("shopping_day")===this.model.get("weekday")}));
this.leftovers_template_meals||this.initializeTemplateMeals();this.leftovers_template_meals.render();return this}});COLOR_LIST="#34b2f4 #1b92ef #0074D9 #2f5ce9 #4e4ddd #7158e4 #8d38cd #8b30b5 #5235b3 #454798".split(" ");
ETM.LeftoversTemplateDietListView=Backbone.View.extend({className:"row",initialize:function(){},drawLeftoversLines:function(a){this.$el.append('<canvas id="leftovers_chain_lines" width="'+this.$el.outerWidth()+'" height="'+this.$el.outerHeight()+'"></canvas>');parent_offset=this.$el.offset();var b=this;_.each(a.models,function(a){_.each(a.meal_groups,function(d){for(var e=0;e<d.length;e++){if(0==e){var f=d[e];f.leftovers_view.$el.css("border-left","5px solid "+shadeBlend(0.5,COLOR_LIST[a.chain_color_int]));
$(".template_meal_title",f.leftovers_view.el).css("padding-left","0px")}if(d.length>e+1){var f=d[e],g=d[e+1];f.attributes.diet_plan===g.attributes.diet_plan?(first_coords=f.leftovers_view.getCoordinates("bottom",parent_offset),second_coords=g.leftovers_view.getCoordinates("top",parent_offset)):(first_coords=f.leftovers_view.getCoordinates("right",parent_offset),second_coords=g.leftovers_view.getCoordinates("left",parent_offset));$("#leftovers_chain_lines",b.el).drawLine({strokeStyle:shadeBlend(0.5,
COLOR_LIST[a.chain_color_int]),strokeWidth:3,x1:first_coords.x,y1:first_coords.y,x2:second_coords.x,y2:second_coords.y,endArrow:!0,arrowRadius:7})}}})})},sortedByGroceryShoppingDay:function(){for(var a=ETM.current_user_profile.get("shopping_day"),b=[],c=0;7>c;c++)b.push(this.collection.findWhere({weekday:(a+c+1)%7}));return b},render:function(){var a=this;this.$el.html(this.template({}));$(".leftovers_template_diets .diet_row_1",this.el).html("");$(".leftovers_template_diets .diet_row_2",this.el).html("");
var b=0;this.sortedByGroceryShoppingDay().forEach(function(c){c.leftovers_view=new ETM.LeftoversTemplateDietView({model:c});4>b?$(".leftovers_template_diets .diet_row_1",a.el).append(c.leftovers_view.render().el):$(".leftovers_template_diets .diet_row_2",a.el).append(c.leftovers_view.render().el);b++});return this}});ETM.SignupLeftoversView=ETM.LeftoversView.extend({events:{},initialize:function(){},render:function(){this.$el.html(this.template());this.renderForm();return this}});
function shadeBlend(a,b,c){var d=0>a?-1*a:a,e=Math.round,f=parseInt;if(7<b.length){b=b.split(",");a=(c?c:0>a?"rgb(0,0,0)":"rgb(255,255,255)").split(",");c=f(b[0].slice(4));var g=f(b[1]);b=f(b[2]);return"rgb("+(e((f(a[0].slice(4))-c)*d)+c)+","+(e((f(a[1])-g)*d)+g)+","+(e((f(a[2])-b)*d)+b)+")"}b=f(b.slice(1),16);a=f((c?c:0>a?"#000000":"#FFFFFF").slice(1),16);f=b>>16;c=b>>8&255;b&=255;return"#"+(16777216+65536*(e(((a>>16)-f)*d)+f)+256*(e(((a>>8&255)-c)*d)+c)+(e(((a&255)-b)*d)+b)).toString(16).slice(1)}
ETM.LeftoversAddModalView=ModalView.extend({className:"modal fade",events:{"click #add_leftovers_button":"addLeftoversToMeals"},initialize:function(){this.add_leftovers_object=new ETM.AddLeftoversObject({leftovers_food_meal_type:ETM.meal_type_list.at(0).id,leftovers_meal_days:[1]})},render:function(){this.$el.html(this.template({attributes:this.model.attributes,logged_in:ETM.is_logged_in,is_premium:ETM.is_premium}));this.renderForm();return this},renderForm:function(){if(this.model.hasParentDiet()&&
this.model.getParentDiet().is_diet_set){var a=ETM.diet_plan_set.attributes.diets.indexOf(this.model.getParentDiet()),b=ETM.diet_plan_set.attributes.diet_set_items.length,c=Helper.getListOfNextDayNumbers(a,b);this.add_leftovers_object.attributes.leftovers_meal_days=a+1===b?[a]:[a+1]}else c=Helper.getListOfNextDates(ETM.calendar_list.selected_date);this.form=(new Backbone.Form({schema:{leftovers_food_meal_type:{type:"Select",validators:["required"],options:ETM.meal_type_list.getMealTypeNameAndIds()},
leftovers_meal_days:{type:"Checkboxes",validators:["required"],options:c}},model:this.add_leftovers_object,template:Helper.createTemplateFunction($("#addLeftoversFormTemplate",this.el).html())})).render();$("#add_leftovers_form",this.el).html(this.form.el)},addLeftoversToMeals:function(a){a.preventDefault();var b=this,c=this.model.hasParentDiet()&&this.model.getParentDiet().is_diet_set,d=$(a.currentTarget);d.attr("disabled",!0);a=this.form.commit({validate:!0});if("undefined"===typeof a){amplitude.logEvent("placed_leftovers_manually");
var e={food_id:this.model.attributes.id,leftovers_food_meal_type:parseInt(parseIdFromResourceURI(this.add_leftovers_object.attributes.leftovers_food_meal_type)),leftovers_meal_days:JSON.stringify(this.add_leftovers_object.attributes.leftovers_meal_days)};$(".save_spinner",this.el).show();$.post("/create-leftovers/",e,function(a){c?ETM.diet_plan_set.fetch({success:function(a,b,c){ETM.diet_plan_set_view.calendar_carousel.render();ETM.diet_plan_set_view.loadAndRenderAppropriateView()}}):(a=JSON.parse(a),
ETM.calendar_list.reloadDietsInDateList(a,function(){b.parent_modal.parent.loadFood(ETM.current_diet.findFoodObject(e.food_id))}));d.removeClass("btn-primary").addClass("btn-success");d.html("Success!");$(".save_spinner",b.el).hide();setTimeout(function(){d.removeClass("btn-success").addClass("btn-primary");d.html("Add leftovers to meals");d.attr("disabled",!1);b.$el.modal("hide")},1E3)})}else{d.attr("disabled",!1);for(var f in a)$('[data-editors="'+f+'"]').append('<div class="alert alert-danger" style="float:left">'+
a[f].message+"</div>")}}});ETM.AddLeftoversObject=Backbone.Model.extend({});
ETM.LoadPlansModalView=ModalView.extend({className:"modal fade",events:{"click .load_plans_submit":"loadDiets","change #diet-select":"changeSelectedDiet"},initialize:function(){},render:function(){this.$el.html(this.template({diet_sets:ETM.diet_set_list}));this.selected_plan=0<ETM.diet_set_list.length?ETM.diet_set_list.at(0):null;this.renderDietSummary();this.showLoadDates();this.$el.modal({show:!1});return this},selectedPlanIsASet:function(){return null!=this.selected_plan&&-1!==this.selected_plan.id.indexOf("dietplanset")},
changeSelectedDiet:function(){var a=parseInt($("#diet-select",this.el).val());this.selected_plan=ETM.diet_set_list.findWhere({id:a});this.renderDietSummary();this.showLoadDates()},showLoadDates:function(){var a=1;this.selectedPlanIsASet()&&(a=this.selected_plan.attributes.num_diets);$(".load_plans_submit",this.el).attr("disabled",!1);1<a?ETM.is_premium?$(".dates_to_load",this.el).html("These plans will be loaded from <strong>"+moment(ETM.calendar_list.selected_date).format("MMM Do")+"</strong> to <strong>"+
moment(ETM.calendar_list.selected_date).add(a-1,"days").format("MMM Do")+"</strong>."):($(".dates_to_load",this.el).html("<span class='label label-danger'>Error :(</span> The selected set has "+a+" meal plans in it. As a free user, you can only load single-day meal plans. <a href='/choose-plan/'>Want to upgrade?</a>"),$(".load_plans_submit",this.el).attr("disabled",!0)):$(".dates_to_load",this.el).html("This plan will be loaded into <strong>"+moment(ETM.calendar_list.selected_date).format("MMM Do")+
"</strong>.")},loadDiets:function(a){var b=this;a.preventDefault();null!=this.selected_plan&&(this.selectedPlanIsASet()&&1<this.selected_plan.attributes.num_diets&&!ETM.is_premium?$(".ajax_failure",this.el).show():(a={start_date:Helper.convertDateToString(ETM.calendar_list.selected_date),diet_id:this.selected_plan.attributes.id,diet_set:this.selectedPlanIsASet()},$(".ajax_progress",this.el).show(),$(".footer_buttons",this.el).hide(),$(".ajax_failure",this.el).hide(),$.ajax({url:"/weeklyplanner/load-diet-plans/",
data:a,type:"POST",success:function(a){a=JSON.parse(a);ETM.calendar_list.reloadDietsInDateList(a,function(){});$(".ajax_progress",b.el).hide();$(".ajax_success",b.el).show();setTimeout(function(){$(".footer_buttons",b.el).show();$(".ajax_success",b.el).hide();$(".ajax_failure",b.el).hide();b.$el.modal("hide");b.trigger("loadSuccess")},800)},error:function(a,d,e){$(".ajax_failure",b.el).show();$(".ajax_progress",b.el).hide();setTimeout(function(){$(".footer_buttons",b.el).show();$(".ajax_success",
b.el).hide();$(".ajax_failure",b.el).hide()},800)}})))},renderDietSummary:function(){if(null!=this.selected_plan)if(this.selectedPlanIsASet())try{$("#meal-plan-stats",this.el).show(),$("label[for='meal-plan-stats']").show(),$(".calories_info",this.el).html(roundNumber(this.selected_plan.attributes.average_calories,0)),$(".carbs_info",this.el).html(roundNumber(this.selected_plan.attributes.average_carbs,1)),$(".fats_info",this.el).html(roundNumber(this.selected_plan.attributes.average_fats,1)),$(".proteins_info",
this.el).html(roundNumber(this.selected_plan.attributes.average_proteins,1)),null!=this.selected_plan.attributes.description&&0<this.selected_plan.attributes.description.length?$("#meal-plan-description",this.el).html(this.selected_plan.attributes.description):$("#meal-plan-description",this.el).html("<span style='font-style:italic;'>No description</span>")}catch(a){}else{$("#meal-plan-stats",this.el).hide();$("label[for='meal-plan-stats']",this.el).hide();try{if(null!=this.selected_plan.attributes.summary){var b=
this.selected_plan.attributes.summary.replace(/&quot;/g,'"'),c=JSON.parse(b);if(null!=c&&null!=c.num_meals&&null!=c.calories&&null!=c.carbs&&null!=c.fats&&null!=c.proteins){var d=c.num_meals+" Meals<br/>"+c.calories+" Calories<br/><br/>"+c.carbs+"g Carbs<br/>"+c.fats+"g Fat<br/>"+c.proteins+"g Protein<br/><br/>Estimated $"+c.price;$("#meal-plan-description",this.el).html(d)}else{var e=b.replace(/\"/g,"").replace(/\\n/g,"<br/>");$("#meal-plan-description",this.el).html(e)}}else $("#meal-plan-description",
this.el).html("")}catch(f){b=this.selected_plan.attributes.summary.replace(/&quot;/g,'"'),e=b.replace(/\"/g,"").replace(/\n/g,"<br/>"),$("#meal-plan-description",this.el).html(e)}}}});
ETM.AccountManagementApplyDietSetsModalView=ETM.LoadPlansModalView.extend({className:"modal fade",events:{"click .load_plans_submit":"applyDiets","change #diet-select":"changeSelectedDiet"},initialize:function(){this.account_names=[];this.apply_set_callback=null},render:function(){this.$el.html(this.template({diet_sets:ETM.diet_set_list,account_names:this.account_names}));0<ETM.diet_set_list.length?(this.selected_plan=ETM.diet_set_list.at(0),this.renderDateSelector(),this.renderDietSummary(),this.showLoadDates()):
this.selected_plan=null;this.$el.modal({show:!1});return this},renderDateSelector:function(){var a=this;$(".date_range_selector",this.el).kalendae({useYearNav:!1});$(".date_range_selector",this.el).data("kalendae").subscribe("hide",function(b){a.showLoadDates()})},showLoadDates:function(){if(null!=this.selected_plan){var a=this.selected_plan.attributes.num_diets;$(".load_plans_submit",this.el).attr("disabled",!1);var b=$(".date_range_selector",this.el).data("kalendae").getSelected();1<a?$(".dates_to_load",
this.el).html("These plans will be applied from <strong>"+moment(b).format("MMM Do")+"</strong> to <strong>"+moment(b).add(a-1,"days").format("MMM Do")+"</strong>."):$(".dates_to_load",this.el).html("This plan will be applied to <strong>"+moment(b).format("MMM Do")+"</strong>.")}},applyDiets:function(a){var b=this;a.preventDefault();$(".alert-danger",this.el).hide();var c=$(".date_range_selector",this.el).data("kalendae").getSelected();console.log(c);if(null==c)$(".missing_starting_date",this.el).show();
else{var c=Helper.parseDateStringSlashes(c),d=$(".load_plans_submit",this.el).ladda();d.ladda("start");a=this.selected_plan.attributes.num_diets;var e=moment(c).add(a-1,"days").toDate();$.ajax({type:"POST",url:"/account-management/apply-diet-sets/",data:{start_date:c.toJSON(),end_date:e.toJSON(),usernames:JSON.stringify(this.account_names),diet_set_id:this.selected_plan.attributes.id},success:function(a){d.ladda("stop");b.$el.modal("hide");a?Backbone.trigger("flash",{message:a,type:"danger"}):null!=
b.apply_set_callback&&b.apply_set_callback(c,e,b.selected_plan.attributes.title)},error:function(a,b,c){d.ladda("stop");Backbone.trigger("flash",{message:"Error loading diet set: "+b,type:"danger"})}})}}});
ETM.LoggedInFreeDayView=Backbone.View.extend({events:{"click .free_overview":function(){ETM.router.startWalkthrough(ETM.free_overview)},"click .close-show-walkthrough":function(){$(".walkthrough-prompt").remove();ETM.current_user_profile.save({show_walkthrough_prompt:!1},{patch:!0})},"click .link_to_share":function(){ETM.router.navigate("settings/invite-friends/",{trigger:!0})}},initialize:function(a,b){this.hide_prompts=!1;"undefined"!==typeof b&&(this.hide_prompts=b.hide_prompts);this.single_day_view=
new ETM.SingleDayView({model:this.model});this.listenTo(this.single_day_view,"hideMealsAndStats",function(){$(".walkthrough-prompt",this.el).hide();$(".call_to_regenerate",this.el).show()},this);this.listenTo(this.single_day_view,"showMealsAndStats",function(){$(".walkthrough-prompt",this.el).show();$(".call_to_regenerate",this.el).is(":visible")&&$(".call_to_regenerate",this.el).fadeOut(600)},this);this.listenTo(this.single_day_view.plan_header_view,"dietLoad",function(a){ETM.selected_diet_list.at(0).save({diet:a})});
this.listenTo(this.model,"deleteDiet",function(){this.render()},this)},render:function(a){this.$el.html(this.template({show_walkthrough:ETM.current_user_profile.attributes.show_walkthrough_prompt,hide_prompts:this.hide_prompts}));$(".single_day_view",this.el).html(this.single_day_view.render(a).el);this.single_day_view.delegateEvents();return this}});
ETM.LoggedOutDayView=Backbone.View.extend({events:{"click .gen_button":"generateDiet","change .num_meals_selector":"numMealsChanged","change .preset_diet_selector":"presetDietChanged","keyup #cal_input":"processKey","change #cal_input":"changeCalories","click #not_sure_button":"showNutritionCalculator","click .free_overview":function(){ETM.router.startWalkthrough(ETM.free_overview)},"click .close-show-walkthrough":function(){$(".walkthrough-prompt").remove();ETM.current_user_profile.save({show_walkthrough_prompt:!1})},
"click .update_macros":function(a){a.preventDefault();this.updateMacros()}},updateMacros:function(){$("#update_macros_validation",this.el).hide();this.model.attributes.nutrition_profile.changePresetDiet(ETM.current_user_profile.attributes.preset_diet)?(this.presetDietDidChange=!1,$(".preset_diet_update_macros",this.el).hide()):($("#update_macros_validation",this.el).show(),$("#update_macros_validation",this.el).html('Please complete your <button type="button" id="not_sure_button" class="btn btn-default"><img src="/static_files/images/calculator_icon2.png"> User Profile</button> to allow us to suggest macros for your diet.'))},
processKey:function(a){13===a.which&&this.generateDiet(a)},onClose:function(){ETM.scheme_validation_element.remove();ETM.scheme_validation_element=null},initialize:function(a,b){this.load_premade_diet=this.hide_prompts=this.presetDietDidChange=!1;"undefined"!==typeof b&&(this.hide_prompts=null!=b.hide_prompts?b.hide_prompts:!1,this.load_premade_diet=null!=b.load_premade_diet?b.load_premade_diet:!1,this.premade_calories=b.calories,this.premade_diet_type=b.diet_type);this.single_day_view=new ETM.SingleDayView({model:this.model});
this.listenTo(this.single_day_view,"hideMealsAndStats",function(){$(".walkthrough-prompt",this.el).hide();ETM.is_logged_in||$(".enter_some_calories",this.el).css("display","block")},this);this.listenTo(this.single_day_view,"showMealsAndStats",function(){$(".walkthrough-prompt",this.el).show();!ETM.is_logged_in&&$(".enter_some_calories",this.el).is(":visible")&&($(".generator_header").velocity("scroll",{duration:1E3,offset:-50}),$(".enter_some_calories",this.el).fadeOut(600))},this);this.listenTo(this.model,
"deleteDiet",function(){this.render()},this);this.listenTo(this.model.attributes.nutrition_profile,"change:calories",this.updateCalories,this)},changeCalories:function(){var a=parseInt($("#cal_input",this.el).val()),b=this.model.attributes.nutrition_profile.get("calories");a!=b&&(this.model.attributes.nutrition_profile.scaleMacrosFromCalories(a,b),this.model.attributes.nutrition_profile.save({calories:a}))},updateCalories:function(){$("#cal_input",this.el).is(":focus")||(this.model.attributes.nutrition_profile.attributes.calories?
$("#cal_input",this.el).val(this.model.attributes.nutrition_profile.attributes.calories):$("#cal_input",this.el).val(""))},showNutritionCalculator:function(){this.nutritionCalculator.$el.modal("show")},render:function(a){var b;b=this.load_premade_diet&&this.premade_calories?this.premade_calories:"undefined"!=typeof this.model.attributes.nutrition_profile?this.model.attributes.nutrition_profile.attributes.calories:null;"undefined"!=typeof ETM.is_embedded&&ETM.is_embedded&&(this.template=ETM.loadTemplate("#EmbeddedDayView"));
this.$el.html(this.template({attributes:this.model.attributes,calories:b,show_walkthrough:ETM.current_user_profile.attributes.show_walkthrough_prompt,hide_prompts:this.hide_prompts}));$(".single_day_view",this.el).html(this.single_day_view.render(a).el);ETM.scheme_validation_element=$("#scheme_validation",this.el);this.nutritionCalculator=new ETM.NutritionCalculatorView({model:ETM.current_user_profile},{nutrition_profile:this.model.attributes.nutrition_profile,go_back_enabled:!1,save_user_profile:!0,
show_profile_alert:!1});this.listenTo(this.nutritionCalculator,"useCalculatedSettings",function(){$(".preset_diet_update_macros",this.el).hide();$("#update_macros_validation",this.el).hide();this.model.attributes.nutrition_profile.save();this.single_day_view.renderNutritionTargets()},this);$(".not_sure_modal",ETM.$modal_content).html(this.nutritionCalculator.render().el);this.load_premade_diet&&-1!=ETM.PRESET_DIET_TYPES.indexOf(this.premade_diet_type)?($(".preset_diet_selector",this.el).val(this.premade_diet_type),
ETM.current_user_profile.set("preset_diet",this.premade_diet_type)):$(".preset_diet_selector",this.el).val(ETM.current_user_profile.get("preset_diet"));$(".faq_title",this.el).click(function(a){$(this).next(".faq_text").slideToggle("slow")});return this},generateDiet:function(a){ETM.currently_generating||(ETM.currently_generating=!0,this.changeCalories(),this.presetDietDidChange&&this.updateMacros(),a=$(".gen_button"),a.stop(),$("#progressbar").stop(),a.html("Generating"),a.css("opacity",0.7),a.attr("disabled",
"true"),this.single_day_view.generateDiet())},numMealsChanged:function(){this.model.set({num_meals:parseInt($(".num_meals_selector",this.el).val())})},presetDietChanged:function(){ETM.current_user_profile.save({preset_diet:$(".preset_diet_selector",this.el).val()});0!=this.single_day_view.plan_stats_view.model.stats.calories?$(".preset_diet_update_macros",this.el).show():this.presetDietDidChange=!0}});
ETM.MacroChangesView=Backbone.View.extend({events:{"click .show_macro_changes":"toggleMacroChanges","click .apply-macro-changes":"applyMacroChanges"},initialize:function(){var a=this;this.nutrition_profiles=[];ETM.nutrition_profile_list.forEach(function(b){a.nutrition_profiles.push({label:b.attributes.title,val:b.id})});null!=ETM.current_diet&&null!=ETM.current_diet.attributes.nutrition_profile?this.nutrition_profile=ETM.current_diet.attributes.nutrition_profile:0<this.nutrition_profiles.length?this.nutrition_profile=
ETM.nutrition_profile_list.get(this.nutrition_profiles[0].val):(this.nutrition_profile=new ETM.NutritionProfile,this.nutrition_profile.save(null,{async:!1}),ETM.nutrition_profile_list.add(this.nutrition_profile));this.current_preset_diet=ETM.current_user_profile.attributes.preset_diet},render:function(){this.$el.html(this.template());this.renderForm();return this},renderForm:function(){this.form=(new Backbone.Form({data:{nutrition_profile:this.nutrition_profile.id},schema:{nutrition_profile:{type:"Select",
options:this.nutrition_profiles}},template:Helper.createTemplateFunction($("#macro_changes_template",this.el).html())})).render();$(".macro_changes_form",this.el).html(this.form.el)},renderMacroChanges:function(a,b){null!=a&&(this.current_preset_diet=a);null==b&&(b=ETM.current_user_profile.clone().set("preset_diet",this.current_preset_diet));var c=Helper.calculateMacrosFromProfile(b);if(c){var d=ETM.nutrition_profile_list.get(this.form.getValue().nutrition_profile);null==d&&(d=this.nutrition_profile,
this.form.setValue({nutrition_profile:this.nutrition_profile.id}));var e=ETM.loadTemplate("#MacroChangesTemplate"),f="";c.capped_min_calories&&(f+='<br/><div class="alert alert-warning">Your weight goal would require eating too few calories, so the calculator used half the calories required to maintain your current weight instead.</div>');d.attributes.calories!=c.calories&&(f+=e({what_changed:"Calories",old_value:d.attributes.calories,new_value:c.calories}));d.attributes.min_carbs!=c.min_carbs&&(f+=
e({what_changed:"Min Carbs",old_value:d.attributes.min_carbs+"g",new_value:c.min_carbs+"g"}));d.attributes.max_carbs!=c.max_carbs&&(f+=e({what_changed:"Max Carbs",old_value:d.attributes.max_carbs+"g",new_value:c.max_carbs+"g"}));d.attributes.min_fats!=c.min_fats&&(f+=e({what_changed:"Min Fats",old_value:d.attributes.min_fats+"g",new_value:c.min_fats+"g"}));d.attributes.max_fats!=c.max_fats&&(f+=e({what_changed:"Max Fats",old_value:d.attributes.max_fats+"g",new_value:c.max_fats+"g"}));d.attributes.min_proteins!=
c.min_proteins&&(f+=e({what_changed:"Min Proteins",old_value:d.attributes.min_proteins+"g",new_value:c.min_proteins+"g"}));d.attributes.max_proteins!=c.max_proteins&&(f+=e({what_changed:"Max Proteins",old_value:d.attributes.max_proteins+"g",new_value:c.max_proteins+"g"}));f?($(".macro_changes",this.el).html("<br/>In switching to this diet we recommend the following changes to your macros (based on your profile):<br/> "+f),$(".macro_changes",this.el).append('<br/><button class="btn btn-default apply-macro-changes">Apply macro changes</button>')):
$(".macro_changes",this.el).html("This nutrition profile already matches the recommend macro changes.")}else c=b.validationErrorsForCalculator(),d="",0<c.length&&(d="Error(s) trying to calculate recommended changes:<br/>"+c.join("<br/>"),d+="<br/><br/>"),$(".macro_changes",this.el).html(d+'Please fill out your <a href="#" onclick="ETM.router.navigate(&quot;/settings/user-profile/&quot;, {trigger: true})">user profile</a>  or update your weight goal settings to enable macro recommendations.')},toggleMacroChanges:function(){$(".macro_changes",
this.el).slideToggle(300)},applyMacroChanges:function(a){null!=a&&a.preventDefault();a=ETM.nutrition_profile_list.get(this.form.getValue().nutrition_profile);null==a&&(a=ETM.current_diet.attributes.nutrition_profile,this.form.setValue({nutrition_profile:a.id}));var b=Helper.calculateMacrosFromProfile(ETM.current_user_profile.clone().set("preset_diet",this.current_preset_diet));b&&(delete b.capped_min_calories,a.save(b));this.renderMacroChanges()},applyMacroChanges:function(a){null!=a&&a.preventDefault();
a=ETM.nutrition_profile_list.get(this.form.getValue().nutrition_profile);null==a&&(a=ETM.current_diet.attributes.nutrition_profile,this.form.setValue({nutrition_profile:a.id}));var b=Helper.calculateMacrosFromProfile(ETM.current_user_profile.clone().set("preset_diet",this.current_preset_diet));b&&(delete b.capped_min_calories,a.save(b));this.renderMacroChanges()}});
ETM.MapSearchModalView=ModalView.extend({className:"modal fade",events:{"click .only_show_restaurants_with_foods":"search","click .search_again_map":"search","click .redo_search":"search","change .sort_by_buttons":"changeSortType","keyup #enter_restaurant_names":"processKey","click .food_map_search_note .close":"hideMapSearchNote"},initialize:function(){this.INITIAL_ZOOM=4;this.DEFAULT_ZOOM=14;this.MAX_SPECIFIC_RESTAURANTS=5;this.DEFAULT_LAT=39.8282;this.DEFAULT_LON=-98.5795;this.NUMBER_OF_COLORS=
20;this.MAX_NUMBER_SORTED_MEALS=30;this.sort_mode=this.SORT_BY_NUTRITION_MATCH=0;this.restaurant_result_views=[];this.initial_search=!0;this.restaurant_food_map_data=null;this.marker_style={zIndex:1,labelStyle:{opacity:0.75}};this.marker_hover_style={zIndex:3,labelStyle:{opacity:1}};this.marker_info_box_style={zIndex:5,labelStyle:{opacity:1}};this.marker_colors=Helper.rgbColors(this.NUMBER_OF_COLORS);this.nutrition_targets_editor=new ETM.MealNutritionTargetsView({model:this.model});this.nutrition_targets_editor.parent=
this;this.listenTo(this,"replace_with_meal",function(a){this.replaceMeal(a)},this)},hideMapSearchNote:function(){ETM.local_variables.save({show_restaurant_availability_alert:!1})},render:function(){this.$el.html(this.template({show_availability_alert:ETM.local_variables.attributes.show_restaurant_availability_alert,radius_units:ETM.current_user_profile.isImperialUnits()?"mile(s)":"km(s)"}));this.renderForm();this.results_content=$(".results_content",this.el);this.results_container=$(".results_container",
this.el);this.results_spinner=$(".results_spinner_div",this.el);this.map_search_button=$(".search_again_map",this.el);this.redo_search_button=$(".redo_search",this.el);this.edit_targets_button=$(".edit_meal_nutrition_targets",this.el);this.search_type_buttons=$(".map_search_type .btn",this.el);this.sort_by_buttons=$(".sort_by_buttons",this.el);this.only_show_checkbox=$(".only_show_restaurants_with_foods",this.el);this.enter_restaurant_names_div=$(".enter_restaurant_names_div",this.el);this.enter_restaurant_names_tokenfield=
$("#enter_restaurant_names",this.el);this.results_header=$(".results_header",this.el);this.enter_restaurant_names_tokenfield.tokenfield({createTokensOnBlur:!0,limit:this.MAX_SPECIFIC_RESTAURANTS});this.disableSearchFunctions();this.nutrition_targets_div=$(".nutrition_targets_div",this.el);this.nutrition_targets_div.html(this.nutrition_targets_editor.render().el);$(".fast_food_tip",this.el).tooltip({placement:"bottom",html:!1,title:"Our database is mostly fast food restaurants because they're good about publishing nutrition data. They may not be strictly 'healthy', but as long as the meal fits your nutrition targets and you're getting enough vegetables in your diet, it shouldn't hinder your goals."});
return this},renderForm:function(){var a;a=ETM.current_user_profile.isImperialUnits()?[{val:1600,label:"1"},{val:3220,label:"2"},{val:8050,label:"5"},{val:16090,label:"10"},{val:40230,label:"25"},{val:80470,label:"50"}]:[{val:1E3,label:"1"},{val:2E3,label:"2"},{val:5E3,label:"5"},{val:1E4,label:"10"},{val:25E3,label:"25"},{val:5E4,label:"50"}];this.form=(new Backbone.Form({schema:{enter_restaurant_names:{type:"Text",editorAttrs:{maxlength:100,placeholder:"e.g. Chipotle, Subway, Veggie Grill","class":"form-control",
name:"enter_restaurant_names"}},search_radius:{type:"Select",value_type:"Number",options:a}},data:{search_radius:a[0].val},template:Helper.createTemplateFunction($("#map_search_form",this.el).html())})).render();$(".search_form",this.el).html(this.form.el)},getRestaurantNames:function(){var a=[];this.enter_restaurant_names_tokenfield.tokenfield("getTokens").forEach(function(b){a.push(b.label)});return a},isMapSearchType:function(){return 0===this.getRestaurantNames().length},isSortByNutritionMatch:function(){return this.sort_mode==
this.SORT_BY_NUTRITION_MATCH},processKey:function(a){13===a.which&&this.searchForSpecificRestaurant()},changeSortType:function(){var a=this;this.sort_mode=$(".sort_by_buttons .active input",this.el).val();this.sort_by_buttons.prop("disabled",!0);this.sort_by_buttons.addClass("disabled");this.clearRenderedRestaurantFoods();this.emptyResults();this.renderMealResults();setTimeout(function(){a.sort_by_buttons.prop("disabled",!1);a.sort_by_buttons.removeClass("disabled")},500)},displayMap:function(){var a=
this;try{localStorage.getItem("useMyLocation")?(a.emptyResults(),a.results_spinner.show(),navigator.geolocation.getCurrentPosition(function(b){a.loadAndRenderMap(b.coords.latitude,b.coords.longitude)},function(b){localStorage.removeItem("useMyLocation");a.loadAndRenderMap(a.DEFAULT_LAT,a.DEFAULT_LON)})):a.loadAndRenderMap(a.DEFAULT_LAT,a.DEFAULT_LON)}catch(b){a.loadAndRenderMap(a.DEFAULT_LAT,a.DEFAULT_LON)}},loadAndRenderMap:function(a,b){var c=this;"undefined"===typeof google||"undefined"===typeof google.maps?
$.getScript("https://maps.googleapis.com/maps/api/js?key=AIzaSyCcwmRoKyf_54M5IUseZOtUDqivkqW02HI&libraries=places").done(function(d,e){$.getScript("/static_files/markerwithlabel.js").done(function(d,e){c.renderMap(a,b)}).fail(function(a,b,c){console.log("failed to load markerwithlabel")})}).fail(function(a,b,c){console.log("failed to load google maps js")}):c.renderMap(a,b)},switchLocation:function(){var a=this,b=new google.maps.Geocoder,c=a.location_input.val();b.geocode({address:c},function(b,c){c==
google.maps.GeocoderStatus.OK&&(a.map.setCenter(b[0].geometry.location),a.map.setZoom(a.DEFAULT_ZOOM),a.initial_search?a.searchAfterDelay():a.map_search_button.show())})},renderMap:function(a,b){var c=this,d={zoom:c.INITIAL_ZOOM,center:{lat:a,lng:b}};c.markers=[];c.hostnameRegexp=/^https?:\/\/.+?\//;c.info_box_template=ETM.loadTemplate("#MapInfoBoxTemplate");c.map=new google.maps.Map($(".food_search_map",c.el)[0],d);c.location_input=$(".location_input",c.el);c.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(c.map_search_button[0]);
c.search_autocomplete=new google.maps.places.Autocomplete(c.location_input[0]);new google.maps.places.PlacesService(c.map);c.search_autocomplete.addListener("place_changed",function(){c.onPlaceChanged(c);c.initial_search?c.searchAfterDelay():c.map_search_button.show()});c.location_input.on("focus",function(a){c.location_input.focus_val=c.location_input.val()});c.location_input.on("blur",function(a){null!=c.location_input.focus_val&&c.location_input.focus_val!==c.location_input.val()&&c.switchLocation()});
c.location_input.on("keyup",function(a){13===a.which&&c.switchLocation()});c.places=new google.maps.places.PlacesService(c.map);c.map.addListener("dragend",function(){c.map_search_button.show()});c.map.addListener("zoom_changed",function(){c.map_search_button.show()});c.affixMapScrolling();if(a!=c.DEFAULT_LAT&&b!=c.DEFAULT_LON)c.map.setZoom(c.DEFAULT_ZOOM),c.search();else{c.enableSearchFunctions();try{navigator.geolocation.getCurrentPosition(function(a){localStorage.setItem("useMyLocation",1);null!=
a&&(c.map.panTo(new google.maps.LatLng(a.coords.latitude,a.coords.longitude)),c.map.setZoom(c.DEFAULT_ZOOM),c.emptyResults(),c.searchAfterDelay())})}catch(e){}}},affixMapScrolling:function(){var a=this,b=$(".map_box_container",a.el),c=b.offset().top-$(".modal.in").offset().top;a.$el.on("scroll",function(){a.$el.scrollTop()>c?b.addClass("affix"):b.removeClass("affix")})},onPlaceChanged:function(a){var b=a.search_autocomplete.getPlace();b.geometry&&(a.map.panTo(b.geometry.location),a.map.setZoom(this.DEFAULT_ZOOM))},
searchAfterDelay:function(){var a=this;setTimeout(function(){a.search()},300)},search:function(){this.initial_search=!1;this.map_search_button.hide();$(".search_error",this.el).remove();this.isMapSearchType()?this.searchForRestaurantsNearby():this.searchForSpecificRestaurant()},buildFourSquareQueryString:function(a){var b=this.map.data.map.center.lat(),c=this.map.data.map.center.lng();return"https://api.foursquare.com/v2/venues/search?ll="+encodeURIComponent(b.toString()+","+c.toString())+"&client_id="+
ETM.FSQUARE_CLIENT_ID+"&client_secret="+ETM.FSQUARE_CLIENT_SECRET+"&categoryId="+a+"&radius="+this.form.getValue().search_radius+"&v="+ETM.FSQUARE_VERSION_DATE+"&limit=50&m=foursquare"},generateFourSquareSearchPromise:function(a,b){amplitude.logEvent("foursquare_nearby_search");amplitude.logEvent("foursquare_search");$.get(this.buildFourSquareQueryString(b),function(b){if(200==b.meta.code){var d=[];b.response.venues.forEach(function(a){d.push(new ETM.FourSquareMapDataObject(a))});a.resolve(d)}else a.resolve([])})},
searchFourSquareForRestaurantsNearby:function(){this.disableSearchFunctions();var a=$.Deferred();this.generateFourSquareSearchPromise(a,ETM.FSQUARE_SEARCH_CATEGORIES_1);var b=$.Deferred();this.generateFourSquareSearchPromise(b,ETM.FSQUARE_SEARCH_CATEGORIES_2);var c=$.Deferred();this.generateFourSquareSearchPromise(c,ETM.FSQUARE_SEARCH_CATEGORIES_3);return[a.promise(),b.promise(),c.promise()]},searchForRestaurantsNearby:function(){var a=this,b=this.searchFourSquareForRestaurantsNearby();$.when.all(b).then(function(b){var d=
[],e={};b.forEach(function(a){if("undefined"!==typeof a)for(var b=0;b<a.length;b++){var c=a[b];_.has(e,c.id)||(d.push(c),e[c.id]=!0)}});a.renderNearbySearchResults(d)})},searchFourSquareForSpecificRestaurant:function(a){var b=$.Deferred(),c=this.map.data.map.center.lat(),d=this.map.data.map.center.lng();amplitude.logEvent("foursquare_specific_search");amplitude.logEvent("foursquare_search");null!=a&&$.get("https://api.foursquare.com/v2/venues/search?ll="+encodeURIComponent(c.toString()+","+d.toString())+
"&client_id="+ETM.FSQUARE_CLIENT_ID+"&client_secret="+ETM.FSQUARE_CLIENT_SECRET+"&categoryId="+ETM.FSQUARE_SPECIFIC_SEARCH_CATEGORIES+"&radius="+Math.max(this.form.getValue().search_radius,1E4)+"&v="+ETM.FSQUARE_VERSION_DATE+"&limit="+ETM.FSQUARE_RESULT_LIMIT+"&query="+a+"&m=foursquare",function(a){if(200==a.meta.code){var c=[];a.response.venues.forEach(function(a){c.push(new ETM.FourSquareMapDataObject(a))});b.resolve(c)}else b.resolve([])});return b.promise()},searchForSpecificRestaurant:function(){var a=
this,b=this.getRestaurantNames();this.disableSearchFunctions();var c=[];b.forEach(function(b){c.push(a.searchFourSquareForSpecificRestaurant(b))});$.when.all(c).then(function(b){var c=[],f={};b.forEach(function(a){if("undefined"!==typeof a)for(var b=0;b<a.length;b++){var d=a[b];_.has(f,d.id)||(c.push(d),f[d.id]=!0)}});a.renderNearbySearchResults(c)})},renderNearbySearchResults:function(a){this.clearRenderedRestaurantFoods();this.clearMarkers();this.emptyResults();var b=$(".only_show_restaurants_with_foods",
this.el).is(":checked");this.restaurant_food_map_data=new ETM.RestaurantFoodAndMapData(a,b);this.searchForRestaurantFoods()},disableSearchFunctions:function(){this.map_search_button.prop("disabled",!0);this.map_search_button.addClass("disabled");this.edit_targets_button.prop("disabled",!0);this.edit_targets_button.addClass("disabled");this.redo_search_button.prop("disabled",!0);this.redo_search_button.addClass("disabled");this.sort_by_buttons.prop("disabled",!0);this.sort_by_buttons.addClass("disabled");
this.search_type_buttons.prop("disabled",!0);this.search_type_buttons.addClass("disabled");this.only_show_checkbox.prop("disabled",!0)},enableSearchFunctions:function(){this.map_search_button.prop("disabled",!1);this.map_search_button.removeClass("disabled");this.redo_search_button.prop("disabled",!1);this.redo_search_button.removeClass("disabled");this.edit_targets_button.prop("disabled",!1);this.edit_targets_button.removeClass("disabled");this.sort_by_buttons.prop("disabled",!1);this.sort_by_buttons.removeClass("disabled");
this.search_type_buttons.prop("disabled",!1);this.search_type_buttons.removeClass("disabled");this.only_show_checkbox.prop("disabled",!1)},searchForRestaurantFoods:function(){var a=this;a.results_spinner.show();amplitude.logEvent("/food/search-nearby/");a.food_search_xhr=$.ajax({url:"/food/search-nearby/",data:{restaurants:JSON.stringify(this.restaurant_food_map_data.restaurant_names),meal_id:a.model.attributes.id,targets:a.nutrition_targets_editor.getSerializedTargets()},type:"POST",success:function(b){b=
JSON.parse(b);a.restaurant_food_map_data.addRestaurantMealData(b,a.model.get("meal_type"));a.renderMealResults();a.enableSearchFunctions()},error:function(){a.enableSearchFunctions();a.results_spinner.hide();a.results_container.append('<h4 class="search_error">An error occurred searching for results.</h4>')}})},addRestaurantMarkers:function(){var a=this;if(!(0<a.markers.length)){var b=0,c=0,d=a.restaurant_food_map_data.restaurant_meals_dict,e=a.restaurant_food_map_data.restaurant_name_to_id_dict,
f=a.restaurant_food_map_data.id_to_restaurant_map_result_dict,g=a.restaurant_food_map_data.restaurant_name_to_color_dict;null!=d&&"object"===typeof d&&$.each(d,function(d,l){if(0<l.length||!$(".only_show_restaurants_with_foods",a.el).is(":checked")){var m=Helper.removePunctuationAndLowerCase(d);e[m].forEach(function(d){a.addMarker(b,c,f[d]);b++});g[m]=a.marker_colors[c%a.NUMBER_OF_COLORS];c++}})}},renderRestaurantNameResults:function(){var a=this,b=a.restaurant_food_map_data.restaurant_name_to_id_dict,
c=a.restaurant_food_map_data.restaurant_name_to_color_dict,d=a.restaurant_food_map_data.restaurant_name_sorted_meal_lists;0==d.length&&a.results_content.append("<div>No results found.</div>");d.forEach(function(d,f){var g=Helper.removePunctuationAndLowerCase(d.restaurant_name),g=new ETM.RestaurantResultView({map:a.map,meal_list:d,restaurant_index:f,sanitized_restaurant_name:g,num_locations:b[g].length,color:c[g],markers:a.markers,parent_view:a});a.restaurant_result_views.push(g);a.results_content.append(g.render().el);
g.applyEvents()})},renderNutritionMatchResults:function(){var a=this.restaurant_food_map_data.nutrition_sorted_meals,b=this.restaurant_food_map_data.restaurant_names,c=this.restaurant_food_map_data.restaurant_name_to_id_dict,d=this.restaurant_food_map_data.restaurant_name_to_color_dict;0==a.length?this.results_content.append("<div>No results found.</div>"):this.results_content.append("<br/>");for(var e=$('<div class="row" style="text-align: center; margin-bottom: 20px"><button type="button" class="btn btn-info inline_block" data-toggle="collapse" data-target="#restaurant_show_more_div" aria-expanded="false"> Show more results </button></div>'),
f=$('<div class="collapse" id="restaurant_show_more_div" aria-expanded="false" style="height: 0px;"></div>'),g=0;g<a.length&&g<this.MAX_NUMBER_SORTED_MEALS;g++){var h=a[g],l=new ETM.MealObject({foods:h.foods,meal_type:this.model.get("meal_type"),restaurant_name:h.restaurant_name,score:h.score}),m=Helper.removePunctuationAndLowerCase(h.restaurant_name),h=new ETM.RestaurantNutritionMatchView({map:this.map,meal_object:l,restaurant_index:b.indexOf(h.restaurant_name),sanitized_restaurant_name:m,num_locations:c[m].length,
color:d[m],markers:this.markers,parent_view:this});this.restaurant_result_views.push(h);10>g?this.results_content.append(h.render().el):(10==g&&(this.results_content.append(e),this.results_content.append(f),e.on("click",function(){$(this).remove()})),f.append(h.render().el));h.applyEvents()}},renderMealResults:function(){this.addRestaurantMarkers();this.results_header.show();this.emptyResults();this.isSortByNutritionMatch()?this.renderNutritionMatchResults():this.renderRestaurantNameResults()},pinSymbol:function(a){return{path:"M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0",
fillColor:a,fillOpacity:1,strokeColor:"#000",strokeWeight:1.5,scale:0.9}},addMarker:function(a,b,c){var d=this,e=new MarkerWithLabel({position:new google.maps.LatLng(c.lat,c.lng),labelAnchor:new google.maps.Point(40,-2),labelClass:"map_marker_label",labelContent:c.name,labelInBackground:!0,icon:d.pinSymbol(d.marker_colors[b%d.NUMBER_OF_COLORS])});e.setOptions(d.marker_style);d.markers[a]=e;e.placeResult=c;e.restaurant_index=b;e.sanitizedRestaurantName=Helper.removePunctuationAndLowerCase(c.name);
google.maps.event.addListener(e,"click",function(){d.showInfoWindow(d,this);this.setOptions(d.marker_info_box_style)});google.maps.event.addListener(e,"mouseover",function(){this.zIndex!=d.marker_info_box_style.zIndex&&this.setOptions(d.marker_hover_style)});google.maps.event.addListener(e,"mouseout",function(){this.zIndex!=d.marker_info_box_style.zIndex&&this.setOptions(d.marker_style)});setTimeout(d.dropMarker(a),10)},clearMarkers:function(){for(var a=0;a<this.markers.length;a++)this.markers[a]&&
this.markers[a].setMap(null);this.markers=[]},clearRenderedRestaurantFoods:function(){this.restaurant_result_views.forEach(function(a){a.remove()});this.results_header.hide();this.restaurant_result_views=[]},emptyResults:function(){$(".initial_results_container_text",this.el).remove();this.results_spinner.hide();this.results_content.empty()},dropMarker:function(a){var b=this;return function(){b.markers[a].setMap(b.map)}},showRestaurantResults:function(a){this.sort_mode==this.SORT_BY_NUTRITION_MATCH&&
$(".sort_by_buttons label:not(.active) input",this.el).click();$(".collapse.in:not(#restaurant_"+a+")",this.el).collapse("hide");$(".collapse_button",this.el).html('<span class="glyphicon glyphicon-plus"></span>');this.restaurant_result_views[a].expand()},showInfoWindow:function(a,b){a.infoWindow&&(a.infoWindow.marker.setOptions(a.marker_style),a.infoWindow.close());a.infoWindow=new google.maps.InfoWindow({content:a.info_box_template({place:b.placeResult,restaurant_index:b.restaurant_index})});google.maps.event.addListener(a.infoWindow,
"closeclick",function(){a.infoWindow.marker.setOptions(a.marker_style)});b.setOptions(a.marker_info_box_style);a.infoWindow.marker=b;a.infoWindow.open(a.map,b)},replaceMeal:function(a){var b=this;if(a){var c=[],d={};b.model.attributes.foods.each(function(a){d[a.attributes.food.attributes.id]=a.attributes.amount});_.each(a.attributes.foods.models,function(a){a=a.clone();a.attributes.meal=b.model.id;c.push(a)});_.each(this.model.attributes.foods.models,function(a){(a.attributes.is_leftovers||a.attributes.has_leftovers)&&
a.updateRelatedLeftovers("delete")});this.model.attributes.foods.reset(c);this.model.set("delete_other_foods",!0);this.model.save(null,{success:function(a,c){delete b.model.attributes.delete_other_foods;delete b.model.attributes.delete_other_foods_except;delete b.model.attributes.delete_other_foods_except_leftovers;amplitude.logEvent("swapped_new_meal_combo");b.model.trigger("updateStats");b.$el.modal("hide");new_meal_obj=b.model.clone();ETM.analytics.logMealRefresh(d,new_meal_obj,ETM.MAP_SEARCH_MEAL_CHOSEN);
ETM.calendar_view.single_day_view.trigger("swap_complete")}})}else console.log("FAILED TO FIND THE MEAL TO SWAP")}});
ETM.MealListView=Backbone.View.extend({initialize:function(){this.is_diet_set=_.has(this.model,"diet")&&_.has(this.model.diet,"is_diet_set")&&this.model.diet.is_diet_set;this.meal_views=[];this.applyEvents()},applyEvents:function(){var a=this;this.listenTo(this.model,"reset",function(){this.render()},this);this.listenTo(this.model,"add",function(b){b=(new ETM.MealObjectView({model:b,is_diet_set:a.is_diet_set})).render();a.meal_views.push(b);a.$el.append(b.el)})},render:function(){var a=this;this.$el.empty();
_.each(this.model.models,function(b){b=(new ETM.MealObjectView({model:b,is_diet_set:a.is_diet_set})).render();a.meal_views.push(b);a.$el.append(b.el)},this);return this},onClose:function(){_.each(this.meal_views,function(a){a.close()},this);this.meal_views=null}});
ETM.MealObjectView=Backbone.View.extend({tagName:"div",className:"meal_box",events:{"click .meal_refresh_btn":"shuffleMeal","click .edit_meal_type":"editMealType","click .meal_options_dropdown_button":"showMealTypeDropdown","click .create_meal_type":"createMealType","click .i_ate_this":function(a){$(a.currentTarget).toggleClass("i_ate_this_on").toggleClass("i_ate_this_off");this.model.save({eaten:!this.model.attributes.eaten},{patch:!0});ETM.calendar_view.trigger("meal_eaten_update")},"click .meal_thumb_icon":function(a){$(a.currentTarget).prop("disabled")||
this.toggleThumb($(a.currentTarget))},"click .swap_food":function(){var a=new ETM.SwapMealModalView({model:this.model});$("#swap_food_modal",ETM.$modal_content).html(a.render().el);a.$el.modal("show")},"click .search_map":function(){var a=new ETM.MapSearchModalView({model:this.model});ETM.map_search=a;$("#map_search_modal",ETM.$modal_content).html(a.render().el);a.$el.modal("show");a.$el.one("shown.bs.modal",function(){a.displayMap()});a.$el.one("hidden.bs.modal",function(){a.close();$("#map_search_modal",
ETM.$modal_content).empty()})},"click .list_meal_combos":function(){var a=new ETM.ListMealCombosModalView({model:this.model});$("#list_meals_modal",ETM.$modal_content).html(a.render().el);a.$el.modal("show")},"click .add_restaurant_food":function(){var a=this,b=new ETM.CustomFoodList([],{url:ROOT+"/customfood/"});this.listenTo(b,"add",function(b){ETM.sidebar_view.custom_foods_view.collection&&ETM.sidebar_view.custom_foods_view.collection.add(b);ETM.food_info_object_list.add(b.attributes.food);a.food_list.collection.add(new ETM.FoodObject({amount:b.attributes.amount,
units:b.attributes.units,food:b.attributes.food}))});amplitude.logEvent("add_restaurant_food_shortcut");b=new ETM.AteOutFormView({model:b.food_info_object_list});$("#ate_out_modal",ETM.$modal_content).html(b.render().el);b.$el.modal("show")},"click .add_food":function(){var a=this,b=new ETM.CustomFoodList([],{url:ROOT+"/customfood/"});this.listenTo(b,"add",function(b){ETM.sidebar_view.custom_foods_view.collection&&ETM.sidebar_view.custom_foods_view.collection.food_info_object_list.add(b.attributes.food);
ETM.food_info_object_list.add(b.attributes.food);a.food_list.collection.add(new ETM.FoodObject({amount:b.attributes.amount,units:b.attributes.units,food:b.attributes.food}))});amplitude.logEvent("add_custom_food_shortcut");b=new ETM.CustomFoodFormView({model:b.food_info_object_list});$("#quick_add_modal",ETM.$modal_content).html(b.render().el);b.$el.modal("show")},"click .search_foods":function(){ETM.sidebar_view.toggleFoodBank("open");ETM.sidebar_view.showRecipes();amplitude.logEvent("search_foods_shortcut")},
"click .search_restaurant_foods":function(){ETM.sidebar_view.toggleFoodBank("open");ETM.sidebar_view.showRestaurantFoods();amplitude.logEvent("search_restaurant_foods_shortcut")}},toggleThumb:function(a){if(!ETM.is_logged_in)return!1;var b=a.siblings(".meal_thumb_icon");a.prop("disabled",!0);b.prop("disabled",!0);ETM.local_variables.attributes.seen_meal_rating_info||(this.showThumbInfoPopup(a),ETM.local_variables.save({seen_meal_rating_info:!0}));a.toggleClass("active").toggleClass("inactive");if(a.hasClass("active")){b.hasClass("active")&&
b.toggleClass("active").toggleClass("inactive");var c=a.hasClass("meal_thumbs_up")?2:1}else c=0;var d=function(){a.prop("disabled",!1);b.prop("disabled",!1)};this.is_swap_meal?this.model.saveThumbRating(c,this.meal_type_id,this.meal_number,this.num_meals,d):this.model.saveThumbRating(c,null,null,null,d)},reAddThumbButtonEvent:function(){events=_.result(this,"events");var a=this.events["click .meal_thumb_icon"],b="click",a=_.bind(a,this),b=b+(".delegateEvents"+this.cid);this.$el.on(b,".meal_thumb_icon",
a);return this},showThumbInfoPopup:function(a){Helper.oneTimePopover(a,"top","Use the thumb ratings to help our algorithms learn which foods go well together in a meal.<div class='small_top_spacer row'><div class='col-xs-1' style='padding-right: 0px;'><img width='16' src='/static_files/images/thumb_up_green.png'></div><div class='col-xs-11'>I <strong>like</strong> the combination of foods in this meal.</div></div><div class='row'><div class='col-xs-1' style='padding-right: 0px;'><img width='16' src='/static_files/images/thumb_down_red.png'></div><div class='col-xs-11'>I <strong>dislike</strong> the combination of foods in this meal.</div></div><p class='small_top_spacer'>The more you rate, the better it gets!</p><p>Also, Favorite/Block specific foods to send an even stronger signal about what you do/don't like.</p>",
"Rating your meals",!0,"meal_rating_info_popup")},showThumbsDownCaveatTooltip:function(){if(!ETM.local_variables.attributes.seen_thumbs_down_temp_tooltip&&!is_mobile&&ETM.is_logged_in&&1===this.model.getThumbRating())Helper.oneTimePopover($(".meal_thumbs_down",this.el),"top","<p>Sorry for showing you this meal again! You gave it a thumbs-down, but our algorithms struggled to find a better meal for your preferences. If this meal keeps appearing, try blocking specific foods.</p>","Refresh me!",!0,"meal_rating_info_popup",
function(){ETM.local_variables.save({seen_thumbs_down_temp_tooltip:!0})})},updateThumbRatingView:function(){var a=this.model.getThumbRating(),b=$(".meal_thumbs_up",this.el),c=$(".meal_thumbs_down",this.el);2==a?(b.addClass("active").removeClass("inactive"),c.addClass("inactive").removeClass("active")):1==a?(c.addClass("active").removeClass("inactive"),b.addClass("inactive").removeClass("active")):(b.removeClass("active").addClass("inactive"),c.removeClass("active").addClass("inactive"))},initialize:function(a){this.is_diet_set=
!1;"undefined"!==typeof a&&_.has(a,"is_diet_set")&&a.is_diet_set&&(this.is_diet_set=!0);this.listenTo(this.model,"switchedMealTypes changedMealType",this.updateMealTypeTitle,this);this.listenTo(this.model,"switchedMealTypes",function(){ETM.use_local_storage?(this.model.set({meal_type:this.model.attributes.meal_type.attributes.resource_uri}),ETM.current_diet.save()):(this.model.save({meal_type:this.model.attributes.meal_type.attributes.resource_uri},{patch:!0}),this.updateThumbRatingView())},this);
var b=this;this.listenTo(this.model,"updateStats",function(a,d){b.updateThumbRatingView();b.renderStats()});this.listenTo(this.model,"parent_diet_finished_generating",function(a,d){b.showThumbsDownCaveatTooltip()})},render:function(){var a=this.model.getThumbRating();ETM.is_mobile&&!ETM.is_tablet?this.$el.html(ETM.loadTemplate("#MobileMealObjectView")({attributes:this.model.attributes,is_premium:ETM.is_premium,cid:this.model.cid,is_diet_set:this.is_diet_set,thumb_rating:a})):this.$el.html(this.template({attributes:this.model.attributes,
is_premium:ETM.is_premium,cid:this.model.cid,is_diet_set:this.is_diet_set,thumb_rating:a}));this.food_list||(this.food_list=new ETM.FoodListView({collection:this.model.attributes.foods,el:$(".meal_foods",this.el)}),this.food_list.render());this.meal_options=new ETM.MealOptionsDropdownView({model:this.model});this.renderStats();this.meal_options.$el=$(".meal-options-dropdown-menu",this.el);this.meal_options.delegateEvents({"click .other_meal_type":"switchMealTypes","click .delete_meal_type":"deleteMealType"});
this.model.checkRecurringFoods();return this},onClose:function(){this.stopListening();this.food_list.close();this.meal_options.close();this.meal_stats_view.close();null!=this.create_meal_type&&(this.create_meal_type.close(),this.create_meal_type=null);this.meal_stats_view=this.meal_options=this.food_list=null},renderEditMealType:function(){this.edit_meal_type=new ETM.EditMealTypeView({model:this.model.get("meal_type")},{meal:this.model});$("#edit_meal_type_modal",ETM.$modal_content).html(this.edit_meal_type.render().el)},
renderCreateMealType:function(){this.create_meal_type=new ETM.EditMealTypeView({model:new ETM.MealType},{meal:this.model});$("#edit_meal_type_modal",ETM.$modal_content).html(this.create_meal_type.render().el)},renderStats:function(){this.meal_stats_view&&this.meal_stats_view.close();this.meal_stats_view=new ETM.MealStatsView({model:this.model});$(".meal_stats",this.el).html(this.meal_stats_view.render().el)},showMealTypeDropdown:function(){this.meal_options.render()},editMealType:function(){this.renderEditMealType();
this.edit_meal_type.renderForm();this.edit_meal_type.$el.modal("show")},createMealType:function(){this.renderCreateMealType();this.create_meal_type.model=new ETM.MealType;this.create_meal_type.renderForm();this.create_meal_type.$el.modal("show")},updateMealTypeTitle:function(){$(".print_meal_title",this.el).html(this.model.get("meal_type").get("title"))},updateDietAndRender:function(a){var b=this;b.model.trigger("updateStats");Helper.retainPageHeight(function(){null!=b.food_list&&(b.food_list.close(),
b.food_list=null);b.render();$(a.currentTarget).fadeTo("slow",1).removeAttr("disabled");ETM.currently_generating=!1})},shuffleMeal:function(a){var b=this;if(!ETM.currently_generating)if(this.model.attributes.eaten){var c=$(a.currentTarget).parent().parent().next().find(".i_ate_this_text");c.effect("shake");Helper.oneTimeTooltip(c,"top","This meal is locked since it's marked as eaten. Uncheck 'I ate this' to regenerate it.",3E3)}else $(a.currentTarget).stop(),a.currentTarget.style.opacity=0.7,$(a.currentTarget).attr("disabled",
"true"),this.model.shuffleMeal(function(){b.updateDietAndRender(a);b.model.trigger("parent_diet_finished_generating")})}});
ETM.MealOptionsDropdownView=Backbone.View.extend({render:function(){var a=this;this.current_meal_type=this.model.get("meal_type");this.other_meal_types=[];ETM.meal_type_list.forEach(function(b){b.id==a.current_meal_type.id||b.attributes.deleted||a.other_meal_types.push(b)});this.$el.html(this.template({current_meal_type:this.current_meal_type,other_meal_types:this.other_meal_types,is_logged_in:ETM.is_logged_in}));return this},deleteMealType:function(a){a.stopPropagation();a=parseInt(a.currentTarget.id);
this.other_meal_types[a].attributes.deleted=1;this.other_meal_types[a].save(null,{validate:!1});this.render()},switchMealTypes:function(a){a.stopPropagation();a=parseInt(a.currentTarget.id);a=this.other_meal_types[a];this.model.set("meal_type",a);this.current_meal_type=a;this.render();this.model.trigger("switchedMealTypes")}});
ETM.MealStatsView=Backbone.View.extend({render:function(){this.model.calorie_printout=roundNumber(this.model.stats.calories,1);this.$el.html(this.template(this.model));this.applyTooltip();this.applyGraphRender();return this},updateStatsTooltip:function(){this.model.calorie_printout=roundNumber(this.model.stats.calories,1);this.$el.html(this.template(this.model));var a=getStatsHTML(this.model.stats);this.$el.attr("title",mealStatsTooltipHTML(this.model.attributes.meal_number,a)).tooltip("fixTitle");
return this},applyTooltip:function(){var a=getStatsHTML(this.model.stats);placement=ETM.is_mobile?"left":"right";this.$el.tooltip({title:mealStatsTooltipHTML(this.model.attributes.meal_number,a),html:!0,animation:!1,placement:placement})},applyGraphRender:function(){var a=this;this.$el.mouseover(function(){setTimeout(function(){a.renderTooltipGraph(a)},1)})},renderTooltipGraph:function(a){var b="mealgraph"+a.model.attributes.meal_number;0!=a.model.stats.calories&&miniGraph(a.model.stats,b)}});
ETM.SwapMealObjectView=ETM.MealObjectView.extend({initialize:function(a){var b=this;this.show_missing_ingredients=!1;this.listenTo(this.model,"updateStats",function(a,d){b.renderStats()});this.is_swap_meal=!0;a.meal_type_id&&(b.meal_type_id=a.meal_type_id,b.meal_number=a.meal_number,b.num_meals=a.num_meals)},render:function(){var a=0,b=0;this.show_missing_ingredients&&this.model.attributes.foods.each(function(c){_.has(c.attributes.food.attributes,"missing_ingredients")&&(a+=parseInt(c.attributes.food.attributes.missing_ingredients));
b=_.has(c.attributes.food.attributes,"number_of_ingredients")&&0<c.attributes.food.attributes.number_of_ingredients?b+c.attributes.food.attributes.number_of_ingredients:b+1});var c=this.model.getThumbRating(self.meal_type_id);this.$el.html(this.template({show_missing_ingredients:this.show_missing_ingredients,total_ingredients:b,total_owned_ingredients:b-a,attributes:this.model.attributes,is_premium:ETM.is_premium,cid:this.model.cid,thumb_rating:c}));this.food_list||this.renderFoodList();this.renderStats();
this.model.checkRecurringFoods();return this},renderFoodList:function(){this.food_list=new ETM.FoodListView({collection:this.model.attributes.foods,el:$(".meal_foods",this.el)});this.food_list.render()}});
ETM.SwapRestaurantMealObjectView=ETM.SwapMealObjectView.extend({className:"meal_box",renderFoodList:function(){var a=this;this.food_list=new ETM.RestaurantFoodListView({collection:this.model.attributes.foods,el:$(".meal_foods",this.el)});this.food_list.render();$(".replace_meal_button",this.el).on("click",function(){a.model.parent_view.trigger("replace_with_meal",a.model)})}});
ETM.EditMealTypeView=ModalView.extend({className:"modal fade",id:"edit_meal_type_modal",initialize:function(a,b){null!=b&&null!=b.meal&&(this.meal=b.meal)},events:{"click #meal_type_save_changes":"saveMealType","click #remove_delete":"removeDelete","click .close_modal":"closeModal","click .replace-button":function(a){var b=this;a.preventDefault();ETM.meal_type_list.filter(function(a){return a.attributes.title===b.form.getValue().title&&!a.deleted&&(null==b.model.attributes.user_id||a.attributes.user_id==
b.model.attributes.user_id)&&a.id!==b.model.id}).forEach(function(a){a.save({title:findNextAvailableTitle(ETM.meal_type_list,a.attributes.title)},{validate:!1})});$(".meal_type_error",this.el).remove()}},render:function(){this.$el.html(this.template(this.model));this.$el.modal({show:!1});this.renderForm();return this},closeModal:function(){this.trigger("closedModal");this.$el.modal("hide")},renderForm:function(){this.form=(new Backbone.Form({model:this.model,template:Helper.createTemplateFunction($("#editMealTypeFormTemplate",
this.el).html())})).render();$("#edit_meal_type_body",this.el).html(this.form.el);0===this.model.get("max_cooktime")?($("#cant_cook",this.el).addClass("active"),$("#cant_cook .btn",this.el).checked=!0):1===this.model.get("min_cooktime")?($("#must_cook",this.el).addClass("active"),$("#must_cook .btn",this.el).checked=!0):($("#can_cook",this.el).addClass("active"),$("#can_cook .btn",this.el).checked=!0);$(".family_scale_tooltip",this.el).tooltip({placement:"right",html:!0,title:'<p align="left">When the weekly planner generates your grocery list, it will multiply the number of ingredients needed for this meal by the number of people selected here.</p><p align="left">Check out the Knowledge Base in the Help menu for tips on making this work for people with different nutrition targets (search "family meal").</p>'});
$(".only_use_recurring_tooltip",this.el).tooltip({placement:"right",html:!0,title:'<p align="left">When the generator creates this meal, it will only use the "Recurring foods" that you\'ve selected. This lets you completely customize the generator\'s output.</p><p align="left">If you haven\'t selected any recurring foods and you check this box, the generator will leave this meal empty.</p>'});$(".meal_complexity_tooltip",this.el).popover({placement:"top",html:!0,trigger:"hover",content:'<p align="left">Low complexity gives fewer foods per meal and recipes have fewer ingredients. Higher complexity tends to give more interesting recipes and has better variety, but the grocery list also gets longer.</p><p align="left"><span class="label label-info">Tip</span> Try changing these settings around and regenerating the meals to see how they affect your results.</p>'});
this.renderSliders();this.toggleSaveButton()},renderSliders:function(){var a=this;$("#meal-type-size",this.el).hide();var b=$(".size_slider",this.el),c=this.model.schema.size_slider.options;$(".size_slider_label",a.el).html(c[(parseInt(this.model.attributes.size_slider)-50)/25].label);b.slider({range:"min",min:c[0].val,max:c[c.length-1].val,step:25,value:this.model.attributes.size_slider,slide:function(b,e){$(".size_slider_label",a.el).html(c[(parseInt(e.value)-50)/25].label);$("#meal-type-size select",
a.el).val(e.value)}})},toggleSaveButton:function(){this.model.attributes.deleted?($("#meal_type_save_changes",this.el).hide(),$("#deleted_meal_type_warning",this.el).html("<div class='alert alert-danger'>This meal type was previously deleted.<button class='btn btn-default' id='remove_delete'>Undo the delete</button></div>")):($("#deleted_meal_type_warning",this.el).html(""),$("#meal_type_save_changes",this.el).show())},removeDelete:function(a){a.preventDefault();this.model.attributes.deleted=!1;ETM.meal_type_list.findWhere({id:this.model.attributes.id}).attributes.deleted=
!1;this.model.save();this.toggleSaveButton()},saveMealType:function(a){a.preventDefault();a=this.form.commit({validate:!0});if("undefined"===typeof a){var b=this,c="undefined"===typeof this.model.attributes.id;$("#cant_cook",this.el).hasClass("active")?(this.model.set("min_cooktime",0),this.model.set("max_cooktime",0)):$("#must_cook",this.el).hasClass("active")?(this.model.set("min_cooktime",1),this.model.set("max_cooktime",this.model.get("max_totaltime"))):(this.model.set("min_cooktime",0),this.model.set("min_preptime",
0),this.model.set("max_cooktime",this.model.get("max_totaltime")),this.model.set("max_preptime",this.model.get("max_totaltime")));this.model.save(null,{success:function(a,d){c&&ETM.meal_type_list.add(a);null!=b.meal&&(b.meal.attributes.meal_type=a,c?b.meal.trigger("switchedMealTypes"):b.meal.trigger("changedMealType"));b.trigger("closedModal");b.$el.modal("hide")}})}else for(var d in a)$('[data-editors="'+d+'"]').append('<div class="alert alert-danger meal_type_error" style="float:left">'+a[d].message+
"</div>")}});
ETM.NotificationViews=Backbone.View.extend({events:{},initialize:function(){this.current_modal=null},initializeEvents:function(a){var b=this;this.current_modal.$el.one("hide.bs.modal",function(a){a=$("input#dont_show_me_again",b.current_modal.$el).is(":checked");b.current_modal.closingNotification(a)});this.current_modal.$el.one("hidden.bs.modal",function(c){b.current_modal.remove();a()})},showRefreshLeftoversInfo:function(a){app||this.model.attributes.seen_refresh_leftovers_info&&(!this.model.attributes.seen_refresh_leftovers_info||this.model.attributes.dont_show_refresh_leftovers_info)?
a():(this.current_modal=new ETM.RefreshLeftoversInfoModal({model:this.model}),$("#notifications_modal").html(this.current_modal.render().el),this.current_modal.$el.modal("show"),this.initializeEvents(a))}});
ETM.RefreshLeftoversInfoModal=ModalView.extend({className:"modal fade",events:{},initialize:function(a){this.dont_show_again=this.model.attributes.dont_show_refresh_leftovers_info;this.is_diet=a.is_diet},render:function(){this.$el.html(this.template({dont_show_again:this.dont_show_again,is_diet:this.is_diet}));this.$el.modal({show:!1});return this},closingNotification:function(a){this.model.attributes.seen_refresh_leftovers_info=!0;this.model.attributes.dont_show_refresh_leftovers_info=a;this.model.save()}});
ETM.NutritionTargetsView=Backbone.View.extend({events:{"click .edit_meal_options":"editNutritionProfile","click .create_profile_btn":"createNutritionProfile","click .nutrition_targets_dropdown_button":"renderDropdown"},initialize:function(){this.initializeEvents()},initializeEvents:function(){null!=this.model?this.listenTo(this.model,"nutritionProfileUpdated switchedNutritionProfiles change:nutrition_profile",this.updateCurrentNutritionProfile,this):_errs.push(Error("Null nutrition profile"))},updateCurrentNutritionProfile:function(){null==
this.nutritionTargetsDetails&&this.render();$(".nutrition_targets_title",this.el).text(this.model.attributes.nutrition_profile.attributes.title);this.nutritionTargetsDetails.render();this.renderDropdown()},render:function(){this.current_nutrition_profile=this.model.attributes.nutrition_profile;this.nutritionTargetsDetails=new ETM.NutritionTargetsDetailsView({model:this.model});this.dropdown=new ETM.NutritionTargetsDropdownView({model:this.model});this.$el.html(this.template({current_profile:this.current_nutrition_profile}));
$(".nutrition_targets_details",this.el).html(this.nutritionTargetsDetails.render().el);this.dropdown.$el=$("#nutrition_targets_dropdown",this.el);return this},renderDropdown:function(){this.dropdown.render();this.dropdown.delegateEvents({"click .other_profile":"switchNutritionProfiles","click .delete_profile":"deleteNutritionProfile"})},editNutritionProfile:function(){this.initializeEditNutritionModal(this.model.attributes.nutrition_profile.clone())},createNutritionProfile:function(){this.initializeEditNutritionModal(new ETM.NutritionProfile)},
initializeEditNutritionModal:function(a){this.editNutrition=new ETM.EditNutritionTargetsModalView({model:a},{diet:this.model});this.listenTo(this.editNutrition,"openNutritionCalculator",this.showNutritionCalculator,this);this.nutritionCalculator=new ETM.NutritionCalculatorView({model:ETM.current_user_profile},{nutrition_profile:a,go_back_enabled:!0,show_profile_alert:!0});this.listenTo(this.nutritionCalculator,"useCalculatedSettings",this.showEditNutritionModal,this);this.listenTo(this.nutritionCalculator,
"openEditNutritionTargets",this.showEditNutritionModal,this);$("#targets_modal",ETM.$modal_content).html(this.editNutrition.render().el);$("#nutrition_calculator_modal",ETM.$modal_content).html(this.nutritionCalculator.render().el);this.showEditNutritionModal()},showEditNutritionModal:function(){this.editNutrition.updateNutritionTargets();this.editNutrition.$el.modal("show")},showNutritionCalculator:function(){this.nutritionCalculator.renderForm();this.nutritionCalculator.renderHeightAndWeight();
this.nutritionCalculator.$el.modal("show")}});ETM.NutritionTargetsDetailsView=Backbone.View.extend({render:function(){this.current_nutrition_profile=this.model.attributes.nutrition_profile;this.$el.html(this.template({current_profile:this.current_nutrition_profile}));return this}});
ETM.NutritionTargetsDropdownView=Backbone.View.extend({render:function(){var a=this;this.current_nutrition_profile=this.model.attributes.nutrition_profile;this.other_profiles=[];ETM.nutrition_profile_list.each(function(b){b.id==a.current_nutrition_profile.id||b.attributes.deleted||a.other_profiles.push(b)});this.$el.html(this.template({current_profile:this.current_nutrition_profile,other_profiles:this.other_profiles,is_logged_in:ETM.is_logged_in}));return this},deleteNutritionProfile:function(a){a.stopPropagation();
a=parseInt(a.currentTarget.id);this.other_profiles[a].attributes.deleted=1;this.other_profiles[a].save(null,{validate:!1});ETM.nutrition_profile_list.remove(this.other_profiles[a]);this.render()},switchNutritionProfiles:function(a){a.stopPropagation();a=parseInt(a.currentTarget.id);a=this.other_profiles[a];this.model.save({nutrition_profile:a},{patch:!0});this.model.trigger("switchedNutritionProfiles");this.current_nutrition_profile=a;this.render()}});
ETM.MealNutritionTargetsView=Backbone.View.extend({events:{"click .reset_nutrition_button":"resetNutritionTargets","click .edit_meal_nutrition_targets":"toggleNutritionTargetsPopover"},initialize:function(a,b){this.nutrition_target_storage=new ETM.SimpleNutritionProfile;this.nutrition_target_storage.fetch();this.default_targets=this.getDefaultTargets();this.targets_dict=_.clone(this.default_targets)},render:function(){this.$el.html(this.template({targets:this.targets_dict,nutrition_profile:this.nutrition_target_storage}));
this.popover_button=$(".edit_meal_nutrition_targets",this.el);this.renderTargetsString();this.renderNutritionTargetsPopover();return this},renderTargetsString:function(){var a=this.targets_dict.calories+" Calories, "+this.targets_dict.min_carbs+"-"+this.targets_dict.max_carbs+"g carbs, "+this.targets_dict.min_fats+"-"+this.targets_dict.max_fats+"g fat, "+this.targets_dict.min_proteins+"-"+this.targets_dict.max_proteins+"g protein";$(".restaurant_nutrition_targets",this.el).html(a);this.showResetButton()},
showResetButton:function(){var a=!1,b;for(b in this.targets_dict)if(this.targets_dict.hasOwnProperty(b)&&this.targets_dict[b]!==this.default_targets[b]){a=!0;break}a?$(".reset_nutrition_div",this.el).show():$(".reset_nutrition_div",this.el).hide()},resetNutritionTargets:function(){this.targets_dict=_.clone(this.default_targets);this.renderTargetsString();this.parent.search()},getDefaultTargets:function(){var a=getMealConstraints(ETM.diet_list.findWhere({resource_uri:this.model.attributes.diet_plan}),
this.model.attributes.meal_number);cleanConstraints(a);return a},getSerializedTargets:function(){return JSON.stringify(this.targets_dict)},renderNutritionTargetsPopover:function(){var a=this.nutrition_target_storage.attributes.customized_targets?new ETM.SimpleNutritionProfile(this.nutrition_target_storage.attributes):new ETM.SimpleNutritionProfile(this.targets_dict);this.nutrition_form_view||(this.nutrition_form_view=new ETM.MiniNutritionTargetsView({model:a}),this.nutrition_form_view.parent=this);
this.popover_button.popover({placement:"bottom",html:!0,container:"#mealCombosModalTemplate",title:"Customize nutrition filters",template:'<div class="targets_popover popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',content:this.nutrition_form_view.render().el,trigger:"manual"})},toggleNutritionTargetsPopover:function(){this.popover_button.popover("toggle")},closeNutritionTargetsPopover:function(){this.popover_button.popover("hide")},
loadTargetsAndRender:function(){this.targets_dict.calories=this.nutrition_form_view.model.attributes.calories;this.targets_dict.min_carbs=this.nutrition_form_view.model.attributes.min_carbs;this.targets_dict.max_carbs=this.nutrition_form_view.model.attributes.max_carbs;this.targets_dict.min_fats=this.nutrition_form_view.model.attributes.min_fats;this.targets_dict.max_fats=this.nutrition_form_view.model.attributes.max_fats;this.targets_dict.min_proteins=this.nutrition_form_view.model.attributes.min_proteins;
this.targets_dict.max_proteins=this.nutrition_form_view.model.attributes.max_proteins;this.closeNutritionTargetsPopover();this.renderTargetsString();this.parent.search()}});
ETM.MiniNutritionTargetsView=ETM.EditNutritionTargetsView.extend({events:{"click #increase_macro_maximums":"increaseMacroMaximums","click #decrease_macro_minimums":"decreaseMacroMinimums","change #2nd_cal_input input":"caloriesChangedCheck","change #fats div input":"updateFats","change #carbs div input":"updateCarbs","change #proteins div input":"updateProteins","click .cancel_meal_targets":"closeForm","click .close_popover":"closeForm","click .save_meal_targets":"saveChanges"},initialize:function(a,
b){},changeMacroScheme:function(){$(".macro_ranges",this.el).show()},schema:{calories:{type:"PositiveNumber"},max_carbs:"PositiveNumber",max_fats:"PositiveNumber",max_proteins:"PositiveNumber",min_carbs:"PositiveNumber",min_fats:"PositiveNumber",min_proteins:"PositiveNumber"},renderForm:function(){this.form=(new Backbone.Form({model:this.model,template:Helper.createTemplateFunction($("#smallEditNutritionFormTemplate",this.el).html()),schema:this.schema})).render();$(".editTargetsForm",this.el).html(this.form.el);
this.min_carbs_input=$("#carbs .min_input input",this.el);this.min_fats_input=$("#fats .min_input input",this.el);this.min_proteins_input=$("#proteins .min_input input",this.el);this.max_carbs_input=$("#carbs .max_input input",this.el);this.max_fats_input=$("#fats .max_input input",this.el);this.max_proteins_input=$("#proteins .max_input input",this.el)},closeForm:function(){this.parent.closeNutritionTargetsPopover()},saveChanges:function(){$(".nutrition_profile_error",this.el).remove();var a=this.form.commit({validate:!0});
"undefined"===typeof a&&this.checkIfValidCalories()?(this.saveTargetsToLocalStorage(),this.parent.loadTargetsAndRender()):this.renderErrors(a);return!1},saveTargetsToLocalStorage:function(){this.parent.nutrition_target_storage.save({customized_targets:!0,calories:this.model.attributes.calories,min_carbs:this.model.attributes.min_carbs,max_carbs:this.model.attributes.max_carbs,min_fats:this.model.attributes.min_fats,max_fats:this.model.attributes.max_fats,min_proteins:this.model.attributes.min_proteins,
max_proteins:this.model.attributes.max_proteins})}});
ETM.ParseIngredientsListView=Backbone.View.extend({initialize:function(a){this.results=[];"undefined"!==typeof a&&a.results&&(this.results=a.results)},render:function(){var a=this;this.$el.html(this.template());a.ingredients_views=[];$(".parse_results",a.el).html("<h3>Matched ingredients</h3><p>Confirm the ingredient matches we made. See a match that you don't like? View alternatives and select a different food, or drag in a different food from the Food Bank.</p>");a.results.ingredient_matches.forEach(function(b){b=
new ETM.ParseSingleIngredientView({parsed_ingredient:b});b.render();a.ingredients_views.push(b);$(".parse_results",a.el).append(b.el)});return this}});
ETM.ParseSingleIngredientView=Backbone.View.extend({"class":"parse_ingredient_view",events:{"click .edit_parsed_text":function(){$(".edit_parsed_text_div",this.el).show();$(".parsed_text_div",this.el).hide()},"click .cancel_search":function(){$(".edit_parsed_text_div",this.el).hide();$(".parsed_text_div",this.el).show()},"click .redo_parse_search":function(a){if($(".ingredient_text_to_parse",this.el).val()===this.match_string)$(".parsed_text_div",this.el).show(),$(".edit_parsed_text_div",this.el).hide();
else if(!this.currently_parsing){var b=$(a.currentTarget).ladda();b.ladda("start");this.searchAndRender(!1,function(){b.ladda("stop")})}},"click .search_alternates":function(){var a=this;$(".search_alternates",a.el).prop("disabled",!0);$(".parse_spinner",a.el).show();this.searchAndRender(!0,function(){$(".matches_row .diet_draggable",a.el).not(":visible").slideDown();$(".drag_suggestion",a.el).slideDown();$(".view_more_link",a.el).hide()})},"click .expand_alternates":function(){$(".matches_row .diet_draggable",
this.el).not(":visible").slideDown();$(".drag_suggestion",this.el).slideDown();$(".view_more_link",this.el).hide()}},searchAndRender:function(a,b){a=a||!1;var c=this,d=$(".ingredient_text_to_parse",this.el).val();this.currently_parsing=!0;$(".redo_parse_search",c.el).prop("disabled",!0);$(".ingredient_text_to_parse",c.el).prop("disabled",!0);$(".parse_spinner",c.el).show();$.ajax({url:"/recipe/parse-ingredients/",data:{ingredients:d,force_text_search:a},type:"POST",success:function(a){c.currently_parsing=
!1;$(".ingredient_text_to_parse",c.el).prop("disabled",!1);$(".redo_parse_search",c.el).prop("disabled",!1);$(".parse_spinner",c.el).hide();a=JSON.parse(a);0<a.ingredient_matches.length&&(c.parsed_ingredient=a.ingredient_matches[0],add_food_info_objects(a.info_objs),c.render());"undefined"!==typeof b&&b()},error:function(a,b,d){console.log(b);$(".enter_ingredients_textbox",c.el).prop("disabled",!1);$(".parse_ingredients_text",c.el).prop("disabled",!1);$(".parse_spinner",c.el).hide();c.currently_parsing=
!1;c.showNormalIngredients()}})},initialize:function(a){this.parsed_ingredient=a.parsed_ingredient;this.currently_parsing=!1},render:function(){var a=null,b=null;$.each(this.parsed_ingredient,function(c,d){a=c;b=d});this.match_string=a;this.$el.html(this.template({match_string:a,match_values:b}));var c=new ETM.IngredientsList;b.forEach(function(a){var b=null!=a.parsed_directions?a.parsed_directions.charAt(0).toUpperCase()+a.parsed_directions.slice(1):null;a=new ETM.IngredientObject({food:ETM.food_info_object_list.get(ROOT+
"/food/"+parseInt(a.food_match.pk)+"/"),amount:a.unit_match.unit_amount,units:a.unit_match.unit_column,preparation:b},{skip_global:!0});a.attributes.food.attributes.resource_uri=a.attributes.food.id;c.add(a)});var d=new ETM.ParsedIngredientCollectionView({collection:c,el:$(".parse_result_list",this.el)});d.original_unit_string=a;d.render();$(".diet_draggable:not(:first-child)",d.el).hide();d.setSelectedModels([0],{by:"offset"});this.ingredients_list_view=d;return this}});
ETM.ParseIngredientMatchesView=Backbone.View.extend({"class":"parse_ingredient_view",initialize:function(a,b){"undefined"!==typeof b&&(this.ingredient_text=b.ingredient_text,this.parse_result_element=b.parse_result_element,this.fixed_match_id=b.fixed_match_id)},parseTextIngredients:function(a){var b=this;this.currently_parsing||(this.currently_parsing=!0,$.ajax({url:"/recipe/parse-ingredients/",data:{ingredients:this.ingredient_text},type:"POST",success:function(c){b.currently_parsing=!1;b.parseResults=
JSON.parse(c);add_food_info_objects(b.parseResults.info_objs);b.renderParseResults(b.parseResults);a()},error:function(c,d,e){console.log(d);b.currently_parsing=!1;a()}}))},parseTextIngredientsWithoutFixedMatches:function(a){var b=this;this.currently_parsing||(this.currently_parsing=!0,$.ajax({url:"/recipe/parse-ingredients-without-fixed/",data:{ingredients:this.ingredient_text},type:"POST",success:function(c){b.currently_parsing=!1;b.parseResults=JSON.parse(c);add_food_info_objects(b.parseResults.info_objs);
b.renderParseResults(b.parseResults);a()},error:function(c,d,e){console.log(d);b.currently_parsing=!1;a()}}))},renderParseResults:function(a){var b=this;b.parseListViews=[];this.parse_result_element.html("<h4>Parse Results</h4><p>Only the first item for each ingredient will be used.  You can also leave an ingredient blank or drag in foods from the sidebar.</p>");a.ingredient_matches.forEach(function(a){var d=null,e=null;$.each(a,function(a,b){d=a;e=b});a=$('<ul class="parse_result_list"/>');var f=
new ETM.IngredientsList;e.forEach(function(a){var b=null!=a.parsed_directions?Helper.capitalizeFirstLetter(a.parsed_directions):null;a=new ETM.IngredientObject({food:ETM.food_info_object_list.get(ROOT+"/food/"+parseInt(a.food_match.pk)+"/"),amount:a.unit_match.unit_amount,units:a.unit_match.unit_column,preparation:b},{skip_global:!0});a.attributes.food.attributes.resource_uri=a.attributes.food.id;f.add(a)});var g=new ETM.IngredientListView({collection:f,el:a});g.render();b.parseListViews.push(g);
b.parse_result_element.append($('<div class="parse_result row"><hr/><div class="parse_result_text">'+d+"</div></div>").append(a));b.parse_result_element.append($('<div class="row"><div class="col-xs-12"><div class="btn pull-right btn-lg btn-primary confirm_ingredients_text">Save Top Match</div></div></div>'));$(".confirm_ingredients_text",b.parse_result_element).on("click",function(a){var c=$(a.target).ladda();c.ladda("start");b.parseListViews.forEach(function(a){0<a.collection.length&&(a=a.collection.at(0),
$.ajax({url:"/update_fixed_match/",data:{id:b.fixed_match_id,unit_database_column:a.attributes.units,unit_amount:a.attributes.amount,food_id:a.attributes.food.attributes.id,notes:a.attributes.preparation},type:"POST",success:function(){c.ladda("stop");b.parse_result_element.closest(".fixed_match").slideUp(function(){$(this).remove()})}}))})})})}});
ETM.PremiumSignupView=Backbone.View.extend({render:function(){var a=this;this.renderForm();$(".finish_signup").on("click",function(){a.signupComplete()});this.leftovers_view=new ETM.SignupLeftoversView;$(".leftovers_view").html(this.leftovers_view.render().el);$(".leftover_settings_title").hide();return this},renderForm:function(){this.form=(new Backbone.Form({model:ETM.current_user_profile,schema:ETM.current_user_profile.premium_signup_schema(),template:this.template})).render();$(".premium_finish_signup").show();
$(".premium_signup_load_spinner").hide();$(".premium_signup").html(this.form.el);$(".generator_focus_tooltip",this.form.el).tooltip({placement:"left",html:!0,title:ETM.current_user_profile.generator_focus_toolip_text()});$(".shopping_day_tooltip",this.form.el).tooltip({placement:"right",title:ETM.current_user_profile.shopping_day_tooltip_text(),html:!0})},signupComplete:function(){var a=$("#enable_leftovers").is(":checked");ETM.current_user_profile.save({show_walkthrough_prompt:!0,timezone:this.form.getValue().timezone,
shopping_day:this.form.getValue().shopping_day,generator_focus:this.form.getValue().generator_focus,use_leftovers:a},{patch:!0,async:!1});$("#finish_premium_signup_form").submit()}});
ETM.PremiumWelcomeModal=ModalView.extend({className:"modal fade",events:{"click .close_welcome_modal":"closeWelcomeModal"},initialize:function(){this.listenTo(ETM.generator_status,"weeklyProgressUpdated",function(a){ETM.current_user_profile.attributes.currently_generating?"SUCCESS"===a?$(".status_div",this.el).html("Generating complete!"):"ERROR"===a?$(".status_div",this.el).html("Uh oh, something went wrong generating.  Click the regenerate entire week button to try again."):$(".loading_percent",
this.el).html(ETM.generator_status.getCurrentProgress()):$(".status_div",this.el).html("Generating complete!")},this)},render:function(){this.$el.html(this.template({is_generating:ETM.current_user_profile.attributes.currently_generating,generator_progress:ETM.generator_status.getCurrentProgress()}));return this},closeWelcomeModal:function(){!0!=ETM.current_user_profile.attributes.welcome_complete&&ETM.current_user_profile.save({welcome_complete:!0},{patch:!0})}});
ETM.ManagedAccountPremiumWelcomeModal=ETM.PremiumWelcomeModal.extend({render:function(){this.$el.html(this.template({manager_username:ETM.current_user_profile.attributes.manager_username,is_generating:ETM.current_user_profile.attributes.currently_generating,generator_progress:ETM.generator_status.getCurrentProgress()}));return this}});
ETM.ManagerAccountPremiumWelcomeModal=ETM.PremiumWelcomeModal.extend({events:{"click .start_adding_users":function(){this.$el.modal("hide");ETM.router.navigate("account-management/accounts/",{trigger:!0})},"click .view_resources":function(){this.$el.modal("hide");ETM.router.navigate("account-management/resources/",{trigger:!0})},"click .close_welcome_modal":"closeWelcomeModal"}});
ETM.FreeWelcomeModal=ETM.PremiumWelcomeModal.extend({initialize:function(){this.$el.on("hidden.bs.modal",function(a){Helper.oneTimePopover($(".regenerate_button .gen_button"),"top","Click <strong>Regenerate</strong> to get a new meal plan, or <strong>Search foods</strong> to add/track your own dishes.",null,!0)})},render:function(){this.$el.html(this.template({}));return this}});ETM.FreeWelcomeChangesModal=ETM.FreeWelcomeModal.extend({initialize:function(){}});
ETM.BetaTestModal=ModalView.extend({className:"modal fade",initialize:function(){},render:function(){this.$el.html(this.template({}));return this}});
ETM.generatePrintableMealList=function(a,b){var c=new ETM.MealList;c.reset();var d=new ETM.FoodInfoObjectList;d.urlRoot=ROOT+"/recipe/";a.attributes.meals.forEach(function(a){var b=new ETM.MealObject({meal_number:a.attributes.meal_number,meal_type:a.attributes.meal_type});b.stats=a.stats;a.attributes.foods.forEach(function(a){var c=a.attributes.food;if(c.get("is_recipe")){a=a.clone();a.attributes.food=a.attributes.food.clone();var e=a.attributes.food;e.id=ROOT+"/recipe/"+c.attributes.id+"/";e.attributes.resource_uri=
ROOT+"/recipe/"+c.attributes.id+"/";d.add(e)}b.attributes.foods.add(a)});c.add(b)});d.fetch({success:function(){c.forEach(function(a){a.attributes.foods.forEach(function(a){a.attributes.food.attributes.is_recipe&&(null==a.attributes.food.attributes.ingredients&&(a.attributes.food=d.get(a.attributes.food.id)),a.attributes.food.attributes.ingredients.forEach(function(a){a.attributes.original_recipe_amount=a.get("amount")}),a.scaleIngredients(a.attributes.amount))})});b(c)}})};
ETM.renderPrintableMealList=function(a,b){return ETM.loadTemplate("#PrintableDietTemplate")({mealList:a,dietStats:b.stats,planTitle:b.attributes.title})};ETM.printDiet=function(a){ETM.generatePrintableMealList(a,function(b){b=ETM.renderPrintableMealList(b,a);$(".print-body").html(b);window.print()})};
ETM.finish_profile_completeness_key=function(a){if("undefined"!=typeof ETM.current_profile_completeness&&!1===ETM.current_profile_completeness.attributes[a]){var b={};b[a]=!0;ETM.current_profile_completeness.save(b,{patch:!0})}};
ETM.ProfileCompletenessView=Backbone.View.extend({events:{"click .expand_todos":function(){this.expand_todos=!this.expand_todos},"click .list-group > a":"showTodoTip"},showTodoTip:function(a){var b=$(a.currentTarget).data("selector");"initial_signup_complete"===b?window.location.href="/create-free-profile/":ETM.ALL_PROFILE_TODOS.forEach(function(a){if(a.key==b)if("function"==typeof a.onclick)a.onclick();else ETM[a.onclick].start()})},initialize:function(){var a=this;this.expand_todos=!1;this.listenTo(this.model,
"change",function(){a.render()})},render:function(){var a=this,b=[],c=[];ETM.ALL_PROFILE_TODOS.forEach(function(d){if(!d.premium||ETM.is_premium)!0===a.model.attributes[d.key]?c.push(d):b.push(d)});this.$el.html(this.template({completeness_percent:this.model.getCompletenessPercent(),attributes:this.model.attributes,expand_todos:this.expand_todos,active_todos:b,finished_todos:c}));return this}});ETM.customize_meal_type_tip=introJs();
ETM.customize_meal_type_tip.setOptions({name:"Customize your Meal Types",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".meal_bar",intro:"Each meal is defined by its 'Meal Type'. Click the meal's name to switch the Meal Type, edit it, or create your own.<br/><br/>Meal Types define most of your meal's settings, including <strong>cook time, number of family members, meal size, and meal complexity</strong>.",position:"top"}]});
ETM.customize_meal_type_tip.onbeforechange(function(a){switch(ETM.customize_meal_type_tip._currentStep){case 0:""!=Backbone.history.fragment&&(ETM.current_profile_completeness.listenToOnce(ETM.dispatcher,"finishedRenderingDayView",function(){setTimeout(function(){ETM.customize_meal_type_tip.updateElementSelectors();ETM.customize_meal_type_tip.refresh()},100)}),ETM.router.navigate("",{trigger:!0}))}});ETM.customize_food_preferences_tip=introJs();
ETM.customize_food_preferences_tip.setOptions({name:"Customize food preferences",require_diet:!1,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".food_preferences_form",intro:"These are your food preferences. By default, we try to give as much variety as possible, but you can change your 'preset diet' to quickly filter different groups of foods, or add specific keywords to filter in the 'I don't want to eat' section.<br/><br/>If you want to filter on a keyword that isn't in the list of suggestions, feel free to type your own. Any recipe that matches the keyword, either in name or in its ingredients, will be removed from the generator.",
position:"top"}]});
ETM.customize_food_preferences_tip.onbeforechange(function(a){switch(ETM.customize_food_preferences_tip._currentStep){case 0:"settings/food-preferences/"!=Backbone.history.fragment&&(ETM.router.navigate("settings/food-preferences/",{trigger:!0}),setTimeout(function(){ETM.customize_food_preferences_tip.updateElementSelectors();ETM.customize_food_preferences_tip.refresh()},200))}ETM.customize_food_preferences_tip._previousStep=ETM.premium_intro._currentStep;ETM.customize_food_preferences_tip._previousElement=a});
ETM.mark_eaten_tip=introJs();ETM.mark_eaten_tip.setOptions({name:"Mark eaten meals",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".i_ate_this",intro:"Click 'I ate this meal' to keep track of things that you actually ate. If you skipped a recipe, delete it from your plan by clicking the 'x'. This will help keep accurate totals on your 'Stats and Progress' page.",position:"left"}]});
ETM.mark_eaten_tip.onbeforechange(function(a){switch(ETM.mark_eaten_tip._currentStep){case 0:""!=Backbone.history.fragment&&(ETM.current_profile_completeness.listenToOnce(ETM.dispatcher,"finishedRenderingDayView",function(){setTimeout(function(){ETM.mark_eaten_tip.updateElementSelectors();ETM.mark_eaten_tip.refresh()},100)}),ETM.router.navigate("",{trigger:!0}))}});ETM.refresh_meal_tip=introJs();
ETM.refresh_meal_tip.setOptions({name:"Refresh meals to fine tune",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".meal_bar",intro:"If you see a meal that doesn't appeal to you, click the <span class='glyphicon glyphicon-random'></span> shuffle button to get a new suggestion.<br/><br/>Any time you refresh, the generator will try to reach the overall targets for your diet. So if you delete a food from another meal and refresh this meal, it'll make up the extra calorie difference.",
position:"top"}]});ETM.refresh_meal_tip.onbeforechange(function(a){switch(ETM.refresh_meal_tip._currentStep){case 0:""!=Backbone.history.fragment&&(ETM.current_profile_completeness.listenToOnce(ETM.dispatcher,"finishedRenderingDayView",function(){setTimeout(function(){ETM.refresh_meal_tip.updateElementSelectors();ETM.refresh_meal_tip.refresh()},100)}),ETM.router.navigate("",{trigger:!0}))}});ETM.drag_food_tip=introJs();
ETM.drag_food_tip.setOptions({name:"Refresh meals to fine tune",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".diet_draggable",intro:"Click and hold on a food to begin dragging it.  You can then drag it to another meal.",position:"top"}]});
ETM.drag_food_tip.onbeforechange(function(a){switch(ETM.drag_food_tip._currentStep){case 0:""!=Backbone.history.fragment&&(ETM.current_profile_completeness.listenToOnce(ETM.dispatcher,"finishedRenderingDayView",function(){setTimeout(function(){ETM.drag_food_tip.updateElementSelectors();ETM.drag_food_tip.refresh()},100)}),ETM.router.navigate("",{trigger:!0}))}});ETM.add_a_dish_tip=introJs();
ETM.add_a_dish_tip.setOptions({name:"Refresh meals to fine tune",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".left_panel",intro:"Click and hold on a food to start dragging it.  Move it on top of a meal to insert the food in that meal.",position:"right"}]});ETM.set_weight_goal_tip=introJs();
ETM.set_weight_goal_tip.setOptions({name:"Set a weight goal to stay on track",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".profile_weight_update",intro:"Click the pencil icon to edit your current weight or set a weight goal. Setting a weight goal can help you stay on track with making progress while you follow your meal plans.",position:"bottom"}]});
ETM.set_weight_goal_tip.onafterchange(function(a){switch(ETM.set_weight_goal_tip._currentStep){case 0:$(".introjs-helperLayer").css("opacity","0.5")}});ETM.set_weight_goal_tip.onexit(function(a){$(".introjs-helperLayer").css("opacity","auto")});ETM.add_recurring_food_tip=introJs();
ETM.add_recurring_food_tip.setOptions({name:"Add recurring foods to keep things familiar",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".recurring_foods",intro:"Here you can add foods to 'recur' <span class='glyphicon glyphicon-repeat'></span> in specific meals of your plan. If you want the planner to add your morning coffee in every breakfast meal, drag it in from the Food Bank and set it to recur 'always'. <br/><br/>Settings Recurring Foods is the easiest way to explicitly tell the generator what you want, and the rest of the foods will be generated with respect to the nutrition in your recurring foods.",position:"top"}]});
ETM.add_recurring_food_tip.onbeforechange(function(a){switch(ETM.add_recurring_food_tip._currentStep){case 0:"recurring-foods/"!=Backbone.history.fragment&&(ETM.router.navigate("recurring-foods/",{trigger:!0}),setTimeout(function(){ETM.add_recurring_food_tip.updateElementSelectors();ETM.add_recurring_food_tip.refresh()},200))}});ETM.favorite_food_tip=introJs();
ETM.favorite_food_tip.setOptions({name:"Favorite foods to improve the generator results",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".diet_draggable",intro:'When you click the <img src="/static_files/images/addFavorite.png" alt="Heart" height="16" width="16">  heart next to foods in your plan, they\'ll be <img src="/static_files/images/addFavoriteActive.png" alt="Heart" height="16" width="16"> favorited and show up in the sidebar for easy access. The generator will also suggest your favorites slightly more often in your meal plans.<br/><br/>Try adding a few foods that you like as favorites to make your meal plans more consistently likable.',
position:"top"}]});ETM.favorite_food_tip.onbeforechange(function(a){switch(ETM.favorite_food_tip._currentStep){case 0:""!=Backbone.history.fragment&&(ETM.current_profile_completeness.listenToOnce(ETM.dispatcher,"finishedRenderingDayView",function(){setTimeout(function(){ETM.favorite_food_tip.updateElementSelectors();ETM.favorite_food_tip.refresh()},100)}),ETM.router.navigate("",{trigger:!0}))}});ETM.block_food_tip=introJs();
ETM.block_food_tip.setOptions({name:"Block foods to improve the generator results",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".diet_draggable",intro:"When you hover the mouse over a food, a <div class='block_food_image'></div> block icon will appear on the left side. Click this to prevent the food from showing up in your meal plans the next time they regenerate.",position:"top"}]});
ETM.block_food_tip.onbeforechange(function(a){switch(ETM.block_food_tip._currentStep){case 0:""!=Backbone.history.fragment&&(ETM.current_profile_completeness.listenToOnce(ETM.dispatcher,"finishedRenderingDayView",function(){setTimeout(function(){ETM.block_food_tip.updateElementSelectors();ETM.block_food_tip.refresh()},100)}),ETM.router.navigate("",{trigger:!0}))}});
ETM.block_food_tip.onchange(function(a){switch(ETM.block_food_tip._currentStep){case 0:$(a).find(".mod_units").show(),$(a).find(".static_div").hide(),$(".top_row_icons:first .food_delete").show(),$(".top_row_icons:first .food_repeat").show(),$(".bottom_row_icons:first .food_refresh").show(),$(".bottom_row_icons:first .block_food").show()}switch(ETM.free_overview._previousStep){case 0:$(ETM.block_food_tip._previousElement).find(".mod_units").hide(),$(ETM.block_food_tip._previousElement).find(".static_div").show(),
$(".top_row_icons:first .food_delete").hide(),$(".top_row_icons:first .food_repeat").hide(),$(".bottom_row_icons:first .food_refresh").hide(),$(".bottom_row_icons:first .block_food").hide()}ETM.block_food_tip._previousStep=ETM.block_food_tip._currentStep;ETM.block_food_tip._previousElement=a});ETM.view_custom_food_screen=introJs();
ETM.view_custom_food_screen.setOptions({name:"Remember to make custom foods if you need them",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".left_panel",intro:"If you want to track a food that isn't in our database, you can add it yourself.<br/><br/>You can create either simple custom foods that just have nutrition info, or you can create custom recipes. When you add ingredients to custom recipes, the nutrition will automatically calculate. The generator will also automatically use your custom recipes in future meal plans.",
position:"right"}]});ETM.weekly_layout_tip=introJs();ETM.weekly_layout_tip.setOptions({name:"Customize the weekly layout",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:"#settings_content",intro:"This is where you can layout the structure of your weekly meal plan, such as the number of calories or the meal types you want to eat each day.",position:"top"}]});
ETM.weekly_layout_tip.onbeforechange(function(a){switch(ETM.weekly_layout_tip._currentStep){case 0:"settings/weekly-planner-layout/"!=Backbone.history.fragment&&(ETM.router.navigate("settings/weekly-planner-layout/",{trigger:!0}),setTimeout(function(){ETM.weekly_layout_tip.updateElementSelectors();ETM.weekly_layout_tip.refresh()},100))}});ETM.setup_leftovers_tip=introJs();
ETM.setup_leftovers_tip.setOptions({name:"Refresh meals to fine tune",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:"#settings_content",intro:"This is where you can set up custom leftovers patterns. Leftovers can help cut down on the ingredients you need for your grocery list, as well as reduce the amount of cooking you need to do every day. When you refresh leftovers in your meal plan, they all refresh together.",position:"top"}]});
ETM.setup_leftovers_tip.onbeforechange(function(a){switch(ETM.setup_leftovers_tip._currentStep){case 0:"settings/leftovers/"!=Backbone.history.fragment&&(ETM.router.navigate("settings/leftovers/",{trigger:!0}),setTimeout(function(){ETM.setup_leftovers_tip.updateElementSelectors();ETM.setup_leftovers_tip.refresh()},100))}});ETM.add_foods_to_pantry_tip=introJs();
ETM.add_foods_to_pantry_tip.setOptions({name:"Add foods you already own to the Pantry",require_diet:!0,exitOnOverlayClick:!0,showStepNumbers:!1,showBullets:!1,skipLabel:"Got it",steps:[{element:".pantry_column",intro:"Add foods that you already own to the Pantry. When you regenerate the weekly plan, it will place an emphasis on using up what you already own. If you want to increase the amount that it focuses on using up your existing foods, tell the weekly planner to focus on 'Groceries'.",position:"top"}]});
ETM.add_foods_to_pantry_tip.onbeforechange(function(a){switch(ETM.add_foods_to_pantry_tip._currentStep){case 0:"groceries/"!=Backbone.history.fragment&&(ETM.router.navigate("groceries/",{trigger:!0}),setTimeout(function(){ETM.add_foods_to_pantry_tip.updateElementSelectors();ETM.add_foods_to_pantry_tip.refresh()},500))}});
ETM.ReadOnlySingleDayView=Backbone.View.extend({events:{},initialize:function(){this.plan_stats_view=new ETM.PlanStatsView({model:this.model,read_only:!0});this.plan_header_view=new ETM.ReadOnlyPlanHeaderView({model:this.model});this.listenTo(this.model,"updateStats",function(){this.renderStats()})},render:function(a){this.$el.html(this.template(this.model.attributes));$(".workspace_header",this.el).html(this.plan_header_view.render().el);this.plan_header_view.delegateEvents();this.renderMeals(a);
return this},showMeals:function(){for(var a=this.model.get("num_meals"),b=0;9>b;b++)b<a?$(".meal_box",this.el).eq(b).show():$(".meal_box",this.el).eq(b).hide()},hideMealsAndStats:function(){$(".workspace_divider",this.el).hide();$("#meal_list",this.el).hide();$("#workspace_stats",this.el).hide()},showMealsAndStats:function(){$(".workspace_divider",this.el).show();$("#meal_list",this.el).show();$("#workspace_stats",this.el).show()},renderMeals:function(a){0<this.model.attributes.meals.length&&(this.meal_list&&
this.meal_list.close(),this.meal_list=new ETM.MealListView({model:this.model.attributes.meals}),$("#meal_list",this.el).html(this.meal_list.render().el),$(".meal_refresh_btn",this.el).hide(),this.meal_list.meal_views.forEach(function(a){$(".meal_options_dropdown",a.el).removeClass("dropdown");$(".meal_options_dropdown",a.el).html('<span class="meal_title print_meal_title">'+a.model.get("meal_type").get("title")+"</span>")}),$(".meal_options_dropdown",this.el).unbind(),$(".meal_actions_dropdown",this.el).hide(),
this.model.attributes.diet_owner_username!=ETM.current_user_profile.attributes.username&&(this.meal_list.meal_views.forEach(function(a){a.food_list.$el.sortable({disabled:!0})}),$(".diet_draggable",this.el).css("cursor","auto"),$(".meal_icons",this.el).hide(),$(".i_ate_this",this.el).remove(),$(".food_refresh",this.el).remove(),$(".food_delete",this.el).remove(),$(".block_item",this.el).switchClass("col-xs-offset-0","col-xs-offset-6"),$(".block_item",this.el).switchClass("col-sm-offset-2","col-sm-offset-7"),
$(".block_item",this.el).switchClass("col-md-offset-4","col-md-offset-8"),$(".block_item",this.el).addClass("read_only_block_item"),$(".mod_units",this.el).remove(),$(".static_div",this.el).addClass("remain_visible")),this.renderStats(a),this.showMeals());0==this.plan_stats_view.model.stats.calories?this.hideMealsAndStats():this.showMealsAndStats()},renderStats:function(a){$("#workspace_stats",this.el).html(this.plan_stats_view.render().el);this.plan_stats_view.delegateEvents();"undefined"===typeof a&&
this.printGraph()},printGraph:function(){this.plan_stats_view.printGraph()}});
ETM.ReadOnlyPlanHeaderView=Backbone.View.extend({events:{"click .save_diet":"showSaveDiet","click .print_diet":"showPrintDiet","click .email_diet":"showEmailDiet","click .email_date_range":"showEmailDietRange","click .return_to_generator":function(){ETM.router.navigate("",{trigger:!0})}},onClose:function(){ETM.scheme_validation_element.remove();ETM.scheme_validation_element=null},showEmailDietRange:function(){ETM.email_plan_set_modal&&($("#email_plan_set_modal").html(ETM.email_plan_set_modal.render().el),
ETM.email_plan_set_modal.delegateEvents(),ETM.email_plan_set_modal.$el.modal("show"))},render:function(){this.$el.html(this.template({attributes:this.model.attributes,is_logged_in:ETM.is_logged_in,is_diet_set:this.model.is_diet_set,is_premium:ETM.is_premium,current_user:ETM.current_user_profile}));ETM.scheme_validation_element=$("#scheme_validation",this.el);return this},showSaveDiet:function(){this.saveDiet=new ETM.SavePublicDietModalView;$("#save_diet_modal").html(this.saveDiet.render().el);this.saveDiet.$el.modal("show")},
showPrintDiet:function(){ETM.printDiet(ETM.current_diet)},showEmailDiet:function(){ETM.generatePrintableMealList(ETM.current_diet,function(a){a=ETM.renderPrintableMealList(a,ETM.current_diet);$.post("/diet/email/",{plan_title:ETM.current_diet.attributes.title,plan_html:a},function(a){})})}});
ETM.FoodObjectModalRecipeView=ETM.FoodObjectModalBasicView.extend({className:"modal-content",events:function(){return _.extend({},ETM.FoodObjectModalBasicView.prototype.events,{"click .personalize_recipe":"convertViewToEdit","click .add_direction":"addDirection","click .cancel_edits":"closeEditor","click .save_recipe":"saveRecipe","click .enter_ingredients_text":function(a){this.enterTextIngredients(!1)},"click .confirm_ingredients_text":"confirmTextIngredients","click .parse_ingredients_text":function(a){this.parseTextIngredients($(".enter_ingredients_textbox",
self.el).val())},"click .cancel_ingredients_text":"cancelTextIngredients","click .admin_edit":"adminEditRecipe","click .admin_curate_and_edit":"adminCurateAndEditRecipe","change .modal_curate_recipe_radio":"changeRecipeCuration","click .enable_curation_radio":"enableCurationRadioButtons","change .admin_extra_tags_checkboxes input":"enableTagSaveButton","click .admin_save_recipe_tags":"saveRecipeTags","click .report_recipe_btn":"reportRecipeModal","submit .import_recipe_form":"importRecipeFromUrl",
"click .see_import_errors":"scrollToError","blur .form-group.import_group":"validateInputUI"})},render:function(){this.updateStaticAmountAndUnits();var a=this;this.$el.html(this.template({model:this.model,amino_acids:ETM.amino_acids,fatty_acids:ETM.fatty_acids,vits_and_mins:ETM.vits_and_mins,nutrient_names:ETM.nutrient_names,selector_html:a.selectorHTML(),user_id:ETM.current_user_profile.attributes.user_id,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff,image:this.model.attributes.food.getDisplayImage()}));
this.printFoodStats();this.addTooltips();this.model.attributes.food.downloadRecipeInfo(function(){$(".downloading_ingredients_spinner",a.el).hide();_.has(a,"ingredients_list_view")||(a.ingredients_list_view=new ETM.ReadOnlyIngredientListView({collection:a.model.get("food").get("ingredients"),el:$(".ingredients_list",a.el)}),a.ingredients_list_view.render());_.has(a,"directions_list_view")||(a.directions_list_view=new ETM.ReadOnlyDirectionsListView({collection:a.model.get("food").get("directions"),
el:$(".directions_list",a.el)}),a.directions_list_view.render());$(".scaled_servings",a.el).hasClass("active")?a.scaledIngredientsToEat():$(".cook_scaled_servings",a.el).hasClass("active")?a.scaledIngredientsToCook():a.unscaledIngredients()});this.printTags();this.renderCuratorSection();this.updateScaleSelector();this.create_uploader();return this},renderCuratorSection:function(){if(this.isUsingCurator()){var a=new ETM.FoodChangesListView({model:this.model});a.food_object_modal=this;$(".curator_div",
this.el).html(a.render().el)}},initialize:function(){this.listenTo(this.model.attributes.food,"addFavorite",function(){this.model.is_favorite=!0;$(".food_control_panel .favorite_food",this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeFavorite",function(){this.model.is_favorite=!1;$(".food_control_panel .favorite_food",this.el).removeClass("active")},this);this.listenTo(this.model.attributes.food,"addBlock",function(){this.model.is_blocked=!0;$(".food_control_panel .block_food",
this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeBlock",function(){this.model.is_blocked=!1;$(".food_control_panel .block_food",this.el).removeClass("active")},this)},printFoodStats:function(){if(!this.model.get("food").get("is_recipe")||this.parent&&"original"!==this.parent.ingredients_scale)this.model.get("food").get("is_recipe")&&"to_cook"===this.parent.ingredients_scale?(a=this.model.amount_to_cook,b=this.model.customStats(a,1),c=roundNumber(a*this.model.attributes.food.attributes.weights[1].amount,
5),d=this.model.attributes.food.attributes.weights[1].description,a*=this.model.get("food").attributes.weights[1].grams):(a=this.model.get("amount"),b=this.model.stats,c=this.model.static_amount,d=this.model.static_units,a*=this.model.get("food").attributes.weights[this.model.get("units")].grams);else var a=this.model.get("food").get("number_servings"),b=this.model.customStats(a,1),c=roundNumber(a*this.model.attributes.food.attributes.weights[1].amount,5),d=this.model.attributes.food.attributes.weights[1].description,
a=a*this.model.get("food").attributes.weights[1].grams;$("#serving_size",this.el).html(Helper.formatFoodAmount(c)+" "+d);$("#serving_grams",this.el).html(roundNumber(a,2));c=new DailyRecommended;for(d=0;d<all_nutrients.length;d++)a=0==c[all_nutrients[d]]?"-":Math.ceil(100*(b[all_nutrients[d]]/c[all_nutrients[d]]))+"%",$("#"+all_nutrients[d],this.el).html(Math.round(b[all_nutrients[d]]*Math.pow(10,1))/Math.pow(10,1)),$("#"+all_nutrients[d],this.el).next(".amount_units").html(micro_units[d]),$("#"+
all_nutrients[d]+"_dv",this.el).html(a);c=roundNumber(b.carbs-b.fiber,1);0>c&&(c=0);$("#net_carbs",this.el).html(c).next(".amount_units").html("g");$("#calories",this.el).html(roundNumber(b.calories,1));$("#fat_cals",this.el).html(roundNumber(9*b.fats,1));$("#fat_cal_percent",this.el).html(roundNumber(100*(9*b.fats/b.calories),1));b=getStatsHTML(b);$("#modal_day_stats .stats_output",this.el).html(b)},convertViewToEdit:function(){var a=this;a.undelegateEvents();this.parent.$el.one("hidden.bs.modal",
function(){ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.copyThenLoad(a.model,!1);$("#food_object_modal_div").html(ETM.recipe_editor.render().el);ETM.recipe_editor.applyEvents();ETM.recipe_editor.delayPrintGraph()}).modal("hide")},adminCurateAndEditRecipe:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;a.undelegateEvents();this.parent.$el.one("hidden.bs.modal",function(){ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.admin_curate_and_edit=
!0;ETM.recipe_editor.copyThenLoad(a.model,!1);$("#food_object_modal_div").html(ETM.recipe_editor.render().el);ETM.recipe_editor.applyEvents();ETM.recipe_editor.delayPrintGraph()}).modal("hide")},adminEditRecipe:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;a.undelegateEvents();this.parent.$el.one("hidden.bs.modal",function(){ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.admin_edit=!0;ETM.recipe_editor.copyThenLoad(a.model,!1);$("#food_object_modal_div").html(ETM.recipe_editor.render().el);
ETM.recipe_editor.applyEvents();ETM.recipe_editor.delayPrintGraph()}).modal("hide")},changeRecipeCuration:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=$(".modal_curate_recipe_radio input:checked").val();$.ajax({url:"/admin/recipe/switch_curated/"+this.model.get("food").get("id"),data:{curated:a},type:"POST",success:function(a){console.log("successfully changed")}})},enableTagSaveButton:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;$(".admin_save_recipe_tags",
this.el).attr("disabled",!1)},reportRecipeModal:function(){var a=new ETM.RecipeReportModalView({model:this.model.attributes.food});$("#report_recipe_modal_div").html(a.render().el);Helper.showNestedModal(a)},saveRecipeTags:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;$(".admin_save_recipe_tags",a.el).attr("disabled",!0);var b=[];$(".admin_extra_tags_checkboxes :checkbox:checked",this.el).each(function(){b.push($(this).attr("name"))});save_tags=b.join(" ");$.ajax({url:"/admin/recipe/save_tags/"+
this.model.get("food").get("id"),data:{substitution_tags:save_tags},type:"POST",success:function(b){console.log("successfully changed");$(".save_tags_errors",a.el).html("<span class='text-success'>Success!</span>");a.model.attributes.food.attributes.substitution_tags=save_tags},error:function(b,d,e){$(".save_tags_errors",a.el).html("<span class='text-danger'>Shoot, an error!</span>");$(".admin_save_recipe_tags",a.el).attr("disabled",!1);console.log(d);console.log(e)}})},printTags:function(){if(!0!=
ETM.current_user_profile.get("is_staff"))return!1;var a=this,b=null!=a.model.attributes.food.attributes.substitution_tags?a.model.attributes.food.attributes.substitution_tags.split(" "):[];$(".admin_extra_tags_checkboxes input",this.el).each(function(){$(this).attr("checked",!1)});b&&_.each(b,function(b){$(".admin_extra_tags_checkboxes [name='"+b+"']",a.el).attr("checked",!0)})},enableCurationRadioButtons:function(){$(".modal_curate_recipe_radio input",this.el).prop("disabled",!1)}});
ETM.RecipeEditorModalView=ETM.FoodObjectModalRecipeView.extend({id:"recipe_editor_modal",className:"modal fade",initialize:function(){this.admin_verify_and_edit=this.admin_curate_and_edit=this.admin_edit=this.imported_recipe_url=this.currently_parsing=this.editing_user_recipe=this.editing_from_sidebar=this.original_food_object=this.editing_old_recipe=!1;this.$el.one("hidden.bs.modal",function(){ETM.recipe_editor.undelegateEvents();ETM.recipe_editor.close();self.editing_old_recipe&&!self.editing_from_sidebar?
(self.editing_old_recipe=!1,self.original_food_object=!1,self.editing_from_sidebar=!1,self.editing_user_recipe=!1,ETM.food_object_modal.loadFood(ETM.food_object_modal.model)):(self.editing_old_recipe=!1,self.original_food_object=!1,self.editing_from_sidebar=!1,self.editing_user_recipe=!1);ETM.sidebar_view.showAllTabs();ETM.sidebar_view.showCustomRecipes()})},applyEvents:function(){var a=this;this.listenTo(this.model.get("food").get("ingredients"),"add",function(){a.calculateStats();a.printRecipeStats();
a.printGraph()});this.listenTo(this.model.get("food").get("ingredients"),"remove",function(){a.calculateStats();a.printRecipeStats();a.printGraph()});this.listenTo(this.model.get("food").get("ingredients"),"updateStats",function(){a.calculateStats();a.printRecipeStats();a.printGraph()});this.listenTo(this.model.get("food").get("ingredients"),"addedRecipe",function(){$(".ingredients_error",a.el).css("display","inline-block")});this.listenTo(this.model.get("food").get("ingredients"),"addedIngredient",
function(){$(".ingredients_error",a.el).hide()})},render:function(){ETM.sidebar_view.toggleFoodBank("open");ETM.sidebar_view.toggleIngredientsOnly();ETM.sidebar_view.moveToFront();this.$el.html(this.template({model:this.model,image:this.model.attributes.food.getEditorDisplayImage(),user_id:null,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));this.$el.modal({backdrop:"static",keyboard:!1,show:!0});this.ingredients_list_view=new ETM.IngredientListView({collection:this.model.get("food").get("ingredients"),
el:$(".ingredients_list",this.el)});this.ingredients_list_view.render();this.setIngredientScale(this.model.get("food").get("number_servings"));this.directions_list_view=new ETM.DirectionsListView({collection:this.model.get("food").get("directions"),el:$(".directions_list",this.el)});this.directions_list_view.render();this.renderForm();this.resizeDirectionsFields();this.model.get("food").get("ingredients").each(function(a){a.calculateStats()});this.calculateStats();this.printRecipeStats();this.create_uploader();
this.addTooltips();return this},resizeDirectionsFields:function(){setTimeout("resizeAllDirections()",500)},create_uploader:function(){var a=this;this.listenTo(this.model,"imageUpdated",function(b){a.imageObject=b});ETM.displayImageSelectModal($(".recipe_upload_image",this.el),function(b){a.modal&&a.modal.close();a.modal=new ETM.FoodImageCropModalView({model:a.model});$("#upload_image_modal",ETM.$modal_content).html(a.modal.render(b).el);a.modal.show();$("#upload_image_modal",ETM.$modal_content).one("hidden.bs.modal",
function(a){setTimeout(function(){$("body").addClass("modal-open")},100)})})},copyThenLoad:function(a,b){this.editing_old_recipe=!0;this.editing_user_recipe=!1;this.original_food_object=a;this.editing_from_sidebar=b;var c=a.clone(),d=a.attributes.food.clone();if(0<d.attributes.images.length){var e=a.attributes.food.getEditorDisplayImage();this.imageObject=new ETM.FoodImage(e.attributes);Helper.clearIDs(this.imageObject);d.attributes.images.add(this.imageObject)}var f=[];a.attributes.food.attributes.ingredients.each(function(a){f.push(a.toJSON())});
var e=new ETM.IngredientsList(f),g=new ETM.DirectionsList(a.attributes.food.attributes.directions.toJSON());d.attributes.ingredients=e;d.attributes.directions=g;ETM.current_user_profile.get("user_id")===d.attributes.user_id&&!1===d.attributes.curated?(this.editing_user_recipe=!0,d.attributes.deleted=!1,d.url=function(){return ROOT+"/recipe/"+a.attributes.food.get("id")+"/"}):!0===ETM.current_user_profile.get("is_staff")&&this.admin_edit?(this.editing_user_recipe=!0,d.attributes.admin_edit=!0,d.url=
function(){return ROOT+"/recipe/"+a.attributes.food.get("id")+"/"}):(!0===ETM.current_user_profile.get("is_staff")&&this.admin_curate_and_edit?d.attributes.admin_curate_and_edit=d.attributes.user_id:!0===ETM.current_user_profile.get("is_staff")&&this.admin_verify_and_edit?d.attributes.admin_verify_and_edit=d.attributes.user_id:d.attributes.deleted=!1,Helper.clearIDs(d),delete d.attributes.food_id,d.attributes.ingredients.each(function(a){Helper.clearIDs(a)}),d.attributes.directions.each(function(a){Helper.clearIDs(a)}),
!0===d.attributes.curated&&(d.attributes.curated=!1),d.attributes.previous_food_id=a.attributes.food.attributes.id,d.attributes.base_food_id=null!=a.attributes.food.attributes.base_food_id?a.attributes.food.attributes.base_recipe:a.attributes.food.attributes.id,d.url=function(){return ROOT+"/recipe/"});c.attributes.food=d;this.model=c},closeEditor:function(){this.$el.modal("hide")},renderForm:function(){this.form=(new Backbone.Form({model:this.model.get("food"),template:Helper.createTemplateFunction($("#recipeForm",
this.el).html())})).render();$(".recipe_info_container",this.el).html(this.form.el);$("#recipe-title",this.el).val(this.model.get("food").attributes.food_name);$("#recipe-description",this.el).val(this.model.get("food").attributes.description);$("#serving-size-input",this.el).val(this.model.get("food").attributes.weights[1].amount);$("#serving-description",this.el).val(this.model.get("food").attributes.weights[1].description)},parseServingSize:function(a){return roundNumber(parseFloat(a),2)},validate:function(a){$(".recipe_validation_error",
this.el).remove();var b=!0,c=$("#recipe-title",this.el),d=$("#serving-size-input",this.el),e=$("#serving-description",this.el);0<!c.val().length&&(c.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a title.</div>"),b=!1);0<!d.val().length?(d.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a serving size.</div>"),b=!1):0>=this.parseServingSize(d.val())&&(d.after("<div class='alert alert-danger recipe_validation_error'>The recipe serving size must be greater than zero.</div>"),
b=!1);0<!e.val().length&&(e.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a serving size description.</div>"),b=!1);a||0!=this.model.get("food").attributes.ingredients.length||($(".ingredients_header").after("<div class='alert alert-danger recipe_validation_error'>The recipe needs at least one ingredient.</div>"),b=!1);return b},scrapeFields:function(){var a=$("#recipe-title",this.el).val(),b=$("#recipe-description",this.el).val(),c=$("#serving-size-input",this.el).val(),
d=$("#serving-description",this.el).val(),e=this.model.get("food");e.attributes.food_name=a;e.attributes.description=b;e.attributes.weights[1].amount=this.parseServingSize(c);e.attributes.weights[1].description=d;return e},saveRecipe:function(){var a=this;if($(".enter_ingredients_text",this.el).hasClass("as_drag"))return $(".ingredients_container",this.el).after('<div class="alert alert-danger recipe_finishing_entering_ingredients_error recipe_validation_error">Please finish verifying the matched ingredients or hit cancel.'),
!1;if(!this.validate())return!1;var b=this.form.commit({validate:!0}),c=this.scrapeFields();if("undefined"===typeof b){a.imported_recipe_url&&ETM.analytics.logImportedRecipeSave(a.imported_recipe_url);var d=0;c.get("ingredients").each(function(a){a.attributes.order=d;d++});d=0;c.get("directions").each(function(b){b.attributes.order=d;b.attributes.text=$(".directions_text textarea",a.el).eq(d).val().replace(/</g,"").replace(/>/g,"");0===b.attributes.text.length&&(b.attributes.text="");d++});$(".recipe_save_spinner",
this.el).show();$(".save_recipe",this.el).prop("disabled",!0);c.save({},{success:function(b,c,d){a.imageObject&&a.imageObject.save({food_id:b.attributes.id},{async:!1,success:function(){b.attributes.images.add(a.imageObject)}});b.attributes.ingredients.models.forEach(function(a){a.attributes.original_recipe_amount=a.attributes.amount});c=ROOT+"/food/"+b.get("id")+"/";b.id=c;b.set("resource_uri",c);b.url=function(){return ROOT+"/food/"+b.get("id")+"/"};a.editing_old_recipe=!1;a.editing_from_sidebar=
!1;a.original_food_object&&(_.has(a.original_food_object.attributes.food,"tooltip_ingredients")&&(delete a.original_food_object.attributes.food.tooltip_ingredients,delete all_ingredients[b.get("id")]),a.original_food_object.trigger("removeFoodObjectListeners"),a.original_food_object.stopListening(a.original_food_object.get("food")),_.has(a.original_food_object.attributes,"meal")?a.original_food_object.save({food:b}):a.original_food_object.set({food:b}),a.original_food_object.calculateStats(),a.original_food_object.initializeEvents(),
a.original_food_object.get("food").trigger("change"));(c=ETM.sidebar_view.custom_recipes_view.collection.food_info_object_list.get(b.id))?(_.has(c,"tooltip_ingredients")&&(delete c.tooltip_ingredients,delete all_ingredients[b.get("id")]),c.set(b.toJSON())):ETM.sidebar_view.custom_recipes_view.collection.food_info_object_list.add(b,{at:0});ETM.reload_food_pool=!0;$(".sb_search_input").val("");ETM.sidebar_view.showCustomRecipes();var e=null;a.original_food_object&&(e=a.original_food_object.clone());
a.$el.one("hidden.bs.modal",function(){e&&_.has(e.attributes,"meal")&&ETM.food_object_modal.loadFood(e)}).modal("hide")},error:function(b,c,d){$(".recipe_save_spinner",a.el).hide();$(".save_recipe",a.el).prop("disabled",!1);console.log("failed to save recipe :(");$(".modal-footer").append('<div class="alert alert-danger recipe_validation_error" style="float:left">Failed to save recipe.</div>')}})}else for(var e in b)b.hasOwnProperty(e)&&$('[data-editors="'+e+'"]').append('<div class="alert alert-danger recipe_validation_error" style="float:left">'+
b[e].message+"</div>")},enterTextIngredients:function(a){a=a||!1;if($(".enter_ingredients_text",this.el).hasClass("as_text"))if($(".enter_ingredients_text",this.el).switchClass("as_text","as_drag"),$(".enter_ingredients_text",this.el).html('<span class="glyphicon glyphicon glyphicon-arrow-left"></span> Cancel ingredient matching'),$(".ingredients_list",this.el).hide(),$(".ingredients_box",this.el).hide(),$(".recipe_stats_div",this.el).hide(),$(".enter_ingredients_text_div",this.el).show(),a)$(".ingredients_text_input_row",
this.el).hide();else{$(".ingredients_text_input_row",this.el).show();$(".enter_ingredients_textbox",this.el).val("");var b="";this.model.get("food").get("ingredients").each(function(a){b+=a.getStaticAmount()+" "+a.getStaticUnits()+" "+a.attributes.food.attributes.description+" "+a.attributes.food.attributes.food_name+"\n"});$(".enter_ingredients_textbox",this.el).val(b)}else $(".enter_ingredients_text",this.el).switchClass("as_drag","as_text"),$(".enter_ingredients_text",this.el).html('<span class="glyphicon glyphicon glyphicon-pencil"></span> Enter ingredients as text'),
$(".enter_ingredients_text_div",this.el).hide(),$(".ingredients_list",this.el).show(),$(".ingredients_box",this.el).show(),$(".recipe_stats_div",this.el).show()},showNormalIngredients:function(){$(".enter_ingredients_text",this.el).switchClass("as_drag","as_text");$(".enter_ingredients_text",this.el).html('<span class="glyphicon glyphicon glyphicon-pencil"></span> Enter ingredients as text');$(".enter_ingredients_text_div",this.el).hide();$(".ingredients_list",this.el).show();$(".ingredients_box",
this.el).show();$(".recipe_stats_div",this.el).show()},toggleTextInput:function(a){"show"===a||$(".ingredients_text_input_row",this).is(":visible")},parseTextIngredients:function(a,b){var c=this;this.currently_parsing||(this.currently_parsing=!0,$(".parse_spinner",this.el).show(),$(".enter_ingredients_textbox",this.el).prop("disabled",!0),$(".parse_ingredients_text",this.el).prop("disabled",!0),$.ajax({url:"/recipe/parse-ingredients/",data:{ingredients:a},type:"POST",success:function(a){c.currently_parsing=
!1;$(".enter_ingredients_textbox",c.el).prop("disabled",!1);$(".parse_ingredients_text",c.el).prop("disabled",!1);$(".parse_spinner",c.el).hide();$(".accept_parse_buttons",c.el).show();c.parseResults=JSON.parse(a);add_food_info_objects(c.parseResults.info_objs);c.renderParseResults(c.parseResults);"undefined"!==typeof b&&b()},error:function(a,e,f){console.log(e);$(".enter_ingredients_textbox",c.el).prop("disabled",!1);$(".parse_ingredients_text",c.el).prop("disabled",!1);$(".parse_spinner",c.el).hide();
c.currently_parsing=!1;c.showNormalIngredients();"undefined"!==typeof b&&b()}}))},renderParseResults:function(a){this.parsed_results=new ETM.ParseIngredientsListView({results:a});$(".parse_results_div",this.el).html(this.parsed_results.render().el)},confirmTextIngredients:function(){var a=[],b=[];this.parsed_results.ingredients_views.forEach(function(c){c=c.ingredients_list_view;if(0<c.collection.length){var d=c.getSelectedModel();d&&(a.push(d),b.push({original_string:c.original_unit_string,unit_database_column:d.attributes.units,
unit_amount:d.attributes.amount,food_id:d.attributes.food.attributes.id,notes:d.attributes.preparation}))}});$.ajax({url:"/save_user_fixed_matches/",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",type:"POST"});this.parseListViews=[];$(".parse_results",this.el).html("");$(".accept_parse_buttons",this.el).hide();this.showNormalIngredients();this.model.get("food").get("ingredients").reset(a);this.model.get("food").get("ingredients").each(function(a){a.calculateStats()});this.calculateStats();
this.printRecipeStats();this.printGraph()},cancelTextIngredients:function(){$(".recipe_finishing_entering_ingredients_error").remove();self.showNormalIngredients()},addDirection:function(){this.directions_list_view.collection.add(new ETM.Direction)},calculateStats:function(){self=this;self.stats={};ETM.NUTRIENT_LIST.forEach(function(a){self.stats[a]=0});this.model.get("food").get("ingredients").each(function(a){ETM.NUTRIENT_LIST.forEach(function(b){self.stats[b]+=a.stats[b]})})},printRecipeStats:function(){var a=
getStatsHTML(this.stats);$("#modal_day_stats .stats_output",this.el).html(a)},printGraph:function(){var a=4*this.stats.carbs+4*this.stats.proteins+9*this.stats.fats,b=$("#modal_cumulative_graph",this.el);if(0>=a)b.html("");else{var c=roundNumber(100*(4*this.stats.carbs/a),2),d=roundNumber(100*(9*this.stats.fats/a),2),a=roundNumber(100*(4*this.stats.proteins/a),2);$.plot(b,[{label:"Carbs",data:c,color:"#ff9000"},{label:"Protein",data:a,color:"#479ff3"},{label:"Fat",data:d,color:"#3aae4e"}],{series:{pie:{startAngle:0,
show:!0,radius:1,label:{show:!0,radius:0.5,formatter:function(a,b){return'<div style="font-size:7pt;text-align:center;padding:2px;color:white;">'+a+"<br/>"+Math.round(b.percent)+"%</div>"},threshold:0.1}}},legend:{show:!1}})}},importRecipeFromUrl:function(a){var b=this;a.preventDefault();var c=$("#recipe_url",this.el).val(),d=$(".import_recipe_btn",this.el).ladda();d.ladda("start");$.ajax({url:"/recipe/import_recipe_url/",data:{recipe_url:c},method:"POST",success:function(a){d.ladda("stop");ETM.analytics.logRecipeImport(c);
b.imported_recipe_url=c;b.updateRecipeStatsFromUrl(JSON.parse(a))},error:function(){d.ladda("stop");console.log("error importing recipe from url: "+c)}})},extensionUrlImport:function(a){var b=this;a.from&&"ETM_CHROME_EXT"==a.from&&"recipeData"==a.action&&(null==a.url||null==a.html?a.retry?(document.dispatchEvent(new CustomEvent("etmExtFailed")),document.dispatchEvent(new CustomEvent("ETM_ext_disconnect"))):document.dispatchEvent(new CustomEvent("etmExtResendRecipeData")):$.ajax({url:"/recipe/import_recipe_url/",
data:{recipe_url:a.url,recipe_html:a.html},method:"POST",success:function(c){document.dispatchEvent(new CustomEvent("etmExtRecipeClipped"));ETM.analytics.logRecipeImport(a.url);b.imported_recipe_url=a.url;b.updateRecipeStatsFromUrl(JSON.parse(c))},error:function(){console.log("error importing recipe from url: "+recipe_url);$(".image_upload_group",this.el).before("<div class='col-sm-8 col-sm-offset-2 alert alert-warning import_status'>Uh oh. :(<br/>We're sorry, it seems something has gone wrong clipping your recipe.<br/>Please try importing the recipe by pasting the url above.</div>")}}))},
updateRecipeStatsFromUrl:function(a){var b=!1;this.model.attributes.food.attributes.imported?this.clearImportedData(a):this.model.attributes.food.attributes.imported=!0;if(a.url_valid){this.model.attributes.food.attributes.source_url=a.source_url;b=this.fillRecipeSettings(a.settings)||b;b=this.fillServings(a.servings)||b;this.addMetaTags(a.other);this.renderForm();var c=this.addDirections(a.directions,a.author),b=c||b,d=this.addIngredients(a.ingredients),b=d||b,b=!this.validate(!0)||b;this.printImportStatus(b);
this.showFormErrors(a,c,d)}else $(".image_upload_group",this.el).before("<div class='col-sm-8 col-sm-offset-2 alert alert-danger import_status'>Uh oh. It looks like we weren't able to import information for that url. We're not able to import every recipe unfortunately. Please check the url and try again. We're sorry!</div>")},fillServings:function(a){var b=!1;null!=a.amount?this.model.attributes.food.attributes.number_servings=a.amount:(this.model.attributes.food.attributes.number_servings="",this.model.attributes.food.attributes.weights[1].amount=
"",b=!0);null!=a.units?this.model.attributes.food.attributes.weights[1].description=a.units:(this.model.attributes.food.attributes.weights[1].description="",b=!0);return b},fillRecipeSettings:function(a){var b=!1,c;for(c in a){var d=a[c];if(""==d||null==d)b=!0;this.model.attributes.food.attributes[c]=d}return b},addMetaTags:function(a){var b="",c;for(c in a){var d=a[c];""!=d&&null!=d&&(b+=d+", ")}this.model.attributes.food.attributes.meta_tags=b},addDirections:function(a,b){for(var c=!1,d=0;d<a.length;d++)new_direction=
new ETM.Direction,new_direction.attributes.text=a[d],this.directions_list_view.collection.add(new_direction);0<a.length?this.directions_list_view.render():c=!0;d="";b&&(d+="Recipe by: "+b);d+=" (source: "+this.model.attributes.food.attributes.source_url+")";source_direction=new ETM.Direction;source_direction.attributes.text=d;this.directions_list_view.collection.add(source_direction);return c},addIngredients:function(a){for(var b="",c=!1,d=this,e=0;e<a.length;e++)b+=a[e]+"\n";""!=b?(d.enterTextIngredients(!0),
$(".enter_ingredients_textbox",this.el).val(b),$(".results_spinner_div",this.el).show(),d.parseTextIngredients(b,function(){$(".results_spinner_div",d.el).hide()}),ETM.is_mobile&&ETM.sidebar_view.toggleFoodBank("close")):c=!0;return c},printImportStatus:function(a){var b=$(".image_upload_group",this.el);a?b.before("<div class='col-sm-8 col-sm-offset-2 alert alert-warning import_status'>It looks like one or more of the fields weren't able to be imported. Please scroll through, fill in any incorrect blanks, and make sure the chosen ingredients are correct.</div>"):
b.before("<div class='col-sm-8 col-sm-offset-2 alert alert-info import_status'>Import complete. Please scroll down, fill in any incorrect blanks, and choose the correct parsed ingredient(s) below :)</div>")},printImportWarning:function(a,b,c){a=$(a);"after"==b?a.after(c):"before"==b&&a.before(c)},clearImportedData:function(a){this.cancelTextIngredients();this.ingredients_list_view.collection.reset();this.directions_list_view.collection.reset();if(a)for(var b in a.settings)delete this.model.attributes.food.attributes[b];
delete this.model.attributes.food.attributes.meta_tags;this.model.attributes.food.attributes.number_servings=1;this.model.attributes.food.attributes.weights[1].description="servings";this.model.attributes.food.attributes.weights[1].amount=1;$(".recipe_validation_error").detach();$(".import_status").detach();this.removeFormUiValidation()},showFormErrors:function(a,b,c){for(var d in a.settings){var e=a.settings[d],f=$(".form-group."+d);""!=e&&null!=e?f.addClass("has-success"):f.addClass("has-error")}$(".form-group.non-import").addClass("has-warning");
d=$(".form-group.number_servings");null!=a.servings.amount?d.addClass("has-success"):d.addClass("has-error");d=$(".form-group.serving_size");null!=a.servings.units?d.addClass("has-success"):d.addClass("has-error");b&&self.printImportWarning(".recipe_directions_list","before","<div style='padding-top: 20px;' class='row'><div class='col-sm-6 col-sm-offset-3 alert alert-warning recipe_validation_error'>Something went wrong importing directions. Please re-enter any missing directions.</div></div>");c&&
self.printImportWarning(".ingredients_header","before","<div style='padding-top: 20px;' class='row'><div class='col-sm-6 col-sm-offset-3 alert alert-warning recipe_validation_error'>Something went wrong importing ingredients. Please re-enter ingredients.</div></div>")},removeFormUiValidation:function(){$(".form-group.import_group").removeClass("has-error has-warning has-success")},validateInputUI:function(a){var b=$(a.target);a=b.val();b=b.closest(".form-group");if(b.hasClass("has-warning")||b.hasClass("has-error")){if(b.hasClass("serving_size")){var c=
!0;$("input",b).each(function(){""==this.value&&(c=!1)});c&&(b.removeClass("has-warning has-error"),b.addClass("has-success"))}else""!=a&&(b.removeClass("has-warning has-error"),b.addClass("has-success"));""!=$("#num-servings-input input").val()&&""!=$("#serving-size-input").val()&&""!=$("#serving-description").val()&&$(".recipe_validation_error",".form-group.serving_size").detach()}}});
ETM.RecipeEditorView=ETM.RecipeEditorModalView.extend({id:"recipe_editor",className:"div",render:function(){this.template=ETM.loadTemplate("#RecipeEditorModalView");ETM.sidebar_view.toggleFoodBank("open");ETM.sidebar_view.toggleIngredientsOnly();ETM.sidebar_view.moveToFront();this.$el.html(this.template({model:this.model,image:this.model.attributes.food.getEditorDisplayImage(),user_id:null,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));$(".modal-content",this.el).unwrap(".modal-dialog");
$(".modal-header",this.el).unwrap(".modal-content");this.ingredients_list_view=new ETM.IngredientListView({collection:this.model.get("food").get("ingredients"),el:$(".ingredients_list",this.el)});this.ingredients_list_view.render();this.setIngredientScale(this.model.get("food").get("number_servings"));this.directions_list_view=new ETM.DirectionsListView({collection:this.model.get("food").get("directions"),el:$(".directions_list",this.el)});this.directions_list_view.render();this.renderForm();this.resizeDirectionsFields();
this.model.get("food").get("ingredients").each(function(a){a.calculateStats()});this.calculateStats();this.printRecipeStats();this.create_uploader();this.addTooltips();return this},saveRecipe:function(){var a=this;if($(".enter_ingredients_text",this.el).hasClass("as_drag"))return $(".ingredients_container",this.el).after('<div style="margin-bottom:20px;" class="alert alert-danger recipe_finishing_entering_ingredients_error recipe_validation_error">Please finish entering your text ingredients or hit cancel.'),
$(".recipe_directions_list",this.el).after('<div style="margin-bottom:20px;" class="alert alert-danger recipe_finishing_entering_ingredients_error recipe_validation_error">Please scroll up and finish entering your text ingredients, or hit cancel.'),!1;if(!this.validate())return!1;var b=this.form.commit({validate:!0}),c=this.scrapeFields();if("undefined"===typeof b){a.imported_recipe_url&&ETM.analytics.logImportedRecipeSave(a.imported_recipe_url);var d=0;c.get("ingredients").each(function(a){a.attributes.order=
d;d++});d=0;c.get("directions").each(function(b){b.attributes.order=d;b.attributes.text=$(".directions_text textarea",a.el).eq(d).val().replace(/</g,"").replace(/>/g,"");0===b.attributes.text.length&&(b.attributes.text="");d++});$(".recipe_save_spinner",this.el).show();$(".save_recipe",this.el).prop("disabled",!0);c.save({},{success:function(b,c,d){a.imageObject?a.imageObject.save({food_id:b.attributes.id},{success:function(){a.model.attributes.food.attributes.images.add(a.imageObject);window.location.replace("/recipe/view/"+
b.attributes.slug)}}):window.location.replace("/recipe/view/"+b.attributes.slug)},error:function(b,d,e){Helper.clearIDs(c);$(".recipe_save_spinner",a.el).hide();$(".save_recipe",a.el).prop("disabled",!1);$(".modal-footer").append('<div class="alert alert-danger recipe_validation_error" style="float:left">Failed to save recipe.</div>');console.log("failed to save recipe :(")}})}else for(var e in b)b.hasOwnProperty(e)&&$('[data-editors="'+e+'"]').append('<div class="alert alert-danger recipe_validation_error" style="float:left">'+
b[e].message+"</div>")}});
ETM.RecipeView=ETM.FoodObjectModalRecipeView.extend({id:"recipe_viewer",className:"div",events:{"click .remove_item_modal":"deleteFood","click .recurring_icon_modal":"openRecurringFoodModal","click .add_recurring_button":"openRecurringFoodModal","keyup .food_control_panel .mod_input":"updateAmount","change .food_control_panel .list_selector":"updateUnits","click .favorite_icon_modal":function(a){$(a.currentTarget).prop("disabled")||this.model.toggleFavorite($(a.currentTarget))},"click .food_eaten":"toggleEaten",
"click .block_icon_modal":function(a){$(a.currentTarget).prop("disabled")||this.model.toggleBlock($(a.currentTarget))},"click .expand_modal_nutrition":"expandNutrition","click .ingredients_scale_options .scaled_servings":"scaledIngredientsToEat","click .ingredients_scale_options .unscaled_servings":"unscaledIngredients","click .ingredients_scale_options .cook_scaled_servings":"scaledIngredientsToCook","change .modal_curate_recipe_radio":"changeRecipeCuration","click .enable_curation_radio":"enableCurationRadioButtons",
"change .admin_extra_tags_checkboxes input":"enableTagSaveButton","click .admin_save_recipe_tags":"saveRecipeTags"}});ETM.DirectionView=Backbone.View.extend({tagName:"tr",className:"table table-bordered",events:{"click .delete_direction":"deleteDirection"},deleteDirection:function(){this.undelegateEvents();this.model.destroy();this.remove()},render:function(){this.$el.html(this.template(this.model));return this}});
ETM.DirectionsListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,sortable:!0,sortableOptions:{placeholder:"list_placeholder",axis:"y",tolerance:"pointer",handle:".drag_handle"},emptyListCaption:"<div class='empty_meal_box'>There are no directions in this recipe</div>",modelView:ETM.DirectionView});ETM.ReadOnlyDirectionView=Backbone.View.extend({tagName:"tr",className:"table table-bordered",render:function(){this.$el.html(this.template(this.model));return this}});
ETM.ReadOnlyDirectionsListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,emptyListCaption:"<div class='empty_meal_box'>There are no directions in this recipe</div>",modelView:ETM.ReadOnlyDirectionView});
ETM.ReadOnlyIngredientObjectView=ETM.FoodObjectView.extend({initialize:function(){this.listenTo(this.model.attributes.food,"addBlock",function(){this.model.is_blocked=!0;$(".block_food",this.el).addClass("active")},this);this.listenTo(this.model.attributes.food,"removeBlock",function(){this.model.is_blocked=!1;$(".block_food",this.el).removeClass("active")},this)},render:function(a){"undefined"===typeof a&&(a=!0);this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();ETM.is_mobile&&
(this.template=ETM.loadTemplate("#MobileReadOnlyIngredientObjectView"));a=this.template({model:this.model,read_only:a,image:this.model.attributes.food.getDisplayImage()});this.$el.html(a);this.applyTooltip();this.printGramReadout();return this},applyReadOnlyHoverEffects:function(){}});
ETM.IngredientListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,sortable:!0,sortableOptions:function(){return ETM.is_mobile?{handle:".draggable_handle",placeholder:"list_placeholder",axis:"y",tolerance:"pointer"}:{placeholder:"list_placeholder",axis:"y",tolerance:"pointer"}},emptyListCaption:"<div class='empty_meal_box'>Drag ingredients here to add them to the recipe</div>",modelView:ETM.IngredientObjectView});
ETM.ParsedIngredientCollectionView=Backbone.CollectionView.extend({tagName:"ul",selectable:!0,sortable:!0,sortableOptions:{placeholder:"list_placeholder",axis:"y",tolerance:"pointer"},emptyListCaption:"<div class='empty_meal_box' style='margin-left:35px;'>No ingredients found for this text. You can drag one in from the sidebar to use it</div>",modelView:ETM.IngredientObjectView});
ETM.ReadOnlyIngredientListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,emptyListCaption:"<div class='row'><div class='col-xs-10 col-xs-offset-2 empty_meal_box'>This recipe has no ingredients</div></div>",modelView:ETM.ReadOnlyIngredientObjectView});function auto_grow(a){a.style.height="5px";a.style.height=a.scrollHeight+"px"}function resizeAllDirections(){_.each($(".directions_text textarea").get(),function(a){auto_grow(a)})}
ETM.RecipeReportModalView=ETM.FoodReportModalView.extend({renderForm:function(){this.form=(new Backbone.Form({schema:{preset_reasons:{type:"Select",validators:["required"],options:[{val:1,label:"Incorrect prep or cook time"},{val:2,label:"Incorrect serving size or number of servings"},{val:3,label:"Incorrect nutrition information"},{val:4,label:"Missing ingredients"},{val:5,label:"Incorrect ingredients or ingredient amounts"},{val:6,label:"Confusing ingredients or ingredient amounts"},{val:7,label:"Missing directions"},
{val:8,label:"Incorrect directions"},{val:9,label:"Confusing directions"},{val:10,label:"Bad picture"},{val:11,label:"Tasted bad :("},{val:0,label:"Other reason"}]},custom_reason:{type:"TextArea",editorAttrs:{maxlength:2048}}},template:Helper.createTemplateFunction($("#report_recipe_form",this.el).html())})).render();$("#report_recipe_form_container",this.el).html(this.form.el)}});
ETM.RecurringFoodModalView=ModalView.extend({className:"modal fade",events:{"click #add_recurring_food_button":"addRecurringFood","change #recurring_food_meal_type select":"renderMealRecurringFoods","click .recurring_list_item_delete":"deleteRecurringFood","change .recurring_select":"changeFrequency","change .modal_recurring_select":"changeFrequency"},initialize:function(){null!=ETM.current_diet&&null!=ETM.current_diet.attributes.meals.get(this.model.attributes.meal)?this.current_meal_type=ETM.current_diet.attributes.meals.get(this.model.attributes.meal).attributes.meal_type:
this.current_meal_type=ETM.meal_type_list.at(0)},render:function(){this.$el.html(this.template({attributes:this.model.attributes,logged_in:ETM.is_logged_in}));ETM.is_logged_in&&(this.renderForm(),this.renderRecurringIn(),this.renderMealRecurringFoods());return this},renderForm:function(){this.recurring_food=new ETM.RecurringFood({food:this.model.attributes.food,meal_type:this.current_meal_type.id,units:this.model.attributes.units,amount:this.model.attributes.amount});var a=[];this.recurring_food.attributes.food.attributes.weights.forEach(function(b,
c){a.push({val:c,label:b.description})});this.form=(new Backbone.Form({schema:{meal_type:{type:"Select",validators:["required"],options:ETM.meal_type_list.getMealTypeNameAndIds()},frequency:{type:"SegmentedRadio",validators:["required"],options:[{val:0,label:"Often"},{val:1,label:"Always"}]},amount:{type:"PositiveNumber"},units:{type:"Select",value_type:"Number",validators:["required"],options:a}},model:this.recurring_food,template:Helper.createTemplateFunction($("#addRecurringFormTemplate",this.el).html())})).render();
this.form.setValue({amount:roundNumber(this.recurring_food.attributes.amount*this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].amount,2)});this.listenTo(this.form,"amount:change",function(a,c){var d=c.getValue()/this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].amount;this.recurring_food.set({amount:d})},this);this.listenTo(this.form,"units:change",function(a,c){var d=c.getValue();this.recurring_food.set({amount:this.recurring_food.attributes.amount*
this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].grams/this.recurring_food.attributes.food.attributes.weights[d].grams,units:d});this.form.setValue({units:this.recurring_food.attributes.units,amount:roundNumber(this.recurring_food.attributes.amount*this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].amount,2)})},this);this.list_item_template=ETM.loadNestedTemplate("#RecurringFoodTemplates","#recurringFoodListModalItemTemplate");
this.empty_food_template=ETM.loadNestedTemplate("#RecurringFoodTemplates","#recurringFoodEmptyTemplate");$("#add_recurring_form",this.el).html(this.form.el)},renderRecurringIn:function(){var a=this,b="";ETM.recurring_foods_list.where({food:this.model.attributes.food}).forEach(function(c){var d=ETM.meal_type_list.get(c.attributes.meal_type);b+=a.list_item_template({title:d.attributes.title,frequency:ETM.RecurringFood.frequency_types[c.attributes.frequency],id:c.id})});b||(b=this.empty_food_template());
$("#recurring_in",this.el).html(b);this.showDeleteOnHover($(".recurring_list_item",this.el),".recurring_list_item_delete")},renderMealRecurringFoods:function(){var a=this,b=this.form.getValue().meal_type,c=ETM.meal_type_list.get(b);"undefined"==typeof c?(_errs.meta.meal_type_id=b,_errs.push(Error("No meal type id render meal recurring foods."))):($("#meal_recurring_foods_header",this.el).text("Recurring foods for "+c.attributes.title+":"),$("#meal_recurring_foods",this.el).html(""),b=ETM.recurring_foods_list.where({meal_type:b}),
b.forEach(function(b){b=new ETM.RecurringFoodObjectView({model:b});a.listenTo(b.model,"destroy",function(b){ETM.recurring_foods_list.remove(b);a.renderRecurringIn();a.renderMealRecurringFoods();null!=ETM.current_diet&&ETM.current_diet.attributes.meals.each(function(a){a.checkRecurringFoods()})});$("#meal_recurring_foods",a.el).append(b.render().el)}),0==b.length&&$("#meal_recurring_foods",this.el).html(this.empty_food_template()),this.showDeleteOnHover($(".recurring_list_item",this.el),".recurring_list_item_delete"))},
showDeleteOnHover:function(a,b){a.hover(function(){$(this).find(b).show()},function(){$(this).find(b).hide()})},changeFrequency:function(a){var b=$(a.currentTarget);a=b.val();var b=b.data("id"),c=$('select[data-id="'+b+'"]',this.el);c.val(a);"always"===a?(c.removeClass("label-info"),c.addClass("label-primary")):(c.removeClass("label-primary"),c.addClass("label-info"));ETM.recurring_foods_list.get(b).save({frequency:ETM.RecurringFood.frequency_types.indexOf(a)},{patch:!0})},deleteRecurringFood:function(a){a.preventDefault();
ETM.recurring_foods_list.get($(a.currentTarget).data("id")).destroy();this.renderRecurringIn();this.renderMealRecurringFoods();null!=ETM.current_diet&&ETM.current_diet.attributes.meals.each(function(a){a.checkRecurringFoods()})},addRecurringFood:function(a){a.preventDefault();a=this.form.commit({validate:!0});if("undefined"===typeof a)this.recurring_food.set({amount:this.recurring_food.attributes.amount/this.recurring_food.attributes.food.attributes.weights[this.recurring_food.attributes.units].amount}),
this.recurring_food.save(null,{async:!1}),ETM.recurring_foods_list.add(this.recurring_food),this.current_meal_type=ETM.meal_type_list.get(this.recurring_food.attributes.meal_type),this.renderForm(),this.renderRecurringIn(),this.renderMealRecurringFoods(),null!=ETM.current_diet&&ETM.current_diet.attributes.meals.each(function(a){a.checkRecurringFoods()});else for(var b in a)$('[data-editors="'+b+'"]').append('<div class="alert alert-danger" style="float:left">'+a[b].message+"</div>")}});
ETM.RecurringFoodObjectView=ETM.FoodObjectView.extend({tagName:"li",className:"row",events:{"click .food_delete":function(){this.$el.tooltip("destroy");this.remove();this.model.destroy()},"keyup .mod_input":"updateAmount","change .list_selector":"updateUnits"},initialize:function(){this.listenTo(this.model,"change:frequency",this.toggleUnitsText,this);this.listenTo(this.model,"recurring_food_saved",this.render,this)},render:function(){this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();
this.model.combineFoodInfoPointers();var a=ETM.food_info_object_list.get(this.model.attributes.food),a=this.template({food_name:a.attributes.food_name,frequency:ETM.RecurringFood.frequency_types[this.model.attributes.frequency],food:a,model:this.model});this.$el.html(a);this.toggleUnitsText();this.applyHoverEffects();this.applyTooltip();this.printGramReadout();return this},toggleUnitsText:function(){0==this.model.attributes.frequency?($(".often_frequency_units",this.el).show(),$(".always_frequency_units",
this.el).hide()):($(".often_frequency_units",this.el).hide(),$(".always_frequency_units",this.el).show())},applyHoverEffects:function(){this.timer2=this.timer1=null;var a=this,b=$(".food_delete",this.el),c=$(".mod_input",this.el),d=$(".mod_units",this.el),e=$(".static_div",this.el);this.$el.hover(function(){c.unbind("blur");clearTimeout(a.timer1);clearTimeout(a.timer2);e.fadeOut(100);d.fadeIn(100);b.fadeIn(100)},function(){c.is(":focus")?c.blur(function(){a.timer1=setTimeout(function(){e.fadeIn(200);
d.fadeOut(100);b.fadeOut(100)},900)}):a.timer1=setTimeout(function(){e.fadeIn(200);d.fadeOut(100);b.fadeOut(100)},900)})}});ETM.DraggableRecurringFoodObjectView=ETM.RecurringFoodObjectView.extend({tagName:"li",className:"diet_draggable row"});
ETM.RecurringFoodListView=Backbone.CollectionView.extend({sortable:!0,selectable:!1,sortableOptions:function(){return ETM.is_mobile?{handle:".recurring_draggable_handle",connectWith:".meal_type_recurring_foods",placeholder:"recurring_list_placeholder",axis:"y",tolerance:"pointer"}:{connectWith:".meal_type_recurring_foods",placeholder:"recurring_list_placeholder",axis:"y",tolerance:"pointer"}},emptyListCaption:"<div class='row'><div class=\"col-xs-1\"></div><div class='col-xs-11 recurring_item_container'><div class='row'><div class='empty_recurring_food_box'>There are no recurring foods in this meal. Drag foods from the sidebar to add them.</div></div></div></div>",
modelView:ETM.DraggableRecurringFoodObjectView});
ETM.RecurringFoodSettingsView=Backbone.View.extend({events:{"change .recurring_select":"changeFrequency","click .open_food_bank":function(){ETM.sidebar_view.toggleFoodBank()}},render:function(){Helper.lockPageHeight();this.$el.html(this.template());this.meal_type_template=ETM.loadNestedTemplate("#RecurringFoodTemplates","#recurringFoodListTemplate");this.renderRecurringFoods();this.applyTipsTooltip();Helper.unlockPageHeight();return this},applyTipsTooltip:function(){$(".recurring_foods_tips",this.el).popover({title:"<strong>Using Recurring Foods</strong>",
content:'<ul class="grocery_tips"><li><strong>Want total control over the foods that the planner uses?</strong> Drag 15-20 foods that you like into a meal (all set to "often"), and check "Only use recurring foods for this meal". The more foods you add, the better the variety will be. </li><li>If you want different foods to recur on different days of the week, create a new meal type for that day in the "Weekly planner layout" page of your settings, or directly in the planner by clicking the meal\'s name. </li><li><strong>Add foods that you already typically eat to make a plan much easier to start following.</strong> Make breakfast and lunch match your typical day, and then leave dinner a surprise. The added redundancy will dramatically shorten your grocery list. </li></ul>',
trigger:"hover",placement:"bottom",html:!0})},renderRecurringFoods:function(){var a=this;$(".recurring_foods",this.el).html("");ETM.meal_type_list.where({deleted:!1}).forEach(function(b){var c=ETM.recurring_foods_list.where({meal_type:b.id}),d=$(a.meal_type_template({meal_type:b.attributes.title})),e=(new Backbone.Form({model:b,schema:{only_use_recurring:{type:"Checkbox"}},template:ETM.loadNestedTemplate("#RecurringFoodTemplates","#onlyUseRecurringFormTemplate"),templateData:{model:b}})).render();
a.listenTo(e,"only_use_recurring:change",function(a,b,c){a.model.save({only_use_recurring:a.getValue().only_use_recurring},{patch:!0})});$(".onlyUseRecurringForm",d).html(e.el);c=new ETM.RecurringFoodList(c);c.meal_type=b.id;b=new ETM.RecurringFoodListView({collection:c,el:$(".meal_type_recurring_foods",d)});b.render();a.listenTo(b.collection,"dragError",function(b){var c="Error(s) adding recurring food: ",d;for(d in b)b.hasOwnProperty(d)&&(c+=b[d].message+".  ");a.$el.append('<div class="alert alert-danger recurring_drag_error col-xs-11 col-xs-offset-1">'+
c+"<div/>");setTimeout(function(){$(".recurring_drag_error",a.el).fadeOut("normal",function(){$(a).remove()})},5E3)},b);$(".recurring_foods",a.el).append(d)})},changeFrequency:function(a){a=$(a.currentTarget);var b=a.val(),c=a.data("id");"always"===b?(a.removeClass("label-info"),a.addClass("label-primary")):(a.removeClass("label-primary"),a.addClass("label-info"));ETM.recurring_foods_list.get(c).save({frequency:ETM.RecurringFood.frequency_types.indexOf(b)},{patch:!0})},deleteRecurringFood:function(a){a.preventDefault();
var b=$(a.currentTarget).data("id"),c=this;Helper.retainPageHeight(function(){ETM.recurring_foods_list.get(b).destroy();c.renderRecurringFoods()})}});
ETM.RegenerateWeekModalView=ModalView.extend({className:"modal fade",events:{"click .submit_regenerate_week":"submitRegenerateWeek","click .reset_weekly_planner":function(){this.render();this.checkPantryStatus()},"change .generator_focus input":function(){ETM.current_user_profile.save({generator_focus:this.form.getValue().generator_focus},{patch:!0})},"change .shopping_day_row select":function(){ETM.current_user_profile.save({shopping_day:this.form.getValue().shopping_day},{patch:!0})}},initialize:function(){var a=
this;this.form_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateWeekForm");this.status_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateStatusView");this.error_template=ETM.loadNestedTemplate("#RegenerateWeekModalTemplates","#regenerateErrorView");this.listenTo(ETM.generator_status,"weeklyProgressUpdated",function(b){"SUCCESS"===b?(is_debug&&show_planner_log&&(window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.host),
window.open(window.location.origin+"/view-planner-log/","_blank")),a.$el.modal("hide"),a.render()):"ERROR"===b?a.renderErrorView():$(".progress_percent",this.el).html(ETM.generator_status.getCurrentProgress())});this.listenTo(ETM.current_user_profile,"change:shopping_day",function(){a.renderForm();a.checkPantryStatus()})},render:function(){ETM.is_premium?(this.$el.html(this.template({})),this.renderForm(),$(".last_updated_eaten_foods .explanation",this.el).popover({title:"<strong>Updating the pantry</strong>",
content:"<p>To regenerate future meal plans, your pantry has to be up-to-date so that the generator knows what foods it can use up. We update the pantry for you automatically every time a weekly meal plan is generated by deducting the foods from your previous meal plans.</p><p>For this to be accurate, it trusts that your previous meal plans accurately reflect what you actually ate. So if you care about the pantry being accurate, make sure you remove any foods you didn't eat from the meal plans and add things you did.</p><p><strong>If you don't have anything in the pantry, don't worry.</strong> The generator will make sure your grocery list has everything you need.</p>",
trigger:"hover",placement:"bottom",html:!0})):this.$el.html(this.template({}));return this},checkPantryStatus:function(){ETM.current_user_profile.attributes.last_updated_eaten_foods!==moment().format("YYYY-MM-DD")?($(".update_pantry_text",this.el).html(pantryUpdateStringRegenerateWeekModal()),$(".last_updated_eaten_foods",this.el).show()):$(".last_updated_eaten_foods",this.el).hide()},renderForm:function(){var a=ETM.current_user_profile.attributes.shopping_day+1;7===a&&(a=0);for(var b,c=0,d=new Date;d.getDay()!=
a&&7>=c;d.setDate(d.getDate()+1))b=d,c++;var e,f,a=moment();e=moment(b);d=moment(e).add("days",1);f=moment(e).add("days",7);b=[a.format("YYYY-MM-DD"),e.format("YYYY-MM-DD")];c="Current week, "+a.format("MMM Do")+" to "+e.format("MMM Do");a=[d.format("YYYY-MM-DD"),f.format("YYYY-MM-DD")];d="Next week, "+d.format("MMM Do")+" to "+f.format("MMM Do");if(ETM.current_user_profile.hasManagerSubscription()){week_3_start=moment(e).add("days",8);week_3_end=moment(e).add("days",14);week_4_start=moment(e).add("days",
15);week_4_end=moment(e).add("days",21);e=[week_3_start.format("YYYY-MM-DD"),week_3_end.format("YYYY-MM-DD")];f="Third week, "+week_3_start.format("MMM Do")+" to "+week_3_end.format("MMM Do");var g=[week_4_start.format("YYYY-MM-DD"),week_4_end.format("YYYY-MM-DD")],h="Fourth week, "+week_4_start.format("MMM Do")+" to "+week_4_end.format("MMM Do");b=[{val:b,label:c},{val:a,label:d},{val:e,label:f},{val:g,label:h}]}else b=[{val:b,label:c},{val:a,label:d}];this.form&&this.form.close();this.form=(new Backbone.Form({schema:{regenerate_weeks:{type:"Checkboxes",
options:b},shopping_day:{type:"Select",value_type:"Number",options:[{val:6,label:"Sunday"},{val:0,label:"Monday"},{val:1,label:"Tuesday"},{val:2,label:"Wednesday"},{val:3,label:"Thursday"},{val:4,label:"Friday"},{val:5,label:"Saturday"}]},reset_groceries:{type:"Checkbox"},send_email:{type:"Checkbox"},generator_focus:{type:"SegmentedRadio",value_type:"Number",options:[{val:0,label:"Balanced"},{val:1,label:"Variety"},{val:2,label:"Macros"},{val:3,label:"Groceries"}]}},data:{regenerate_weeks:[a],shopping_day:ETM.current_user_profile.attributes.shopping_day,
reset_groceries:!0,send_email:!1,generator_focus:ETM.current_user_profile.attributes.generator_focus},template:this.form_template})).render();$(".generator_focus_tooltip",this.form.el).tooltip({placement:"left",html:!0,title:ETM.current_user_profile.generator_focus_toolip_text()});$(".shopping_day_tooltip",this.form.el).tooltip({placement:"left",title:ETM.current_user_profile.regenerate_week_shopping_day_text(),html:!0});$("#modal_body_template",this.el).html(this.form.el);$(".modal-footer",this.el).html('<a href="#" data-dismiss="modal" class="btn btn-default">Cancel</a> <button class="btn btn-orange submit_regenerate_week">Regenerate <span class="glyphicon glyphicon-random"></span></button>')},
renderErrorView:function(){$("#modal_body_template",this.el).html(this.error_template)},renderLoadingInfo:function(){$(".regenerate_info",this.el).hide();$("#regenerate_week_form",this.el).hide();$(".modal-footer",this.el).html('<a href="#" data-dismiss="modal" class="btn btn-default">Close</a>');$("#modal_body_template",this.el).html(this.status_template)},submitRegenerateWeek:function(){$(".regenerate_week_validation_error",this.el).remove();var a=this,b=!1,c=this.form.getValue();if(0===c.regenerate_weeks.length)$('[data-editors="regenerate_weeks"]').append('<div class="alert alert-danger regenerate_week_validation_error" style="float:left">Please select at least one time period</div>');
else{for(var d=0;d<ETM.template_diet_list.length;d++){var e=ETM.template_diet_list.getTemplateDietAtIndex(d);0<e.attributes.diet.attributes.meals.length&&(b=!0);current_scheme=ETM.food_pool.compileSchemeForDiet(e.attributes.diet);if(!ETM.food_pool.schemeIsValid(current_scheme,$("#scheme_validation",a.el),getTemplateWeekday(e.attributes.weekday)))return}b?(ETM.generator_status.newRun(c.regenerate_weeks),ETM.calendar_list.regenerateWeeks(c),c.regenerate_weeks=JSON.stringify(c.regenerate_weeks),ETM.analytics.logRegenerate(c),
$.ajax({type:"POST",url:"/regenerate-weeks/",data:c,success:function(b){a.renderLoadingInfo();ETM.StatusTracker.init()},error:function(){console.log("error with fetch")}})):$('[data-editors="regenerate_weeks"]').append('<div class="alert alert-danger regenerate_week_validation_error" style="float:left">You weekly templates have no meals.  Add at least one meal to one template to regenerate.</div>')}}});ETM.status_tracker=!1;
var progress_comments=[[20,"Wiping down counter top;Preheating oven;Rinsing vegetables;Getting mentally prepared;Sharpening knives;Spinning saucers".split(";")],[85,"Slicing salty sausage;Peeling prickly potatoes;Saut\u00e9ing summer squash;Sizzling succotash;Mincing onions;Finely filleting fresh flounder;Folding fine foie gras;Braising browned beef;Buttering blue beets;Thinking about Stir Friday;Tenderizing tomatoes;Crying because of onions;Creaming crispy cranberries;Turning turbid turnips".split(";")],
[101,["Cleaning dishes","Wrapping up","Counting calories","Setting the table","Taking out the trash"]]];
ETM.GeneratorStatus=Backbone.Model.extend({initialize:function(){this.weeks={};this.past_progress=0;this.current_comment="";this.available_comments=$.extend(!0,[],progress_comments)},newRun:function(a){var b=this;this.weeks={};this.past_progress=0;this.current_comment="";this.available_comments=$.extend(!0,[],progress_comments);_.each(a,function(a){b.weeks[a]=0})},setProgressAndComment:function(a){if(a!=this.past_progress&&!isNaN(a))for(var b=0;b<this.available_comments.length;b++)if(a<this.available_comments[b][0]){var c=
Helper.randomNumber(this.available_comments[b][1].length);this.current_comment=this.available_comments[b][1][c];1<this.available_comments[b][1].length&&this.available_comments[b][1].splice(c,1);break}this.past_progress=a},progressError:function(){},updateProgress:function(a){if("PENDING"===a)this.setProgressAndComment(0);else if("ERROR"===a)this.progressError();else if("SUCCESS"!==a){var b=0,c=0;for(progress_counter in a)c++,b+=a[progress_counter];if(0!=b||0!=c)a=roundNumber(b/c,0),99<a&&(a=99),this.setProgressAndComment(a)}},
getCurrentProgress:function(){return 0===this.past_progress?"1% Preparing ingredients...":this.past_progress+"% "+this.current_comment+"..."},getCurrentProgressShort:function(){return 0===this.past_progress?"1%":this.past_progress+"%"}});
ETM.StatusTracker={failed:0,interval:2E3,init:function(){!1!=ETM.status_tracker&&clearTimeout(ETM.status_tracker);ETM.status_tracker=setTimeout($.proxy(this.getData,this),this.interval)},getData:function(){var a=this;$.ajax({url:"/check-generator-progress/",success:function(b){"SUCCESS"===b||"ERROR"===b?(ETM.generator_status.updateProgress(b),ETM.generator_status.trigger("weeklyProgressUpdated",b),ETM.generator_status.trigger("finishedWeeklyPlanner",b),a.stopPolling()):(ETM.generator_status.updateProgress(b),
ETM.generator_status.trigger("weeklyProgressUpdated",b),a.init())},error:$.proxy(a.errorHandler,a)})},errorHandler:function(){10>++this.failed&&(this.interval+=1E3,this.init())},stopPolling:function(){clearTimeout(ETM.status_tracker);ETM.status_tracker=!1}};
ETM.RestaurantNutritionMatchView=Backbone.View.extend({initialize:function(a){var b=this;$.each(a,function(a,d){b[a]=d});this.last_visited_marker_index=-1},render:function(){this.meal_object.parent_view=this.parent_view;var a=new ETM.SwapRestaurantMealObjectView({model:this.meal_object});a.show_missing_ingredients=!1;this.$el.html(a.render().el);this.removeMealControls(a);return this},removeMealControls:function(a){a.undelegateEvents()},cycleThroughLocationsListener:function(){$("a",this.el).blur();
for(var a=!1,b=null,c=this.last_visited_marker_index+1;!a&&c<this.markers.length;c++)this.markers[c].sanitizedRestaurantName===this.sanitized_restaurant_name&&(a=!0,b=c);for(c=0;!a&&c<this.last_visited_marker_index;c++)this.markers[c].sanitizedRestaurantName===this.sanitized_restaurant_name&&(a=!0,b=c);null!=b&&(this.map.panTo(this.markers[b].getPosition()),google.maps.event.trigger(this.markers[b],"click"),this.last_visited_marker_index=b)},applyEvents:function(){var a=this,b=$('<div class="num_locations_container inline_block"/>'),
c=$('<div class="nutrition_match_color_box" style="background:'+this.color+'"></div>');b.append(c);c=$('<a href="#" style="margin-left: 10px">'+a.num_locations+(1<a.num_locations?" locations ":" location ")+"found</a></h4>");b.append(c);$(".replace_meal_button",this.el).after(b);b.click(function(){a.cycleThroughLocationsListener()})}});
ETM.RestaurantResultView=ETM.RestaurantNutritionMatchView.extend({events:{"click .collapse_button":"toggleCollapse"},render:function(){var a=this,b="restaurant_"+this.restaurant_index;a.$el.html(this.template({restaurant_collapse_id:b,sanitized_restaurant_name:this.sanitized_restaurant_name,restaurant_name:this.meal_list.restaurant_name,color:this.color,num_locations:a.num_locations,has_meals:0<this.meal_list.length}));var c=$("#"+b,a.el);this.meal_list.forEach(function(b){b.parent_view=a.parent_view;
b=new ETM.SwapRestaurantMealObjectView({model:b});b.show_missing_ingredients=!1;c.append(b.render().el);a.removeMealControls(b)});return this},toggleCollapse:function(a){$(".collapse",this.el).hasClass("in")?$(a.currentTarget).html('<span class="glyphicon glyphicon-plus"></span>'):$(a.currentTarget).html('<span class="glyphicon glyphicon-minus"></span>')},expand:function(){$(".collapse_button",this.el).html('<span class="glyphicon glyphicon-minus"></span>');$(".collapse",this.el).collapse("show")},
applyEvents:function(){var a=this,b=$("#"+this.sanitized_restaurant_name,a.el);b.tooltip({title:"Click to cycle between locations of this restaurant on the map.",html:!0,animation:!1,position:"top"});b.click(function(){a.cycleThroughLocationsListener()})}});
ETM.ResultsView=Backbone.View.extend({events:{"click .update_weight_button":function(){ETM.router.renderWeightModal();ETM.weight_modal.$el.modal("show");setTimeout('$(".weight_input_field").focus()',400)}},initialize:function(){var a=this;this.weight_entries=new ETM.WeightEntryList;this.weight_entries_data=[];this.calorie_target_data=[];this.actual_calorie_data=[];this.theoretical_calorie_data=[];this.theoretical_macros_data={protein:[],fat:[],carbs:[]};this.actual_macros_data={protein:[],fat:[],
carbs:[]};this.theoretical_micros_data={};this.calendar_fetch_complete=this.weight_fetch_complete=!1;this.days_to_fetch=40;this.start_date_to_fetch=new Date;this.start_date_to_fetch.setDate(this.start_date_to_fetch.getDate()-this.days_to_fetch);this.today=new Date;ETM.calendar_list||(ETM.calendar_list=new ETM.CalendarDietList([],{selected_date:this.today}));this.listenTo(ETM.current_user_profile,"change:units change:weight",function(){a.weight_entries_data=[];a.weight_entries.forEach(function(b){a.weight_entries_data.push({x:Helper.parseDateString(b.attributes.date).getTime()/
1E3,y:b.getWeightForCurrentUnits()})});a.updateWeightGoalData();try{a.weight_graph.series[0].data=a.weight_entries_data,a.weight_graph.series[1].data=a.weight_goal_data,a.weight_graph.update()}catch(b){}},this);this.listenTo(ETM.current_user_profile,"change:weight_goal change:weight_goal_date",function(){a.updateWeightGoalData();try{a.weight_graph.series[1].data=a.weight_goal_data,a.weight_graph.update()}catch(b){}},this)},render:function(){this.$el.html(this.template());var a="M"==ETM.current_user_profile.attributes.units?
"kgs":"lbs";$(".weight_graph_title",this.el).html("Your weight ("+a+") over time");$(".weight_graph_section #y_axis_label",this.el).html("Weight ("+a+")");return this},drawGraphs:function(){var a=this;this.weight_fetch_complete&&this.calendar_fetch_complete?(this.renderWeightGraph(),this.renderCalorieGraph(),this.renderMacrosGraph(),this.renderMicrosGraph()):(this.weight_fetch_complete||$.when(this.weight_entries.fetch()).done(function(){a.weight_fetch_complete=!0;a.weight_entries.forEach(function(b){a.weight_entries_data.push({x:Helper.parseDateString(b.attributes.date).getTime()/
1E3,y:b.getWeightForCurrentUnits()})});a.renderWeightGraph()}),this.calendar_fetch_complete||$.when(ETM.calendar_list.getDietsFromStartAndEndDate(this.start_date_to_fetch,this.today)).done(function(){a.calendar_fetch_complete=!0;a.formatCalendarData();a.renderCalorieGraph();a.renderMacrosGraph();a.renderMicrosGraph()}))},updateWeightGoalData:function(){if(0<this.weight_entries.length&&(this.weight_goal_data=[{x:this.weight_entries_data[0].x,y:this.weight_entries_data[0].y}],null!=ETM.current_user_profile.attributes.weight_goal_date&&
null!=ETM.current_user_profile.attributes.weight_goal)){var a=ETM.current_user_profile.attributes.weight_goal;"M"==ETM.current_user_profile.attributes.units&&(a=0.453592*ETM.current_user_profile.attributes.weight_goal);this.weight_goal_data=[{x:this.weight_entries_data[0].x,y:this.weight_entries_data[0].y},{x:Helper.parseDateString(ETM.current_user_profile.attributes.weight_goal_date).getTime()/1E3,y:a}]}},renderWeightGraph:function(){$("#weight_graph",this.el).empty();$("#weight_legend",this.el).empty();
$(".weight_graph_section",this.el).show();$(".weight_graph_spinner",this.el).hide();this.updateWeightGoalData();if(0<this.weight_entries_data.length){this.weight_graph=new Rickshaw.Graph({element:document.querySelector("#weight_graph"),renderer:"multi",interpolation:"linear",min:"auto",padding:{top:0.2,right:0.01,bottom:0.08,left:0.01},series:[{color:"steelblue",name:"Your weight",data:this.weight_entries_data,renderer:"lineplot"},{color:"lightblue",name:"Your weight goal",data:this.weight_goal_data,
renderer:"line"}]});this.weight_graph.render();(new Rickshaw.Graph.Axis.Time({graph:this.weight_graph})).render();(new Rickshaw.Graph.Axis.Y({graph:this.weight_graph,pixelsPerTick:20})).render();new Rickshaw.Graph.HoverDetail({graph:this.weight_graph,yFormatter:function(a){return null===a?a:a.toFixed(1)},formatter:function(a,c,d,e,f,g){return a.name+":&nbsp;"+f+"&nbsp;"+("M"==ETM.current_user_profile.attributes.units?"kgs":"lbs")}});var a=new Rickshaw.Graph.Legend({graph:this.weight_graph,element:document.getElementById("weight_legend")});
new Rickshaw.Graph.Behavior.Series.Toggle({graph:this.weight_graph,legend:a});new Rickshaw.Graph.RangeSlider({graph:this.weight_graph,element:document.getElementById("weight_preview")})}else $(".weight_graph_section #y_axis_label",this.el).hide(),$(".weight_graph_section  #x_axis_label",this.el).hide(),$("#weight_graph",this.el).html('<br/><div class="alert alert-warning">Please enter a weight and reload this page.</div>')},formatCalendarData:function(){var a=this;this.calorie_target_data=[];this.actual_calorie_data=
[];this.theoretical_calorie_data=[];this.theoretical_micros_data={};this.theoretical_macros_data={proteins:[],fats:[],carbs:[]};this.actual_macros_data={proteins:[],fats:[],carbs:[]};ETM.calendar_list.forEach(function(b){if(null!=b.get("diet")){var c=Helper.parseDateString(b.attributes.date).getTime()/1E3;a.calorie_target_data.push({x:c,y:b.get("diet").get("nutrition_profile").get("calories")});a.theoretical_calorie_data.push({x:c,y:b.get("diet").stats.calories});a.theoretical_macros_data.proteins.push({x:c,
y:b.get("diet").stats.proteins});a.theoretical_macros_data.fats.push({x:c,y:b.get("diet").stats.fats});a.theoretical_macros_data.carbs.push({x:c,y:b.get("diet").stats.carbs});daily_rec.forEach(function(d,e){if(0<d){var f=all_nutrients[e],g=ETM.nutrient_names[f];null==a.theoretical_micros_data[g]&&(a.theoretical_micros_data[g]=[]);a.theoretical_micros_data[g].push({x:c,y:roundNumber(100*b.get("diet").stats[f]/d,0)})}});var d=0,e=0,f=0,g=0;b.get("diet").get("meals").forEach(function(a){a.attributes.eaten&&
(d+=a.stats.calories,e+=a.stats.proteins,f+=a.stats.fats,g+=a.stats.carbs)});a.actual_calorie_data.push({x:c,y:d});a.actual_macros_data.proteins.push({x:c,y:e});a.actual_macros_data.fats.push({x:c,y:f});a.actual_macros_data.carbs.push({x:c,y:g})}})},renderCalorieGraph:function(){$("#calorie_graph",this.el).empty();$("#calorie_legend",this.el).empty();$(".calorie_graph_section",this.el).show();$(".calorie_graph_spinner",this.el).hide();this.calorie_graph=new Rickshaw.Graph({element:document.querySelector("#calorie_graph"),
interpolation:"linear",renderer:"multi",min:"auto",padding:{top:0.2,right:0.01,bottom:0.08,left:0.01},series:[{color:"lightblue",name:"Planned calories",data:this.theoretical_calorie_data,renderer:"line"},{color:"orange",name:"Tracked calories",data:this.actual_calorie_data,renderer:"line"},{color:"steelblue",name:"Target calories",data:this.calorie_target_data,renderer:"line"}]});this.calorie_graph.render();(new Rickshaw.Graph.Axis.Time({graph:this.calorie_graph})).render();(new Rickshaw.Graph.Axis.Y({graph:this.calorie_graph,
pixelsPerTick:20})).render();new Rickshaw.Graph.HoverDetail({graph:this.calorie_graph});var a=new Rickshaw.Graph.Legend({graph:this.calorie_graph,element:document.getElementById("calorie_legend")});new Rickshaw.Graph.Behavior.Series.Toggle({graph:this.calorie_graph,legend:a});new Rickshaw.Graph.RangeSlider({graph:this.calorie_graph,element:document.getElementById("calorie_preview")})},renderMacrosGraph:function(){$("#macros_graph",this.el).empty();$("#macros_legend",this.el).empty();$(".macros_graph_section",
this.el).show();$(".macros_graph_spinner",this.el).hide();this.macros_graph=new Rickshaw.Graph({element:document.querySelector("#macros_graph"),interpolation:"linear",renderer:"multi",min:"auto",padding:{top:0.2,right:0.01,bottom:0.08,left:0.01},series:[{color:"lightgreen",name:"Fats",data:this.theoretical_macros_data.fats,renderer:"line"},{color:"lightblue",name:"Proteins",data:this.theoretical_macros_data.proteins,renderer:"line"},{color:"khaki",name:"Carbs",data:this.theoretical_macros_data.carbs,
renderer:"line"},{color:"green",name:"Tracked Fats",data:this.actual_macros_data.fats,renderer:"line",disabled:!0},{color:"blue",name:"Tracked Proteins",data:this.actual_macros_data.proteins,renderer:"line",disabled:!0},{color:"orange",name:"Tracked Carbs",data:this.actual_macros_data.carbs,renderer:"line",disabled:!0}]});this.macros_graph.render();(new Rickshaw.Graph.Axis.Time({graph:this.macros_graph})).render();(new Rickshaw.Graph.Axis.Y({graph:this.macros_graph,pixelsPerTick:20})).render();new Rickshaw.Graph.HoverDetail({graph:this.macros_graph});
var a=new Rickshaw.Graph.Legend({graph:this.macros_graph,element:document.getElementById("macros_legend")});new Rickshaw.Graph.Behavior.Series.Toggle({graph:this.macros_graph,legend:a});new Rickshaw.Graph.RangeSlider({graph:this.macros_graph,element:document.getElementById("macros_preview")})},renderMicrosGraph:function(){var a=[],b=new Rickshaw.Color.Palette({scheme:"munin"}),c;for(c in this.theoretical_micros_data)this.theoretical_micros_data.hasOwnProperty(c)&&a.push({color:b.color(),name:c,data:this.theoretical_micros_data[c],
renderer:"line"});$("#micros_graph",this.el).empty();$("#micros_legend",this.el).empty();$(".micros_graph_section",this.el).show();$(".micros_graph_spinner",this.el).hide();this.micros_graph=new Rickshaw.Graph({element:document.querySelector("#micros_graph"),interpolation:"linear",renderer:"multi",min:"auto",padding:{top:0.2,right:0.01,bottom:0.08,left:0.01},series:a});this.micros_graph.render();(new Rickshaw.Graph.Axis.Time({graph:this.micros_graph})).render();(new Rickshaw.Graph.Axis.Y({graph:this.micros_graph,
pixelsPerTick:20})).render();new Rickshaw.Graph.HoverDetail({graph:this.micros_graph});a=new Rickshaw.Graph.Legend({graph:this.micros_graph,element:document.getElementById("micros_legend")});new Rickshaw.Graph.Behavior.Series.Toggle({graph:this.micros_graph,legend:a});new Rickshaw.Graph.RangeSlider({graph:this.micros_graph,element:document.getElementById("micros_preview")})}});
ETM.SaveDietModalView=ModalView.extend({className:"modal fade",events:{"click #save_changes":"saveDiet","keypress #current-diet-title input":"handleKeypress"},initialize:function(){this.template=ETM.loadNestedTemplate("#DietMenuModalsView","#saveDietModalTemplate")},render:function(){this.$el.html(this.template({diet:ETM.current_diet}));var a=roundNumber(ETM.current_diet.attributes.num_meals,1)+" Meals\n"+roundNumber(ETM.current_diet.stats.calories,1)+" Calories\n\n"+roundNumber(ETM.current_diet.stats.carbs,
1)+" Carbs\n"+roundNumber(ETM.current_diet.stats.fats,1)+" Fat\n"+roundNumber(ETM.current_diet.stats.proteins,1)+" Protein\nEstimated "+ETM.current_diet.stats.price.toFixed(2);$("#meal-plan-stats",this.el).text(a);return this},handleKeypress:function(a){13==a.which&&this.saveDiet(a)},saveDiet:function(a){var b=this;a.preventDefault();$(".form-error",this.el).remove();a=$("#diet_title",this.el).val().trim();if(!a||/^\s*$/.test(a))$("#current-diet-title",this.el).append("<div class='form-error alert alert-danger inline'>Diet must have a title</div>");
else{var c=ETM.current_diet.clone();c.attributes.title=a;c.attributes.sandbox=1;c.attributes.summary=$("#meal-plan-stats",this.el).val();Helper.clearIDs(c);c.attributes.meals.each(function(a){Helper.clearIDs(a);a.attributes.foods.each(function(a){Helper.clearIDs(a)})});c.save(null,{silent:!0,success:function(){$(".save_errors",b.el).remove();ETM.diet_list.add(c);b.$el.modal("hide")},error:function(a,c,f){$(".save_errors",b.el).remove();$(".modal-body",b.el).append('<div class="alert alert-danger">'+
c+"</div>")}})}}});
ETM.SavePlansModalView=ModalView.extend({className:"modal fade",events:{"click .save_plans_submit":"saveDiet","keypress #current-diet-title input":"handleKeypress","click .view_saved_plans_list":"viewSavedPlans","click .view_client_accounts":"viewClientAccounts","click .view_saved_plan_btn":function(){this.$el.modal("hide");ETM.router.navigate("dietset/"+this.recently_saved_plan.attributes.diet_key+""+this.recently_saved_plan.attributes.id+"/",{trigger:!0})},"click .share_saved_plan_btn":function(){var a=this;
this.$el.one("hidden.bs.modal",function(b){a.share_diet_set_modal=new ETM.ShareDietModalView({model:a.recently_saved_plan});$("#share_diet_set_modal",ETM.$modal_content).html(a.share_diet_set_modal.render().el);a.share_diet_set_modal.$el.modal("show");a.share_diet_set_modal.delegateEvents()});this.$el.modal("hide")}},initialize:function(){this.end_date=this.start_date=0;this.recently_saved_plan=null},render:function(){var a=this;this.$el.html(this.template({start_date:this.start_date,end_date:this.end_date}));
this.$el.modal({show:!1});ETM.is_premium&&($(".date_range_selector",this.el).kalendae({mode:"range",months:2,useYearNav:!1}),$(".date_range_selector",this.el).data("kalendae").subscribe("hide",function(b){a.queryPlanSummary();a.updateSaveTitle()}));return this},handleKeypress:function(a){13==a.which&&this.saveDiet(a)},viewSavedPlans:function(){ETM.router.navigate("settings/saved-plans/",{trigger:!0});this.$el.modal("hide")},viewClientAccounts:function(){ETM.router.navigate("account-management/edit-plans/",
{trigger:!0});this.$el.modal("hide")},updateSaveTitle:function(){var a=$("#diet_title",this.el),b="My saved plan";-1!==a.val().trim().indexOf("saved plan")&&(b=$(".date_range_selector",this.el).data("kalendae").getSelected().split(" - "),b=1<b.length?b[0]==b[1]?moment(b[0]).format("MMM D")+" saved plan":moment(b[0]).format("MMM D")+" - "+moment(b[1]).format("MMM D")+" saved plan":moment(b[0]).format("MMM D")+" saved plan",a.val(b))},queryPlanSummary:function(){var a=$(".date_range_selector",this.el).data("kalendae").getSelected(),
b=this;$(".save_plans_submit",this.el).removeAttr("disabled");a?$.get("/weeklyplanner/get-plan-summary/",{date_range:a},function(a){var d=JSON.parse(a);a=d.num_plans;d=d.plan_stats;0==a?b.disableSaveFunctions():(1==a?$(".num_plans_to_save",b.el).html("You have selected 1 meal plan to save."):$(".num_plans_to_save",b.el).html("You have selected "+a+" meal plans to save."),$(".calories_info",b.el).html(roundNumber(d.calories,1)),$(".carbs_info",b.el).html(roundNumber(d.carbs,1)),$(".fats_info",b.el).html(roundNumber(d.fats,
1)),$(".proteins_info",b.el).html(roundNumber(d.proteins,1)))}):b.disableSaveFunctions()},disableSaveFunctions:function(a){$(".save_plans_submit",self.el).attr("disabled",!0);$(".num_plans_to_save",self.el).html("<span class='text-danger'>This date range has no plans to save.</span>");$(".calories_info",self.el).html("N/A");$(".carbs_info",self.el).html("N/A ");$(".fats_info",self.el).html("N/A ");$(".proteins_info",self.el).html("N/A ")},renderPlanSummary:function(){$(".current_date",this.el).html(moment().format("MMM Do"));
$(".calories_info",this.el).html(roundNumber(ETM.current_diet.stats.calories,1));$(".carbs_info",this.el).html(roundNumber(ETM.current_diet.stats.carbs,1));$(".fats_info",this.el).html(roundNumber(ETM.current_diet.stats.fats,1));$(".proteins_info",this.el).html(roundNumber(ETM.current_diet.stats.proteins,1))},saveDiet:function(a){var b=this;a.preventDefault();$(".form-error",this.el).remove();if(ETM.is_premium){if(a=$(".date_range_selector",this.el).data("kalendae").getSelected(),!a||/^\s*$/.test(a)){$(".date_range_selector",
this.el).append("<div class='form-error alert alert-danger inline'>Please select a date or date range to save</div>");return}}else a=getCurrentCalendarDateRangeString();var c=$("#diet_title",this.el).val().trim();if(!c||/^\s*$/.test(c))$("#current-diet-title",this.el).append("<div class='form-error alert alert-danger inline'>Diet must have a title</div>");else{b.$el.one("hidden.bs.modal",function(a){$(".footer_buttons",b.el).show();$(".ajax_success",b.el).hide();$(".ajax_failure",b.el).hide()});var d=
$("#meal-plan-description",this.el).val();a={date_range:a,title:c,description:d};$(".ajax_progress",this.el).show();$(".footer_buttons",this.el).hide();$(".ajax_failure",this.el).hide();$.post("/weeklyplanner/save-diet-plans/",a,function(a){$(".ajax_progress",b.el).hide();"Too many saved plans"==a?($(".ajax_failure",b.el).show(),$(".footer_buttons",b.el).show(),$(".ajax_success",b.el).hide(),$(".save_error_text",b.el).html("You have too many saved plans! <a href='javascript:void(0);' class='view_saved_plans_list'>Delete some to save more.</a>")):
"Too many days"==a?($(".ajax_failure",b.el).show(),$(".footer_buttons",b.el).show(),$(".ajax_success",b.el).hide(),$(".save_error_text",b.el).html("There are too many days in your plan! We have a limit of 31 days at a time.")):(a=JSON.parse(a),a=ETM.diet_set_list.add(a),b.recently_saved_plan=a,$(".ajax_success",b.el).show())}).fail(function(){$(".ajax_progress",b.el).hide();Backbone.trigger("flash",{message:"Error accessing plans, check your date range.",type:"danger"});$(".footer_buttons",b.el).show()})}}});
ETM.SavePublicDietModalView=ETM.SaveDietModalView.extend({saveDiet:function(a){a.preventDefault();$(".form-error",this.el).remove();a=$("#diet_title",this.el).val().trim();if(!a||/^\s*$/.test(a))$("#current-diet-title",this.el).append("<div class='form-error alert alert-danger inline'>Diet must have a title</div>");else{var b=ETM.current_diet.clone();b.attributes.title=a;b.attributes.sandbox=1;b.attributes.summary=$("#meal-plan-stats",this.el).val();Helper.clearIDs(b);b.attributes.meals.each(function(a){Helper.clearIDs(a);
delete a.attributes.user;Helper.clearIDs(a.attributes.meal_type);a.attributes.foods.each(function(a){Helper.clearIDs(a);delete a.attributes.user})});b.save();ETM.diet_list.add(b);this.$el.modal("hide")}}});
ETM.SavedPlansView=Backbone.View.extend({render:function(){this.$el.html(this.template({is_premium:ETM.is_premium,diet_sets:ETM.diet_set_list}));this.renderSetGrid();return this},renderSetGrid:function(){var a=new Backgrid.Grid({columns:[{name:"title",label:"Title",cell:"string"},{name:"num_diets",label:"Number of days",editable:!1,cell:"integer"},{name:"average_calories",label:"Avg Calories",editable:!1,cell:"integer"},{name:"created",label:"Created",editable:!1,cell:"date"},{name:"",label:"View / Edit",
editable:!1,cell:ETM.ViewDietSetCell},{name:"",label:"Share",editable:!1,cell:ETM.ShareLinkCell},{name:"",label:"Delete",editable:!1,cell:ETM.DeleteRowCell}],collection:ETM.diet_set_list});$("#diet_plan_set_table",this.el).append(a.render().el)}});
ETM.OriginalRecipeView=Backbone.View.extend({tagName:"li",className:"recipe_list_item",render:function(){this.template=ETM.loadNestedTemplate("#SavedRecipeTemplates","#originalRecipeItemTemplate");this.$el.html(this.template({title:this.model.attributes.food.attributes.food_name,id:this.model.id?this.model.id:this.model.cid}));this.showDeleteOnHover(this.$el,".recipe_list_item_delete");return this},showDeleteOnHover:function(a,b){a.hover(function(){$(this).find(b).show()},function(){$(this).find(b).hide()})}});
ETM.OriginalRecipesCollectionView=Backbone.CollectionView.extend({sortable:!1,selectable:!1,emptyListCaption:"<div class='empty_saved_plans_box'>You have no original recipes.</div>",modelView:ETM.OriginalRecipeView});
ETM.DeleteRowCell=Backgrid.Cell.extend({events:{"click button":"deleteRow"},className:"delete_cell",deleteRow:function(a){a.preventDefault();this.model.destroy()},render:function(){this.$el.html('<button class="btn btn-danger btn-sm"><span class="glyphicon glyphicon-remove"></span></button>');return this}});
ETM.ViewDietSetCell=Backgrid.Cell.extend({className:"view_cell",render:function(){this.$el.html("<a onclick='ETM.router.navigate(\"dietset/"+this.model.attributes.diet_key+""+this.model.attributes.id+'/", {trigger: true});\' href="javascript:void(0);" class="btn btn-primary btn-sm">View / Edit</a>');return this}});
ETM.ViewDietsCell=Backgrid.Cell.extend({className:"view_cell",render:function(){this.$el.html('<a href="/diet/'+this.model.attributes.diet_key+""+this.model.attributes.id+'" class="btn btn-primary btn-sm">View / Edit</a>');return this}});
ETM.ShareLinkCell=Backgrid.Cell.extend({className:"share_link_cell",events:{"click button":"openShareModal"},openShareModal:function(){this.share_diet_set_modal||(this.share_diet_set_modal=new ETM.ShareDietModalView({model:this.model}));$("#share_diet_set_modal",ETM.$modal_content).html(this.share_diet_set_modal.render().el);this.share_diet_set_modal.$el.modal("show");this.share_diet_set_modal.delegateEvents()},render:function(){this.$el.html('<button class="btn share_link btn-success btn-sm" value="'+
CURRENT_SITE_URL+"/dietset/"+this.model.attributes.diet_key+""+this.model.attributes.id+'/"><span class="glyphicon glyphicon-send"></span></button>');return this}});ETM.SavedRecipesView=Backbone.View.extend({initialize:function(){this.custom_foods=new ETM.CustomFoodList([],{url:ROOT+"/customfood/"});this.custom_recipes=new ETM.CustomFoodList([],{url:ROOT+"/customrecipe/"})},render:function(){this.$el.html(this.template({is_premium:ETM.is_premium,user:ETM.current_user_profile.attributes}));return this}});
ETM.SidebarFoodObjectView=ETM.FoodObjectView.extend({className:"foodbank_food",events:{"click .custom_delete":"deleteCustomFood","click .favorite_delete":"deleteFavorite","click .custom_edit":"editCustomFood","click .food_image a":"openStaticFoodModal"},render:function(){this.model.image=this.model.attributes.food.getDisplayImage();var a=this.template({model:this.model,list_type:this.list_type,mobile:ETM.is_mobile});this.$el.html(a);this.$el.attr("data-model-cid",this.model.cid);this.applyTooltip();
this.applyDraggable();return this},initialize:function(a){this.list_type="undefined"!=typeof a.list_type?a.list_type:"generic";this.listenTo(this.model,"delegateEvents",function(){this.delegateEvents();this.applyTooltip();this.applyDraggable()},this);this.listenTo(this.model,"deleteItem",function(){this.model.destroy();this.remove()},this);this.listenTo(this.model,"change:food",function(){this.render();this.updateTooltip();this.$el.tooltip("hide")},this)},applyDraggable:function(){handle=ETM.is_mobile?
".sidebar_draggable_handle":null;this.$el.draggable({handle:handle,connectToSortable:ETM.sidebar_view.ingredients_only?".ingredients_list, .parse_result_list":".meal_foods, .meal_type_recurring_foods, .grocery_foods_list, .parse_result_list",helper:"clone",tolerance:"pointer",placeholder:"list_placeholder",start:function(a,b){$(b.helper).tooltip("hide");$(b.helper).tooltip("disable")}})},deleteCustomFood:function(){this.$el.tooltip("hide");this.$el.tooltip("disable");this.model.attributes.food.save({deleted:!0},
{patch:!0});ETM.sidebar_view.active_view.collection.food_info_object_list.remove(this.model.attributes.food.id);this.model.destroy();this.close();return!1},deleteFavorite:function(){this.$el.tooltip("hide");this.$el.tooltip("disable");var a=ETM.favorite_foods_list.where({food:this.model.attributes.food.id});0<a.length?(favorite_object=a[0],this.model.is_favorite=!1,this.model.attributes.food.trigger("removeFavorite"),favorite_object.destroy(),this.undelegateEvents(),this.close()):console.log("FOUND NO FAVORITE ITEM (something broke - no longer synchronized with the favorites list)")},
editCustomFood:function(){if(this.model.get("food").get("is_recipe")){var a=this;this.model.get("food").downloadRecipeInfo(function(){ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.copyThenLoad(a.model,!0);$("#food_object_modal_div").html(ETM.recipe_editor.render().el);ETM.recipe_editor.printGraph();ETM.recipe_editor.applyEvents()})}else ETM.sidebar_view.custom_food_form=new ETM.CustomFoodFormView({model:ETM.sidebar_view.custom_foods_view.collection.food_info_object_list}),ETM.sidebar_view.custom_food_form.parent=
this,$("#food_form_modal",this.el).html(ETM.sidebar_view.custom_food_form.render()),ETM.sidebar_view.custom_food_form.food_id=this.model.attributes.food.attributes.id,ETM.sidebar_view.custom_food_form.loadFood(this.model.attributes.food),ETM.sidebar_view.custom_food_form.$el.modal("show")}});
ETM.SidebarPantryFoodObjectView=ETM.SidebarFoodObjectView.extend({applyIngredientsLookup:function(){var a=this,b=this.model.attributes.food;this.$el.hover(function(){if(b.hasOwnProperty("tooltip_ingredients"))update_ingredients_timer=setTimeout(function(){a.updateTooltip()},tooltip_show_delay+1);else{var c=b.attributes.id,d=grabPantrySidebarIngredients(c);!1==d?tooltip_timer=setTimeout(function(){$.post("/food/fetch_sidebar_pantry_ingredients/",{recipe_ids:JSON.stringify([c])},function(d){all_pantry_sidebar_ingredients[c]=
JSON.parse(d);b.tooltip_ingredients=all_pantry_sidebar_ingredients[c];a.updateTooltip()})},tooltip_show_delay+150):(b.tooltip_ingredients=d,a.updateTooltip())}},function(){clearTimeout(tooltip_timer);clearTimeout(update_ingredients_timer)})},tooltipHTML:function(){var a=this.model.attributes.food,b=this.model.attributes.food.attributes,c=b.food_name,d=b.description,e=this.model.stats,f="";if(b.is_recipe){var g="<div class='tooltip_units'>"+b.prep_time+" mins prep, "+b.cook_time+" mins cook</div>",
c='<div class="sb_tooltip_title">'+c+"</div>";a.hasOwnProperty("tooltip_ingredients")?(d=this.model.getServingAmount(),a="<hr class='ingredients_bar'/><div class='recipe_ingredients'>"+pantrySidebarIngredientsHTML(a,d,b.number_servings)+"</div>"):a="<hr class='ingredients_bar'/><div class='recipe_ingredients'><img src='/static_files/ttp_spinner.gif'/></div>"}else g="",c='<div class="sb_tooltip_title">'+c+'</div><div class="sb_tooltip_desc">'+d+"</div>",a="",_.has(this.model.attributes,"origin_string")&&
0<this.model.attributes.origin_string.length&&(f="<hr class='ingredients_bar'/><div class='grocery_origin'>"+this.model.attributes.origin_string+"</div>");d="";0<e.price?(d='<div class="tt_macro tooltip_price"><div class="tt_macro_name">Est. Price</div><div class="tt_macro_amt">$'+roundNumber(e.price,2).toFixed(2)+"</div></div>",b.is_recipe&&b.missing_prices&&(d+="<div>*Some missing price info</div>")):d="No price info";b="<div class='tooltip_units'>Per "+Helper.formatFoodAmount(this.model.attributes.amount*
b.weights[this.model.attributes.units].amount)+" "+b.weights[this.model.attributes.units].description+"</div>";e='<div class="tt_macro tooltip_carbs"><div class="tt_macro_name">Carbs</div><div class="tt_macro_amt">'+roundNumber(e.carbs,1)+'g</div></div><div class="tt_macro tooltip_fats"><div class="tt_macro_name">Fat</div><div class="tt_macro_amt">'+roundNumber(e.fats,1)+'g</div></div><div class="tt_macro tooltip_proteins"><div class="tt_macro_name">Protein</div><div class="tt_macro_amt">'+roundNumber(e.proteins,
1)+'g</div></div><div class="tt_macro tooltip_calories"><div class="tt_macro_name">Calories</div><div class="tt_macro_amt">'+roundNumber(e.calories,1)+"</div></div>"+d;return'<div class="tooltip_box">'+c+g+b+e+a+f+"</div>"}});
ETM.SidebarListView=Backbone.View.extend({events:{"click .add_custom":"newCustomFood","click .add_recipe":"newRecipe","click .sidebar_pantry_refresh > a":"refreshPantrySuggestions"},initialize:function(a){this.list_type="generic";for(var b in a)this[b]=a[b];this.search_template=ETM.loadNestedTemplate("#SidebarFoodListTemplates",".search_results_view")},render:function(a){var b=this;this.$el.html(this.template({is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium}));var c=$("ul",this.el);ETM.is_logged_in||
"custom_recipes"!=this.list_type&&"custom_foods"!=this.list_type?this.collection.fetchFoodInfoObjects(function(){b.collection.models.forEach(function(a){a=new ETM.SidebarFoodObjectView({model:a,list_type:b.list_type});a.parent=b;c.append(a.render().el)},b);Helper.resizeSidebar();a(b)}):a(b)},find:function(a){return this.collection.get(a)},refreshPantrySuggestions:function(){this.search=!0;ETM.sidebar_view.previous_search_string[this.items]="";ETM.sidebar_view.renderActiveTab()},runSearch:function(a,
b){var c=this;this.collection.search(a,function(d){var e=$(".sb_search_input").val();a==e&&(c.search_results=d,c.renderSearch(b))})},renderSearch:function(a){var b=this;b.$el.html(b.search_template({num_results_text:b.search_results.length+" "+b.items+" found."}));var c=$("ul",b.el);b.search_results.forEach(function(a){a=new ETM.SidebarFoodObjectView({model:a,list_type:b.list_type});a.parent=b;c.append(a.render().el)});Helper.resizeSidebar();a(b)},newCustomFood:function(){this.custom_food_form=new ETM.CustomFoodFormView({model:this.collection.food_info_object_list});
this.custom_food_form.parent=this;$("#food_form_modal",this.el).html(this.custom_food_form.render());$("#gram_weight_1_amount",this.custom_food_form.el).val(1);$("#gram_weight_1_description",this.custom_food_form.el).val("serving");($("#recipe_editor_modal").data("bs.modal")||{}).isShown?Helper.showNestedModal(this.custom_food_form):this.custom_food_form.$el.modal("show")},newRecipe:function(){var a=new ETM.FoodInfoObject({ingredients:new ETM.IngredientsList,directions:new ETM.DirectionsList,nutrition:{},
category_id:11,number_servings:1});a.url=function(){return ROOT+"/recipe/"};a=new ETM.FoodObject({food:a,amount:1,units:1});ETM.recipe_editor=new ETM.RecipeEditorModalView;ETM.recipe_editor.model=a;$("#food_object_modal_div").html(ETM.recipe_editor.render().el);ETM.recipe_editor.printGraph();ETM.recipe_editor.applyEvents()}});
ETM.SidebarCustomListView=ETM.SidebarListView.extend({initialize:function(){ETM.SidebarListView.prototype.initialize.apply(this,arguments);this.listenTo(this.collection,"add",function(a,b){if(ETM.sidebar_view.active_view.cid===this.cid){var c=new ETM.SidebarFoodObjectView({model:a,list_type:this.list_type});c.parent=this;$("ul",this.el).append(c.render().el)}},this)}});
ETM.SidebarBasicFoodListView=ETM.SidebarListView.extend({initialize:function(a){this.list_type="undefined"!=typeof a.list_type?a.list_type:"generic";for(var b in a)this[b]=a[b];this.search_template=ETM.loadNestedTemplate("#SidebarFoodListTemplates",".search_results_view")},render:function(a){var b=this;this.$el.html(this.template());var c=$("ul",this.el);this.collection.fetchFoodInfoObjects(function(){var d=b.collection.structure,e;for(e in d)if(d.hasOwnProperty(e))if(c.append("<div class='foodheader'>"+
e+"</div>"),"[object Array]"===Object.prototype.toString.call(d[e]))for(var f=0;f<d[e].length;f++){var g=d[e][f],g=b.collection.food_info_object_list.get("/api/v1/food/"+g+"/"),g=g.sidebar_food_object,g=new ETM.SidebarFoodObjectView({model:g,list_type:b.list_type});g.parent=b;c.append(g.render().el)}else for(var h in d[e])if(d[e].hasOwnProperty(h))for(c.append("<div class='foodsubheader'>"+h+"</div>"),f=0;f<d[e][h].length;f++)g=d[e][h][f],g=b.collection.food_info_object_list.get("/api/v1/food/"+g+
"/"),g=g.sidebar_food_object,g=new ETM.SidebarFoodObjectView({model:g,list_type:b.list_type}),g.parent=b,c.append(g.render().el);Helper.resizeSidebar();a(b)})},runSearch:function(a,b){var c=this;this.collection.search(a,c.filters,function(d){var e=$(".sb_search_input").val();a==e&&(c.search_results=d,c.renderSearch(b))})},renderSearch:function(a){var b=this;this.search=!0;b.$el.html(b.search_template({num_results_text:b.search_results.length+" "+b.items+" found."}));var c=$("ul.search_results_list",
b.el);b.search_results.forEach(function(a){a=new ETM.FoodObject({food:a,amount:1,units:a.default_units},{skip_global:!0});b.collection.add(a,{silent:!0});a=new ETM.SidebarFoodObjectView({model:a,list_type:b.list_type});a.parent=b;c.append(a.render().el)});Helper.resizeSidebar();a(b)}});
ETM.SidebarNutritionixListView=ETM.SidebarBasicFoodListView.extend({render:function(a){var b=this;if(this.search)this.search=!1,this.collection.search("",b.filters,function(c){b.$el.html(b.template());var e=$("ul",b.el);b.collection.reset();c.forEach(function(a){a=new ETM.FoodObject({food:a,amount:1,units:a.default_units},{skip_global:!0});b.collection.add(a,{silent:!0});a=new ETM.SidebarFoodObjectView({model:a,list_type:b.list_type});a.parent=b;e.append(a.render().el)});Helper.resizeSidebar();a(b)});
else{this.search=!1;b.$el.html(b.template());var c=$("ul",b.el);b.collection.forEach(function(a){a=new ETM.SidebarFoodObjectView({model:a,list_type:b.list_type});a.parent=b;c.append(a.render().el)});Helper.resizeSidebar();a(b)}}});
ETM.SidebarRecipeListView=ETM.SidebarListView.extend({events:{"change .category_selector":"fetchAndRenderCategory"},initialize:function(a){this.list_type="undefined"!=typeof a.list_type?a.list_type:"generic";for(var b in a)this[b]=a[b];this.search=!1;this.recipes={};this.search_template=ETM.loadNestedTemplate("#SidebarFoodListTemplates",".search_results_view")},render:function(a){this.$el.html(this.template({is_logged_in:ETM.is_logged_in}));this.fetchAndRenderCategory();a(this)},fetchAndRenderCategory:function(){var a=
this,b=$(".category_selector",this.el).val(),c={model:"r",curated:!0};"latest"!==b&&("popular"===b?c.order_by="-num_favorites":"12"===b?c.main_dish=!0:"13"===b?c.side_dish=!0:c.category=b);_.has(this.recipes,b)?this.renderCategory(b):(this.recipes[b]=new ETM.SidebarRecipeList([]),this.recipes[b].fetch({data:c,success:function(){a.renderCategory(b)}}))},renderCategory:function(a){this.search=!1;var b=this,c=$("ul.recipe_list",this.el);c.empty();this.recipes[a].forEach(function(a){a=new ETM.SidebarFoodObjectView({model:a,
list_type:b.list_type});a.parent=b;c.append(a.render().el)});$(".foodbank_image",b.el).unveil({container:$(".sidebar_list_container")});$(".foodbank_image",b.el).removeClass("lazy");ETM.local_variables.attributes.seen_draggable_sidebar_tooltip||(Helper.oneTimeTooltip($(".foodbank_food_row:first",b.el),"right","<div style='width:180px;'><span class='glyphicon glyphicon-move'></span> Drag items from the sidebar to your meal plan to use them</div>",5E3),ETM.local_variables.save({seen_draggable_sidebar_tooltip:!0}));
Helper.resizeSidebar()},find:function(a){var b=$(".category_selector",this.el).val();return this.search?this.collection.get(a):this.recipes[b].get(a)},renderSearch:function(a){var b=this;this.search=!0;b.$el.html(b.search_template({num_results_text:b.search_results.length+" "+b.items+" found."}));var c=$("ul.search_results_list",b.el);b.search_results.forEach(function(a){a=new ETM.FoodObject({food:a,amount:1,units:a.default_units},{skip_global:!0});b.collection.add(a,{silent:!0});a=new ETM.SidebarFoodObjectView({model:a,
list_type:b.list_type});a.parent=b;c.append(a.render().el)});Helper.resizeSidebar();a(b)}});
ETM.SidebarPantryListView=ETM.SidebarBasicFoodListView.extend({render:function(a){var b=this;if(ETM.is_premium)if(this.search)this.search=!1,this.collection.search("",b.filters,function(c){b.$el.html(b.template());var e=$("ul",b.el);b.collection.reset();c.forEach(function(a){a=new ETM.FoodObject({food:a,amount:1,units:a.default_units},{skip_global:!0});b.collection.add(a,{silent:!0});a=new ETM.SidebarPantryFoodObjectView({model:a,list_type:b.list_type});a.parent=b;e.append(a.render().el)});Helper.resizeSidebar();
a(b)});else{this.search=!1;b.$el.html(b.template());var c=$("ul",b.el);b.collection.forEach(function(a){a=new ETM.SidebarPantryFoodObjectView({model:a,list_type:b.list_type});a.parent=b;c.append(a.render().el)});Helper.resizeSidebar();a(b)}else b.$el.html(b.template()),Helper.resizeSidebar(),a(b)},renderSearch:function(a){var b=this;this.search=!0;b.$el.html(b.search_template({num_results_text:b.search_results.length+" "+b.items+" found."}));var c=$("ul.search_results_list",b.el);b.search_results.forEach(function(a){a=
new ETM.FoodObject({food:a,amount:1,units:a.default_units},{skip_global:!0});b.collection.add(a,{silent:!0});a=new ETM.SidebarPantryFoodObjectView({model:a,list_type:b.list_type});a.parent=b;c.append(a.render().el)});Helper.resizeSidebar();a(b)}});
ETM.SidebarView=Backbone.View.extend({events:{"keyup .sb_search_input":"renderActiveTab","keypress .search-query":"onkeypress","click .clear_search":"clearSearch","click .embedded_clear_search":"clearSearch","click .recipes_tab a":function(){this.active_view=this.recipes_view;this.renderActiveTab()},"click .favorites_tab a":function(){this.favorites_view.collection.initializeEvents();this.active_view=this.favorites_view;this.renderActiveTab()},"click .custom_foods_tab a":function(){this.triggerViewCustomFoodsOnProfile();
this.active_view=this.custom_foods_view;this.renderActiveTab()},"click .custom_recipes_tab a":function(){this.triggerViewCustomFoodsOnProfile();this.active_view=this.custom_recipes_view;this.renderActiveTab()},"click .basic_foods_tab a":function(){this.active_view=this.basic_foods_view;this.renderActiveTab()},"click .packaged_foods_tab a":function(){this.active_view=this.packaged_foods_view;this.renderActiveTab()},"click .restaurant_foods_tab a":function(){this.active_view=this.restaurant_foods_view;
this.renderActiveTab()},"click .pantry_tab a":function(){this.active_view=this.pantry_foods_view;this.renderActiveTab()},"change .search_checkbox":"renderActiveTab","click .sidebar_tab":"toggleFoodBank"},triggerViewCustomFoodsOnProfile:function(){ETM.finish_profile_completeness_key("view_custom_food_screen")},showRecipes:function(){$(".left_panel .recipes_tab a",this.el).tab("show");this.active_view=this.recipes_view;this.renderActiveTab()},showRestaurantFoods:function(){$(".left_panel .restaurant_foods_tab a",
this.el).tab("show");this.active_view=this.restaurant_foods_view;this.renderActiveTab()},showCustomRecipes:function(){$(".left_panel .custom_recipes_tab a",this.el).tab("show");this.active_view=this.custom_recipes_view;this.renderActiveTab()},showFavorites:function(){$(".left_panel .favorites_tab a",this.el).tab("show");this.active_view=this.favorites_view;this.renderActiveTab()},showCustomFoods:function(){$(".left_panel .custom_foods_tab a",this.el).tab("show");this.active_view=this.custom_foods_view;
this.triggerViewCustomFoodsOnProfile();this.renderActiveTab()},showSidebarPantry:function(){$(".left_panel .pantry_tab a",this.el).tab("show");this.active_view=this.pantry_foods_view;this.renderActiveTab()},initialize:function(){this.ingredients_only=!1;this.recipes_view=new ETM.SidebarRecipeListView({collection:new ETM.SidebarRecipeList,template:ETM.loadNestedTemplate("#SidebarFoodListTemplates",".recipes_view"),items:"recipes",search_delay:500});this.basic_foods_view=new ETM.SidebarBasicFoodListView({collection:new ETM.SidebarBasicFoodList,
template:ETM.loadNestedTemplate("#SidebarFoodListTemplates",".basic_foods_view"),items:"basic foods",filters:{include_prepackaged:!1,include_restaurant:!1},search_delay:500});this.basic_foods_view.collection.parent=this.model;this.listenTo(this.basic_foods_view,"search_again",function(){this.renderActiveTab(null,10,!0)},this);this.favorites_view=new ETM.SidebarListView({collection:new ETM.SidebarFavoritesList,template:ETM.loadNestedTemplate("#SidebarFoodListTemplates",".favorites_view"),items:"favorites",
list_type:"favorites",search_delay:10});this.listenTo(this.favorites_view.collection,"addFavorite removeFavorite",function(a,b){this.active_view.cid==this.favorites_view.cid&&this.renderActiveTab(null,10,!0)},this);this.custom_foods_view=new ETM.SidebarCustomListView({collection:new ETM.CustomFoodList([],{url:ROOT+"/customfood/"}),template:ETM.loadNestedTemplate("#SidebarFoodListTemplates",".custom_foods_view"),list_type:"custom_foods",items:"custom foods",search_delay:10});this.custom_recipes_view=
new ETM.SidebarCustomListView({collection:new ETM.CustomRecipeList([],{url:ROOT+"/customrecipe/"}),template:ETM.loadNestedTemplate("#SidebarFoodListTemplates",".custom_recipes_view"),list_type:"custom_recipes",items:"custom recipes",search_delay:10});this.packaged_foods_view=new ETM.SidebarNutritionixListView({collection:new ETM.SidebarBasicFoodList,template:ETM.loadNestedTemplate("#SidebarFoodListTemplates",".basic_foods_view"),items:"pre-packaged foods",search:!0,filters:{include_prepackaged:!0,
include_restaurant:!1},search_delay:500});this.restaurant_foods_view=new ETM.SidebarNutritionixListView({collection:new ETM.SidebarBasicFoodList,template:ETM.loadNestedTemplate("#SidebarFoodListTemplates",".basic_foods_view"),items:"restaurant foods",search:!0,filters:{include_prepackaged:!1,include_restaurant:!0},search_delay:500});this.pantry_foods_view=new ETM.SidebarPantryListView({collection:new ETM.SidebarPantryList,template:ETM.loadNestedTemplate("#SidebarFoodListTemplates",".pantry_foods_view"),
list_type:"pantry_recipes",items:"results",search:!0,search_delay:500});this.sidebar_timer=null;this.active_view=this.recipes_view;this.previous_search_string={}},clearSearch:function(a){$(".sb_search_input").val("");this.renderActiveTab(a,200)},moveToFront:function(){$(".left_panel",this.el).css("z-index",1051)},moveToBack:function(){$(".left_panel",this.el).css("z-index",1001)},showAllTabs:function(){this.ingredients_only=!1;$(".recipes_tab",this.el).show();$(".custom_recipes_tab",this.el).show();
this.active_view.delegateEvents()},toggleIngredientsOnly:function(){this.ingredients_only?(this.ingredients_only=!1,$(".recipes_tab",this.el).show(),$(".custom_recipes_tab",this.el).show()):(this.ingredients_only=!0,this.active_view=this.basic_foods_view,$(".recipes_tab",this.el).hide(),$(".custom_recipes_tab",this.el).hide(),$(".basic_foods_tab a",this.el).tab("show"),this.renderActiveTab());this.active_view.delegateEvents()},toggleFoodBank:function(a,b){var c=$(".left_panel");if(c.hasClass("sidebar_open")||
"close"==a)if("open"!=a){c.removeClass("sidebar_open");$("#fill_container").removeClass("container_with_sidebar");$("#recipe_fill_container").removeClass("container_with_sidebar");$("#top_nav").removeClass("container_with_sidebar");$(".footer_container").removeClass("container_with_sidebar");ETM.is_mobile&&($("#fill_container").removeClass("mobile_sidebar_open"),$("#recipe_fill_container").removeClass("mobile_sidebar_open"),$("#top_nav").removeClass("mobile_sidebar_open"),$(".footer_container").removeClass("mobile_sidebar_open"));
$(".sidebar_tab .sidebar_tab_text").velocity({rotateZ:"0deg"},1E3);var d=this;setTimeout(function(){$(".recipes_tab",d.el).show();$(".custom_recipes_tab",d.el).show()},1E3);b&&setTimeout(b,500)}else b&&b();else this.renderActiveTab(),c.addClass("sidebar_open"),$("#fill_container").addClass("container_with_sidebar"),$("#recipe_fill_container").addClass("container_with_sidebar"),$("#top_nav").addClass("container_with_sidebar"),$(".footer_container").addClass("container_with_sidebar"),ETM.is_mobile?
($("#fill_container").addClass("mobile_sidebar_open"),$("#recipe_fill_container").addClass("mobile_sidebar_open"),$("#top_nav").addClass("mobile_sidebar_open"),$(".footer_container").addClass("mobile_sidebar_open")):$(".sb_search_input",this.el).focus(),b&&setTimeout(b,500),$(".sidebar_tab .sidebar_tab_text").velocity({rotateZ:"180deg"},1E3)},render:function(){this.$el.html(this.template());return this},showSpinner:function(){$(".sidebar_list_container",this.el).empty();$(".sidebar_list_container",
this.el).html('<span class="spinner" style="margin-left:20px"><img src="/static_files/spinner.gif"/></span>');$(".spinner",this.el).show()},renderTabView:function(a){this.active_view.cid==a.cid&&($(".sidebar_list_container",this.el).html(a.el),$(".foodbank_image",this.el).unveil({container:$(".sidebar_list_container",this.el)}),$(".foodbank_image",this.el).removeClass("lazy"),$(".spinner",this.el).hide(),this.active_view.delegateEvents(),$(".sidebar_pantry_tooltip",this.el).tooltip({html:!0,title:"If you have ingredients in your pantry, this tab will show you suggestions for what you can make with what you already own. If you add stuff to your pantry and want to update the suggestions, hit the <span class='glyphicon glyphicon-refresh'></span> Refresh button.",
animation:!0,placement:"top"}))},renderActiveTab:function(a,b,c){clearTimeout(this.sidebar_timer);null==b&&(b=this.active_view.search_delay);null==c&&(c=!1);var d=$(".sb_search_input",this.el).val(),e=this;2<d.length?c||d!=e.previous_search_string[e.active_view.items]?this.sidebar_timer=setTimeout(function(){e.showSpinner();3>d.length||e.active_view.runSearch(d,function(a){e.previous_search_string[e.active_view.items]=d;e.renderTabView(a)})},b):(e.showSpinner(),e.active_view.renderSearch(function(a){e.renderTabView(a)})):
0==d.length&&(e.showSpinner(),e.active_view.render(function(a){e.renderTabView(a)}))},onkeypress:function(a){13==a.keyCode&&a.preventDefault()}});$.fn.serializeObject=function(){var a={},b=this.serializeArray();$.each(b,function(){void 0!==a[this.name]?(a[this.name].push||(a[this.name]=[a[this.name]]),a[this.name].push(this.value||"")):a[this.name]=this.value||""});return a};
ETM.SimilarRecipeObjectView=ETM.FoodObjectView.extend({className:"similar_recipe_object_view",render:function(a){a=this.template({model:this.model,image:this.model.attributes.food.getDisplayImage()});this.$el.html(a);this.applyTooltip();return this},initialize:function(){}});ETM.SimilarRecipeListView=Backbone.CollectionView.extend({tagName:"ul",selectable:!1,emptyListCaption:"<div class='col-xs-6 col-xs-offset-1'>This recipe has no similar recipes</div>",modelView:ETM.SimilarRecipeObjectView});
ETM.SimilarRecipesView=Backbone.View.extend({className:"similar_recipe_view",events:{"click .view_similar_recipe":"viewSimilarRecipe"},renderSimilarRecipes:function(a){var b=this;b.similarRecipeViews=[];var c=$('<ul class="similar_recipes_list col-xs-8 col-xs-offset-1"/>');b.recipe_list=new ETM.SimilarRecipeList;a.forEach(function(a){a=new ETM.FoodInfoObject(a);b.recipe_list.food_info_object_list.add(a);a=new ETM.FoodObject({food:a,amount:1,units:a.attributes.default_units});b.recipe_list.add(a,{silent:!0});
new ETM.SimilarRecipeObjectView({model:a})});a=new ETM.SimilarRecipeListView({collection:b.recipe_list,el:c});a.render();b.similarRecipeViews.push(a);b.similar_recipes_element.append($('<div class="similar_recipes row"></hr></div>').append(c))},searchRecipes:function(a){var b=this;this.currently_searching||(this.currently_searching=!0,$.ajax({url:"/food/get_similar_recipes/",data:{ingredients:JSON.stringify(this.ingredients),name_string:this.name_string,original_recipe_id:this.original_recipe_id},
type:"POST",success:function(c){b.currently_searching=!1;b.renderSimilarRecipes(JSON.parse(c));a(b.original_recipe_id)},error:function(c,d,e){console.log(d);b.currently_searching=!1;a()}}))},initialize:function(a,b){"undefined"!==typeof b&&(this.list_type="undefined"!=typeof b.list_type?b.list_type:"generic",this.ingredients=b.ingredients,this.name_string=b.name,this.original_recipe_id=b.recipe_id,this.similar_recipes_element=b.element)}});
ETM.SingleDayView=Backbone.View.extend({events:{"change .num_meals_selector":"numMealsChanges"},initialize:function(a){this.plan_stats_view=new ETM.PlanStatsView({model:this.model});this.plan_header_view=new ETM.PlanHeaderView({model:this.model});this.plan_header_view.parent_day_view=this;this.nutrition_targets_view=new ETM.NutritionTargetsView({model:this.model});this.initializeEvents()},initializeEvents:function(){var a=this;this.listenTo(this.plan_header_view,"dietLoad",function(b){a.model.destroy();
ETM.current_diet=b;a.model=b;a.model.calculateStats();a.stopListening();a.initializeEvents();a.plan_header_view.model=b;a.plan_stats_view.model=b;a.nutrition_targets_view.model=b;a.nutrition_targets_view.stopListening();a.nutrition_targets_view.initializeEvents();a.plan_header_view.updateTitle();a.renderNutritionTargets();a.renderMeals()});this.listenTo(this.model,"updateStats",function(){this.renderStats()});this.listenTo(this.model,"finishedGenerating",function(){a.model.save(null,{silent:!0,success:function(){a.renderMeals();
a.model.attributes.meals.each(function(a){a.trigger("parent_diet_finished_generating");delete a.attributes.delete_other_foods;delete a.attributes.delete_other_foods_except_leftovers})}});ETM.currently_generating=!1;$(".gen_button").html('Regenerate <span class="glyphicon glyphicon-random"></span>');$(".gen_button").fadeTo("slow",1).removeAttr("disabled")},this);this.listenTo(this.model,"change:num_meals",function(){0==this.model.attributes.num_meals?$(".gen_button").prop("disabled",!0):$(".gen_button").prop("disabled",
!1);this.renderMeals();this.showMeals()},this);this.listenTo(this,"swap_complete",function(){this.renderMeals()},this)},render:function(a){this.$el.html(this.template(this.model.attributes));$(".workspace_header",this.el).html(this.plan_header_view.render().el);this.plan_header_view.delegateEvents();this.renderNutritionTargets();this.renderMeals(a);ETM.dispatcher.trigger("finishedRenderingDayView");return this},highlightFoods:function(a){this.model.attributes.meals.each(function(b){b.attributes.foods.each(function(b){b.attributes.food.attributes.id===
a&&b.trigger("highlightFood")})})},renderNutritionTargets:function(){$(".display_nutrition_targets",this.el).html(this.nutrition_targets_view.render().el);this.nutrition_targets_view.delegateEvents()},showMeals:function(){for(var a=this.model.get("num_meals"),b=0;9>b;b++)b<a?$(".meal_box",this.el).eq(b).show():$(".meal_box",this.el).eq(b).hide()},hideMealsAndStats:function(){ETM.is_logged_in?($(".workspace_divider",this.el).hide(),$("#meal_list",this.el).hide(),$("#workspace_stats",this.el).hide()):
this.$el.hide()},showMealsAndStats:function(){ETM.is_logged_in?($(".workspace_divider",this.el).show(),$("#meal_list",this.el).show(),$("#workspace_stats",this.el).show()):this.$el.is(":visible")||this.$el.slideDown(800)},renderMeals:function(a){0!=this.plan_stats_view.model.stats.calories||ETM.is_premium?(this.showMealsAndStats(),this.trigger("showMealsAndStats")):(this.hideMealsAndStats(),this.trigger("hideMealsAndStats"));0==this.model.attributes.meals.length||0==this.model.attributes.num_meals?
$("#meal_list",this.el).html("<h3> This diet has no meals.</h3>"):0<this.model.attributes.meals.length&&(Helper.lockPageHeight(),this.meal_list&&this.meal_list.close(),this.meal_list=new ETM.MealListView({model:this.model.attributes.meals}),$("#meal_list",this.el).html(this.meal_list.render().el),this.renderStats(a),this.showMeals(),Helper.unlockPageHeight())},renderStats:function(a){$("#workspace_stats",this.el).html(this.plan_stats_view.render().el);this.plan_stats_view.delegateEvents();"undefined"===
typeof a&&this.printGraph()},printGraph:function(){this.plan_stats_view.printGraph()},generateDiet:function(){this.model.generate()}});
ETM.PlanHeaderView=Backbone.View.extend({events:{"click .open_food_bank":"toggleFoodBankFromPlanView","change .num_meals_selector":"numMealsChanges","click .save_diet":"showSaveDiet","click .save_diet_range, .save_diet_shortcut":"showSaveDietRange","click .load_diet_range":"showLoadDietRange","click .load_diet":"showLoadDiet","click .print_diet":"showPrintDiet","click .pdf_diet":"showPDFDiet","click .email_diet":"showEmailDiet","click .email_date_range":"showEmailDietRange","click .delete_diet":"showDeleteDiet",
"click .gen_button":"generateDiet","blur .meal_plan_title":"titleChanged","click .edit_meal_type":function(a){a.preventDefault();a=$(a.currentTarget).data("id");a=new ETM.EditMealTypeView({model:ETM.meal_type_list.get(a)});$("#edit_meal_type_modal",ETM.$modal_content).html(a.render().el);a.renderForm();a.$el.modal("show")}},generateDiet:function(a){ETM.currently_generating||(ETM.currently_generating=!0,$(a.currentTarget).stop(),$("#progressbar").stop(),$(a.currentTarget).html("Generating"),a.currentTarget.style.opacity=
0.7,$(a.currentTarget).attr("disabled","true"),null!=this.parent_day_view.meal_list.meal_views&&_.each(this.parent_day_view.meal_list.meal_views,function(a){!0===a.model.attributes.eaten&&a.$el.find(".eaten_lock_icon").show()}),this.model.generate())},toggleFoodBankFromPlanView:function(){ETM.sidebar_view.toggleFoodBank()},onClose:function(){ETM.scheme_validation_element.remove();ETM.scheme_validation_element=null;delete this.parent_day_view},render:function(){var a;a=ETM.is_embedded?ETM.loadTemplate("#EmbeddedPlanHeaderView")({attributes:this.model.attributes,
is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium}):this.template({attributes:this.model.attributes,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_diet_set:this.model.is_diet_set});this.$el.html(a);ETM.is_logged_in&&(ETM.scheme_validation_element=$("#scheme_validation",this.el));return this},updateTitle:function(){$(".meal_plan_title").text(this.model.attributes.title)},titleChanged:function(){var a=$(".meal_plan_title");this.model.get("title")!=a.text()&&this.model.save({title:a.text()},
{patch:!0})},numMealsChanges:function(){var a=parseInt($(".num_meals_selector",this.el).val());googleanalytics("send","event","selector","change_to","num_meals",a);this.model.set({num_meals:a})},showSaveDiet:function(){this.saveDiet=new ETM.SaveDietModalView;$("#save_diet_modal").html(this.saveDiet.render().el);this.saveDiet.$el.modal("show")},showSaveDietRange:function(){ETM.save_plans_modal||(ETM.save_plans_modal=new ETM.SavePlansModalView,$("#save_plans_modal").html(ETM.save_plans_modal.render().el));
ETM.is_premium?($(".date_range_selector",ETM.save_plans_modal.el).data("kalendae").setSelected(getCurrentCalendarDateRangeString()),ETM.save_plans_modal.$el.modal("show"),ETM.save_plans_modal.queryPlanSummary(),ETM.save_plans_modal.updateSaveTitle()):(ETM.save_plans_modal.$el.modal("show"),ETM.save_plans_modal.renderPlanSummary());googleanalytics("send","event","button","click","save_diet");amplitude.logEvent("save_diet")},showLoadDietRange:function(){ETM.load_plans_modal||(ETM.load_plans_modal=new ETM.LoadPlansModalView);
$("#load_plans_modal").html(ETM.load_plans_modal.render().el);ETM.load_plans_modal.showLoadDates();ETM.load_plans_modal.delegateEvents();ETM.load_plans_modal.$el.modal("show");googleanalytics("send","event","button","click","load_diet");amplitude.logEvent("load_diet")},showPrintDiet:function(){googleanalytics("send","event","button","click","print_diet");amplitude.logEvent("print_diet");ETM.printDiet(ETM.current_diet)},showEmailDiet:function(){ETM.generatePrintableMealList(ETM.current_diet,function(a){a=
ETM.renderPrintableMealList(a,ETM.current_diet);$.post("/diet/email/",{plan_title:ETM.current_diet.attributes.title,plan_html:a},function(a){})});googleanalytics("send","event","button","click","email_diet");amplitude.logEvent("email_diet")},showEmailDietRange:function(){this.model.is_diet_set?ETM.email_plan_set_modal&&($("#email_plan_set_modal").html(ETM.email_plan_set_modal.render().el),ETM.email_plan_set_modal.delegateEvents(),ETM.email_plan_set_modal.$el.modal("show")):(ETM.email_plans_modal||
(ETM.email_plans_modal=new ETM.EmailPlansModalView,$("#email_plans_modal").html(ETM.email_plans_modal.render().el)),ETM.email_plans_modal.setCalendarDate(getGrocerySyncDateString()),ETM.email_plans_modal.$el.modal("show"))},showDeleteDiet:function(){var a=new ETM.DeleteDietModalView({model:this.model});$(".delete_plan_modal",ETM.$modal_content).html(a.render().el);$(".delete_plan_modal .modal",ETM.$modal_content).modal("show");googleanalytics("send","event","button","click","delete_diet");amplitude.logEvent("delete_diet")},
showPDFDiet:function(){googleanalytics("send","event","button","click","pdf_diet");amplitude.logEvent("pdf_diet");ETM.generatePrintableMealList(ETM.current_diet,function(a){a=ETM.renderPrintableMealList(a,ETM.current_diet);var b=new jsPDF("p","pt","a4",15,15,{width:600});b.fromHTML(a);a=b.output("datauristring");window.open(a)})}});
ETM.DeleteDietModalView=Backbone.View.extend({events:{"click .delete_diet_confirm":function(){ETM.is_logged_in?this.model.is_diet_set?this.model.trigger("deleteDietFromSet"):this.model.trigger("deleteCalendarDiet"):this.model.trigger("deleteDiet")}},initialize:function(){},render:function(){this.$el.html(this.template());return this}});
ETM.PlanStatsView=Backbone.View.extend({events:{"click .free_overview_tour_link":function(){ETM.current_diet.attributes.meals.at(0).attributes.foods.at(0).trigger("disableHover");ETM.free_overview.startOnHomePage()},"click .premium_tour_link":function(){ETM.current_diet.attributes.meals.at(0).attributes.foods.at(0).trigger("disableHover");ETM.premium_intro.startOnHomePage()},"click #micro_expandable":"toggleMicroStats"},initialize:function(a){this.read_only=!1;"undefined"!==typeof a&&a.read_only&&
(this.read_only=!0);this.microStatsOpen=!1},render:function(){this.model.statsHTML=getMainStatsHTML(this.model.stats);this.model.premium=ETM.is_premium;ETM.is_mobile&&!ETM.is_tablet?this.$el.html(ETM.loadTemplate("#MobilePlanStatsView")(this.model)):this.$el.html(this.template(this.model));if(this.microStatsOpen){var a=$("#micro_day_stats");a.html(getMicroHTML(this.model.stats));a.show()}$(".net_carbs_tooltip",this.el).tooltip({placement:"right",html:!1,title:"Net carbs are the grams of carbohydrates minus the grams of fiber. If you're following a low-carb diet, this is the number you should pay attention to."});
this.toggleStatsAlert();return this},toggleStatsAlert:function(){this.model.dietStatsMatchTargets()||this.microStatsOpen||this.read_only?$(".stats_alert",this.el).css("display","none"):$(".stats_alert",this.el).css("display","block")},toggleMicroStats:function(){this.microStatsOpen=!this.microStatsOpen;var a=$("#micro_day_stats");a.html(getMicroHTML(this.model.stats));a.toggle();this.toggleStatsAlert()},printGraph:function(){var a=4*this.model.stats.carbs+4*this.model.stats.proteins+9*this.model.stats.fats,
b=$("#cumulativegraph",this.el);if(0>=a)b.html("");else{var c=roundNumber(100*(4*this.model.stats.carbs/a),2),d=roundNumber(100*(9*this.model.stats.fats/a),2),a=roundNumber(100*(4*this.model.stats.proteins/a),2),c=[{label:"Carbs",data:c,color:"#ff9000"},{label:"Protein",data:a,color:"#479ff3"},{label:"Fat",data:d,color:"#3aae4e"}];try{$.plot(b,c,{series:{pie:{startAngle:0,show:!0,radius:1,label:{show:!0,radius:0.5,formatter:function(a,b){return'<div style="font-size:7pt;text-align:center;padding:2px;color:white;">'+
a+"<br/>"+Math.round(b.percent)+"%</div>"},threshold:0.1}}},legend:{show:!1}})}catch(e){console.log("--- failed to print graph ---"),console.log("good chance that an old diet view still exists and is trying to render the graph without a div for it")}}}});var tooltip_timer,update_ingredients_timer,all_ingredients={},all_pantry_sidebar_ingredients={};function grabIngredients(a){return _.has(all_ingredients,a)?all_ingredients[a]:!1}
function grabPantrySidebarIngredients(a){return _.has(all_pantry_sidebar_ingredients,a)?all_pantry_sidebar_ingredients[a]:!1}function mealStatsTooltipHTML(a,b){return'<div class="meal_tooltip"><div class="mealgraph" id="mealgraph'+a+'"></div><div id="mealstats'+a+'" class="mealstats">'+b+"</div></div>"}
function getStatsHTML(a){var b=roundNumber(a.carbs-a.fiber,1);0>b&&(b=0);var c=roundNumber(a.carbs,1)+"g Carbs<br/>",c=c+("<div class='net_carbs_div'>("+b+"g net carbs)</div>")+(roundNumber(a.fats,1)+"g Fat<br/>"),c=c+(roundNumber(a.proteins,1)+"g Protein<br/>"),c=c+(roundNumber(a.calories,1)+" Calories<br/>");return c+="<div class='total_price_div'>Estimated $"+roundNumber(a.price,2).toFixed(2)+"</div>"}
function getMainStatsHTML(a){var b=roundNumber(a.carbs-a.fiber,1),c=roundNumber(a.carbs,1)+"g Carbs<br/>",c=c+("<div class='net_carbs_div'>("+b+"g <span class='net_carbs_tooltip'>net carbs</span>)</div>")+(roundNumber(a.fats,1)+"g Fat<br/>"),c=c+(roundNumber(a.proteins,1)+"g Protein<br/>"),c=c+(roundNumber(a.calories,1)+" Calories<br/>");return c+="<div class='total_price_div'>Estimated $"+roundNumber(a.price,2).toFixed(2)+"</div>"}
function miniGraph(a,b){var c=4*a.carbs+4*a.proteins+9*a.fats,c=[{label:"C",data:100*(4*a.carbs/c),color:"#ff9000"},{label:"P",data:100*(4*a.proteins/c),color:"#479ff3"},{label:"F",data:100*(9*a.fats/c),color:"#3aae4e"}];$.plot($("#"+b),c,{series:{pie:{startAngle:0,stroke:{color:"#000"},show:!0,radius:1,label:{show:!0,radius:0.5,formatter:function(a,b){return'<div style="font-size:7pt;text-align:center;padding:2px;color:white;">'+a+"</div>"},threshold:0.1}}},legend:{show:!1}})}
function ingredientsHTML(a,b,c){b/=c;c="<div class='ttp_ingredients'>";for(var d=0;d<a.length;d++){var e=a[d];if("M"===ETM.current_user_profile.get("units")&&e.accurate_grams&&hasImperial(e.unit_description)||"grams"==e.unit_description){var f=e.gram_amount*e.amount*b,f=200<f?roundNumber(10*Math.round((f+4.9)/10),0):30<f?roundNumber(5*Math.round((f+2.4)/5),0):5<f?roundNumber(f,0):roundNumber(f,1);c=c+"<span class='ttp_ingredient_amount'>"+Helper.formatFoodAmount(f)+"g "+e.food_name+"</span><br/>"}else c=
c+"<span class='ttp_ingredient_amount'>"+mixin.getFractionFromDecimal(roundNumber(e.unit_amount*e.amount*b,2))+" "+e.unit_description+" "+e.food_name+"</span><br/>"}return c+"</div>"}
function pantrySidebarIngredientsHTML(a,b,c){b/=c;c=a.tooltip_ingredients;var d=[];if(a.attributes.missing_ids&&0<a.attributes.missing_ids.length)for(d=a.attributes.missing_ids.split(","),a=0;a<d.length;a++)d[a]=parseInt(d[a]);var e="<div class='ttp_ingredients'>";for(a=0;a<c.length;a++){var f=c[a],g="";f.normalized_id&&-1<d.indexOf(f.normalized_id)&&(g=" ttp_ingredient_missing ");if("M"===ETM.current_user_profile.get("units")&&f.accurate_grams&&hasImperial(f.unit_description)||"grams"==f.unit_description)var h=
f.gram_amount*f.amount*b,h=200<h?roundNumber(10*Math.round((h+4.9)/10),0):30<h?roundNumber(5*Math.round((h+2.4)/5),0):5<h?roundNumber(h,0):roundNumber(h,1),e=e+"<span class='ttp_ingredient_amount"+g+"'>"+Helper.formatFoodAmount(h)+"g "+f.food_name+"</span><br/>";else e=e+"<span class='ttp_ingredient_amount"+g+"'>"+mixin.getFractionFromDecimal(roundNumber(f.unit_amount*f.amount*b,2))+" "+f.unit_description+" "+f.food_name+"</span><br/>"}return e+"</div>"}
function hasImperial(a){return-1!=a.indexOf("oz")||-1!=a.indexOf("ounce")||-1!=a.indexOf("cup")||-1!=a.indexOf("tsp")||-1!=a.indexOf("tbsp")||-1!=a.indexOf("tablespoon")||-1!=a.indexOf("teaspoon")||-1!=a.indexOf("lbs")||"lb"==a?!0:!1}ETM.TemplateNutritionTargetsView=ETM.NutritionTargetsView.extend({});
ETM.TemplateMealView=ETM.MealObjectView.extend({tagName:"li",className:function(){_.has(this.model.attributes.meal_type,"label_class")||(this.model.attributes.meal_type.label_class="meal_label_"+Helper.randomNumber(5));return"template_meal label "+this.model.attributes.meal_type.label_class},events:{"click .edit_template_meal":"showMealTypeDropdown","click .create_meal_type":"createMealType","click .edit_meal_type":"editMealType","click .delete_template_meal":"deleteMeal"},updateMealTypeTitle:function(){$(".template_meal_title",
this.el).html(this.model.get("meal_type").get("title"));this.$el.attr("class",this.className()+" open")},render:function(){this.$el.html(this.template({meal_type_name:this.model.attributes.meal_type.attributes.title}));this.meal_options=new ETM.MealOptionsDropdownView({model:this.model});this.meal_options.$el=$(".meal-options-dropdown-menu",this.el);this.meal_options.delegateEvents({"click .other_meal_type":"switchMealTypes","click .delete_meal_type":"deleteMealType"});return this},editMeal:function(){this.edit_meal_type=
new ETM.EditMealTypeView({model:this.model.get("meal_type")},{meal:this.model});$("#edit_meal_type_modal",ETM.$modal_content).html(this.edit_meal_type.render().el);this.edit_meal_type.renderForm();this.edit_meal_type.$el.modal("show")},deleteMeal:function(){this.undelegateEvents();this.model.destroy({wait:!0,url:"/api/v1/reordermeal/"+this.model.attributes.id+"/"})}});
ETM.TemplateMealListView=Backbone.CollectionView.extend({tagName:"ul",sortable:!0,selectable:!1,sortableOptions:{connectWith:".template_meals",forcePlaceholderSize:!0,placeholder:"meal_type_placeholder",tolerance:"pointer"},emptyListCaption:"<div class='empty_meal_box'>There are no meals in this day</div>",modelView:ETM.TemplateMealView});DAY_LIST="Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" ");
ETM.TemplateDietView=Backbone.View.extend({className:"daily_template_column template_column",events:{"click .add_meal":"openAddMealModal"},initialize:function(){this.nutrition_targets_view=new ETM.TemplateNutritionTargetsView({model:this.model.attributes.diet});var a=this;this.model.attributes.diet.attributes.meals.each(function(b){a.listenTo(b.attributes.meal_type,"change:title",function(){a.template_meals.render()},this)})},initializeTemplateMeals:function(){var a=this;this.sanitizeMealNumbers();
this.template_meals=new ETM.TemplateMealListView({collection:this.model.attributes.diet.attributes.meals,el:$(".template_meals",this.el)});this.listenTo(this.template_meals,"sortStop",function(b,c){0<=c&&c!==b.attributes.meal_number&&b.save({meal_number:c},{patch:!0,url:ROOT+"/reordermeal/"+b.attributes.id+"/"});a.model.get("diet").updateMeals()});this.listenTo(this.model.attributes.diet.attributes.meals,"add",function(b,c,d){b.attributes.meal_number===d.at&&b.attributes.diet_plan===a.model.get("diet").id||
b.save({meal_number:d.at,diet_plan:a.model.get("diet").id},{patch:!0,async:!1,url:"/api/v1/reordermeal/"+b.attributes.id+"/"});a.model.get("diet").set({num_meals:a.model.attributes.diet.attributes.meals.length});a.model.get("diet").updateMeals()});this.listenTo(this.model.attributes.diet.attributes.meals,"remove",function(b,c,d){a.model.get("diet").set({num_meals:a.model.attributes.diet.attributes.meals.length});a.model.get("diet").updateMeals()})},sanitizeMealNumbers:function(){this.model.get("diet").get("meals").each(function(a,
b){a.get("meal_number")!==b&&a.save({meal_number:b},{patch:!0})})},renderNutritionTargets:function(){$(".template_targets",this.el).html(this.nutrition_targets_view.render().el);this.nutrition_targets_view.delegateEvents()},render:function(){this.$el.html(this.template({template_day:ETM.current_user_profile.attributes.single_template_diet?"Daily layout":DAY_LIST[this.model.attributes.weekday],single_template_enabled:ETM.current_user_profile.attributes.single_template_diet}));this.renderNutritionTargets();
this.template_meals||this.initializeTemplateMeals();this.template_meals.render();return this},openAddMealModal:function(){ETM.weekly_settings_view.add_meal_modal||(ETM.weekly_settings_view.add_meal_modal=new ETM.AddMealTypeModal,$("#add_meals_modal",ETM.$modal_content).html(ETM.weekly_settings_view.add_meal_modal.render().el));ETM.weekly_settings_view.add_meal_modal.renderForm(this.model.attributes.weekday);ETM.weekly_settings_view.add_meal_modal.$el.modal("show")}});ETM.SingleTemplateDietView=ETM.TemplateDietView.extend({className:"single_template_column template_column"});
ETM.TemplateDietListView=Backbone.View.extend({initialize:function(){this.template_diet_views=[]},onClose:function(){_.each(this.template_diet_views,function(a){a.close()},this);this.template_diet_views=null},render:function(){var a=this;this.$el.html(this.template());$(".template_diets .diet_row_1",this.el).html("");$(".template_diets .diet_row_2",this.el).html("");var b=0;ETM.current_user_profile.attributes.single_template_diet?a.renderSingleTemplateDiet(a.collection.models[a.collection.SINGLE_TEMPLATE_INDEX]):
this.collection.models.forEach(function(c){a.renderTemplateDiet(c,b);b++});return this},renderSingleTemplateDiet:function(a){a=new ETM.SingleTemplateDietView({model:a});this.template_diet_views.push(a);$(".template_diets .single_template_row",this.el).append(a.render().el)},renderTemplateDiet:function(a,b){var c=new ETM.TemplateDietView({model:a});this.template_diet_views.push(c);4>b?$(".template_diets .diet_row_1",this.el).append(c.render().el):$(".template_diets .diet_row_2",this.el).append(c.render().el)}});
var dates={convert:function(a){return a.constructor===Date?a:a.constructor===Array?new Date(a[0],a[1],a[2]):a.constructor===Number?new Date(a):a.constructor===String?new Date(a):"object"===typeof a?new Date(a.year,a.month,a.date):NaN},compare:function(a,b){return isFinite(a=this.convert(a).valueOf())&&isFinite(b=this.convert(b).valueOf())?(a>b)-(a<b):NaN},inRange:function(a,b,c){return isFinite(a=this.convert(a).valueOf())&&isFinite(b=this.convert(b).valueOf())&&isFinite(c=this.convert(c).valueOf())?
b<=a&&a<=c:NaN}};
ETM.SwapMealModalView=ModalView.extend({className:"modal fade",id:"swap_meal_modal",events:{"change select#date":function(){this.renderForm(Helper.parseDateString(this.form.getValue().date));this.renderMeal()},"change select#meal_type":function(){this.renderMeal()},"click #swap_btn":function(a){$(".swap_modal_error",this.el).empty();var b=this;a.preventDefault();if(null!=this.model&&null!=this.selected_meal){a=this.model.attributes.foods.clone();var c=this.selected_meal.attributes.foods.clone(),d=
parseIdFromResourceURI(this.model.attributes.resource_uri),e=parseIdFromResourceURI(this.selected_meal.attributes.resource_uri);ETM.analytics.logSwapMeal(d,e);var f=[];a.each(function(a){f.push(a.save({meal:b.selected_meal.id}))});c.each(function(a){f.push(a.save({meal:b.model.id}))});this.model.attributes.foods=c;this.selected_meal.attributes.foods=a;$.when(f).done(function(){amplitude.logEvent("swapped_meal");b.model.calculateStats();b.selected_meal.calculateStats();b.$el.modal("hide");ETM.calendar_view.single_day_view.trigger("swap_complete")})}else $(".swap_modal_error",
this.el).html('<div class="alert alert-danger">Must select a valid date and meal to swap with.</div>')}},initialize:function(){var a=this;this.current_date=new Date;this.selected_date=ETM.calendar_list.selected_date;this.$el.on("hidden.bs.modal",function(){null!=a.swap_meal&&a.swap_meal.food_list.collection.models.forEach(function(a){a.trigger("enableHover");a.trigger("enableTooltip");a.trigger("enableEvents")});null!=a.orig_meal&&a.orig_meal.food_list.collection.models.forEach(function(a){a.trigger("enableHover");
a.trigger("enableTooltip");a.trigger("enableEvents")})});this.dates_array=[];for(var b=addDays(this.current_date,-7);b<addDays(this.current_date,8);b=addDays(b,1))"object"===typeof ETM.calendar_list.getCalendarDiet(b)&&this.dates_array.push({val:Helper.convertDateToString(b),label:Helper.convertDateToString(b)})},render:function(){this.$el.html(this.template());this.renderForm(this.selected_date);this.orig_meal=new ETM.MealObjectView({model:this.model});$(".orig_meal",this.el).html(this.orig_meal.render().el);
this.removeMealControls(this.orig_meal);this.renderMeal();return this},renderForm:function(a){var b=this;this.meals_array=[];ETM.calendar_list.getCalendarDiet(a).attributes.diet.attributes.meals.forEach(function(a){a!=b.model&&b.meals_array.push({val:a.attributes.meal_type.id,label:a.attributes.meal_type.attributes.title})});this.form=(new Backbone.Form({schema:{date:{type:"Select",options:this.dates_array},meal_type:{type:"Select",options:this.meals_array}},data:{meal_type:this.meals_array[0].val,
date:Helper.convertDateToString(a)},template:Helper.createTemplateFunction($("#swapMealFormTemplate",this.el).html())})).render();$(".swap_form",this.el).html(this.form.el)},renderMeal:function(){$(".swap_modal_error",this.el).empty();var a=this.form.getValue().meal_type,b=this.form.getValue().date;null!=a&&null!=b?(a=ETM.meal_type_list.get(this.form.getValue().meal_type),b=Helper.parseDateString(b),this.selected_meal=ETM.calendar_list.getCalendarDiet(b).attributes.diet.attributes.meals.findWhere({meal_type:a}),
this.swap_meal=new ETM.MealObjectView({model:this.selected_meal}),$(".swap_meal",this.el).html(this.swap_meal.render().el),this.removeMealControls(this.swap_meal)):$(".swap_modal_error",this.el).html('<div class="alert alert-danger">Must select a valid date and meal to swap with.</div>')},removeMealControls:function(a){a.undelegateEvents();$(".meal_options_dropdown",a.el).removeClass("dropdown");$(".meal_options_dropdown",a.el).html('<span class="meal_title print_meal_title">'+a.model.get("meal_type").get("title")+
"</span>");a.food_list.collection.models.forEach(function(a){a.trigger("disableHover");a.trigger("disableEvents");a.trigger("enableTooltip")});a.food_list.$el.sortable({disabled:!0});$(".diet_draggable",this.el).css("cursor","auto");$(".favorite_food",this.el).css("cursor","auto");$(".food_link",this.el).css("cursor","auto");$(".meal_options_dropdown",this.el).unbind();$(".meal_icons",this.el).hide();$(".food_link_text",this.el).hide();$(".favorite_food",this.el).hide();$(".meal_refresh_btn",this.el).hide();
$(".i_ate_this_text",this.el).hide();$(".i_ate_this",this.el).css("cursor","auto")}});
ETM.ListMealCombosModalView=ModalView.extend({className:"modal fade",id:"meal_combos_modal",events:{"click #refresh_combos":function(){},"click .replace_meal_button":function(a){a.preventDefault();this.replaceMeal(a.target.id)},"change .sort_by_pantry":function(){this.sort_by_pantry=$(".sort_by_pantry",this.el).is(":checked");ETM.local_variables.save({sort_by_pantry:this.sort_by_pantry});this.refreshComboList()}},initialize:function(){var a=this;this.current_date=new Date;this.meal_combo_list=new ETM.MealList;
this.meal_view_list=[];this.sort_by_pantry=ETM.local_variables.attributes.sort_by_pantry;this.$el.on("hidden.bs.modal",function(){a.orig_meal.food_list.collection.models.forEach(function(a){a.trigger("enableHover");a.trigger("enableTooltip");a.trigger("enableEvents")})})},refreshComboList:function(){var a=this;_.each(this.meal_view_list,function(a){a.remove()});this.meal_combo_list.reset();this.downloadComboList(function(){a.renderComboList()})},downloadComboList:function(a){var b=this;$(".meal_combo_error",
this.el).hide();$(".new_meal_combos",this.el).html("<div class='text-center'><img src='/static_files/big_spinner.gif'/></div>");$(".sort_by_pantry",this.el).attr("disabled",!0);$.post("/generate-meal-combos/",{meal_id:b.model.attributes.id,sort_by_pantry:this.sort_by_pantry},function(c){new_meal_combos=JSON.parse(c);"Unable to find alternative meals"===new_meal_combos||0===new_meal_combos.length?$(".meal_combo_error",b.el).show():_.each(new_meal_combos,function(a){a=new ETM.SimpleFoodList(a);b.meal_combo_list.add(new ETM.MealObject({foods:a,
meal_type:b.model.get("meal_type")}))});$(".sort_by_pantry",b.el).attr("disabled",!1);a()})},replaceMeal:function(a){var b=this;if(a=this.meal_combo_list.get({cid:a})){var c=[],d=!1,e=[],f={};b.model.attributes.foods.each(function(a){f[a.attributes.food.attributes.id]=a.attributes.amount});_.each(a.attributes.foods.models,function(a){a.attributes.has_leftovers&&(d=!0,e.push(a.attributes.id));var f=a.clone();f.attributes.meal=b.model.id;a.attributes.has_leftovers&&_.has(a.attributes,"makes_leftovers_for")&&
null!=a.attributes.makes_leftovers_for&&0<a.attributes.makes_leftovers_for.length&&(f.attributes.update_leftovers=!0);c.push(f)});_.each(this.model.attributes.foods.models,function(a){a.attributes.is_leftovers&&a.updateRelatedLeftovers("delete")});this.model.attributes.foods.reset(c);d?this.model.set("delete_other_foods_except",e):this.model.set("delete_other_foods",!0);this.model.save(null,{success:function(a,c){delete b.model.attributes.delete_other_foods;delete b.model.attributes.delete_other_foods_except;
delete b.model.attributes.delete_other_foods_except_leftovers;d&&a.attributes.foods.each(function(a){a.attributes.has_leftovers&&a.hasValidLeftovers()&&a.attributes.makes_leftovers_for.each(function(a){ETM.dispatcher.trigger("update_food_"+a.attributes.id,a.toJSON(),!1)})});amplitude.logEvent("swapped_new_meal_combo");b.model.trigger("updateStats");b.$el.modal("hide");new_meal_obj=b.model.clone();ETM.analytics.logMealRefresh(f,new_meal_obj,ETM.ALTERNATE_MEAL_CHOSEN);ETM.calendar_view.single_day_view.trigger("swap_complete")}})}else console.log("FAILED TO FIND THE MEAL TO SWAP")},
renderComboList:function(){var a=this,b=$(".new_meal_combos",this.el);b.html("");a.meal_combo_list.each(function(c){meal_view=new ETM.SwapMealObjectView({model:c,meal_type_id:a.model.attributes.meal_type.id,meal_number:a.model.attributes.meal_number,num_meals:a.model.parent.attributes.num_meals});meal_view.show_missing_ingredients=a.sort_by_pantry;a.meal_view_list.push(meal_view);b.append(meal_view.render().el);a.removeMealControls(meal_view)});a.removeFoodControls()},render:function(){var a=this;
this.$el.html(this.template({model:this.model,sort_by_pantry:this.sort_by_pantry}));this.orig_meal=new ETM.SwapMealObjectView({model:this.model.clone()});$(".orig_meal",this.el).html(this.orig_meal.render().el);$(".replace_meal_button",this.orig_meal.el).hide();this.removeMealControls(this.orig_meal);this.removeFoodControls();this.downloadComboList(function(){a.renderComboList()});return this},removeMealControls:function(a){a.undelegateEvents();a.reAddThumbButtonEvent();$(".meal_options_dropdown",
a.el).removeClass("dropdown");$(".meal_options_dropdown",a.el).html('<span class="meal_title print_meal_title">'+a.model.get("meal_type").get("title")+"</span>");a.food_list.collection.models.forEach(function(a){a.trigger("disableHover");a.trigger("disableEvents");a.trigger("enableTooltip")});a.food_list.$el.sortable({disabled:!0})},removeFoodControls:function(){$(".diet_draggable",this.el).css("cursor","auto");$(".favorite_food",this.el).css("cursor","auto");$(".food_link",this.el).css("cursor",
"auto");$(".meal_options_dropdown",this.el).unbind();$(".meal_icons",this.el).hide();$(".food_link_text",this.el).hide();$(".favorite_food",this.el).hide();$(".meal_refresh_btn",this.el).hide();$(".i_ate_this_text",this.el).hide();$(".i_ate_this",this.el).css("cursor","auto")}});
ETM.UserProfileView=Backbone.View.extend({events:{'click div[name="units"] .btn':"changeUnits","click [name='gender']":"showBfatPercent","click .update_weight_from_profile":"openWeightModal"},initialize:function(a,b){var c=this;this.waiting_to_save=null;this.save_delay=2E3;this.shopping_day_enabled=ETM.is_premium;this.autosave=!0;this.display_weight_goal=!1;"undefined"!=typeof b&&("undefined"!=typeof b.shopping_day_enabled&&(this.shopping_day_enabled=b.shopping_day_enabled),"undefined"!=typeof b.autosave&&
(this.autosave=b.autosave),"undefined"!=typeof b.display_weight_goal&&(this.display_weight_goal=b.display_weight_goal));this.listenTo(this.model,"update_weight",function(){c.render()});this.profile_completeness_view=new ETM.ProfileCompletenessView({model:ETM.current_profile_completeness})},showBfatPercent:function(a){"F"==(a?$(a.target).find("input").val():this.model.attributes.gender)?($(".female_bfat_percent",this.el).show(),$(".male_bfat_percent",this.el).hide()):($(".male_bfat_percent",this.el).show(),
$(".female_bfat_percent",this.el).hide())},render:function(){this.$el.html(this.template({attributes:this.model.attributes,shopping_day_enabled:this.shopping_day_enabled,display_weight_goal:this.display_weight_goal}));this.renderForm();$(".profile_completeness_display",this.el).html(this.profile_completeness_view.render().el);this.profile_completeness_view.delegateEvents();return this},openWeightModal:function(){ETM.router.renderWeightModal();ETM.weight_modal.$el.modal("show");setTimeout('$(".weight_input_field").focus()',
400)},renderForm:function(){var a=this;this.form=(new Backbone.Form({model:this.model,template:Helper.createTemplateFunction($("#user_profile_form",this.el).html()),schema:this.display_weight_goal?this.model.weight_goal_schema():this.model.schema})).render();this.display_weight_goal&&(this.updateWeeklyRate(),this.listenTo(this.model,"change:weight_goal",function(){this.form.fields.weight_goal.editor.setImperialValue(ETM.current_user_profile.attributes.weight_goal)},this),this.listenTo(this.model,
"change:weight_goal_date",function(){null!=ETM.current_user_profile.attributes.weight_goal_date&&this.form.setValue({weight_goal_date:Helper.parseDateString(ETM.current_user_profile.attributes.weight_goal_date)})},this),this.listenTo(this.model,"change:weight_goal_weekly_rate",function(){this.form.fields.weight_goal_weekly_rate.editor.setImperialValue(ETM.current_user_profile.attributes.weight_goal_weekly_rate)},this),this.listenTo(this.form,"weight_goal:change weight_goal_date:change",function(){this.updateWeeklyRate()},
this),this.listenTo(this.form,"weight_goal_weekly_rate:change",function(){this.updateGoalDate()},this));$(".user_profile_form_div",this.el).html(this.form.el);this.autosave&&(this.listenTo(this.form,"change",function(){this.autosaveProfile()},this),$('input[name="height_primary"]',this.el).change(function(){a.autosaveProfile()}),$('input[name="height_secondary"]',this.el).change(function(){a.autosaveProfile()}),$('input[name="weight"]',this.el).change(function(){a.autosaveProfile()}));$(".activity_tooltip",
this.el).tooltip({placement:"left",html:!0,title:ETM.current_user_profile.activity_level_tooltip_text()});$(".shopping_day_tooltip",this.el).tooltip({placement:"bottom",title:ETM.current_user_profile.shopping_day_tooltip_text(),html:!0});$(".bfat_help_tooltip",this.form.el).tooltip({placement:"right",title:ETM.current_user_profile.bodyfat_tooltip_text(),html:!0});this.renderHeightAndWeight();"I"===this.model.attributes.units?($(".imperial_inputs",this.el).show(),$(".metric_inputs",this.el).hide(),
$('input[name="height_primary"]',this.el).show(),$(".weight_units",this.el).html("lbs")):"M"===this.model.attributes.units&&($(".imperial_inputs",this.el).hide(),$(".metric_inputs",this.el).show(),$('input[name="height_primary"]',this.el).hide(),$(".weight_units",this.el).html("kgs"));this.showBfatPercent()},renderHeightAndWeight:function(){var a=this.model.get("height"),b=this.model.get("weight");"M"===this.model.get("units")?(a&&(a*=2.54,$('input[name="height_secondary"]',this.el).val(roundNumber(a,
0))),b&&$('input[name="weight"]',this.el).val(roundNumber(0.453592*b,1))):(a&&($('input[name="height_primary"]',this.el).val(Math.floor(a/12)),$('input[name="height_secondary"]',this.el).val(roundNumber(a%12,0))),b&&$('input[name="weight"]',this.el).val(roundNumber(b,1)))},changeUnits:function(a){if(!$(a.currentTarget).hasClass("active")){var b=parseFloat($('input[name="height_primary"]',this.el).val()),c=parseFloat($('input[name="height_secondary"]',this.el).val()),d=parseFloat($('input[name="weight"]',
this.el).val());"I"==$("input",a.currentTarget).val()?(a=0.393701*c,d=roundNumber(2.20462*d,0),$(".imperial_inputs",this.el).show(),$(".metric_inputs",this.el).hide(),$('input[name="height_primary"]',this.el).show(),null==a||isNaN(a)||($('input[name="height_primary"]',this.el).val(Math.floor(a/12)),$('input[name="height_secondary"]',this.el).val(roundNumber(a%12,0))),null==d||isNaN(d)||$('input[name="weight"]',this.el).val(d),this.display_weight_goal&&(this.form.fields.weight_goal.editor.toggleUnits("I"),
this.form.fields.weight_goal_weekly_rate.editor.toggleUnits("I")),$(".weight_units",this.el).html("lbs")):"M"==$("input",a.currentTarget).val()&&(a=roundNumber(2.54*(12*b+c),0),d=roundNumber(0.453592*d,0),$(".imperial_inputs",this.el).hide(),$(".metric_inputs",this.el).show(),$('input[name="height_primary"]',this.el).hide(),null==a||isNaN(a)||$('input[name="height_secondary"]',this.el).val(a),null==d||isNaN(d)||$('input[name="weight"]',this.el).val(d),this.display_weight_goal&&(this.form.fields.weight_goal.editor.toggleUnits("M"),
this.form.fields.weight_goal_weekly_rate.editor.toggleUnits("M")),$(".weight_units",this.el).html("kgs"))}},updateWeeklyRateMinMax:function(a){var b=$('input[name="weight_goal_weekly_rate"]',this.form.el);0>a?(b.attr("max","-0.1"),b.removeAttr("min")):0<a&&(b.attr("min","0.1"),b.removeAttr("max"))},updateWeeklyRate:function(){var a=this.scrapeForm().weight;if(a&&this.form.getValue().weight_goal&&this.form.getValue().weight_goal_date){a=this.form.getValue().weight_goal-a;this.updateWeeklyRateMinMax(a);
var b=Helper.days_between(Helper.parseDateString(this.form.getValue().weight_goal_date),new Date)/7;this.form.fields.weight_goal_weekly_rate.editor.setImperialValue(roundNumber(a/b,1));this.validateWeightGoal()}},updateGoalDate:function(){var a=this.scrapeForm().weight;if(a&&this.form.getValue().weight_goal&&this.form.getValue().weight_goal_weekly_rate){var a=(this.form.getValue().weight_goal-a)/(this.form.getValue().weight_goal_weekly_rate/7),b=new Date;b.setDate(b.getDate()+Math.ceil(a));this.form.setValue({weight_goal_date:b});
this.validateWeightGoal()}},validateWeightGoal:function(){$(".weight_goal_update_error",this.el).hide();$(".weight_goal_date_update_error",this.el).hide();$(".weight_goal_weekly_rate_warning",this.el).hide();if(null==this.form.getValue().weight_goal)return!0;var a=!0;0<!this.form.getValue().weight_goal&&($(".weight_goal_update_error",this.el).show(),$(".weight_goal_update_error",this.el).html("Please enter a weight goal greater than 0."),a=!1);var b=this.form.getValue().weight_goal_date;if(null==
b)$(".weight_goal_date_update_error",this.el).show(),$(".weight_goal_date_update_error",this.el).html("Please enter a valid weight goal date."),a=!1;else{var c=new Date;c.setDate(c.getDate()+7);+Helper.parseDateString(b)>=+c||($(".weight_goal_date_update_error",this.el).show(),$(".weight_goal_date_update_error",this.el).html("Please enter a weight goal date at least a week in the future."),a=!1)}"M"===this.scrapeForm().units?this.form.getValue().weight_goal_weekly_rate&&0.9<Math.abs(this.form.fields.weight_goal_weekly_rate.editor.getRawValue())&&
($(".weight_goal_weekly_rate_warning",this.el).show(),$(".weight_goal_weekly_rate_warning",this.el).html("The CDC and health professionals strongly advise against weight changes of more than 0.9 kgs a week")):this.form.getValue().weight_goal_weekly_rate&&2<Math.abs(this.form.getValue().weight_goal_weekly_rate)&&($(".weight_goal_weekly_rate_warning",this.el).show(),$(".weight_goal_weekly_rate_warning",this.el).html("The CDC and health professionals strongly advise against weight changes of more than 2 lbs a week"));
return a},validate:function(a){$(".user_profile_errors",this.el).remove();var b=this.validateWeightGoal();0<!a.height&&($("#height-inputs",this.el).append("<div class='user_profile_errors alert alert-danger inline'>Height must be greater than 0.</div>"),b=!1);0<!a.weight&&($("#weight-input",this.el).append("<div class='user_profile_errors alert alert-danger inline'>Weight must be greater than 0.</div>"),b=!1);0<!a.age&&($("#age-input",this.el).append("<div class='user_profile_errors alert alert-danger inline'>Age must be greater than 0.</div>"),
b=!1);0<!a.bodyfat&&($("#bodyfat-radio",this.el).parent().append("<div class='user_profile_errors wide_user_profile_error alert alert-danger inline'>Please select a bodyfat amount. If you don't know, an estimation is fine, and you can easily change this later.</div>"),b=!1);if(a=this.form.validate()){for(var c in a)$('[data-editors="'+c+'"]').append('<div class="user_profile_errors alert alert-danger">'+a[c].message+"</div>");b=!1}return b},scrapeForm:function(){var a=this.form.getValue();a.height_primary=
parseFloat($('input[name="height_primary"]',this.el).val());a.height_secondary=parseFloat($('input[name="height_secondary"]',this.el).val());a.weight=parseFloat($('input[name="weight"]',this.el).val());"I"===a.units?(a.height=roundNumber(12*a.height_primary+a.height_secondary,1),a.weight=parseFloat(a.weight)):(a.height=roundNumber(0.393701*a.height_secondary,1),a.weight=roundNumber(2.2046*a.weight,1));this.model.attributes.weight!=a.weight&&(a.last_updated_weight=moment().format("YYYY-MM-DD"));delete a.height_primary;
delete a.height_secondary;return a},autosaveProfile:function(){var a=this;if(null==this.waiting_to_save)this.saveProfile();else if(!this.waiting_to_save){var b=this.scrapeForm();this.validate(b)&&this.model.set(b);this.waiting_to_save=!0;setTimeout(function(){a.saveProfile()},this.save_delay)}},saveProfile:function(){this.waiting_to_save=!1;var a=this.scrapeForm();return this.validate(a)?(this.model.save(a,{patch:!0}),!0):!1},beforeClose:function(){this.waiting_to_save&&this.saveProfile()}});
ETM.NutritionCalculatorView=ETM.UserProfileView.extend({events:{"click #open_edit_nutrition_targets":"openEditNutritionTargets",'click div[name="units"] .btn':"changeUnits","click #calculate_button":"calculate","click .use_calculated_settings":"useCalculatedSettings","click [name='gender']":"showBfatPercent"},className:"modal fade",id:"nutrition_calculator_view",initialize:function(a,b){"undefined"!==typeof b&&(this.go_back_enabled=b.go_back_enabled,this.nutrition_profile=b.nutrition_profile,this.save_user_profile=
b.save_user_profile,this.display_weight_goal=!0,this.show_profile_alert=b.show_profile_alert)},render:function(){this.$el.html(this.template({attributes:this.model.attributes,go_back_button_enabled:this.go_back_enabled,logged_in:ETM.is_logged_in,show_profile_alert:this.show_profile_alert}));this.$el.modal({show:!1});this.renderForm();return this},renderForm:function(){this.form=(new Backbone.Form({model:this.model,schema:this.model.nutrition_calculator_schema(),template:Helper.createTemplateFunction($("#nutritionCalculatorFormTemplate",
this.el).html())})).render();$("#calculator_form",this.el).html(this.form.el);$(".bfat_help_tooltip",this.form.el).tooltip({placement:"right",title:ETM.current_user_profile.bodyfat_tooltip_text(),html:!0});this.renderHeightAndWeight();this.updateWeeklyRate();this.listenTo(this.form,"weight_goal:change weight_goal_date:change",function(){this.updateWeeklyRate()},this);this.listenTo(this.form,"weight_goal_weekly_rate:change",function(){this.updateGoalDate()},this);"I"===this.model.attributes.units?
($(".imperial_inputs",this.el).show(),$(".metric_inputs",this.el).hide(),$('input[name="height_primary"]',this.el).show(),$(".weight_units",this.el).html("lbs")):"M"===this.model.attributes.units&&($(".imperial_inputs",this.el).hide(),$(".metric_inputs",this.el).show(),$('input[name="height_primary"]',this.el).hide(),$(".weight_units",this.el).html("kgs"));$(".activity_tooltip",this.el).tooltip({placement:"left",html:!0,title:ETM.current_user_profile.activity_level_tooltip_text()});this.showBfatPercent()},
openEditNutritionTargets:function(a){a.preventDefault();var b=this;this.$el.modal("hide");this.$el.one("hidden.bs.modal",function(){b.trigger("openEditNutritionTargets")})},calculate:function(a){null!=a&&a.preventDefault();a=this.scrapeForm();this.validate(a)&&(this.save_user_profile&&this.model.save(a),this.calculated_values=Helper.calculateMacros(a.age,a.weight,a.height,a.gender,a.goal,a.bodyfat,a.activity_level,this.model.get("preset_diet"),a.weight_goal,a.weight_goal_weekly_rate/7),this.renderCalculatedValues())},
renderCalculatedValues:function(){var a,b,c,d;a=this.calculated_values.calories+" kcal";b=1E4>this.calculated_values.max_carbs?this.calculated_values.min_carbs+"g - "+this.calculated_values.max_carbs+"g":"at least "+this.calculated_values.min_carbs+"g";c=1E4>this.calculated_values.max_fats?this.calculated_values.min_fats+"g - "+this.calculated_values.max_fats+"g":"at least "+this.calculated_values.min_fats+"g";d=1E4>this.calculated_values.max_proteins?this.calculated_values.min_proteins+"g - "+this.calculated_values.max_proteins+
"g":"at least "+this.calculated_values.min_proteins+"g";$(".suggested_calories",this.el).html(a);$(".suggested_carbs",this.el).html(b);$(".suggested_fats",this.el).html(c);$(".suggested_proteins",this.el).html(d);$(".macro_recommendation").show()},useCalculatedSettings:function(a){a.preventDefault();var b=this;delete this.calculated_values.capped_min_calories;this.nutrition_profile.set(this.calculated_values);this.$el.modal("hide");this.$el.one("hidden.bs.modal",function(){b.trigger("useCalculatedSettings")})}});
ETM.no_meal_plan_walkthrough=introJs();ETM.is_premium?ETM.no_meal_plan_walkthrough.setOptions({skipLabel:"Close",steps:[{element:".generator_header,.workspace_header",intro:"To enable the full walkthrough, please create/load a diet plan for this day."}]}):ETM.no_meal_plan_walkthrough.setOptions({skipLabel:"Close",steps:[{element:".generator_header,.workspace_header",intro:"To enable the full walkthrough, please enter a number of calories and hit the Generate button."}]});ETM.free_overview=introJs();
ETM.free_overview.setOptions({name:"Free overview",exitOnOverlayClick:!1,skipLabel:"Close",steps:[{intro:"This is a quick summary of the generator's features."},{element:".display_nutrition_targets",intro:"These are the nutrition targets the meal planner will try to match.  You can edit them in the dropdown."},{element:".meal_header",intro:'This is a meal type.  You can customize its settings by clicking the <span class="glyphicon glyphicon-cog"></span> button.<br/>You can also regenerate the foods in the meal by clicking the <span class="glyphicon glyphicon-random"></span> button. Whenever you regenerate, the planner will find new foods that still hit your nutrition targets.'},
{element:".diet_draggable",intro:'This is a food in your meal plan. Hovering your mouse over it (or tapping it once on a touchscreen) will show you several options and let you change the amount/units. Here\'s what they do:<br/><br/> <img src="/static_files/images/addFavorite.png" alt="Heart" height="16" width="16"> - Add to your favorites list. Favorites can be accessed in the Food Bank sidebar, and will show up in your meal plans slightly more often.<br/><br/><span class="glyphicon glyphicon-info-sign"></span> - View food details and nutrition. With recipes, this is where you can find the directions and more ingredient details. <br/><br/><span class="glyphicon glyphicon-repeat"></span> - Set this food to recur. Recurring foods can be set to repeat in a meal "always" or "often". Setting up a lot of recurring foods is the best way to make your plan consistently likable.<br/><br/><span class="glyphicon glyphicon-random"></span> - Regenerate this food. Whenever you regenerate a food, the planner will try to replace it with something that fills out your meal plan\'s nutrition targets. <br/><br/><div class="block_food_image"></div> - Block this food. Then if you delete the food or regenerate it, it won\'t show up again until you unblock it.<br/><br/><span class="glyphicon glyphicon-remove"></span> - Delete the food from the meal plan.'},
{element:".add_a_dish",intro:"Add a specific food using the food bank. You can search existing dishes, make your own, view your favorites and then drag any of them into your meal plan.",position:"bottom-right-aligned"},{element:"#workspace_stats",intro:"The generator will try to meet all of your goals, but sometimes it may violate one limit (like budget) in favor of meeting another (like minimum protein). Double check the results before following any diet."},{element:".help-dropdown",intro:"For more information and more in depth walkthroughs, check out our Help button in the top menu bar. The Knowledge Base should be able to answer most of your questions. Thanks for reading, we hope you enjoy using Eat This Much!"}]});
ETM.free_overview.onchange(function(a){0!=ETM.free_overview._currentStep?$(a).velocity("scroll",{duration:700,offset:-60}):$(a).velocity("scroll",{duration:300,offset:-120});switch(ETM.free_overview._currentStep){case 3:$(a).find(".mod_units").show();$(a).find(".static_div").hide();$(".top_row_icons:first .food_delete").show();$(".top_row_icons:first .food_repeat").show();$(".bottom_row_icons:first .food_refresh").show();$(".bottom_row_icons:first .block_food").show();break;case 6:$(".help-dropdown").is(":visible")||
$(".navbar-toggle").trigger("click")}switch(ETM.free_overview._previousStep){case 3:$(ETM.free_overview._previousElement).find(".mod_units").hide(),$(ETM.free_overview._previousElement).find(".static_div").show(),$(".top_row_icons:first .food_delete").hide(),$(".top_row_icons:first .food_repeat").hide(),$(".bottom_row_icons:first .food_refresh").hide(),$(".bottom_row_icons:first .block_food").hide()}ETM.free_overview._previousStep=ETM.free_overview._currentStep;ETM.free_overview._previousElement=
a});ETM.free_overview.oncomplete(function(a){$(".walkthrough-prompt").remove();ETM.current_user_profile.save({show_walkthrough_prompt:!1},{patch:!0});ETM.current_diet.attributes.meals.at(0).attributes.foods.at(0).trigger("enableHover")});ETM.free_overview.onexit(function(a){ETM.current_diet.attributes.meals.at(0).attributes.foods.at(0).trigger("enableHover")});ETM.free_intro=introJs();
ETM.free_intro.setOptions({name:"Free intro",exitOnOverlayClick:!1,skipLabel:"Close",steps:[{intro:"This overview of the generator's features will help you quickly build your ideal diet plan."},{element:".display_nutrition_targets",intro:"These are the nutrition targets the meal planner will try to match. It will try to stay within the range for proteins, fats, and carbs (known as the macronutrients)  and as close to the calorie number as possible.  You can edit these nutrition targets by opening the dropdown menu and choosing the edit option.  You can also create multiple sets of these settings and switch between them freely."},
{element:".meal_header",intro:"This is a meal type. Meal types allow you to customize meals across multiple days by setting  the size of the meal, the time you have to make the meal, and more."},{element:".meal_header",intro:"The meal options dropdown lets you edit the settings for this meal type, switch to other meal types, delete meal types, and create new meal types."},{element:".meal_refresh_btn",intro:"You can regenerate an individual meal with this refresh button to replace that meal with new foods that still match your nutrition targets."},
{element:".diet_draggable",intro:"This is a food in your meal plan. Clicking the heart will favorite that food, causing it to appear more often in your meal plans. You can also drag foods between meals and hover over them to see options as well as a tooltip with more information.  Lets look at each of the hover options in more detail."},{element:".food_units",intro:"These editors allow you to change the amount of the food in question and the units it is presented as. Changing units will automatically convert the amount of the food to maintain the same number of calories."},
{element:".food_image",intro:"Clicking the food image will show detailed statistics and allow you to personalize recipes with your own ingredients and directions."},{element:".food_icons .top_row_icons .repeat_item",intro:"The recurring food button will open a modal where you can set the current food to appear often or always in a specific meal. See the recurring foods walkthrough for more information."},{element:".food_icons .bottom_row_icons .refresh_item",intro:"You can also regenerate individual foods to replace them with another food while still matching your nutrition targets."},
{element:".food_icons .bottom_row_icons .block_food",intro:"Blocking a food will prevent it from ever appearing again in your meal plans. You can view your blocked foods via the settings button and unblock them should you change your mind."},{element:".food_icons .top_row_icons .remove_item",intro:"The remove button will delete the food from the plan. This is generally useful when you want to add foods to a plan manually, which we will cover next."},{element:".add_a_dish",intro:"Add a specific food using the food bank. You can search existing dishes, make your own, view your favorites and then drag any of them into your meal plan. As a subscriber, you can even have the generator automatically use your custom recipes."},
{element:"#workspace_stats",intro:"The generator will try to meet all of your goals, but sometimes it may violate one limit (like budget) in favor of meeting another (like minimum protein). Double check the results before following any diet."},{element:".help-dropdown",intro:"For more information and more in depth walkthroughs, check out our Help button.  Thanks for reading, we hope you enjoy using Eat This Much!"}]});
ETM.free_intro.onchange(function(a){switch(ETM.free_intro._currentStep){case 6:$(a).find(".static_div").hide();$(a).find(".mod_units").show();break;case 8:case 9:case 10:case 11:$(".top_row_icons:first").children().children().show();$(".bottom_row_icons:first").children().children().show();break;case 14:$(".help-dropdown").is(":visible")||$(".navbar-toggle").trigger("click")}switch(ETM.free_intro._previousStep){case 6:$(ETM.free_intro._previousElement).find(".mod_units").hide();$(ETM.free_intro._previousElement).find(".static_div").show();
break;case 8:case 9:case 10:case 11:if(8>ETM.free_intro._currentStep||11<ETM.free_intro._currentStep)$(".top_row_icons:first").children().children().hide(),$(".bottom_row_icons:first").children().children().hide()}ETM.free_intro._previousStep=ETM.free_intro._currentStep;ETM.free_intro._previousElement=a});ETM.free_intro.oncomplete(function(a){$(".walkthrough-prompt").remove();ETM.current_user_profile.save({show_walkthrough_prompt:!1},{patch:!0});ETM.current_diet.attributes.meals.at(0).attributes.foods.at(0).trigger("enableHover")});
ETM.free_intro.onexit(function(a){ETM.current_diet.attributes.meals.at(0).attributes.foods.at(0).trigger("enableHover")});ETM.premium_intro=introJs();
ETM.premium_intro.setOptions({name:"Premium intro",require_diet:!1,exitOnOverlayClick:!1,skipLabel:"Close",steps:[{intro:"This overview of the premium features will help you get the most out of your subscription."},{element:".calendar_navigation_box",intro:"This is the calendar. Each day can have a meal plan, and you can view those plans by clicking the day or using the arrows."},{element:".pantry_grocery_nav",intro:"This will take you to your grocery list, let's head there now."},{element:".grocery_options",
intro:"At the top of the grocery list page, you can:<br/>1. Open the Food Bank to search for foods to add to your grocery list or pantry,<br/>2. Reset the grocery list to use a different date range of meal plans.<br/>3. Print or email your grocery list and a selection of meal plans from your calendar.<br/>4. Remove foods from the pantry that were in past meal plans, indicating that you ate them.<br/><br/><span class='label label-info'>Note</span> If you make changes to your meal plans, the grocery list will automatically reload every time you view this page. However, if you change an item in your grocery list, that food will stop automatically updating to prevent from overwriting your changes (until the next time you reset the list)."},
{element:".grocery_title_col",intro:"This is your grocery list. It contains the foods that you still need to buy for your next week. You can move foods from the grocery list to the pantry to indicate you have bought them."},{element:".pantry_title_col",intro:"This is the pantry list. It contains foods that you have already bought.  The planner will automatically remove foods from the pantry as you use them throughout the week. You can trigger the planner to remove the foods with the 'Remove eaten foods'above, otherwise they will be removed automatically when the weekly planner runs."},
{element:".settings_nav",position:"top",intro:"Next let's look at the Weekly meal layout, available from the Settings menu."},{element:"#settings_content",intro:"This is where you can layout the structure of your weekly meal plan, such as the number of calories or the meal types you want to eat each day.",position:"bottom"},{element:".template_targets",intro:"This is where you can change/edit the nutrition profile for each day (in this case Sunday) or create a new one.  Creating separate profiles for different days allows you to do things like have high/low calorie + protein days for workout/rest days.  Changing a nutrition profile will affect all the days that use it, so if you want different settings for just one day, create a new profile.",
position:"right"},{element:".template_column",intro:"This is where you can modify the meal types for each day.  You can add, edit, and delete meal types as well as change their order by dragging them.  Meal types + recurring foods allows you to customize your week exactly the way you want it - be it desserts each Saturday or bacon and eggs for brunch each Sunday.",position:"right"},{element:".help-dropdown",intro:"For more information and more in depth walkthroughs, check out our Help button.  Thanks for reading, we hope you enjoy using Eat This Much!"}]});
ETM.premium_intro.oncomplete(function(a){$(".walkthrough-prompt").remove();ETM.current_user_profile.save({show_walkthrough_prompt:!1},{patch:!0});$(".weekly-planner-layout").removeAttr("style")});ETM.premium_intro.onexit(function(a){$(".weekly-planner-layout").removeAttr("style")});ETM.premium_intro.onafterchange(function(a){switch(ETM.premium_intro._currentStep){case 6:setTimeout(function(){$(".settings_button").trigger("click");$(".weekly-planner-layout").css("background-color","yellow")},400)}});
ETM.premium_intro.onbeforechange(function(a){switch(ETM.premium_intro._currentStep){case 3:case 4:case 5:case 6:"groceries/"!=Backbone.history.fragment&&(ETM.router.navigate("groceries/",{trigger:!0}),setTimeout(function(){ETM.premium_intro.updateElementSelectors();ETM.premium_intro.refresh()},400));break;case 7:setTimeout(function(){ETM.premium_intro.updateElementSelectors();ETM.premium_intro.refresh()},500);case 8:case 9:"settings/weekly-planner-layout/"!=Backbone.history.fragment&&ETM.router.navigate("settings/weekly-planner-layout/",
{trigger:!0});break;case 10:$(".help-dropdown").is(":visible")||$(".navbar-toggle").trigger("click");default:""!=Backbone.history.fragment&&(ETM.router.navigate("",{trigger:!0}),setTimeout(function(){ETM.premium_intro.updateElementSelectors();ETM.premium_intro.refresh()},400))}switch(ETM.premium_intro._previousStep){case 7:case 8:case 9:$(".settings_button")&&$(".settings_button").trigger("click")}ETM.premium_intro._previousStep=ETM.premium_intro._currentStep;ETM.premium_intro._previousElement=a});
ETM.WeeklySettingsView=Backbone.View.extend({events:{"click .add_more_meals":"openAddMealModal","click .save_changes":"saveChanges","change .one_template input":function(a){a=!$(a.currentTarget).is(":checked");ETM.current_user_profile.save({single_template_diet:a});this.render()},"click .close-regenerate-prompt":function(a){this.hide_regenerate_prompt=!0},"click .template-regenerate":function(a){a.preventDefault();amplitude.logEvent("regenerate_week_settings_modal");this.regenerate_week_modal=new ETM.RegenerateWeekModalView;
$("#regenerate_week_modal",ETM.$modal_content).html(this.regenerate_week_modal.render().el);this.regenerate_week_modal.$el.modal("show");this.regenerate_week_modal.delegateEvents();this.regenerate_week_modal.checkPantryStatus()}},initialize:function(){this.amplitude_log_change=!0;this.hide_regenerate_prompt=!1},showAlert:function(){this.alert_active&&!this.hide_regenerate_prompt&&$(".regenerate-alert",this.el).show()},onClose:function(){this.template_diet_list_view.close();this.template_diet_list_view=
null},render:function(){this.$el.html(this.template());$("#one_template",this.el).prop("checked",!ETM.current_user_profile.attributes.single_template_diet);ETM.current_user_profile.attributes.single_template_diet&&$(".add_more_meals",this.el).hide();this.renderTemplates();this.showAlert();return this},renderTemplates:function(){var a=this;this.template_diet_list_view&&(this.template_diet_list_view.close(),this.template_diet_list_view=null);this.template_diet_list_view=new ETM.TemplateDietListView({collection:this.collection});
var b=0;this.collection.models.forEach(function(c){a.listenTo(c.attributes.diet,"change",function(){a.alert_active=!0;a.showAlert();a.amplitude_log_change&&(a.amplitude_log_change=!1,amplitude.logEvent("weekly_settings_update_weekly_layout"))},this);6!=c.attributes.weekday&&c.attributes.diet.attributes.meals.forEach(function(a){a=a.attributes.meal_type;_.has(a,"label_class")||(a.label_class="meal_label_"+b,b++,10<=b&&(b=0))})});this.collection.findWhere({weekday:6}).attributes.diet.attributes.meals.forEach(function(a){a=
a.attributes.meal_type;_.has(a,"label_class")||(a.label_class="meal_label_"+b,b++,10<=b&&(b=0))});$(".template_diet_list",this.el).html(this.template_diet_list_view.render().el)},saveChanges:function(){},openAddMealModal:function(){this.add_meal_modal||(this.add_meal_modal=new ETM.AddMealTypeModal,$("#add_meals_modal",ETM.$modal_content).html(this.add_meal_modal.render().el));this.add_meal_modal.renderForm();this.add_meal_modal.$el.modal("show")}});
ETM.WeeklySettingsTeaserView=Backbone.View.extend({render:function(){this.$el.html(this.template());return this}});
ETM.WeightModalView=ModalView.extend({className:"modal fade",events:{"click .update_weight_submit":"updateWeight","click .update_weight_goal_submit":"updateWeightGoal","keypress .weight_input_field":"processKey","click .show_weight_goal":function(){$(".weight_goal_entry",this.el).slideToggle(300)}},initializeForm:function(){this.form=new Backbone.Form({model:ETM.current_user_profile,schema:ETM.current_user_profile.weight_goal_schema(),template:ETM.loadNestedTemplate("#WeightModalView","#weight_entry_form")});
this.listenTo(this.form,"weight_goal:change weight_goal_date:change",function(){this.updateWeeklyRate();this.renderMacroChanges()},this);this.listenTo(this.form,"weight_goal_weekly_rate:change",function(){this.updateGoalDate();this.renderMacroChanges()},this)},initialize:function(){this.initializeForm();this.macro_changes_view=new ETM.MacroChangesView},render:function(){this.$el.html(this.template());this.renderForm();this.$el.modal({show:!1});return this},checkUnits:function(){"M"===ETM.current_user_profile.get("units")?
(this.form.fields.todays_weight.editor.toggleUnits("M"),this.form.fields.weight_goal.editor.toggleUnits("M"),this.form.fields.weight_goal_weekly_rate.editor.toggleUnits("M"),$(".weight_units",this.el).html("kgs")):(this.form.fields.todays_weight.editor.toggleUnits("I"),this.form.fields.weight_goal.editor.toggleUnits("I"),this.form.fields.weight_goal_weekly_rate.editor.toggleUnits("I"),$(".weight_units",this.el).html("lbs"));$(".recent_weight_update span",this.el).html(lastWeightUpdateString())},updateWeeklyRateMinMax:function(a){var b=
$('input[name="weight_goal_weekly_rate"]',this.form.el);0>a?(b.attr("max","-0.1"),b.removeAttr("min")):0<a&&(b.attr("min","0.1"),b.removeAttr("max"))},updateWeeklyRate:function(){if(ETM.current_user_profile.attributes.weight&&this.form.getValue().weight_goal&&this.form.getValue().weight_goal_date){var a=this.form.getValue().weight_goal-ETM.current_user_profile.attributes.weight;this.updateWeeklyRateMinMax(a);var b=Helper.days_between(Helper.parseDateString(this.form.getValue().weight_goal_date),new Date)/
7;this.form.fields.weight_goal_weekly_rate.editor.setImperialValue(roundNumber(a/b,1));this.validateWeightGoal()}},updateGoalDate:function(){if(ETM.current_user_profile.attributes.weight&&this.form.getValue().weight_goal&&this.form.getValue().weight_goal_weekly_rate){var a=(this.form.getValue().weight_goal-ETM.current_user_profile.attributes.weight)/(this.form.getValue().weight_goal_weekly_rate/7),b=new Date;b.setDate(b.getDate()+Math.ceil(a));this.form.setValue({weight_goal_date:b});this.validateWeightGoal()}},
renderForm:function(){this.form.render();this.listenTo(ETM.current_user_profile,"change:weight_goal change:weight_goal_date change:weight_goal_weekly_rate",function(){null!=ETM.current_user_profile.attributes.weight_goal_date&&this.form.setValue({weight_goal_date:Helper.parseDateString(ETM.current_user_profile.attributes.weight_goal_date)});this.form.fields.weight_goal.editor.setImperialValue(ETM.current_user_profile.attributes.weight_goal);this.form.fields.weight_goal_weekly_rate.editor.setImperialValue(ETM.current_user_profile.attributes.weight_goal_weekly_rate)},
this);this.listenTo(ETM.current_user_profile,"change:units",function(){this.checkUnits()},this);this.updateWeeklyRate();$(".update_weight_form",this.el).html(this.form.el);$(".macro_changes_view",this.el).html(this.macro_changes_view.render().el);this.macro_changes_view.delegateEvents();this.renderMacroChanges();this.checkUnits()},renderMacroChanges:function(){var a=ETM.current_user_profile.clone();a.set({weight_goal:this.form.getValue().weight_goal,weight_goal_date:this.form.getValue().weight_goal_date,
weight_goal_weekly_rate:this.form.getValue().weight_goal_weekly_rate});this.macro_changes_view.renderMacroChanges(ETM.current_user_profile.attributes.preset_diet,a)},processKey:function(a){13===a.which&&(a.preventDefault(),this.updateWeight(a))},successfullyUpdated:function(a){var b=this;$(".update_progress",b.el).hide();$(".update_success",b.el).show();ETM.current_user_profile.set({weight:a,last_updated_weight:moment().format("YYYY-MM-DD")});ETM.current_user_profile.trigger("update_weight",a);$(".recent_weight_update span",
this.el).html(lastWeightUpdateString());setTimeout(function(){$(".update_weight_submit",b.el).show();$(".update_success",b.el).hide();$(".update_weight_submit",this.el).prop("disabled",!1)},1E3)},updateWeight:function(a){a.preventDefault();var b=this;$(".weight_update_error",this.el).hide();var c=this.form.getValue().todays_weight;0<!c?($(".weight_update_error",this.el).show(),$(".weight_update_error",this.el).html("Please enter a weight greater than 0.")):($(".update_progress",this.el).show(),$(".update_weight_submit",
this.el).prop("disabled",!0),(new ETM.WeightEntry({weight:c})).save(null,{success:function(){b.successfullyUpdated(c)},error:function(a,e,f){201==f.xhr.status?b.successfullyUpdated(c):($(".update_progress",b.el).hide(),$(".update_weight_submit",b.el).prop("disabled",!1),$(".update_success",b.el).hide(),$(".weight_update_error",b.el).show(),$(".weight_update_error",b.el).html("Something went wrong with the update :( Please check the weight input and try again."))}}))},validateWeightGoal:function(){$(".weight_goal_update_error",
this.el).hide();$(".weight_goal_date_update_error",this.el).hide();$(".weight_goal_weekly_rate_warning",this.el).hide();var a=!0;0<!this.form.getValue().weight_goal&&($(".weight_goal_update_error",this.el).show(),$(".weight_goal_update_error",this.el).html("Please enter a weight goal greater than 0."),a=!1);var b=this.form.getValue().weight_goal_date;if(null==b)$(".weight_goal_date_update_error",this.el).show(),$(".weight_goal_date_update_error",this.el).html("Please enter a valid weight goal date."),
a=!1;else{var c=new Date;c.setDate(c.getDate()+7);+Helper.parseDateString(b)>=+c||($(".weight_goal_date_update_error",this.el).show(),$(".weight_goal_date_update_error",this.el).html("Please enter a weight goal date at least a week in the future."),a=!1)}"M"===ETM.current_user_profile.get("units")?this.form.getValue().weight_goal_weekly_rate&&0.9<Math.abs(this.form.fields.weight_goal_weekly_rate.editor.getRawValue())&&($(".weight_goal_weekly_rate_warning",this.el).show(),$(".weight_goal_weekly_rate_warning",
this.el).html("The CDC and health professions strongly advise against weight changes of more than 0.9 kgs a week")):this.form.getValue().weight_goal_weekly_rate&&2<Math.abs(this.form.getValue().weight_goal_weekly_rate)&&($(".weight_goal_weekly_rate_warning",this.el).show(),$(".weight_goal_weekly_rate_warning",this.el).html("The CDC and health professions strongly advise against weight changes of more than 2 lbs a week"));return a},updateWeightGoal:function(a){a.preventDefault();this.validateWeightGoal()&&
($(".update_progress",this.el).show(),$(".update_weight_goal_submit",this.el).prop("disabled",!0),ETM.current_user_profile.save({weight_goal:this.form.getValue().weight_goal,weight_goal_date:this.form.getValue().weight_goal_date,weight_goal_weekly_rate:this.form.getValue().weight_goal_weekly_rate},{success:function(){var a=this;$(".update_progress",a.el).hide();$(".update_success",a.el).show();setTimeout(function(){$(".update_weight_goal_submit",a.el).prop("disabled",!1);$(".update_success",a.el).hide()},
1E3)}}))}});function lastWeightUpdateString(){var a=ETM.current_user_profile.get("weight"),b="lbs";"M"===ETM.current_user_profile.get("units")&&(a=roundNumber(0.453592*a,1),b="kgs");var c=moment(ETM.current_user_profile.get("last_updated_weight")),c=c.year()===moment().year()?c.format("MMM Do"):c.format("MMM Do, YYYY");return a+" "+b+" on "+c}
ETM.CuratorView=Backbone.View.extend({initialize:function(){this.food_list=new ETM.FoodList},render:function(){var a=this;this.$el.html(this.template({is_staff:ETM.is_staff,is_logged_in:ETM.is_logged_in,user:ETM.current_user_profile.attributes}));this.loadCuratorProfile(function(){a.loadListToCurate(function(){a.renderListToCurate();a.updateFilters()})});return this},renderForm:function(){this.form=(new Backbone.Form({model:this.model.get("curator"),template:Helper.createTemplateFunction($("#curatorForm",
this.el).html())})).render()},loadCuratorProfile:function(a){var b=this;this.curator_profile?a():(curator_profile_list=new ETM.CuratorProfileList,curator_profile_list.fetch({success:function(){b.curator_profile=curator_profile_list.at(0);1<b.curator_profile.attributes.current_search_query.length&&$("#query_input",this.el).val(b.curator_profile.attributes.current_search_query);a()}}))},reloadCurator:function(a){a.preventDefault();var b=this;a=$("#query_input").val();a!==this.curator_profile.get("current_search_query")?
this.curator_profile.save({current_search_query:a},{success:function(){b.loadListToCurate(function(){b.renderListToCurate();b.updateFilters()})}}):b.loadListToCurate(function(){b.renderListToCurate();b.updateFilters()})},loadListToCurate:function(a){var b=this;$(".loading_gif",this.el).show();$.get("/curator/get-list/",function(c){$(".loading_gif",b.el).hide();var d=[];JSON.parse(c).forEach(function(a){a=new ETM.FoodObjectWithChanges({food:a,amount:1,units:a.default_units},{skip_global:!0});d.push(a)});
b.food_list.reset(d);a()})},renderListToCurate:function(){this.curate_list_view=new ETM.CuratorFoodListView({collection:this.food_list,el:$(".curate_list",this.el)});this.curate_list_view.render()},updateFilters:function(){var a=this.curator_profile;a||(a=this.loadCuratorProfile());(a=a.get("current_search_query"))||(a='{"model__in":"u"}');var b=JSON.parse(a);Object.keys(b).forEach(function(a){var d=$("#"+a);d&&("model__in"==a?b[a].split(",").forEach(function(a){"ub"!=a&&$("#"+a+"_model").prop("checked",
!0)}):d.val(b[a]))})}});
ETM.CuratorFoodObjectView=ETM.FoodObjectView.extend({render:function(){this.updateStaticAmountAndUnits();this.model.selector_html=this.selectorHTML();this.model.image=this.model.attributes.food.getDisplayImage();for(var a="Needs review",b=0;b<this.model.attributes.food.attributes.changes.models.length;b++){var c=this.model.attributes.food.attributes.changes.models[b];if(c.attributes.review_approved){a="Review complete";break}else c.attributes.reviewer===ETM.curator_view.curator_profile.id&&(!c.attributes.review_complete||
c.attributes.review_approved||c.attributes.review_rejected?c.attributes.review_rejected&&c.attributes.review_complete&&(a="Needs re-review"):a="Waiting for approval")}this.model.review_status=a;a=this.template(this.model);this.$el.html(a);this.$el.unbind("mouseenter mouseleave");this.applyHoverEffects();this.applyTooltip();this.printGramReadout();this.applyButtonTooltips();return this}});ETM.CuratorFoodListView=ETM.FoodListView.extend({modelView:ETM.CuratorFoodObjectView});
ETM.FoodChangesListView=Backbone.View.extend({events:{"click .create_new_changes":"startNewFoodChanges"},startNewFoodChanges:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;a.food_object_modal.undelegateEvents();this.food_object_modal.parent.$el.one("hidden.bs.modal",function(){a.model.get("food").get("is_recipe")?(ETM.recipe_editor=new ETM.RecipeCuratorModalView,ETM.recipe_editor.loadFoodChanges(a.model,!1),$("#food_object_modal_div").html(ETM.recipe_editor.render().el),
ETM.recipe_editor.applyEvents(),ETM.recipe_editor.delayPrintGraph()):(ETM.basic_food_curator=new ETM.BasicFoodCuratorModalView,ETM.basic_food_curator.parent=this,ETM.basic_food_curator.loadFoodChanges(a.model),$("#curator_modal_div").html(ETM.basic_food_curator.render()))}).modal("hide")},render:function(){var a=this;this.$el.html(this.template(this.model));list_div=$(".existing_changes_list",this.el);list_div.html("");_.each(this.model.attributes.food.attributes.changes.models,function(b){object_view=
new ETM.FoodChangesObjectView({model:b});object_view.food_object_modal=a.food_object_modal;list_div.append(object_view.render().el)});return this}});
ETM.FoodChangesObjectView=Backbone.View.extend({events:{"click .edit_changes":"loadExistingChanges","click .duplicate_changes":"copyChanges","click .delete_changes":"deleteChanges","click .merge_changes":"applyChangesToRecipe","change .approval_radio":"setChangesApproval"},initialize:function(){},loadExistingChanges:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;a.food_object_modal.undelegateEvents();this.food_object_modal.parent.$el.one("hidden.bs.modal",function(){a.food_object_modal.model.get("food").get("is_recipe")?
(ETM.recipe_editor=new ETM.RecipeCuratorModalView,ETM.recipe_editor.loadFoodChanges(a.food_object_modal.model,!0,a.model),$("#food_object_modal_div").html(ETM.recipe_editor.render().el),ETM.recipe_editor.applyEvents(),ETM.recipe_editor.delayPrintGraph()):(ETM.basic_food_curator=new ETM.BasicFoodCuratorModalView,ETM.basic_food_curator.parent=this,ETM.basic_food_curator.loadFoodChanges(a.food_object_modal.model,!0,a.model),$("#curator_modal_div").html(ETM.basic_food_curator.render()))}).modal("hide")},
copyChanges:function(){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;var a=this;a.food_object_modal.undelegateEvents();this.food_object_modal.parent.$el.one("hidden.bs.modal",function(){a.food_object_modal.model.get("food").get("is_recipe")?(ETM.recipe_editor=new ETM.RecipeCuratorModalView,ETM.recipe_editor.loadFoodChanges(a.food_object_modal.model,!1,a.model),$("#food_object_modal_div").html(ETM.recipe_editor.render().el),ETM.recipe_editor.applyEvents(),ETM.recipe_editor.delayPrintGraph()):
(ETM.basic_food_curator=new ETM.BasicFoodCuratorModalView,ETM.basic_food_curator.parent=this,ETM.basic_food_curator.loadFoodChanges(a.food_object_modal.model,!1,a.model),$("#curator_modal_div").html(ETM.basic_food_curator.render()))}).modal("hide")},deleteChanges:function(){this.remove();this.model.destroy()},setChangesApproval:function(){if(!0!=is_superuser)return!1;var a=$(".approval_radio input:checked",this.el).val();"null"==a?this.model.set({review_approved:!1,review_rejected:!1}):0==a?this.model.set({review_approved:!1,
review_rejected:!0}):1==a&&this.model.set({review_approved:!0,review_rejected:!1});this.model.save()},render:function(){this.$el.html(this.template({curator_profile:ETM.curator_view.curator_profile,model:this.model}));return this}});
ETM.RecipeCuratorModalView=ETM.RecipeEditorModalView.extend({id:"recipe_curator_editor_modal",className:"modal fade",events:function(){return _.extend({},ETM.FoodObjectModalBasicView.prototype.events,{"click .personalize_recipe":"convertViewToEdit","click .add_direction":"addDirection","click .cancel_edits":"closeEditor","click .save_recipe_changes":"saveChanges","click .enter_ingredients_text":"enterTextIngredients","click .confirm_ingredients_text":"confirmTextIngredients","click .parse_ingredients_text":"parseTextIngredients",
"click .cancel_ingredients_text":"cancelTextIngredients","click .admin_edit":"adminEditRecipe","click .admin_curate_and_edit":"adminCurateAndEditRecipe","change .modal_curate_recipe_radio":"changeRecipeCuration","click .enable_curation_radio":"enableCurationRadioButtons","change .admin_extra_tags_checkboxes input":"enableTagSaveButton","click .admin_save_recipe_tags":"saveRecipeTags"})},loadFoodChanges:function(a,b,c){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;this.original_food_object=
a;var d=a.clone();if(b||c)e=new ETM.FoodChanges(c.toJSON()),e.attributes.ingredients=new ETM.IngredientsList(JSON.parse(e.attributes.ingredients_changes)),e.attributes.directions=new ETM.DirectionsList(JSON.parse(e.attributes.directions_changes));else{var e=new ETM.FoodChanges(a.attributes.food.toJSON());e.addExtraFoodAttributesToChanges(a);var f=a.attributes.food.attributes.directions,g=[];a.attributes.food.attributes.ingredients.each(function(a){g.push(a.toJSON())});var h=new ETM.IngredientsList(g),
f=new ETM.DirectionsList(f.toJSON());e.attributes.ingredients=h;e.attributes.directions=f}e.attributes.ingredients.each(function(a){Helper.clearIDs(a)});e.attributes.directions.each(function(a){Helper.clearIDs(a)});e.attributes.food_id=a.attributes.food.attributes.id;b&&(ETM.current_user_profile.get("user_id")===e.attributes.user_id||is_superuser)?e.url=function(){return ROOT+"/foodchanges/"+c.get("id")+"/"}:(Helper.clearIDs(e),e.url=function(){return ROOT+"/foodchanges/"});this.model=d;this.food_changes_obj=
e},saveChanges:function(){var a=this;if(!this.validate())return console.log("failed to validate!"),!1;if($(".enter_ingredients_text",this.el).hasClass("as_drag"))return $(".ingredients_container",this.el).after('<div class="alert alert-danger recipe_finishing_entering_ingredients_error recipe_validation_error">Please finish entering your text ingredients or hit cancel.'),!1;var b=this.form.commit({validate:!0}),c=this.scrapeFields();if("undefined"===typeof b){var d=0;c.get("ingredients").each(function(a){a.attributes.order=
d;d++});d=0;c.get("directions").each(function(b){b.attributes.order=d;b.attributes.text=$(".directions_text textarea",a.el).eq(d).val().replace(/</g,"").replace(/>/g,"");0===b.attributes.text.length&&(b.attributes.text="");d++});c.attributes.ingredients_changes=JSON.stringify(c.attributes.ingredients.toJSON());c.attributes.directions_changes=JSON.stringify(c.attributes.directions.toJSON());this.checkIfIngredientsDirectionsChanged(c);$(".recipe_save_spinner",this.el).show();$(".save_recipe",this.el).prop("disabled",
!0);_.has(c.attributes,"reviewer")&&null!=c.attributes.reviewer||(c.attributes.reviewer=ETM.curator_view.curator_profile.id);c.save({},{success:function(b,c,d){a.original_food_object.attributes.food.fetch({success:function(){a.original_food_object.trigger("modalUpdated")}});a.$el.modal("hide")},error:function(b,c,d){$(".recipe_save_spinner",a.el).hide();$(".save_recipe",a.el).prop("disabled",!1);$(".modal-footer").append('<div class="alert alert-danger recipe_validation_error" style="float:left">Failed to save recipe.</div>')}})}else for(var e in b)b.hasOwnProperty(e)&&
$('[data-editors="'+e+'"]').append('<div class="alert alert-danger recipe_validation_error" style="float:left">'+b[e].message+"</div>")},checkIfIngredientsDirectionsChanged:function(a){var b=this.original_food_object.attributes.food.attributes.ingredients.clone(),c=this.original_food_object.attributes.food.attributes.directions.clone();b.each(function(a){Helper.clearIDs(a)});c.each(function(a){Helper.clearIDs(a)});b=JSON.stringify(b.toJSON());c=JSON.stringify(c.toJSON());a.attributes.has_ingredients_changes=
a.attributes.ingredients_changes!=b;a.attributes.has_directions_changes=a.attributes.directions_changes!=c},render:function(){ETM.sidebar_view.toggleFoodBank("open");ETM.sidebar_view.toggleIngredientsOnly();ETM.sidebar_view.moveToFront();this.$el.html(this.template({model:this.model,image:this.model.attributes.food.getDisplayImage(),user_id:null,is_logged_in:ETM.is_logged_in,is_premium:ETM.is_premium,is_staff:ETM.is_staff}));this.$el.modal({backdrop:"static",keyboard:!1,show:!0});this.ingredients_list_view=
new ETM.IngredientListView({collection:this.food_changes_obj.get("ingredients"),el:$(".ingredients_list",this.el)});this.ingredients_list_view.render();this.setIngredientScale(this.model.get("food").get("number_servings"));this.directions_list_view=new ETM.DirectionsListView({collection:this.food_changes_obj.get("directions"),el:$(".directions_list",this.el)});this.directions_list_view.render();this.renderForm();this.resizeDirectionsFields();this.model.get("food").get("ingredients").each(function(a){a.calculateStats()});
this.calculateStats();this.printRecipeStats();this.create_uploader();this.addTooltips();return this},renderForm:function(){this.form=(new Backbone.Form({model:this.food_changes_obj,template:Helper.createTemplateFunction($("#recipeChangesForm",this.el).html())})).render();$(".recipe_info_container",this.el).html(this.form.el);$("#recipe-title",this.el).val(this.food_changes_obj.attributes.food_name);$("#recipe-description",this.el).val(this.food_changes_obj.attributes.description);$("#serving-size-input",
this.el).val(this.food_changes_obj.attributes.serving_size_amount);$("#serving-description",this.el).val(this.food_changes_obj.attributes.serving_size_description);$(".review_complete",this.el).prop("checked",this.food_changes_obj.attributes.review_complete);this.setupMealTagTokenField()},validate:function(){$(".recipe_validation_error",this.el).remove();var a=!0,b=$("#recipe-title",this.el),c=$("#serving-size-input",this.el),d=$("#serving-description",this.el),e=$(".tokenfield",this.el);0<!b.val().length&&
(b.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a title.</div>"),a=!1);0<!c.val().length?(c.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a serving size.</div>"),a=!1):0>=this.parseServingSize(c.val())&&(c.after("<div class='alert alert-danger recipe_validation_error'>The recipe serving size must be greater than zero.</div>"),a=!1);0<$(".token.invalid").length&&(e.after("<div class='alert alert-danger recipe_validation_error'>Invalid meal tag entered.</div>"),
a=!1);0<!d.val().length&&(d.after("<div class='alert alert-danger recipe_validation_error'>The recipe must have a serving size description.</div>"),a=!1);0==this.model.get("food").attributes.ingredients.length&&($(".ingredients_header").after("<div class='alert alert-danger recipe_validation_error'>The recipe needs at least one ingredient.</div>"),a=!1);return a},scrapeFields:function(){var a=$("#recipe-title",this.el).val(),b=$("#recipe-description",this.el).val(),c=$("#serving-size-input",this.el).val(),
d=$("#serving-description",this.el).val(),e=this.food_changes_obj;e.attributes.food_name=a;e.attributes.description=b;e.attributes.serving_size_amount=this.parseServingSize(c);e.attributes.serving_size_description=d;e.attributes.review_complete=$(".review_complete",this.el).is(":checked");return e},setupMealTagTokenField:function(){var a=this;this.tokenfield_selector=$("#meal-tags",this.el);this.tokenfield_selector.tokenfield({autocomplete:{source:function(a,c){var d=$.ui.autocomplete.filter(ETM.meal_tag_list.pluck("tag_name"),
a.term);c(d)},delay:100},showAutocompleteOnFocus:!0});a.loadMealTagTokens();this.tokenfield_selector.on("tokenfield:createtoken",function(b){b.attrs.value=b.attrs.value.toLowerCase();b.attrs.label=b.attrs.value;$.each($(this).tokenfield("getTokens"),function(c,d){d.value===b.attrs.value&&($(".token-input",a.el).val(""),b.preventDefault())})});this.tokenfield_selector.on("tokenfield:createdtoken",function(b){var c=ETM.meal_tag_list.findWhere({tag_name:b.attrs.value});c?a.food_changes_obj.attributes.mapped_meal_tags.add(c):
$(b.relatedTarget).addClass("invalid")});this.tokenfield_selector.on("tokenfield:removedtoken",function(b){(b=a.food_changes_obj.attributes.mapped_meal_tags.findWhere({tag_name:b.attrs.value}))&&a.food_changes_obj.attributes.mapped_meal_tags.remove(b)})},loadMealTagTokens:function(){var a=this.food_changes_obj.attributes.mapped_meal_tags.pluck("tag_name");0<a.length&&this.tokenfield_selector.tokenfield("setTokens",a)}});
ETM.BasicFoodCuratorModalView=Backbone.View.extend({className:"modal fade",id:"basic_food_curator_modal",tagName:"div",parent:"#curator_modal_div",events:{"click #save_custom_food":"saveChanges","change #default_units select":"updateDefaultServingDescription","click #refresh_serving_size_selector":"updateListOfServingSizes",'click div[name="is_discrete"] .btn':"toggleDiscreteInput"},updateDefaultServingDescription:function(){this.form.commit({validate:!1});var a=this.food_changes_obj.attributes["gram_weight_"+
this.food_changes_obj.attributes.default_units+"_description"];$(".default_unit_text",this.el).html(a)},updateListOfServingSizes:function(){save_errors=this.form.commit({validate:!0});this.renderForm()},initialize:function(){this.ignore_macro_calorie_difference=this.restaurant_enabled=!1;this.food_id=null;this.$el.one("hidden.bs.modal",function(){ETM.basic_food_curator.undelegateEvents();ETM.basic_food_curator.close()})},render:function(){this.carbs=this.fats=this.proteins=this.form_calories=this.macro_calories=
null;this.$el.html(this.template());this.$el.modal({backdrop:"static",keyboard:!1,show:!0});this.renderForm();return this},toggleDiscreteInput:function(a){$(a.currentTarget).hasClass("active")||("true"==$("input",a.currentTarget).val()?$('input[name="minimum_discrete_amount"]',this.el).attr("disabled",!1):"false"==$("input",a.currentTarget).val()&&$('input[name="minimum_discrete_amount"]',this.el).attr("disabled",!0))},toggleTooltips:function(){$(".grams_per_serving_tooltip",this.el).tooltip({title:"<div class='text-left'>Enter the gram weight of a serving of the actual food. This will let you convert between grams and servings.<br/><br/>Conversions:<br/>1 oz = 28.35 g<br/>1 lb = 453.6 g<br/>1 tbsp = 15 g (liquid)<br/>1 tsp = 5 g (liquid)</div>",
html:!0,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div style="margin-left:-20px;margin-right:-20px;" class="tooltip-inner"></div></div>',animation:!0,placement:"top",delay:{show:100,hide:0}})},renderForm:function(){this.food_changes_obj.schema.default_units={type:"Select",value_type:"Number",options:[]};for(var a=0;9>a;a++)if(0<this.food_changes_obj.attributes["gram_weight_"+a+"_amount"]&&0<this.food_changes_obj.attributes["gram_weight_"+a+"_description"].length)this.food_changes_obj.schema.default_units.options.push({val:a,
label:this.food_changes_obj.attributes["gram_weight_"+a+"_amount"]+" "+this.food_changes_obj.attributes["gram_weight_"+a+"_description"]});else break;this.form=(new Backbone.Form({model:this.food_changes_obj,template:Helper.createTemplateFunction($("#basicFoodForm",this.el).html())})).render();$(".basic_food_changes_form",this.el).html(this.form.el);a=this.food_changes_obj.attributes["gram_weight_"+this.food_changes_obj.attributes.default_units+"_description"];$(".default_unit_text",this.el).html(a);
!0===this.food_changes_obj.attributes.is_discrete?$('input[name="minimum_discrete_amount"]',this.el).attr("disabled",!1):$('input[name="minimum_discrete_amount"]',this.el).attr("disabled",!0);$(".review_complete",this.el).prop("checked",this.food_changes_obj.attributes.review_complete)},loadFoodChanges:function(a,b,c){if(!0!=ETM.current_user_profile.get("is_staff"))return!1;this.original_food_object=a;var d=a.clone();if(b||c)e=new ETM.FoodChanges(c.toJSON()),e.attributes.gram_weight_0=100,e.attributes.gram_weight_0_amount=
100,e.attributes.gram_weight_0_description="grams";else for(var e=new ETM.FoodChanges(a.attributes.food.toJSON()),f=0;f<e.attributes.weights.length;f++){var g=e.attributes.weights[f];e.attributes["gram_weight_"+f]=g.grams;e.attributes["gram_weight_"+f+"_amount"]=g.amount;e.attributes["gram_weight_"+f+"_description"]=g.description}e.attributes.food_id=a.attributes.food.attributes.id;b&&(ETM.current_user_profile.get("user_id")===e.attributes.user_id||is_superuser)?e.url=ROOT+"/foodchanges/"+c.get("id")+
"/":(Helper.clearIDs(e),e.url=function(){return ROOT+"/foodchanges/"});this.model=d;this.food_changes_obj=e},scrapeFields:function(){this.food_changes_obj.attributes.review_complete=$(".review_complete",this.el).is(":checked");return this.food_changes_obj},saveChanges:function(){var a=this,b=this.form.commit({validate:!0}),c=this.scrapeFields();if("undefined"===typeof b)$(".recipe_save_spinner",this.el).show(),$("#save_custom_food",this.el).prop("disabled",!0),_.has(c.attributes,"reviewer")&&null!=
c.attributes.reviewer||(c.attributes.reviewer=ETM.curator_view.curator_profile.id),delete c.attributes.changes,delete c.attributes.images,delete c.attributes.date_created,delete c.attributes.date_last_updated,c.save({},{success:function(b,c,d){a.original_food_object.attributes.food.fetch({success:function(){a.original_food_object.trigger("modalUpdated")}});a.$el.modal("hide")},error:function(b,c,d){$(".recipe_save_spinner",a.el).hide();$("#save_custom_food",a.el).prop("disabled",!1);console.log("failed to save food changes :(");
$(".modal-footer").append('<div class="alert alert-danger recipe_validation_error" style="float:left">Failed to save food.</div>')}});else for(var d in b)b.hasOwnProperty(d)&&$('[data-editors="'+d+'"]').append('<div class="alert alert-danger recipe_validation_error" style="float:left">'+b[d].message+"</div>")}});
ETM.FoodBrowserView=ETM.SidebarView.extend({applyEvents:function(){var a=this;this.listenTo(this.model,"reset",function(){this.render()},this);this.listenTo(this.model,"add",function(b){b=(new ETM.MealObjectView({model:b})).render();a.meal_views.push(b);a.$el.append(b.el)})},render:function(){var a=this;this.$el.empty();_.each(this.model.models,function(b){b=(new ETM.MealObjectView({model:b})).render();a.meal_views.push(b);a.$el.append(b.el)},this);return this}});
ETM.analytics={logRegenerate:function(a){dates=JSON.parse(a.regenerate_weeks);a={next_week:!0,this_week:!0};if(2!=dates.length){var b=(new Date).toJSON().split("T")[0],c=dates[0].split(",");Date.parse(b)<Date.parse(c[0])?a.this_week=!1:a.next_week=!1}"/"==window.location.pathname?amplitude.logEvent("regenerate_week_planner",a):"/settings/weekly-planner-layout/"==window.location.pathname?amplitude.logEvent("regenerate_week_weekly_settings",a):amplitude.logEvent("app_regenerate_week",a)},logRecipeImport:function(a){a=
{full_url:a,domain:extractRootDomain(a)};amplitude.logEvent("recipe_import_started",a)},logImportedRecipeSave:function(a){a={full_url:a,domain:extractRootDomain(a)};amplitude.logEvent("recipe_import_saved",a)},logGenerate:function(a,b,c){amplitude.logEvent("generate_diet",{starting_calories:a.calories,starting_carbs:a.carbs,starting_fats:a.fats,starting_proteins:a.proteins,ending_calories:b.stats.calories,ending_carbs:b.stats.carbs,ending_fats:b.stats.fats,ending_proteins:b.stats.proteins,number_meals:b.attributes.num_meals})},
logFoodRefresh:function(a,b,c){amplitude.logEvent("food_refresh");if(ETM.is_logged_in){var d={previous_food:{},new_food:{},other_meal_foods:[]};d.previous_food[a.attributes.food.attributes.id]=a.attributes.amount;d.new_food[b.attributes.food.attributes.id]=b.attributes.amount;c&&c.attributes.foods.each(function(a){a.attributes.food.attributes.id in d.previous_food||d.other_meal_foods.push(a.attributes.food.attributes.id)});d.meal=parseIdFromResourceURI(a.attributes.meal);d.previous_food=JSON.stringify(d.previous_food);
d.new_food=JSON.stringify(d.new_food);d.other_meal_foods=JSON.stringify(d.other_meal_foods);$.ajax({url:"/analytics/food_refresh/",data:d,type:"POST",error:function(a,b,c){console.log("Ajax error logging food refresh "+b)}})}},logInstacartOpenModal:function(){googleanalytics("send","event","instacart","click","open_modal")},logInstacartClick:function(){var a=0,b=0;ETM.groceries_and_pantry.grocery_list.each(function(c){b++;a+=c.stats.price});googleanalytics("send","event","instacart","click","num_items",
b);googleanalytics("send","event","instacart","click","est_cost",a)},logFoodRefreshLeftovers:function(a,b,c){if(ETM.is_logged_in)try{amplitude.logEvent("food_refresh_leftovers");var d={};a.attributes.is_leftovers?(null!=b.makes_leftovers_for&&b.makes_leftovers_for.forEach(function(c){meal_id=parseIdFromResourceURI(c.meal);d[meal_id]={};d[meal_id].previous_food={};d[meal_id].previous_food[a.attributes.food.attributes.id]=a.attributes.amount;d[meal_id].new_food={};d[meal_id].new_food[b.food.id]=c.amount}),
c||(meal_id=parseIdFromResourceURI(b.meal),d[meal_id]={},d[meal_id].previous_food={},d[meal_id].previous_food[a.attributes.food.attributes.id]=a.attributes.uses_leftovers_from.attributes.amount,d[meal_id].new_food={},d[meal_id].new_food[b.food.id]=b.amount)):(null!=a.attributes.makes_leftovers_for&&a.attributes.makes_leftovers_for.forEach(function(a){meal_id=parseIdFromResourceURI(a.attributes.meal);d[meal_id]={};d[meal_id].previous_food={};d[meal_id].previous_food[a.attributes.food.attributes.id]=
a.attributes.amount;d[meal_id].new_food={};null!=b.makes_leftovers_for&&b.makes_leftovers_for.forEach(function(a){parseIdFromResourceURI(a.meal)==meal_id&&(d[meal_id].new_food[a.food.id]=a.amount)})}),c||(meal_id=parseIdFromResourceURI(b.meal),d[meal_id]={},d[meal_id].previous_food={},d[meal_id].previous_food[a.attributes.food.attributes.id]=a.attributes.amount,d[meal_id].new_food={},d[meal_id].new_food[b.food.id]=b.amount));$.each(d,function(a,b){var c={};c.meal=a;c.previous_food=JSON.stringify(b.previous_food);
c.new_food=JSON.stringify(b.new_food);c.refreshed_leftovers=!0;$.ajax({url:"/analytics/food_refresh/",data:c,type:"POST",error:function(a,b,c){console.log("Ajax error logging leftovers refresh "+b)}})})}catch(e){}},logMealRefresh:function(a,b,c){amplitude.logEvent("meal_refresh");if(ETM.is_logged_in){var d={};d.previous_foods=a;d.new_foods={};b.attributes.foods.each(function(a){d.new_foods[a.attributes.food.attributes.id]=a.attributes.amount});d.meal=parseIdFromResourceURI(b.id);d.previous_foods=
JSON.stringify(d.previous_foods);d.new_foods=JSON.stringify(d.new_foods);switch(c){case ETM.MAP_SEARCH_MEAL_CHOSEN:case ETM.ALTERNATE_MEAL_CHOSEN:d.user_chosen_meal_type=c}$.ajax({url:"/analytics/meal_refresh/",data:d,type:"POST",error:function(a,b,c){console.log("Ajax error logging meal refresh "+b)}})}},changeNumMeals:function(){},logEatenMeal:function(a,b){a.attributes.eaten?amplitude.logEvent("log_meal_eaten"):amplitude.logEvent("unlog_meal_eaten");var c={};c.eaten=a.attributes.eaten;c.meal_id=
a.attributes.id;c.food_ids=[];a.attributes.foods.each(function(a){c.food_ids.push(a.attributes.food.attributes.id)});c.food_ids=JSON.stringify(c.food_ids);$.ajax({url:"/analytics/eaten_meal/",data:c,type:"POST",error:function(a,b,c){console.log("Ajax error logging eaten meal "+b)}})},logSwapMeal:function(a,b){$.ajax({url:"/analytics/swap_meal/",data:{orig_meal_id:a,swap_meal_id:b},type:"POST",error:function(a,b,e){console.log("Ajax error logging swapped meal "+b)}})}};
function parseIdFromResourceURI(a){return"string"===typeof a?(a=/\/\w+\/(\d+)/.exec(a),null!=a&&2==a.length?a[1]:!1):a}function extractRootDomain(a){a=extractHostname(a);var b=a.split("."),c=b.length;2<c&&(a=b[c-2]+"."+b[c-1]);return a}function extractHostname(a){a=-1<a.indexOf("://")?a.split("/")[2]:a.split("/")[0];a=a.split(":")[0];return a=a.split("?")[0]}
ETM.BlockedFood=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/blockedfood/",initialize:function(){Backbone.AssociatedModel.prototype.initialize.call(this);this.attributes.food_resource_uri="string"==typeof this.attributes.food?this.attributes.food:this.attributes.food.attributes.resource_uri},toJSONFull:function(){var a=Backbone.AssociatedModel.prototype.toJSONFull.apply(this,arguments);if("string"===typeof a.food||a.food instanceof String){var b=ETM.food_info_object_list.get(a.food);null!=b&&(a.food=
b.toJSONFull())}return a}});
ETM.BlockedFoodList=Backbone.Collection.extend({model:ETM.BlockedFood,url:ROOT+"/blockedfood/",loadFoodInfoObjects:function(){var a=$.Deferred(),b=this,c=[];this.forEach(function(a){c.push(a.attributes.food)});ETM.food_info_object_list.addAndFetchMissing(c,function(){b.listenTo(b,"add",function(a){ETM.food_info_object_list.get(a.attributes.food).trigger("addBlock")},this);b.listenTo(b,"remove",function(a){ETM.food_info_object_list.get(a.attributes.food).trigger("removeBlock")},this);a.resolve()});
return a.promise()}});ETM.CalendarDiet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/calendar/",relations:[{type:Backbone.One,key:"diet",relatedModel:"ETM.Diet",customSerialize:function(a){return null==a.attributes.resource_uri?a:a.attributes.resource_uri}}],initializeEvents:function(){var a=this;this.stopListening();null!=this.attributes.diet&&this.listenTo(this.attributes.diet,"deleteCalendarDiet",function(){delete ETM.calendar_list.date_index[a.attributes.date];a.destroy()})}});
ETM.CalendarDietList=Backbone.Collection.extend({url:ROOT+"/calendar/",model:ETM.CalendarDiet,buffer_range:7,selected_index:3,comparator:function(a){return Helper.parseDateString(a.get("date")).getTime()},initialize:function(a,b){this.date_index={};this.selected_date=b.selected_date;this.invalidate_selected_date=!1},hasDateString:function(a){return _.has(this.date_index,a)},getCarouselDateList:function(){for(var a=this.buffer_range-(this.selected_index+1),b=addDays(this.selected_date,-1*this.selected_index),
a=addDays(this.selected_date,a),c=[];b<=a;b.setDate(b.getDate()+1))c.push(new Date(b));return c},getDietsFromStartAndEndDate:function(a,b,c){var d=this,e=[],f=0;for(a=new Date(a.getTime());a<=b&&1E3>f;a.setDate(a.getDate()+1)){var g=Helper.convertDateToString(a);_.has(this.date_index,g)||e.push(g);f++}if(0<e.length)return this.updateDietIndex("starting_download",e),b=e.join(","),this.fetch({remove:!1,data:{date__in:b},success:function(a,b,f){d.updateDietIndex("add_list",e);null!=c&&c(a)}});null!=
c&&c(this)},getDownloadedCalendarDiet:function(a){a=Helper.convertDateToString(a);return this.date_index[a]},getCalendarDietData:function(a,b){var c=this,d=Helper.convertDateToString(a);_.has(this.date_index,d)&&"generating"!==this.date_index[d]&&"downloading"!==this.date_index[d]?b(this.date_index[d]):(this.updateDietIndex("starting_download",[d]),this.fetch({remove:!1,data:{date__in:d},success:function(a,f,g){c.updateDietIndex("add_list",[d]);b&&"undefined"!=typeof b&&b(c.date_index[d])}}))},getCalendarDietsData:function(a,
b){var c=this;if(0<a.length){this.updateDietIndex("starting_download",a);var d=a.join(",");return this.fetch({remove:!1,data:{date__in:d},success:function(d,f,g){c.updateDietIndex("add_list",a);null!=b&&b(d)}})}null!=b&&b()},getCalendarDiet:function(a,b){var c=this,d=Helper.convertDateToString(a);if(_.has(this.date_index,d))return this.date_index[d];this.updateDietIndex("starting_download",[d]);this.fetch({remove:!1,data:{date__in:d},success:function(a,f,g){c.updateDietIndex("add_list",[d]);b&&"undefined"!=
typeof b&&b(a)}});return"downloading"},getCalendarDietWithBuffer:function(a,b){var c=this.buffer_range-(this.selected_index+1),d=addDays(a,-1*this.selected_index),c=addDays(a,c);this.getDietsFromStartAndEndDate(d,c,b);return _.has(this.date_index,Helper.convertDateToString(a))?this.date_index[Helper.convertDateToString(a)]:"downloading"},regenerateWeeks:function(a){a.reset_groceries&&ETM.groceries_and_pantry&&(ETM.groceries_and_pantry.grocery_list&&ETM.groceries_and_pantry.grocery_list.reset([],{silent:!0}),
ETM.groceries_and_pantry.listenToWeeklyPlannerComplete());this.clearDietsForGenerating(a.regenerate_weeks);this.listenToWeeklyPlannerComplete()},listenToWeeklyPlannerComplete:function(){var a=this;this.listenToOnce(ETM.generator_status,"finishedWeeklyPlanner",function(b){var c=Object.keys(a.date_index);_.each(c,function(b){"generating"===a.date_index[b]?delete a.date_index[b]:"object"===typeof a.date_index[b]&&a.date_index[b].attributes.currently_generating&&delete a.date_index[b]});"SUCCESS"===b&&
a.getCalendarDietWithBuffer(a.selected_date,function(){ETM.generator_status.trigger("updateCarousel");ETM.generator_status.trigger("finishedWeeklyPlannerAndDownloadedNewDiet")})})},clearDietsForGenerating:function(a){var b=this;a.forEach(function(a){var d=a.split(",");a=d[0].split("-");var d=d[1].split("-"),d=new Date(d[0],d[1]-1,d[2]),e=0;for(a=new Date(a[0],a[1]-1,a[2]);a<=d&&1E3>e;a.setDate(a.getDate()+1)){var f=Helper.convertDateToString(a);b.date_index.hasOwnProperty(f)&&"object"===typeof b.date_index[f]&&
b.remove(b.date_index[f],{silent:!0});b.date_index[f]="generating";b.trigger(f,"generating");Helper.convertDateToString(b.selected_date)===f&&_.has(b,"view")&&b.view.loadAndRenderAppropriateView();e++}})},reloadDietsInDateList:function(a,b){var c=this,d=[];a.forEach(function(a){"object"===typeof c.date_index[a]&&c.remove(c.date_index[a],{silent:!0});d.push(a);Helper.convertDateToString(c.selected_date)===a&&_.has(c,"view")&&c.view.loadAndRenderAppropriateView()});if(0<d.length){this.updateDietIndex("starting_download",
d);var e=d.join(",");return this.fetch({remove:!1,data:{date__in:e},success:function(a,e,h){c.updateDietIndex("add_list",d);b&&"undefined"!=typeof b&&b()}})}},loadInitialDiets:function(a){this.getCalendarDietWithBuffer(this.selected_date,a)},getCurrentDiet:function(a){return this.getCalendarDiet(this.selected_date,a)},updateDietIndex:function(a,b){if("add_list"===a)for(var c=0;c<b.length;c++){var d=b[c],e=this.findWhere({date:d});e?e.attributes.currently_generating?(this.date_index[d]="generating",
this.trigger(d,"generating")):(this.date_index[d]=e,ETM.diet_list.add(e.attributes.diet),this.trigger(d,e)):(this.date_index[d]="blank",this.trigger(d,"blank"));Helper.convertDateToString(this.selected_date)===d&&_.has(this,"view")&&this.view.loadAndRenderAppropriateView()}else if("starting_download"===a)for(c=0;c<b.length;c++)d=b[c],this.date_index[d]="downloading"},addCalendarDiet:function(a){this.date_index[Helper.convertDateToString(this.selected_date)]=a;a.save()}});
var mapNutritionProfile=function(a){if(_.isObject(a))return a;var b=ETM.nutrition_profile_list;return(b=b&&b.find(function(b){return b.get(b.idAttribute)===a}))?b:{}},currently_generated_diet;
ETM.Diet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/diet/",defaults:{title:"My meal plan",num_meals:3,date_added:null,user:null,diet_key:null,sandbox:0,nutrition_profile:null},relations:[{type:Backbone.Many,key:"meals",relatedModel:"ETM.MealObject",collectionType:"ETM.MealList",customSerialize:function(a){if(!a.diet.update_nutrition_profile)return a.models.slice(0,a.diet.attributes.num_meals)}},{type:Backbone.One,key:"nutrition_profile",relatedModel:"ETM.NutritionProfile",map:mapNutritionProfile,
customSerialize:function(a){return null!=a.attributes.resource_uri?a.attributes.resource_uri:a}},{type:Backbone.One,key:"user",relatedModel:"ETM.UserProfile",isTransient:!0}],initialize:function(){this.is_diet_set=!1;this.attributes.user||(this.attributes.user=new ETM.UserProfile,ETM.user_profiles_list.add(this.attributes.user));if(!this.attributes.nutrition_profile){var a=ETM.nutrition_profile_list.findWhere({title:"My Nutrition Targets"});a||(a=ETM.nutrition_profile_list.findWhere({deleted:!1}),
a||(a=new ETM.NutritionProfile,ETM.nutrition_profile_list.add(a),0==this.attributes.sandbox&&a.save(null,{async:!1,validate:!1})));this.attributes.nutrition_profile=a}"undefined"==typeof this.attributes.meals&&(this.attributes.meals=new ETM.MealList,0==this.attributes.sandbox&&this.attributes.meals.createMealsIfNeeded());this.attributes.meals.diet=this;this.initializeEvents();this.calculateStats()},initializeEvents:function(){var a=this;this.listenTo(this,"deleteDiet",function(){this.attributes.meals.forEach(function(a){a.set("delete_other_foods",
!0);a.get("foods").reset()});this.save(null,{success:function(a){a.attributes.meals.each(function(a){delete a.attributes.delete_other_foods;delete a.attributes.delete_other_foods_except_leftovers})}})},this);this.listenTo(this,"updateStats:meals",function(b,c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"remove:meals",function(b,c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"add:meals",function(b,c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,
"change:num_meals",function(){a.createMealsIfNeeded();a.calculateStats();a.trigger("updateStats")})},createMealsIfNeeded:function(){var a=this.get("num_meals"),b=this.get("meals"),c=b.length;if(c<a){_errs.meta.adding_meals=a-c;var d=ETM.meal_type_list.findWhere({title:"Snack"});"undefined"===typeof d&&(d=new ETM.MealType,d.attributes.title="Snack",d.attributes.max_cooktime=0,d.attributes.max_preptime=15,d.attributes.max_totaltime=15,d.attributes.size_slider=75,ETM.meal_type_list.add(d),d.save(null,
{async:!1}));for(c+=1;c<=a;c++){var e=new ETM.MealObject({meal_number:c-1,meal_type:d,diet_plan:this.id});b.add(e)}this.save({num_meals:this.get("meals").length},{async:!1})}else this.save({num_meals:a},{patch:!0,async:!1})},numberLockedMeals:function(){for(var a=0,b=0;b<this.attributes.num_meals;b++)this.meal(b).isLocked()&&a++;return a},meal:function(a){return this.attributes.meals.at(a)},loadDiet:function(a,b,c){var d=this,e=ROOT+"/diet/"+a+"/";d.id=e;d.attributes.id=a;d.attributes.resource_uri=
e;d.fetch({reset:!0,silent:!0,success:function(){d.attributes.sandbox=0;Helper.clearIDs(d);d.attributes.meals.each(function(a){Helper.clearIDs(a);a.attributes.foods.each(function(a){Helper.clearIDs(a)})});d.save(null,{success:function(){b()},error:function(a,b,d){c(b)}})},error:function(a,b,d){c(b)}})},generate:function(a){var b=this;googleanalytics("send","event","button","click","generate_diet");var c=b.stats&&b.stats.calories&&0<b.stats.calories?$.extend({},b.stats):{calories:0,carbs:0,fats:0,
proteins:0},d=b.attributes.meals.clone();try{ETM.food_pool.loadFoodPool(b,function(){var e=function(){ETM.currently_generating=!0;Generator.run(b,function(e){b.updateDietAfterGenerating();ETM.use_local_storage&&Helper.resetLocalFoodInfoIDs(ETM.current_diet);b.calculateStats();ETM.currently_generating=!1;b.trigger("finishedGenerating");ETM.analytics.logGenerate(c,b,d);_errs.meta.update_nutrition_profile=b.update_nutrition_profile;_errs.meta.meals_null=null==b.toJSON().meals;null!=a&&b.save(null,{success:function(c,
d,e){b.attributes.meals.each(function(a){delete a.attributes.delete_other_foods;delete a.attributes.delete_other_foods_except_leftovers});b.attributes.meals.forEach(function(a){if(null==a.attributes.resource_uri||null==a.attributes.id)_errs.meta.meal_json=JSON.stringify(a),_errs.meta.response=JSON.stringify(d),_errs.meta.response_status=e.xhr.status,_errs.meta.response_status_text=e.xhr.statusText,_errs.push(Error("Meal obj missing resource uri or id"));a.attributes.foods.forEach(function(a){if(null==
a.attributes.resource_uri||null==a.attributes.id)_errs.meta.food_json=JSON.stringify(a),_errs.meta.response=JSON.stringify(d),_errs.meta.response_status=e.xhr.status,_errs.meta.response_status_text=e.xhr.statusText,_errs.push(Error("Food obj missing resource uri or id"))})});a(b.toJSONFull())}})})},g=b.findFoodWithLeftovers();!1!==g?ETM.notifications.showRefreshLeftoversInfo(function(){g.shuffleFood(e,!0)}):!1!==b.findFoodThatIsLeftovers()?ETM.notifications.showRefreshLeftoversInfo(function(){e()}):
e()},a)}catch(e){console.log(e),b.trigger("finishedGenerating")}},returnDietObjectClassic:function(){var a=new DietObject;a.num_meals=this.attributes.num_meals;for(var b=0;b<this.attributes.num_meals;b++){var c=this.attributes.meals.at(b).attributes.foods.toListIdJSON();c.forEach(function(a){a.locked=!0==a.is_leftovers||!0==a.has_leftovers;a.leftovers=!0==a.is_leftovers||!0==a.has_leftovers});c.forEach(function(c){a["meal_"+b].foods.push(ETM.food_pool.convertFoodObject(c))})}return a},findLeftoversFoodObject:function(a,
b){for(var c=!1,d=0;d<this.attributes.num_meals;d++){for(var e=this.attributes.meals.at(d).attributes.foods.models,f=0;f<e.length;f++){var g=e[f];if(b==g.attributes.food.attributes.id&&(a&&g.attributes.is_leftovers||!a&&g.attributes.has_leftovers)){c=g;break}}if(c)break}return c},findFoodWithLeftovers:function(a){a=a||!0;if(!ETM.is_premium)return!1;for(var b=0;b<this.attributes.num_meals;b++){var c=this.attributes.meals.at(b);if(!c.attributes.eaten||!a)for(var c=c.attributes.foods.models,d=0;d<c.length;d++){var e=
c[d];if(e.attributes.has_leftovers)return e}}return!1},findFoodThatIsLeftovers:function(){if(!ETM.is_premium)return!1;for(var a=0;a<this.attributes.num_meals;a++)for(var b=this.attributes.meals.at(a).attributes.foods.models,c=0;c<b.length;c++){var d=b[c];if(d.attributes.is_leftovers)return d}return!1},findFoodObject:function(a){for(var b=0;b<this.attributes.num_meals;b++)for(var c=this.attributes.meals.at(b).attributes.foods.models,d=0;d<c.length;d++){var e=c[d];if(a==e.attributes.id)return e}return!1},
combineUnlocked:function(){for(var a=0;a<this.attributes.num_meals;a++){for(var b=[],c=this.meal(a).attributes.foods;0<c.length;){for(var d=0,e=c.shift({silent:!0}),f=0;f<b.length;f++){var g=b[f];if(e.attributes.food.attributes.id===g.attributes.food.attributes.id&&!1===e.isLocked()&&!1==g.isLocked()&&e.attributes.units===g.attributes.units){g.attributes.amount+=e.attributes.amount;d=1;break}}0===d&&b.push(e)}this.meal(a).attributes.foods.reset(b,{silent:!0})}},randomGeneratorMealOrder:function(a){for(var b=
[],c=[],d=0;d<this.attributes.num_meals;d++)!1===this.meal(d).isLocked()&&(0<a["meal_"+d].side_dishes.length||0<a["meal_"+d].main_dishes.length)&&(this.meal(d).attributes.meal_type.attributes.only_use_recurring?b.push(d):c.push(d));a=shuffle(b).concat(shuffle(c));return a.concat(a).concat(a)},clearMeal:function(a){a=this.meal(a);if(!a.isLocked()){var b=[];a.attributes.foods.forEach(function(a){a.isLocked()||b.push(a)});0<b.length&&a.attributes.foods.remove(b,{silent:!0})}},clearMealIncludingLocked:function(a){this.meal(a).attributes.foods.reset([],
{silent:!0})},clearMealExceptLeftovers:function(a){a=this.meal(a);var b=[];a.attributes.foods.forEach(function(a){a.attributes.is_leftovers||a.attributes.has_leftovers||b.push(a)});0<b.length&&a.attributes.foods.remove(b,{silent:!0})},addRecurringLockedFoods:function(a){var b=this,c=this.meal(a).attributes.meal_type,d=[];ETM.recurring_foods_list.byMealType(c.id).models.forEach(function(a){1==a.attributes.frequency&&_.has(a.attributes,"amount")&&_.has(a.attributes,"units")&&(a=new ETM.FoodObject({food:a.attributes.food,
amount:a.attributes.amount,units:a.attributes.units}),a.is_recurring_always=!0,d.push(a))});d.forEach(function(c){b.meal(a).attributes.foods.add(c,{silent:!0})});return!1},updateMealFromClassicDietObject:function(a,b,c){a=a["meal_"+b].foods;var d=ETM.current_diet.attributes.meals.findWhere({meal_number:b}),e=[];b=d.attributes.foods.models;for(var f=[],g=0;g<b.length;g++){var h=b[g];(h.attributes.is_leftovers||h.attributes.has_leftovers)&&f.push(h)}a.forEach(function(a){!0!==a.leftovers&&(delete a.list_id,
delete a.weight,delete a.main_dish,delete a.side_dish,delete a.is_recurring,delete a.leftovers,delete a.id,a=new ETM.FoodObject(a),a.attributes.meal=d.attributes.resource_uri,e.push(a))});"undefined"!==typeof c&&!0===c?d.set("delete_other_foods",!0):d.set("delete_other_foods_except_leftovers",!0);c=f.concat(e);d.get("foods").reset(c,{silent:!0});d.calculateStats();ETM.use_local_storage&&Helper.resetLocalFoodInfoIDs(ETM.current_diet)},updateFromClassicDietObject:function(a){ETM.use_local_storage&&
(Helper.deleteLocalStorageKeysWithPrefix("/api/v1/meal/"),this.attributes.meals.each(function(a){a.save()}));for(var b=0;b<ETM.current_diet.attributes.num_meals;b++)this.updateMealFromClassicDietObject(a,b)},updateMealAfterGenerating:function(a,b){var c=this.meal(a);c.attributes.foods.models.forEach(function(a){a.attributes.meal=c.attributes.resource_uri});c.attributes.eaten||("undefined"!==typeof b&&!0===b?c.set("delete_other_foods",!0):c.set("delete_other_foods_except_leftovers",!0));c.calculateStats();
ETM.use_local_storage&&Helper.resetLocalFoodInfoIDs(ETM.current_diet)},updateDietAfterGenerating:function(){ETM.use_local_storage&&(Helper.deleteLocalStorageKeysWithPrefix(ETM.MealObject.prototype.urlRoot),this.attributes.meals.each(function(a){a.save()}));for(var a=0;a<ETM.current_diet.attributes.num_meals;a++)this.updateMealAfterGenerating(a)},updateMeals:function(){var a=this;this.get("meals").each(function(b,c){b.set({meal_number:c,diet_plan:a.id})})},calculateStats:function(){var a=this;a.stats=
{};ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0});this.attributes.meals.each(function(b,c){c>=a.get("num_meals")||ETM.NUTRIENT_LIST.forEach(function(c){a.stats[c]+=b.stats[c]})})},calculateAllStats:function(){var a=this;a.stats={};ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0});this.attributes.meals.each(function(b,c){c>=a.get("num_meals")||(b.calculateStats(),ETM.NUTRIENT_LIST.forEach(function(c){a.stats[c]+=b.stats[c]}))})},returnDietStatsWithoutMeal:function(a){var b=this;stats={};ETM.NUTRIENT_LIST.forEach(function(a){stats[a]=
0});this.attributes.meals.each(function(c,d){d>=b.get("num_meals")||c.attributes.meal_number===a||(c.calculateStats(),ETM.NUTRIENT_LIST.forEach(function(a){stats[a]+=c.stats[a]}))});return stats},dietStatsMatchTargets:function(){var a=this.attributes.nutrition_profile.attributes.calories,b=this.stats.calories;if(0.2<Math.abs(b-a)/a)return!1;if("grams"==this.attributes.nutrition_profile.attributes.macro_scheme){var b=this.attributes.nutrition_profile.attributes.min_proteins,a=this.attributes.nutrition_profile.attributes.max_proteins,
c=this.attributes.nutrition_profile.attributes.min_fats,d=this.attributes.nutrition_profile.attributes.max_fats,e=this.attributes.nutrition_profile.attributes.min_carbs,f=this.attributes.nutrition_profile.attributes.max_carbs,g=this.stats.proteins,h=this.stats.fats,l=this.stats.carbs;if(g<b&&0.2<(b-g)/b||g>a&&0.2<(g-a)/a||h<c&&0.2<(c-h)/c||h>d&&0.2<(h-d)/d||l<e&&0.2<(e-l)/e||l>f&&0.2<(l-f)/f)return!1}else if(a=this.attributes.nutrition_profile.attributes.percent_fats,c=this.attributes.nutrition_profile.attributes.percent_carbs,
d=900*this.stats.fats/b,e=400*this.stats.carbs/b,20<Math.abs(400*this.stats.proteins/b-this.attributes.nutrition_profile.attributes.percent_proteins)||20<Math.abs(d-a)||20<Math.abs(e-c))return!1;return!0},printMealsAndFoods:function(){this.attributes.meals.each(function(a,b){console.log("meal "+b+" : "+a.attributes.resource_uri);a.attributes.foods.each(function(a,b){console.log("food "+b+" : "+a.attributes.resource_uri);console.log(a)});console.log("----")})},getNumberOfActiveMeals:function(){return Math.min(this.attributes.num_meals,
this.attributes.meals.size())}});ETM.DietList=Backbone.Collection.extend({url:ROOT+"/dietlist/",model:ETM.Diet,comparator:function(a){return-1*moment(a.get("date_added")).valueOf()}});ETM.DietPlanSetDietList=Backbone.Collection.extend({url:ROOT+"/dietlist/",model:ETM.Diet});var mapDiet=function(a){if(_.isObject(a))return a;var b=new ETM.Diet({user:{},nutrition_profile:{},meals:{}});b.id=a;b.fetch({async:!1});return b};
ETM.SelectedDiet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/selecteddiet/",defaults:{diet:null},relations:[{type:Backbone.One,key:"diet",relatedModel:"ETM.Diet",collectionType:"ETM.DietList",map:mapDiet,customSerialize:function(a){return null==a.attributes.resource_uri?a:a.attributes.resource_uri}}],initialize:function(){var a=this;a.attributes.diet||(a.attributes.diet=new ETM.Diet,a.attributes.diet.save(null,{async:!1}));this.listenTo(this.attributes.diet,"dietLoad",function(){a.save()})}});
ETM.SelectedDietList=Backbone.Collection.extend({url:ROOT+"/selecteddiet/",model:ETM.SelectedDiet,initialize:function(a,b){}});function roundNumber(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)}
ETM.DietPlanSet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/publicdietset/",url:function(){var a=this.userIsOwner()?"fulldietset":"publicdietset";return ROOT+"/"+a+"/"+this.attributes.diet_key+""+this.attributes.id+"/"},userIsOwner:function(){return this.attributes.diet_set_owner_username===ETM.current_user_profile.attributes.username},relations:[{type:Backbone.Many,key:"diets",relatedModel:"ETM.Diet",collectionType:"ETM.DietPlanSetDietList"}],initialize:function(){this.selected_plan=null;this.listenTo(this,
"sync",function(a){a.attributes.diets.each(function(a){a.is_diet_set=!0})})},getSelectedDiet:function(){return null!=this.selected_plan?this.getDietFromID(this.selected_plan):!1},getSelectedDietIndex:function(){return this.getIndexFromID(this.selected_plan)},getDietFromID:function(a){return this.attributes.diets.findWhere({id:a})},getIndexFromID:function(a){for(var b=0;b<this.attributes.diets.length;b++)if(this.attributes.diets.models[b].attributes.id==a)return b;return-1},setInitialSelectedDiet:function(){this.selected_plan=
0<this.attributes.diets.length?this.attributes.diets.at(0).get("id"):null},setSelectedDietByIndex:function(a){var b=this.attributes.diets.length;this.selected_plan=0<b?b>a?this.attributes.diets.at(a).get("id"):this.attributes.diets.at(b-1).get("id"):null}});ETM.BasicDietPlanSet=Backbone.Model.extend({urlRoot:ROOT+"/dietplanset/",initialize:function(){this.on("change title",function(a,b){a.save(null,{patch:!0})})}});
ETM.BasicDietPlanSetList=Backbone.Collection.extend({url:ROOT+"/dietplanset/",model:ETM.BasicDietPlanSet,comparator:function(a){return-1*moment(a.get("created")).valueOf()}});ETM.Direction=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/directions/",sync:function(){return!1}});ETM.DirectionsList=Backbone.Collection.extend({model:ETM.Direction,url:ROOT+"/directions/",sync:function(){return!1}});
ETM.FavoriteFood=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/favoritefood/",initialize:function(){Backbone.AssociatedModel.prototype.initialize.call(this);this.attributes.food_resource_uri="string"==typeof this.attributes.food?this.attributes.food:this.attributes.food.attributes.resource_uri},toJSONFull:function(){var a=Backbone.AssociatedModel.prototype.toJSONFull.apply(this,arguments);if("string"===typeof a.food||a.food instanceof String){var b=ETM.food_info_object_list.get(a.food);null!=b&&
(a.food=b.toJSONFull())}return a}});
ETM.FavoriteFoodList=Backbone.Collection.extend({model:ETM.FavoriteFood,url:ROOT+"/favoritefood/",loadFoodInfoObjects:function(){var a=$.Deferred(),b=this,c=[];this.forEach(function(a){c.push(a.attributes.food)});ETM.food_info_object_list.addAndFetchMissing(c,function(){b.listenTo(b,"add",function(a){ETM.food_info_object_list.get(a.attributes.food).trigger("addFavorite")},this);b.listenTo(b,"remove",function(a){ETM.food_info_object_list.get(a.attributes.food).trigger("removeFavorite")},this);a.resolve()});
return a.promise()}});ETM.FoodImage=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/image/"});ETM.FoodImageList=Backbone.Collection.extend({urlRoot:ROOT+"/image/",model:ETM.FoodImage});
ETM.default_icons={recipes:{1:"/images/new_food_icons/kebab.png",2:"/images/new_food_icons/cinnamon_roll.png",3:"/images/new_food_icons/doughnut.png",4:"/images/new_food_icons/drink.png",5:"/images/new_food_icons/steak.png",6:"/images/new_food_icons/smoothie.png",7:"/images/new_food_icons/salad.png",8:"/images/new_food_icons/wrap.png",9:"/images/new_food_icons/spaghetti.png",10:"/images/new_food_icons/noodles.png",11:"/images/new_food_icons/salad.png",12:"/images/new_food_icons/bento.png",13:"/images/new_food_icons/kebab.png"},
basic_foods:{100:"/images/new_food_icons/milk_bottle.png",200:"/images/new_food_icons/salt.png",300:"/images/new_food_icons/baby_bottle.png",400:"/images/new_food_icons/bottle.png",500:"/images/new_food_icons/chicken.png",600:"/images/new_food_icons/noodles.png",700:"/images/new_food_icons/sausage.png",800:"/images/new_food_icons/cinnamon_roll.png",900:"/images/new_food_icons/strawberry.png",1E3:"/images/new_food_icons/sausage.png",1100:"/images/new_food_icons/carrot.png",1200:"/images/new_food_icons/soy.png",
1300:"/images/new_food_icons/steak.png",1400:"/images/new_food_icons/bottle.png",1500:"/images/new_food_icons/fish.png",1600:"/images/new_food_icons/soy.png",1700:"/images/new_food_icons/steak.png",1800:"/images/new_food_icons/bread.png",1900:"/images/new_food_icons/ice_cream.png",2E3:"/images/new_food_icons/spaghetti.png",2100:"/images/new_food_icons/hamburger.png",2200:"/images/new_food_icons/bento.png",2500:"/images/new_food_icons/cookie.png",3500:"/images/new_food_icons/food_basket.png",3600:"/images/new_food_icons/wrap.png"}};
ETM.icon_search={recipes:{1:[["shake smoothie","/images/new_food_icons/smoothie.png"],["bread","/images/new_food_icons/bread.png"],["kebab","/images/new_food_icons/kebab.png"]],2:[["egg omelet","/images/new_food_icons/egg.png"],["shake smoothie","/images/new_food_icons/smoothie.png"],["oatmeal porridge scramble","/images/new_food_icons/chopsticks.png"],["fruit","/images/new_food_icons/strawberry.png"],["bacon sausage","/images/new_food_icons/sausage.png"],["yogurt","/images/new_food_icons/milk_bottle.png"],
["salad","/images/new_food_icons/salad.png"],["pancake roll","/images/new_food_icons/cinnamon_roll.png"]],3:[["cake doughnut donut","/images/new_food_icons/doughnut.png"],["honey","/images/new_food_icons/honey.png"],["cream","/images/new_food_icons/ice_cream.png"]],4:[["drink","/images/new_food_icons/drink.png"]],5:[["fish halibut salmon cod tuna","/images/new_food_icons/fish.png"],["chicken cornish","/images/new_food_icons/chicken.png"],["beef steak sirloin roast","/images/new_food_icons/steak.png"]],
6:[["shake smoothie","/images/new_food_icons/smoothie.png"]],7:[["salad","/images/new_food_icons/salad.png"]],8:[["burger","/images/new_food_icons/hamburger.png"],["taco","/images/new_food_icons/taco.png"],["sandwich","/images/new_food_icons/sandwich.png"],["wrap burrito quesadilla","/images/new_food_icons/wrap.png"]],9:[["","/images/new_food_icons/spaghetti.png"]],10:[["","/images/new_food_icons/noodles.png"]],11:[["carrot","/images/new_food_icons/carrot.png"],["steak","/images/new_food_icons/steak.png"],
["pizza","/images/new_food_icons/pizza.png"],["burger","/images/new_food_icons/hamburger.png"],["taco","/images/new_food_icons/taco.png"],["wrap burrito quesadilla","/images/new_food_icons/wrap.png"],["fish halibut salmon cod tuna","/images/new_food_icons/fish.png"],["chicken cornish","/images/new_food_icons/chicken.png"],["beef steak sirloin roast","/images/new_food_icons/steak.png"],["sandwich","/images/new_food_icons/sandwich.png"],["","/images/new_food_icons/noodles.png"]],12:[["","/images/new_food_icons/bento.png"]],
13:[["","/images/new_food_icons/kebab.png"]]},basic_foods:{100:[["cheese","/images/new_food_icons/cheese.png"],["egg","/images/new_food_icons/egg.png"],["","/images/new_food_icons/milk_bottle.png"]],200:[["salt","/images/new_food_icons/salt.png"],["","/images/new_food_icons/pepper_shaker.png"]],300:[["","/images/new_food_icons/baby_bottle.png"]],400:[["","/images/new_food_icons/bottle.png"]],500:[["","/images/new_food_icons/chicken.png"]],600:[["","/images/new_food_icons/noodles.png"]],700:[["","/images/new_food_icons/sausage.png"]],
800:[["","/images/new_food_icons/chopsticks.png"]],900:[["avocado","/images/new_food_icons/avocado.png"],["strawberr blueberr","/images/new_food_icons/strawberry.png"],["watermelon","/images/new_food_icons/watermelon.png"],["tomato","/images/new_food_icons/tomato.png"],["apple","/images/new_food_icons/apple.png"],["pear","/images/new_food_icons/pear.png"],["grape","/images/new_food_icons/grape.png"],["lemon","/images/new_food_icons/lemon.png"],["","/images/new_food_icons/apple.png"]],1E3:[["","/images/new_food_icons/sausage.png"]],
1100:[["broccoli","/images/new_food_icons/broccoli.png"],["tomato","/images/new_food_icons/tomato.png"],["pepper","/images/new_food_icons/red_pepper.png"],["mushroom","/images/new_food_icons/mushroom.png"],["corn","/images/new_food_icons/corn.png"],["carrot","/images/new_food_icons/carrot.png"]],1200:[["peanut","/images/new_food_icons/peanut.png"],["flour","/images/new_food_icons/flour.png"],["hazel","/images/new_food_icons/hazelnut.png"]],1300:[["","/images/new_food_icons/steak.png"]],1400:[["",
"/images/new_food_icons/drink.png"]],1500:[["crab","/images/new_food_icons/crab.png"],["shrimp prawn","/images/new_food_icons/prawn.png"],["","/images/new_food_icons/fish.png"]],1600:[["soy","/images/new_food_icons/soy.png"],["peanut","/images/new_food_icons/peanut.png"],["flour","/images/new_food_icons/flour.png"],["","/images/new_food_icons/soy.png"]],1700:[["","/images/new_food_icons/steak.png"]],1800:[["","/images/new_food_icons/bread.png"]],1900:[["drink","/images/new_food_icons/smoothie.png"],
["donut doughnut cake","/images/new_food_icons/doughnut.png"],["sugar splenda aspartame","/images/new_food_icons/sugar.png"],["honey syrup","/images/new_food_icons/honey.png"],["","/images/new_food_icons/ice_cream.png"]],2E3:[["flour","/images/new_food_icons/flour.png"],["","/images/new_food_icons/spaghetti.png"]],2100:[["burger","/images/new_food_icons/fast_food.png"],["wrap","/images/new_food_icons/fast_food.png"],["","/images/new_food_icons/fast_food.png"]],2200:[["pizza","/images/new_food_icons/pizza.png"],
["burger sandwich","/images/new_food_icons/hamburger.png"],["","/images/new_food_icons/bento.png"]],2500:[["pretzel","/images/new_food_icons/pretzel.png"],["","/images/new_food_icons/cookie.png"]],3500:[["","/images/new_food_icons/bento.png"]],3600:[["","/images/new_food_icons/wrap.png"]]}};
RESTAURANT_LOGOS={Dennys:"/images/restaurant_logos/dennys_thumb.png","Starbucks Coffee":"/images/restaurant_logos/starbucks_thumb.png",Starbucks:"/images/restaurant_logos/starbucks_thumb.png","Subway Sandwiches":"/images/restaurant_logos/subway_thumb.png","Carl's Jr.":"/images/restaurant_logos/carls_jr_thumb.png","Chipotle Mexican Grill":"/images/restaurant_logos/chipotle_thumb.png","Panda Express":"/images/restaurant_logos/panda_express_thumb.png",Sbarro:"/images/restaurant_logos/sbarro_thumb.png",
"Taco Bell":"/images/restaurant_logos/taco_bell_thumb.png","Arby's":"/images/restaurant_logos/arbys_thumb.png","Olive Garden":"/images/restaurant_logos/olive_garden_thumb.png","Tim Hortons":"/images/restaurant_logos/tim_hortons_thumb.png","McDonald's":"/images/restaurant_logos/mcdonalds_thumb.png","Wendy's":"/images/restaurant_logos/wendys_thumb.png",IHOP:"/images/restaurant_logos/ihop_thumb.png","Pita Pit":"/images/restaurant_logos/pita_pit_thumb.png","Jimmy John's":"/images/restaurant_logos/jimmy_johns_thumb.png",
"Applebee's":"/images/restaurant_logos/applebees_thumb.png","Panera Bread":"/images/restaurant_logos/panera_thumb.png","Burger King":"/images/restaurant_logos/burger_king_thumb.png","In-N-Out":"/images/restaurant_logos/innout_thumb.png","IN-N-OUT Burger":"/images/restaurant_logos/innout_thumb.png","Jack in the Box":"/images/restaurant_logos/jackinthebox_thumb.png","El Pollo Loco":"/images/restaurant_logos/el_pollo_loco_thumb.png","Trader Joe's":"/images/restaurant_logos/trader_joes_thumb.png","My Fit Foods":"/images/restaurant_logos/my_fit_foods_thumb.png",
"Jersey Mike's Subs":"/images/restaurant_logos/jersey_mikes_thumb.png",Boloco:"/images/restaurant_logos/boloco_thumb.png","Bob Evans Farms Inc.":"/images/restaurant_logos/bob_evans_thumb.png",Sonic:"/images/restaurant_logos/sonic_thumb.png","Red Lobster":"/images/restaurant_logos/red_lobster_thumb.png","Au Bon Pain":"/images/restaurant_logos/au_bon_pain_thumb.png",Souplantation:"/images/restaurant_logos/souplantation_thumb.png","Pizza Hut":"/images/restaurant_logos/pizza_hut_thumb.png","Del Taco":"/images/restaurant_logos/del_taco_thumb.png",
"Popeyes Chicken & Biscuits":"/images/restaurant_logos/popeyes_thumb.png","KFC Chicken":"/images/restaurant_logos/kfc_thumb.png","Papa John's Pizza":"/images/restaurant_logos/papa_johns_thumb.png","White Castle":"/images/restaurant_logos/white_castle_thumb.png","Veggie Grill":"/images/restaurant_logos/veggie_grill_thumb.png"};
ETM.FoodInfoObject=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/food/",remote:!0,defaults:{major_ingredients:"",default_units:1,main_dish:!0,images:[],weights:[{amount:100,grams:100,description:"grams"},{amount:1,grams:100,description:"serving"}],description:""},relations:[{type:Backbone.Many,key:"ingredients",relatedModel:"ETM.IngredientObject",collectionType:"ETM.IngredientsList"},{type:Backbone.Many,key:"directions",relatedModel:"ETM.Direction",collectionType:"ETM.DirectionsList"},{type:Backbone.Many,
key:"images",relatedModel:"ETM.FoodImage",collectionType:"ETM.FoodImageList",customSerialize:function(a){a.models.forEach(function(a){delete a.attributes.resource_uri});return a}}],getDisplayImage:function(){var a=this.attributes.images,b=null;if(ETM.is_logged_in){var c=0;a.where({uploader:ETM.current_user_profile.attributes.username}).forEach(function(a){a.attributes.id>c&&(c=a.attributes.id,b=a)})}b||(b=a.findWhere({is_primary_image:!0}));b||(b=a.findWhere({curated:!0}));b?(null!=b.attributes.image&&
0!=b.attributes.image.indexOf("/site_media/")&&(b.attributes.image="/site_media/"+b.attributes.image),null!=b.attributes.thumbnail&&0!=b.attributes.thumbnail.indexOf("/site_media/")&&(b.attributes.thumbnail="/site_media/"+b.attributes.thumbnail)):b={attributes:{thumbnail:this.findFoodIcon(),image:"/images/recipe_image_placeholder.jpg",uploader:null}};return b},getEditorDisplayImage:function(){var a=this.attributes.images,b=null;if(ETM.is_logged_in){var c=0;a.where({uploader:ETM.current_user_profile.attributes.username}).forEach(function(a){a.attributes.id>
c&&(c=a.attributes.id,b=a)})}b||(b=a.findWhere({is_primary_image:!0}));b||(b=a.findWhere({curated:!0}));!b&&0<a.length&&(b=a.at(0));b?(null!=b.attributes.image&&0!=b.attributes.image.indexOf("/site_media/")&&(b.attributes.image="/site_media/"+b.attributes.image),null!=b.attributes.thumbnail&&0!=b.attributes.thumbnail.indexOf("/site_media/")&&(b.attributes.thumbnail="/site_media/"+b.attributes.thumbnail)):b={attributes:{thumbnail:this.findFoodIcon(),image:"/images/recipe_image_placeholder.jpg",uploader:null}};
return b},findFoodIcon:function(){var a,b;if("s"!==this.attributes.model&&"b"!==this.attributes.model||!_.has(this.attributes,"manufactured_by")){this.attributes.is_recipe?(a="recipes",b=this.attributes.category_id):null!=this.attributes.nutrition&&(a="basic_foods",b=this.attributes.nutrition.food_group);if(null==a||null==b||null==ETM.icon_search[a][b])return"/site_media/missing_thumbnail1.jpg";for(var c=0;c<ETM.icon_search[a][b].length;c++){var d=ETM.icon_search[a][b][c];if(c+1==ETM.icon_search[a][b].length)return d[1];
var e=d[0].split(" "),f=this.attributes.food_name.toLocaleLowerCase();if(0<e.length)for(var g=0;g<e.length;g++)if(-1!=f.indexOf(e[g]))return d[1]}return ETM.default_icons[a][b]}return _.has(RESTAURANT_LOGOS,this.attributes.manufactured_by)?RESTAURANT_LOGOS[this.attributes.manufactured_by]:"/site_media/missing_thumbnail1.jpg"},downloadRecipeInfo:function(a,b){var c=this;if("r"===this.attributes.model)if(delete _errs.meta.fetching_ingr_for,delete _errs.meta.downloaded_ingredients,delete _errs.meta.existing_ingredients,
_.has(this.attributes,"ingredients")&&_.has(this.attributes,"directions"))_errs.meta.existing_ingredients=JSON.stringify(this.get("ingredients")),a();else{var d=new ETM.RecipeObject;_errs.meta.fetching_ingr_for=c.get("id");d.fetch({url:ROOT+"/recipe/"+c.get("id")+"/",success:function(b,d,g){c.attributes.ingredients=b.get("ingredients");c.attributes.directions=b.get("directions");c.attributes.uploader=b.get("uploader");c.attributes.ingredients.each(function(a){a.attributes.original_recipe_amount=a.get("amount")});
_errs.meta.downloaded_ingredients=JSON.stringify(c.get("ingredients"));a()},error:function(d,f,g){if("undefined"!=typeof b&&b)throw _errs.meta.download_ingredients_error_code=f.status,Error("Download recipe info url "+g.url+" encountered error: "+f.status+" : "+f.statusText);c.downloadRecipeInfo(a,!0)}})}},schema:{food_name:{type:"Text",editorAttrs:{maxlength:100}},description:{type:"Text",editorAttrs:{maxlength:400}},breakfast:"Checkbox",single_serving:"Checkbox",keeps_well:"Checkbox",main_dish:{type:"SegmentedRadio",
value_type:"Boolean",options:[{val:!1,label:"Side dish"},{val:!0,label:"Main dish"}]},category_id:{type:"Select",value_type:"Number",options:[{val:1,label:"Appetizers"},{val:2,label:"Breakfast foods"},{val:3,label:"Desserts"},{val:4,label:"Drinks"},{val:5,label:"Mostly meat"},{val:6,label:"Protein shakes"},{val:7,label:"Salads"},{val:8,label:"Sandwiches"},{val:9,label:"Pasta"},{val:10,label:"Soups"},{val:11,label:"Other"}]},prep_time:{type:"PositiveNumber",validators:["required"]},cook_time:{type:"PositiveNumber",
validators:["required"]},number_servings:{type:"PositiveNumber",validators:[function(a,b){var c={type:"number_servings",message:"Number servings must be more than 0"};if(0<!a)return c}]},changes_reason:{type:"Select",options:[{val:"low_carb",label:"I want fewer carbs"},{val:"high_protein",label:"I want more protein"},{val:"allergic",label:"I was allergic to an ingredient"},{val:"vegetarian",label:"I made it more vegetarian/vegan friendly"},{val:"other",label:"Other"}]},changes_description:"TextArea"}});
ETM.FoodInfoObjectList=Backbone.Collection.extend({model:ETM.FoodInfoObject,remote:!0,urlRoot:ROOT+"/food/",url:function(){var a=this.models,b=this.urlRoot,b=b&&addSlash(b);a&&a.length&&(a=_.map(a,function(a){a=_.compact(a.url().split("/"));return a[a.length-1]}),b+="set/"+a.join(";")+"/");return b||null},initialize:function(a,b){b&&b.url&&(this.url=function(){return b.url})},addAndFetchMissing:function(a,b){var c=[],d=this;a.forEach(function(a){ETM.food_info_object_list.get(a)||(ETM.food_info_object_list.add({id:a}),
(a=/\/(\d+)\/$/g.exec(a))&&a[1]&&c.push(a[1]))});0<c.length?500<c.length?(extra_ids=c.splice(500),ETM.food_info_object_list.fetch({remove:!1,url:this.urlRoot+"set/"+c.join(";")+"/",success:function(){ETM.food_info_object_list.fetch({remove:!1,url:d.urlRoot+"set/"+extra_ids.join(";")+"/",success:function(){b()}})}})):ETM.food_info_object_list.fetch({remove:!1,url:this.urlRoot+"set/"+c.join(";")+"/",success:function(){b()}}):b()}});
ETM.CustomFoodInfoObject=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/customfood/",defaults:{}});ETM.CustomFoodInfoObjectList=Backbone.Collection.extend({url:function(){return this.options.url},model:ETM.CustomFoodInfoObject,initialize:function(a,b){this.options=b}});
var addSlash=function(a){return a+(0<a.length&&"/"===a.charAt(a.length-1)?"":"/")},mapFoodData=function(a){"undefined"!=typeof a.id&&1==Object.keys(a).length&&(a=a.id);if(_.isObject(a))return a;var b=ETM.food_info_object_list;return(b=b&&b.find(function(b){return b.get(b.idAttribute)===a||b.get(b.idAttribute)===ROOT+"/food/"+a+"/"}))?b:a};
function add_food_info_objects(a){a.forEach(function(a){var c=new ETM.FoodInfoObject(a);c.id=ROOT+"/food/"+a.id+"/";c.images=new ETM.FoodImageList(a.images);ETM.food_info_object_list.add(c)})}
ETM.FoodObject=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/foodobject/",relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData},{type:Backbone.Many,key:"makes_leftovers_for",relatedModel:"ETM.LeftoversFoodObject",collectionType:"ETM.LeftoversFoodList",customSerialize:function(a){return null}},{type:Backbone.One,key:"uses_leftovers_from",relatedModel:"ETM.LeftoversFoodObject",customSerialize:function(a){return null}}],
destroy:function(a){(this.attributes.is_leftovers||this.attributes.has_leftovers)&&this.updateRelatedLeftovers("delete");Backbone.AssociatedModel.prototype.destroy.apply(this,arguments)},setParentMeal:function(){_.has(this,"collection")&&_.has(this.collection,"parents")&&1==this.collection.parents.length&&this.collection.parents[0]instanceof ETM.MealObject&&(this.parent=this.collection.parents[0])},hasParentMeal:function(){return _.has(this,"parent")&&null!==this.parent},getParentMeal:function(){return this.parent},
hasParentDiet:function(){return this.hasParentMeal()&&this.getParentMeal().hasParentDiet()},getParentDiet:function(){return this.hasParentDiet()?this.getParentMeal().getParentDiet():!1},getLeftoversOriginString:function(){if(this.attributes.is_leftovers)return this.parent&&_.has(this.parent,"parent")&&this.parent.parent&&this.parent.parent.is_diet_set?"Day "+(ETM.diet_plan_set.attributes.diet_set_items.indexOf(this.attributes.leftovers_from)+1):getWeekday(Helper.parseDateString(this.attributes.leftovers_from).getDay())},
initialize:function(a,b){if(null==this.attributes.food||!(this.attributes.food instanceof ETM.FoodInfoObject))throw"Food object initialized without valid food info object";this.parent=null;this.setParentMeal();"undefined"!=typeof b&&_.has(b,"skip_global")&&b.skip_global||this.combineFoodInfoPointers();this.initializeEvents();this.is_favorite=Boolean(ETM.favorite_foods_list.findWhere({food:this.attributes.food.id}));this.is_blocked=Boolean(ETM.blocked_foods_list.findWhere({food:this.attributes.food.id}));
this.is_recurring_always=this.is_recurring=this.is_selected=!1;this.leftovers_servings=0;this.family_scale=1;this.calculateStats()},initializeEvents:function(){this.listenTo(this,"updateStats",this.calculateStats,this);this.listenTo(this.get("food"),"change",function(){this.trigger("updateStats");this.trigger("foodChanged")},this);this.listenTo(this,"change:food",function(){this.trigger("updateStats");this.trigger("foodChanged")},this);(this.attributes.is_leftovers||this.attributes.has_leftovers)&&
this.listenTo(ETM.dispatcher,"update_food_"+this.attributes.id,function(a,b){var c=this.sanitizeLeftoversJson(a);this.set(c,{silent:b})},this);this.attributes.is_leftovers&&this.isValidLeftovers()?this.listenTo(ETM.dispatcher,"update_uses_leftovers_from_"+this.attributes.uses_leftovers_from.attributes.id,function(a,b,c){"delete"===a?(this.set("is_leftovers",!1),this.set("uses_leftovers_from",null)):"update"===a&&this.set("uses_leftovers_from",b)},this):this.attributes.has_leftovers&&this.hasValidLeftovers()&&
this.listenTo(ETM.dispatcher,"update_makes_leftovers_for_"+this.attributes.id,function(a,b,c){if("delete"===a){for(c=0;c<this.attributes.makes_leftovers_for.models.length;c++)if(a=this.attributes.makes_leftovers_for.models[c],a.attributes.id===b.attributes.id){this.attributes.makes_leftovers_for.remove(a);break}0===this.attributes.makes_leftovers_for.models.length&&this.set("has_leftovers",!1)}else if("update"===a)for(c=0;c<this.attributes.makes_leftovers_for.models.length;c++)if(a=this.attributes.makes_leftovers_for.models[c],
a.attributes.id===b.attributes.id){b=this.sanitizeLeftoversJson(b.toJSON());a.set(b);break}},this)},sanitizeLeftoversJson:function(a){var b=jQuery.extend(!0,{},a);delete b.leftovers_family_scale;delete b.meal_type_id;null!=a.resource_uri&&(b.resource_uri=a.resource_uri.replace("leftoversobject","foodobject"));return b},updateRelatedLeftovers:function(a){this.attributes.is_leftovers&&this.isValidLeftovers()?ETM.dispatcher.trigger("update_makes_leftovers_for_"+this.attributes.uses_leftovers_from.attributes.id,
a,this):this.attributes.has_leftovers&&this.hasValidLeftovers()&&ETM.dispatcher.trigger("update_uses_leftovers_from_"+this.attributes.id,a,this)},getStaticAmount:function(){return mixin.getFractionFromDecimal(roundNumber(this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].amount,5))},getStaticUnits:function(){return this.attributes.food.attributes.weights[this.attributes.units].description},findNextLeftovers:function(){if(this.attributes.has_leftovers&&ETM.calendar_list){var a=
moment(ETM.calendar_list.selected_date).add("days",1).toDate();return ETM.calendar_list.getCalendarDiet(a).attributes.diet.findLeftoversFoodObject(!0,this.attributes.food.attributes.id)}},findPreviousLeftovers:function(){if(this.attributes.is_leftovers&&ETM.calendar_list){var a=moment(ETM.calendar_list.selected_date).subtract("days",1).toDate();return ETM.calendar_list.getCalendarDiet(a).attributes.diet.findLeftoversFoodObject(!1,this.attributes.food.attributes.id)}},findAllLeftovers:function(){},
triggerLeftoverEvents:function(a,b,c){var d=this;ETM.dispatcher.trigger("update_food_"+a.id,a,c);_.each(a.makes_leftovers_for,function(a){c=b&&a.id===d.attributes.id;ETM.dispatcher.trigger("update_food_"+a.id,a,c)})},shuffleLeftovers:function(a,b,c){var d=this,e=d.clone();$.post("/regenerate-leftovers/",{food_id:d.attributes.id},function(f){refreshed_food_json=JSON.parse(f);"Unable to refresh leftovers"===refreshed_food_json?(d.attributes.is_leftovers=!1,d.attributes.has_leftovers=!1,d.shuffleFood(a)):
"Found no results"===refreshed_food_json||"No date"===refreshed_food_json?(ETM.currently_generating=!1,"undefined"!==typeof a&&a(refreshed_food_json)):(f=JSON.parse(JSON.stringify(refreshed_food_json)),ETM.analytics.logFoodRefreshLeftovers(e,f,c),add_food_info_objects([refreshed_food_json.food]),refreshed_food_json.food=ETM.food_info_object_list.get(refreshed_food_json.food.resource_uri),d.triggerLeftoverEvents(refreshed_food_json,b,b&&refreshed_food_json.id===d.attributes.id),f=ETM.current_diet.attributes.meals.get(d.attributes.meal),
b&&(d.calculateStats(),f.calculateStats(),ETM.current_diet.calculateStats()),d.is_favorite=Boolean(ETM.favorite_foods_list.findWhere({food:d.attributes.food.id})),d.is_blocked=Boolean(ETM.blocked_foods_list.findWhere({food:d.attributes.food.id})),f.checkRecurringFoods(),ETM.currently_generating=!1,"undefined"!==typeof a&&a())})},shuffleWithoutLeftovers:function(a,b,c){var d=this,e=d.clone();ETM.food_pool.loadFoodPool(ETM.current_diet,function(){try{delete _errs.meta.meal_resource_uri;delete _errs.meta.meals;
delete _errs.meta.meal_json;delete _errs.meta.self_json;var b=ETM.current_diet.attributes.meals.get(d.attributes.meal),c=b.attributes.meal_number}catch(h){throw _errs.meta.meal_resource_uri=d.attributes.meal,_errs.meta.meals=ETM.current_diet.attributes.meals.modelIds().toString(),_errs.meta.meals_id_keys=ETM.current_diet.attributes.meals.byIdKeys().toString(),_errs.meta.meal_json=JSON.stringify(b),_errs.meta.self_json=JSON.stringify(d),h;}var l=Generator.foodRemix(d,ETM.current_diet,c);googleanalytics("send",
"event","button","click","food_refresh",c);if(l){var c=l.clone(),m=b.clone();ETM.analytics.logFoodRefresh(e,c,m);d.hasValidLeftovers()&&d.set({delete_leftovers:!0});d.is_favorite=Boolean(ETM.favorite_foods_list.findWhere({food:l.attributes.food.id}));d.is_blocked=Boolean(ETM.blocked_foods_list.findWhere({food:l.attributes.food.id}));d.set({amount:l.attributes.amount,food:l.attributes.food,units:l.attributes.units,is_leftovers:!1,has_leftovers:!1,leftovers_from:null,uses_leftovers_from:null});ETM.use_local_storage?
(Helper.resetLocalFoodInfoIDs(ETM.current_diet),ETM.current_diet.save()):d.save(null,{silent:!0,success:function(){_.has(d.attributes,"delete_leftovers")&&delete d.attributes.delete_leftovers;d.hasValidLeftovers()&&d.attributes.makes_leftovers_for.reset([]);_.has(d.attributes,"uses_leftovers_from")&&(d.attributes.uses_leftovers_from=null)}});b.checkRecurringFoods();d.trigger("updateStats");a()}ETM.currently_generating=!1},c)},hasValidLeftovers:function(){return _.has(this.attributes,"makes_leftovers_for")&&
null!=this.attributes.makes_leftovers_for&&_.has(this.attributes.makes_leftovers_for,"models")&&0<this.attributes.makes_leftovers_for.models.length},isValidLeftovers:function(){return _.has(this.attributes,"uses_leftovers_from")&&null!=this.attributes.uses_leftovers_from},shuffleFood:function(a,b,c,d){_.has(this.attributes,"meal")&&(this.attributes.is_leftovers||this.attributes.has_leftovers?this.shuffleLeftovers(a,b,c):this.shuffleWithoutLeftovers(a,b,d))},getAmountToCook:function(){var a=this;current_serving_amount=
this.getServingAmount();if(ETM.current_diet&&this.attributes.meal){var b=_.has(this,"collection")&&_.has(this.collection,"parents")?this.collection.parents[0]:ETM.current_diet.attributes.meals.get(this.attributes.meal);if(!b)return current_serving_amount;if(1<b.attributes.meal_type.attributes.family_scale||ETM.is_premium&&this.attributes.has_leftovers&&(ETM.calendar_list||ETM.diet_plan_set)){this.family_scale=b.attributes.meal_type.attributes.family_scale;var c=1,d=1,e=0;this.attributes.has_leftovers&&
0<this.attributes.makes_leftovers_for.length&&(ETM.calendar_list||ETM.diet_plan_set)&&_.each(this.attributes.makes_leftovers_for.models,function(b){c=a.convertServingAmount(b.attributes.amount,b.attributes.units);leftovers_meal_type=ETM.meal_type_list.get(ROOT+"/mealtype/"+b.attributes.meal_type_id+"/");d=leftovers_meal_type.attributes.family_scale;e+=c*d});this.leftovers_servings=e;return this.amount_to_cook=b=current_serving_amount*b.attributes.meal_type.attributes.family_scale+e}this.amount_to_cook=
current_serving_amount;this.family_scale=1;return current_serving_amount}return _.has(this,"use_url_amounts")?this.amount_to_cook:current_serving_amount},getServingAmount:function(){return 1==this.get("units")?this.attributes.amount:0==this.get("units")?this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].grams/this.attributes.food.attributes.weights[1].grams:this.attributes.amount},isLocked:function(){var a=!1;!0==this.attributes.is_leftovers||!0==this.attributes.has_leftovers?
a=!0:this.is_recurring_always&&(a=!0);return a},convertServingAmount:function(a,b){return 1==b?a:0==b?a*this.attributes.food.attributes.weights[b].grams/this.attributes.food.attributes.weights[1].grams:a},combineFoodInfoPointers:function(){var a=ETM.food_info_object_list.get(this.attributes.food.id);a?this.attributes.food=a:ETM.food_info_object_list.add(this.attributes.food)},addFoodInfoIfMissing:function(){ETM.food_info_object_list.get(this.attributes.food.id)||ETM.food_info_object_list.add(this.attributes.food)},
updateFoodAmount:function(a){this.set({amount:a/this.attributes.food.attributes.weights[this.attributes.units].amount});this.trigger("updateStats");null!=this.url()&&null!=this.id&&this.save();(this.attributes.is_leftovers||this.attributes.has_leftovers)&&this.updateRelatedLeftovers("update")},updateFoodUnits:function(a){this.set({amount:this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].grams/this.attributes.food.attributes.weights[a].grams,units:a});null!=this.url()&&
null!=this.id&&this.save();(this.attributes.is_leftovers||this.attributes.has_leftovers)&&this.updateRelatedLeftovers("update")},calculateStats:function(){var a=this;a.stats={};var b;"string"===typeof a.attributes.food&&(_errs.meta.food_info_obj=a.attributes.food,_errs.meta.food_obj_resource_uri=a.attributes.resource_uri,_errs.meta.food_info_exists_in_list=null!=ETM.food_info_object_list.get(a.attributes.food));try{if(_.has(a.attributes.food.attributes,"weights"))b=a.attributes.food.attributes.weights[a.attributes.units].grams*
a.attributes.amount;else{ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0});return}multiplier=b/100;ETM.NUTRIENT_LIST.forEach(function(b){null!=a.attributes.food.attributes.nutrition&&_.has(a.attributes.food.attributes.nutrition,b)?a.stats[b]=a.attributes.food.attributes.nutrition[b]*multiplier:a.stats[b]=0})}catch(c){throw $.extend(_errs.meta,{food:JSON.stringify(a.attributes.food),food_object_id:a.attributes.id,user_id:ETM.current_user_profile.attributes.user_id}),c;}a.gram_amount=b},scaleIngredients:function(a){var b=
this.get("food").get("number_servings"),c=a/b;try{this.get("food").attributes.ingredients.each(function(a){a.attributes.amount=a.attributes.original_recipe_amount*c;a.calculateStats()})}catch(d){throw _errs.meta.food_id=this.get("food").attributes.id,_errs.meta.food_obj_id=this.attributes.id,_errs.meta.food=JSON.stringify(this.get("food")),d;}},toggleFavorite:function(a){a.prop("disabled",!0);var b,c="string"==typeof this.attributes.food?this.attributes.food:this.attributes.food.id;if(this.is_favorite)this.is_favorite=
!1,this.attributes.food.trigger("removeFavorite"),b=ETM.favorite_foods_list.where({food_resource_uri:c}),0<b.length?(b=b[0],b.destroy({success:function(){a.prop("disabled",!1)},error:function(){a.prop("disabled",!1)}}),googleanalytics("send","event","button","click","remove_favorite"),amplitude.logEvent("remove_favorite",{food_id:parseIdFromResourceURI(c)})):(console.log("FOUND NO FAVORITE ITEM (something broke - no longer syncronized with the favorites list)"),a.prop("disabled",!1));else{this.is_favorite=
!0;this.attributes.food.trigger("addFavorite");var d=new ETM.FavoriteFood({food:c});d.save(null,{success:function(){ETM.favorite_foods_list.add(d,{at:0});a.prop("disabled",!1)},error:function(){a.prop("disabled",!1)}});googleanalytics("send","event","button","click","add_favorite");amplitude.logEvent("add_favorite",{food_id:parseIdFromResourceURI(c)})}},toggleBlock:function(a){a.prop("disabled",!0);var b;b="string"==typeof this.attributes.food?this.attributes.food:this.attributes.food.id;if(this.is_blocked)this.is_blocked=
!1,this.attributes.food.trigger("removeBlock"),b=ETM.blocked_foods_list.where({food_resource_uri:b}),0<b.length?(b=b[0],b.destroy({success:function(){a.prop("disabled",!1)},error:function(){a.prop("disabled",!1)}})):(console.log("FOUND NO BLOCKED ITEM (something broke - no longer syncronized with the block list)"),a.prop("disabled",!1));else{this.is_blocked=!0;this.attributes.food.trigger("addBlock");var c=new ETM.BlockedFood({food:b});c.save(null,{success:function(){ETM.blocked_foods_list.add(c);
a.prop("disabled",!1)},error:function(){a.prop("disabled",!1)}})}},customStats:function(a,b){self=this;var c={},d;if(_.has(self.attributes.food.attributes,"weights"))return d=self.attributes.food.attributes.weights[b].grams*a,multiplier=d/100,ETM.NUTRIENT_LIST.forEach(function(a){null!=self.attributes.food.attributes.nutrition&&_.has(self.attributes.food.attributes.nutrition,a)?c[a]=self.attributes.food.attributes.nutrition[a]*multiplier:c[a]=0}),c;ETM.NUTRIENT_LIST.forEach(function(a){c[a]=0})}});
ETM.FoodList=Backbone.Collection.extend({model:ETM.FoodObject,url:ROOT+"/foodobject/",toListIdJSON:function(){var a=[];this.each(function(b){var c=b.toJSON();c.list_id=b.cid;a.push(c)});return a},search:function(a,b){if(""==a)return this;try{var c=this.filter(function(b){return-1!=b.get("food").get("food_name").toLowerCase().indexOf(a.toLowerCase())});b(c)}catch(d){b([])}},useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},customAdd:function(a){var b=a.find(".foodbank_food"),c=b.attr("data-model-cid"),
c=ETM.sidebar_view.active_view.find(c),d=c.attributes.food;ETM.food_info_object_list.add(d);var e=c.toJSON();e.food=d;if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("in")){if(a.hasClass("meal_foods")||a.hasClass("meal_type_recurring_foods")||a.hasClass("grocery_foods_list"))return b.remove(),!1;if(c.get("food").get("is_recipe"))return b.remove(),this.trigger("addedRecipe"),!1;this.trigger("addedIngredient");c=new ETM.IngredientObject(e)}else c=new ETM.FoodObject(e);a=a.children().index(b);b.remove();
ETM.finish_profile_completeness_key("add_a_dish");return{modelToAdd:c,newIndex:a}},returnFoodObject:function(a){return new ETM.FoodObject({food:a,amount:1,units:a.attributes.default_units,is_custom:!1},{skip_global:!0})}});
ETM.LeftoversFoodObject=ETM.FoodObject.extend({relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData}],initialize:function(){"undefined"!=typeof options&&_.has(options,"skip_global")&&options.skip_global||this.combineFoodInfoPointers();this.initializeEvents();this.calculateStats()},initializeEvents:function(){this.listenTo(this,"updateStats",this.calculateStats,this);this.listenTo(this.get("food"),"change",
function(){this.trigger("updateStats");this.trigger("foodChanged")},this);this.listenTo(this,"change:food",function(){this.trigger("updateStats");this.trigger("foodChanged")},this)}});ETM.LeftoversFoodList=ETM.FoodList.extend({model:ETM.LeftoversFoodObject});
ETM.GeneratorFoodObject=Backbone.Model.extend({urlRoot:ROOT+"/foodobject/",initialize:function(a,b){if(null==this.attributes.food||!(this.attributes.food instanceof ETM.FoodInfoObject))throw"Food object initialized without valid food info object";this.is_recurring_always=this.is_recurring=this.is_selected=!1;this.leftovers_servings=0;this.family_scale=1;this.calculateStats()},hasValidLeftovers:function(){return _.has(this.attributes,"makes_leftovers_for")&&null!=this.attributes.makes_leftovers_for&&
_.has(this.attributes.makes_leftovers_for,"models")&&0<this.attributes.makes_leftovers_for.models.length},isValidLeftovers:function(){return _.has(this.attributes,"uses_leftovers_from")&&null!=this.attributes.uses_leftovers_from},getServingAmount:function(){return 1==this.get("units")?this.attributes.amount:0==this.get("units")?this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].grams/this.attributes.food.attributes.weights[1].grams:this.attributes.amount},isLocked:function(){var a=
!1;!0==this.attributes.is_leftovers||!0==this.attributes.has_leftovers?a=!0:this.is_recurring_always&&(a=!0);return a},calculateStats:function(){var a=this;a.stats={};var b;_.has(a.attributes.food.attributes,"weights")?(b=a.attributes.food.attributes.weights[a.attributes.units].grams*a.attributes.amount,multiplier=b/100,ETM.GENERATOR_NUTRIENTS.forEach(function(b){null!=a.attributes.food.attributes.nutrition&&_.has(a.attributes.food.attributes.nutrition,b)?a.stats[b]=a.attributes.food.attributes.nutrition[b]*
multiplier:a.stats[b]=0}),a.gram_amount=b):ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0})}});
ETM.SimpleFoodObject=ETM.FoodObject.extend({relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData}],initialize:function(a,b){if(null==this.attributes.food||!(this.attributes.food instanceof ETM.FoodInfoObject))throw"Food object initialized without valid food info object";this.addFoodInfoIfMissing();this.initializeEvents();this.is_favorite=Boolean(ETM.favorite_foods_list.findWhere({food:this.attributes.food.id}));
this.is_blocked=Boolean(ETM.blocked_foods_list.findWhere({food:this.attributes.food.id}));this.is_recurring=this.is_selected=!1;this.leftovers_servings=0;this.family_scale=1;this.calculateStats()},initializeEvents:function(){this.listenTo(this,"updateStats",this.calculateStats,this);this.listenTo(this.get("food"),"change",function(){this.trigger("updateStats");this.trigger("foodChanged")},this);this.listenTo(this,"change:food",function(){this.trigger("updateStats");this.trigger("foodChanged")},this)}});
ETM.SimpleFoodList=ETM.FoodList.extend({model:ETM.SimpleFoodObject});ETM.ReportFood=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/foodreport/"});
ETM.GroceryFoodObject=ETM.FoodObject.extend({urlRoot:ROOT+"/pantryfood/",destroy:function(a){if(this.attributes.owned)ETM.FoodObject.prototype.destroy.apply(this,arguments);else{this.updateFoodAmount(0);try{this.collection.remove(this)}catch(b){throw _errs.meta.collection_undefined=null==this.collection,_errs.meta.resource_uri=this.attributes.resource_uri,_errs.meta.food_resource_uri=this.attributes.food.attributes.resource_uri,_errs.meta.in_grocery_list=null!=ETM.groceries_and_pantry.grocery_list.get(this),
_errs.meta.in_pantry_list=null!=ETM.groceries_and_pantry.pantry_list.get(this),b;}}}});
ETM.GroceryFoodList=Backbone.Collection.extend({url:ROOT+"/pantry/",model:ETM.GroceryFoodObject,initialize:function(a,b){this.foods_are_owned=b.foods_are_owned},initializeEvents:function(){this.listenTo(this,"add",function(a,b){a.set("owned",this.foods_are_owned);a.save()},this);this.foods_are_owned&&!1===ETM.current_profile_completeness.get("add_food_to_pantry")&&this.listenToOnce(this,"add",function(){ETM.groceries_and_pantry.triggerPantryProfileCompleteness()})},useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},
customAdd:function(a){var b=a.find(".foodbank_food");if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("in"))b.remove();else{var c=b.attr("data-model-cid"),c=ETM.sidebar_view.active_view.find(c),d=c.attributes.food;ETM.food_info_object_list.add(d);c=new ETM.GroceryFoodObject({food:d,amount:c.attributes.amount,units:c.attributes.units},{skip_global:!0});a=a.children().index(b);b.remove();return{modelToAdd:c,newIndex:a}}},calculateStats:function(){var a=this;a.stats={};ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=
0});this.each(function(b){ETM.NUTRIENT_LIST.forEach(function(c){a.stats[c]+=b.stats[c]})})}});
ETM.GroceriesAndPantry=Backbone.Model.extend({url:ROOT+"/pantry/",initialize:function(){},fetchFoods:function(a){this.fetch({success:function(b,c,d){_.each(b.attributes.foods,function(a){0===a.food.food_group&&(a.food.food_group=null)});"undefined"!=typeof a&&a()}})},listenToWeeklyPlannerComplete:function(){var a=this;this.listenToOnce(ETM.generator_status,"finishedWeeklyPlanner",function(b){a.trigger("reloadGroceryList")})},loadFoodsForDates:function(a,b,c){var d=this;ETM.calendar_list.getDietsFromStartAndEndDate(a,
b,function(a){this.attributes.foods.reset();a.forEach(function(a){a.attributes.meals.forEach(function(a){a.attributes.foods})});d.createFoodLists();"undefined"!=typeof c&&c()})},createFoodLists:function(){var a=_.filter(this.attributes.foods,function(a){return!1==a.owned&&0<a.amount}),b=_.filter(this.attributes.foods,function(a){return!0==a.owned&&0<a.amount});this.grocery_list?this.grocery_list.reset(a):(this.grocery_list=new ETM.GroceryFoodList(a,{foods_are_owned:!1}),this.grocery_list.initializeEvents());
this.pantry_list?this.pantry_list.reset(b):(this.pantry_list=new ETM.GroceryFoodList(b,{foods_are_owned:!0}),this.pantry_list.initializeEvents());this.attributes.foods=[]},loadFoods:function(a){var b=this;this.fetchFoods(function(){b.createFoodLists();"undefined"!=typeof a&&a()})},toJSONFull:function(){return{grocery_list:this.grocery_list.toJSONFull(),pantry_list:this.pantry_list.toJSONFull(),current_start_date:this.attributes.current_start_date,current_end_date:this.attributes.current_end_date}},
deleteFoods:function(a,b){var c,d=[];"grocery"===a?c=this.grocery_list:"pantry"===a&&(c=this.pantry_list);null==b?c.forEach(function(a){d.push(a)}):b.forEach(function(a){d.push(c.get(a))});if(0<d.length){var e="";_.each(d,function(a){a.is_selected=!1;""!=e&&(e+=",");e+=a.attributes.id.toString()});$.ajax({url:"/pantry/delete_set/",data:{ids:e},type:"POST",success:function(a){},error:function(a,b,c){console.log(b)}});c.remove(d,{silent:!0})}},moveFoods:function(a,b){var c,d,e=[];"grocery_to_pantry"===
a?(!1===ETM.current_profile_completeness.get("add_food_to_pantry")&&ETM.groceries_and_pantry.triggerPantryProfileCompleteness(),c=this.grocery_list,d=this.pantry_list):"pantry_to_grocery"===a&&(c=this.pantry_list,d=this.grocery_list);null==b?c.forEach(function(a){a.attributes.owned=d.foods_are_owned;e.push(a)}):b.forEach(function(a){a=c.get(a);a.attributes.owned=d.foods_are_owned;e.push(a)});if(0<e.length){var f="";_.each(e,function(a){a.is_selected=!1;""!=f&&(f+=",");f+=a.attributes.id.toString()});
$.ajax({url:"/pantry/update_set/",data:{ids:f,foods_are_owned:d.foods_are_owned?1:0},type:"POST",success:function(a){},error:function(a,b,c){console.log(b)}});c.remove(e,{silent:!0});d.add(e,{silent:!0})}},triggerPantryProfileCompleteness:function(){ETM.current_profile_completeness.save({add_food_to_pantry:!0},{patch:!0})}});ETM.IngredientObject=ETM.FoodObject.extend({sync:function(){return!1}});
ETM.IngredientsList=Backbone.Collection.extend({model:ETM.IngredientObject,url:ROOT+"/ingredients/",sync:function(){return!1},useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},customAdd:function(a){var b=a.find(".foodbank_food"),c=b.attr("data-model-cid"),c=ETM.sidebar_view.active_view.find(c),d=c.attributes.food;ETM.food_info_object_list.add(d);var e=c.toJSON();e.food=d;if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("in")){if(c.get("food").get("is_recipe")){b.remove();this.trigger("addedRecipe");
return}this.trigger("addedIngredient");modelToAdd=new ETM.IngredientObject(e)}else modelToAdd=new ETM.FoodObject(e);a=a.children().index(b);b.remove();return{modelToAdd:modelToAdd,newIndex:a}}});
ETM.LeftoversChain=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/leftoverschain/",defaults:{user:null,parent_meal_type:null,child_meal_types:null,days_to_save_leftovers:1,repeat:!0,start_day:6,number_dishes:1},schema:{days_to_save_leftovers:{type:"Select",validators:["required"],value_type:"Number",options:[0,1,2,3,4,5,6]},number_dishes:{type:"Select",validators:["required"],value_type:"Number",options:[1,2,3]},repeat:{type:"Radio",value_type:"Boolean",options:[{val:"true",label:"Repeat pattern once leftovers are eaten"},
{val:"false",label:"Start on a specific day, no repeat"}]},start_day:{type:"Select",value_type:"Number",options:[{val:6,label:"Sunday"},{val:0,label:"Monday"},{val:1,label:"Tuesday"},{val:2,label:"Wednesday"},{val:3,label:"Thursday"},{val:4,label:"Friday"},{val:5,label:"Saturday"}]}},initialize:function(){!1===ETM.current_profile_completeness.get("setup_leftovers")&&this.listenToOnce(this,"change",function(){!1===ETM.current_profile_completeness.get("setup_leftovers")&&ETM.current_profile_completeness.save({setup_leftovers:!0},
{patch:!0})})}});ETM.LeftoversChainList=Backbone.Collection.extend({model:ETM.LeftoversChain,url:ROOT+"/leftoverschain/",findUnusedChainColorInt:function(){var a=[];a.length=COLOR_LIST.length;this.forEach(function(b){null!=b.chain_color_int&&b.chain_color_int<a.length&&(a[b.chain_color_int]=!0)});for(var b=0;b<a.length;b++)if(null==a[b])return b;return Helper.randomNumber(a.length)}});
ETM.LocalVariables=Backbone.Model.extend({local:!0,remote:!1,urlRoot:ROOT+"/notifications/",defaults:{show_restaurant_availability_alert:!0,seen_refresh_leftovers_info:!1,dont_show_refresh_leftovers_info:!1,seen_draggable_sidebar_tooltip:!1,seen_meal_rating_info:!1,seen_thumbs_down_temp_tooltip:!1,resource_uri:"12345",sort_by_pantry:!1,hide_apply_changes_dates:[],print_settings:{include_grocery_list:!0,include_meal_plans:!0,include_full_recipes:!0,print_format:"standard"},rated_meals:{}},addHiddenApplyChangesDate:function(a){a=
Helper.convertDateToString(a);-1==$.inArray(a,this.attributes.hide_apply_changes_dates)&&(this.attributes.hide_apply_changes_dates.push(a),this.save())},isApplyChangesHiddenForDate:function(a){a=Helper.convertDateToString(a);return-1<$.inArray(a,this.attributes.hide_apply_changes_dates)},initialize:function(){}});ETM.ManagedAccount=Backbone.AssociatedModel.extend({});ETM.ManagedAccountList=Backbone.Collection.extend({model:ETM.ManagedAccount,url:ROOT+"/managedaccount/"});
ETM.ManagedExternalAccount=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/managedexternalaccount/"});ETM.ManagedExternalAccountList=Backbone.Collection.extend({model:ETM.ManagedExternalAccount,url:ROOT+"/managedexternalaccount/"});ETM.ManagerInvitedUser=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/managerinviteduser/"});ETM.ManagerInvitedUserList=Backbone.Collection.extend({model:ETM.ManagerInvitedUser,url:ROOT+"/managerinviteduser/"});DEFAULT_TRAINER_LOGO="https://images.eatthismuch.com/images/trainer-placeholder.png";
ETM.ManagerProfile=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/managerprofile/",getLogoUrl:function(){return null!=this.attributes.logo_url?"https://images.eatthismuch.com/site_media/"+this.attributes.logo_url:DEFAULT_TRAINER_LOGO},remote:!0});ETM.GooglePlacesMapDataObject=function(a){this.data=a;this.name=a.name;this.id=a.id;this.address=a.vicinity;this.category=null!=a.types&&0<a.types.length?a.types[0]:"";this.lat=a.geometry.location.lat();this.lng=a.geometry.location.lng()};
ETM.FourSquareMapDataObject=function(a){this.data=a;this.name=a.name;this.id=a.id;this.address=a.location.address;this.category="";var b=this;a.categories.forEach(function(a){b.category=""===b.category?a.name:b.category+(", "+a.name)});this.lat=a.location.lat;this.lng=a.location.lng};var mapMealType=function(a){if(_.isObject(a))return a;var b=ETM.meal_type_list;return(b=b&&b.find(function(b){return b.get(b.idAttribute)===a}))?b:{}};
ETM.MealObject=Backbone.AssociatedModel.extend({defaults:{meal_number:null,meal_type:null},urlRoot:ROOT+"/meal/",initialize:function(){"undefined"==typeof this.attributes.foods&&(this.attributes.foods=new ETM.FoodList);this.parent=null;this.setParentDiet();this.initializeEvents();this.calculateStats();this.profileCompletenessEvents()},setParentDiet:function(){_.has(this,"collection")&&_.has(this.collection,"parents")&&1==this.collection.parents.length&&this.collection.parents[0]instanceof ETM.Diet&&
(this.parent=this.collection.parents[0])},getParentDiet:function(){return this.parent},hasParentDiet:function(){return _.has(this,"parent")&&null!==this.parent},profileCompletenessEvents:function(){"undefined"!=typeof ETM.current_profile_completeness&&!1===ETM.current_profile_completeness.attributes.mark_meal_as_eaten&&this.listenToOnce(this,"change:eaten",function(){this.get("eaten")&&!1===ETM.current_profile_completeness.attributes.mark_meal_as_eaten&&ETM.current_profile_completeness.save({mark_meal_as_eaten:!0},
{patch:!0})})},initializeEvents:function(){var a=this;this.listenTo(this,"updateStats:foods",function(b,c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"add:foods",function(b,c){a.calculateStats();a.trigger("updateStats");b.set("meal",this.id);b.save();a.checkRecurringFoods();(b.attributes.has_leftovers||b.attributes.is_leftovers)&&b.updateRelatedLeftovers("update");ETM.use_local_storage&&(Helper.resetLocalFoodInfoIDs(ETM.current_diet),ETM.current_diet.save())},this);this.listenTo(this,
"remove:foods",function(b,c){a.calculateStats();a.trigger("updateStats");ETM.use_local_storage&&(Helper.resetLocalFoodInfoIDs(ETM.current_diet),ETM.current_diet.save())});this.listenTo(this,"reset:foods",function(b,c){a.calculateStats();a.trigger("updateStats")});this.listenTo(this,"change:eaten",ETM.analytics.logEatenMeal)},comparator:function(a){return a.get("meal_number")},relations:[{type:Backbone.Many,key:"foods",relatedModel:"ETM.FoodObject",collectionType:"ETM.FoodList",customSerialize:function(a){a.models.forEach(function(a){delete a.attributes.is_custom});
return a}},{type:Backbone.One,key:"meal_type",relatedModel:"ETM.MealType",map:mapMealType,customSerialize:function(a){return null==a.attributes.resource_uri?a:a.attributes.resource_uri}}],checkRecurringFoods:function(){if(ETM.is_logged_in){var a=ETM.recurring_foods_list.byMealType(this.attributes.meal_type.id);this.attributes.foods.each(function(b){var c=a.byFoodId(b.attributes.food.id);0<c.length?(b.is_recurring=!0,b.is_recurring_always=1==c[0].attributes.frequency,b.trigger("showRecurring")):(b.is_recurring=
!1,b.is_recurring_always=!1,b.trigger("hideRecurring"))})}},isLocked:function(){return!0===this.attributes.eaten||this.allLockedRecurringFoods()?!0:!1},allLockedRecurringFoods:function(){for(var a=this.attributes.meal_type,b=ETM.recurring_foods_list.byMealType(a.id),c=!0,d=0;d<b.models.length;d++)if(1!=b.models[d].attributes.frequency){c=!1;break}return c&&a.attributes.only_use_recurring},shuffleMeal:function(a){if(!ETM.currently_generating){ETM.finish_profile_completeness_key("refresh_meal");var b=
this;ETM.currently_generating=!0;var c={};b.attributes.foods.each(function(a){c[a.attributes.food.attributes.id]=a.attributes.amount});ETM.food_pool.loadFoodPool(ETM.current_diet,function(){var d=function(){var d=b.get("meal_number");googleanalytics("send","event","button","click","meal_refresh",d);Generator.mealRemix(ETM.current_diet,d);ETM.current_diet.updateMealAfterGenerating(d);d=b.clone();ETM.analytics.logMealRefresh(c,d);ETM.use_local_storage?(ETM.current_diet.save(),ETM.currently_generating=
!1,a()):b.save(null,{silent:!0,success:function(){delete b.attributes.delete_other_foods;delete b.attributes.delete_other_foods_except_leftovers;ETM.currently_generating=!1;a()}})},e=b.findFoodWithLeftovers();!1!==e?ETM.notifications.showRefreshLeftoversInfo(function(){e.shuffleFood(d,!0,!0)}):!1!==b.findFoodThatIsLeftovers()?ETM.notifications.showRefreshLeftoversInfo(function(){d()}):d()})}},findFoodWithLeftovers:function(a){if(!ETM.is_premium||this.attributes.eaten)return!1;a=this.attributes.foods.models;
for(var b=0;b<a.length;b++){var c=a[b];if(c.attributes.has_leftovers)return c}return!1},findFoodThatIsLeftovers:function(){if(!ETM.is_premium)return!1;for(var a=this.attributes.foods.models,b=0;b<a.length;b++){var c=a[b];if(c.attributes.is_leftovers)return c}return!1},calculateStats:function(){var a=this;a.stats={};ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=0});this.attributes.foods.each(function(b){ETM.NUTRIENT_LIST.forEach(function(c){a.stats[c]+=b.stats[c]})})},getFoodIDString:function(){var a=
[];this.get("foods").each(function(b){a.push(parseInt(b.attributes.food.attributes.id))});a.sort();return 0<a.length?a.join(","):""},getThumbRating:function(a){if(is_mobile&&!app||!ETM.is_logged_in)return 0;var b=this.getFoodIDString();a=a||this.attributes.meal_type.id;a=ETM.meal_rating_list.findWhere({meal_type:a,food_ids:b});return"undefined"===typeof a?0:a.attributes.rating},saveThumbRating:function(a,b,c,d,e){var f=this.getFoodIDString();c=null!==c?0<=c?c:this.attributes.meal_number:this.attributes.meal_number;
d=d||this.parent.attributes.num_meals;b=b||this.attributes.meal_type.id;0<f.length&&(new ETM.MealRating({food_ids:f,meal_type:b,rating:a,meal_number:c,num_meals:d})).save(null,{success:function(a,b){ETM.meal_rating_list.add(a,{merge:!0});e()},error:function(a,b){e()}})}});
ETM.MealRating=Backbone.Model.extend({urlRoot:ROOT+"/mealrating/",getHash:function(){for(var a=0,a=this.attributes.food_ids.split(","),b=0;b<a.length;b++)a[b]=parseInt(a[b],10);return a=this.attributes.meal_type?Helper.generateMealRatingHash(a,parseIdFromResourceURI(this.attributes.meal_type)):Helper.generateMealRatingHash(a)}});
ETM.MealRatingList=Backbone.Collection.extend({model:ETM.MealRating,url:ROOT+"/mealrating/",initialize:function(){this.on("add",this._onAdd,this);this.on("remove",this._onRemove,this);this.on("reset",this._onReset,this);this._onReset()},hasMealHash:function(a){return!0===this._idHashSet[a]},hasThumbsDownMeal:function(a){return!0===this._thumbsDownHashSet[a]},hasThumbsUpMeal:function(a){return!0===this._thumbsUpHashSet[a]},_onAdd:function(a){var b=a.getHash();this._idHashSet[b]=!0;1===a.attributes.rating?
this._thumbsDownHashSet[b]=!0:2===a.attributes.rating&&(this._thumbsUpHashSet[b]=!0)},_onRemove:function(a){delete this._idHashSet[a.getHash()];delete this._thumbsUpHashSet[a.getHash()];delete this._thumbsDownHashSet[a.getHash()]},_onReset:function(a){this._idHashSet={};this._thumbsUpHashSet={};this._thumbsDownHashSet={};this.each(this._onAdd)}});ETM.COMPLEXITY_CONSTANTS={SUPER_SIMPLE:0,SIMPLE:1,MODERATE:2,COMPLEX:3};ETM.BREAKFAST_CONSTANTS={NO_BREAKFAST:0,ALLOW_BREAKFAST:1,ONLY_BREAKFAST:2};
ETM.MealList=Backbone.Collection.extend({model:ETM.MealObject,url:ROOT+"/meal/",createMealsIfNeeded:function(){if(0==this.length)for(var a=0;3>a;a++){var b=new ETM.MealObject;b.attributes.meal_number=a;if(0==a){var c=ETM.meal_type_list.findWhere({title:"Breakfast"});"undefined"!=typeof c?b.attributes.meal_type=c:(b.attributes.meal_type=new ETM.MealType,b.attributes.meal_type.attributes.breakfast=ETM.BREAKFAST_CONSTANTS.ONLY_BREAKFAST,b.attributes.meal_type.attributes.title="Breakfast",b.attributes.meal_type.attributes.complexity=
ETM.COMPLEXITY_CONSTANTS.SIMPLE,ETM.meal_type_list.add(b.attributes.meal_type,{silent:!0}),b.attributes.meal_type.save(null,{async:!1}),this.listenToOnce(b.attributes.meal_type,"change",function(){!1===ETM.current_profile_completeness.get("customized_meal_types")&&ETM.current_profile_completeness.save({customized_meal_types:!0},{patch:!0})}))}else 1==a?(c=ETM.meal_type_list.findWhere({title:"Lunch"}),"undefined"!=typeof c?b.attributes.meal_type=c:(b.attributes.meal_type=new ETM.MealType,b.attributes.meal_type.attributes.max_cooktime=
0,b.attributes.meal_type.attributes.title="Lunch",b.attributes.meal_type.attributes.complexity=ETM.COMPLEXITY_CONSTANTS.SIMPLE,ETM.meal_type_list.add(b.attributes.meal_type,{silent:!0}),b.attributes.meal_type.save(null,{async:!1}),this.listenToOnce(b.attributes.meal_type,"change",function(){!1===ETM.current_profile_completeness.get("customized_meal_types")&&ETM.current_profile_completeness.save({customized_meal_types:!0},{patch:!0})}))):2==a&&(c=ETM.meal_type_list.findWhere({title:"Dinner"}),"undefined"!=
typeof c?b.attributes.meal_type=c:(b.attributes.meal_type=new ETM.MealType,b.attributes.meal_type.attributes.min_cooktime=1,b.attributes.meal_type.attributes.title="Dinner",b.attributes.meal_type.attributes.complexity=ETM.COMPLEXITY_CONSTANTS.MODERATE,ETM.meal_type_list.add(b.attributes.meal_type,{silent:!0}),b.attributes.meal_type.save(null,{async:!1}),this.listenToOnce(b.attributes.meal_type,"change",function(){!1===ETM.current_profile_completeness.get("customized_meal_types")&&ETM.current_profile_completeness.save({customized_meal_types:!0},
{patch:!0})})));this.add(b)}}});ETM.MealTag=Backbone.Model.extend({idAttribute:"bit_index",initialize:function(){}});ETM.MealTagList=Backbone.Collection.extend({model:ETM.MealTag,url:ROOT+"/mealtag/"});var COMPLEXITY_CHOICES=["Super simple","Simple","Moderate","Complex"];
ETM.MealType=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/mealtype/",defaults:{title:null,size_slider:100,family_scale:1,breakfast:0,takeout:0,min_preptime:0,max_preptime:30,min_cooktime:0,max_cooktime:30,max_totaltime:30,complexity:2,override_complexity:!1,only_use_recurring:!1,deleted:!1,user_id:null},schema:{title:{type:"Text",editorAttrs:{maxlength:100},validators:["required"]},size_slider:{type:"Select",value_type:"Number",validators:["required"],options:[{val:50,label:"Tiny meal"},{val:75,
label:"Small meal"},{val:100,label:"Normal meal"},{val:125,label:"Big meal"},{val:150,label:"Huge meal"}]},family_scale:{type:"Select",validators:["required"],value_type:"Number",options:[1,2,3,4,5,6,7,8,9]},breakfast:{type:"Radio",value_type:"Number",options:[{val:0,label:"No breakfast foods"},{val:1,label:"Breakfast foods and other foods"},{val:2,label:"Only breakfast foods"}]},override_complexity:{type:"Checkbox"},complexity:{type:"Select",validators:["required"],value_type:"Number",options:[{val:0,
label:"Super simple"},{val:1,label:"Simple"},{val:2,label:"Moderate"},{val:3,label:"Complex"}]},max_totaltime:{type:"Select",validators:["required"],value_type:"Number",options:[{val:5,label:"No time (<5 min)"},{val:15,label:"Little time (<15 min)"},{val:30,label:"Some time (<30 min)"},{val:1E3,label:"Lots of time (no limit)"}]},only_use_recurring:{type:"Checkbox"}},validate:function(a){var b=this,c={};0<ETM.meal_type_list.filter(function(c){return c.attributes.title===a.title&&!c.deleted&&(null==
b.attributes.user_id||c.attributes.user_id==b.attributes.user_id)&&c.id!==b.id}).length&&(c.title={message:"A meal type with the title "+a.title+' already exists.  <button class="btn btn-default replace-button">Rename other meal types</button>'});if(!$.isEmptyObject(c))return c}});
ETM.MealTypeList=Backbone.Collection.extend({model:ETM.MealType,url:ROOT+"/mealtype/",comparator:function(a){var b=a.attributes.id+10;if(is_premium&&1<ETM.template_diet_list.length){var c=0,d=0;ETM.template_diet_list.each(function(b){if(b=b.attributes.diet.attributes.meals.findWhere({meal_type:a}))c++,d+=b.attributes.meal_number});0<c&&(b=d/c)}else if(0<ETM.selected_diet_list.length){var e=ETM.selected_diet_list.at(0).attributes.diet.attributes.meals.findWhere({meal_type:a});e&&(b=e.attributes.meal_number)}return b},
getMealTypeNameAndIds:function(){var a=[];this.each(function(b){b.attributes.deleted||a.push({val:b.id,label:b.attributes.title})});return a}});
ETM.NutritionProfile=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/nutritionprofile/",defaults:{calories:null,cholesterol:300,date_made:null,deleted:!1,description:null,fiber:25,macro_scheme:"grams",max_carbs:1E3,max_fats:1E3,max_proteins:1E3,min_carbs:0,min_fats:0,min_proteins:0,percent_carbs:40,percent_fats:30,percent_proteins:30,sodium:2400,title:"My Nutrition Targets",user_id:null,watch_cholesterol:!1,watch_sodium:!1},schema:{title:{type:"Text",editorAttrs:{maxlength:110},validators:["required"]},
description:"Text",calories:{type:"PositiveNumber"},macro_scheme:{type:"SegmentedRadio",validators:["required"],options:[{val:"grams",label:"Within a range"},{val:"percents",label:"As a percentage of calories"}]},max_carbs:"PositiveNumber",max_fats:"PositiveNumber",max_proteins:"PositiveNumber",min_carbs:"PositiveNumber",min_fats:"PositiveNumber",min_proteins:"PositiveNumber",percent_carbs:"PositiveNumber",percent_fats:"PositiveNumber",percent_proteins:"PositiveNumber",sodium:"PositiveNumber",fiber:"PositiveNumber",
cholesterol:"PositiveNumber",watch_cholesterol:"Checkbox",watch_sodium:"Checkbox"},validate:function(a,b){var c=this,d={};"percents"===a.macro_scheme&&100!=a.percent_fats+a.percent_proteins+a.percent_carbs&&(d.macro_scheme={message:"Your macro proportions must equal 100 (currently "+(a.percent_fats+a.percent_proteins+a.percent_carbs)+")."});a.calories&&"undefined"!==typeof a.calories?200>a.calories?d.calories={message:"Calories must be at least 200."}:2E4<a.calories&&(d.calories={message:"Calories must be at most 20000."}):
d.calories={message:"A calorie number is required."};0<ETM.nutrition_profile_list.filter(function(b){return b.attributes.title===a.title&&!b.deleted&&(null==c.attributes.user_id||b.attributes.user_id==c.attributes.user_id)&&b.id!=c.id}).length&&(d.title={message:"A nutrition profile with the title "+a.title+' already exists.  <button class="btn btn-default replace-button">Rename other nutrition profiles</button>'});if(!$.isEmptyObject(d))return d},scaleMacrosFromCalories:function(a,b){if(10<b)var c=
a/b;else this.attributes.min_carbs=0<this.attributes.min_carbs?this.attributes.min_carbs:a/4/5,this.attributes.min_fats=0<this.attributes.min_fats?this.attributes.min_fats:a/9/5,this.attributes.min_proteins=0<this.attributes.min_proteins?this.attributes.min_proteins:a/4/5,c=1;var d=roundNumber(a/4,0),e=roundNumber(a/9,0),f=roundNumber(a/4,0),g=roundNumber(this.attributes.max_carbs*c,0),h=roundNumber(this.attributes.max_fats*c,0),l=roundNumber(this.attributes.max_proteins*c,0);this.set({min_carbs:roundNumber(this.attributes.min_carbs*
c,0),max_carbs:d<g||0==g?roundNumber(d/2,0):g,min_fats:roundNumber(this.attributes.min_fats*c,0),max_fats:e<h||0==h?roundNumber(e/2,0):h,min_proteins:roundNumber(this.attributes.min_proteins*c,0),max_proteins:f<l||0==l?roundNumber(f/2,0):l})},changePresetDiet:function(a){a=Helper.calculateMacrosFromProfile(ETM.current_user_profile.clone().set("preset_diet",a));if(!a)return!1;delete a.capped_min_calories;return this.save(a)}});
ETM.NutritionProfileList=Backbone.Collection.extend({model:ETM.NutritionProfile,url:ROOT+"/nutritionprofile/"});
ETM.SimpleNutritionProfile=ETM.NutritionProfile.extend({local:!0,remote:!1,urlRoot:ROOT+"/simple-nutrition-targets/",schema:{calories:{type:"PositiveNumber"},max_carbs:"PositiveNumber",max_fats:"PositiveNumber",max_proteins:"PositiveNumber",min_carbs:"PositiveNumber",min_fats:"PositiveNumber",min_proteins:"PositiveNumber"},defaults:{resource_uri:"123456789",customized_targets:!1,calories:2E3,cholesterol:300,fiber:25,macro_scheme:"grams",max_carbs:1E3,max_fats:1E3,max_proteins:1E3,min_carbs:0,min_fats:0,
min_proteins:0,sodium:2400,watch_cholesterol:!1,watch_sodium:!1},validate:function(a,b){var c={};"percents"===a.macro_scheme&&100!=a.percent_fats+a.percent_proteins+a.percent_carbs&&(c.macro_scheme={message:"Your macro proportions must equal 100 (currently "+(a.percent_fats+a.percent_proteins+a.percent_carbs)+")."});a.calories&&"undefined"!==typeof a.calories?50>a.calories?c.calories={message:"Calories must be at least 50."}:2E4<a.calories&&(c.calories={message:"Calories must be at most 20000."}):
c.calories={message:"A calorie number is required."};if(!$.isEmptyObject(c))return c},initialize:function(){}});
ETM.FREE_PROFILE_TODOS=[{key:"initial_signup_complete",title:"Create your user profile",premium:!1,content:"Finished the account creation process with your basic profile info.",onclick:"signup_link",weight:5},{key:"add_a_dish",title:"Add a food to your plan",premium:!1,content:"Search for a food and then add it to your current plan by dragging it in.",onclick:function(){ETM.router.navigate("",{trigger:!0});setTimeout(function(){ETM.sidebar_view.toggleFoodBank("open",function(){ETM.sidebar_view.showRecipes();
setTimeout(function(){ETM.add_a_dish_tip.start()},30)})},30)},weight:0.5},{key:"drag_food",title:"Drag a food between meals",premium:!1,content:"Click and hold on a food to start dragging it, then move it to another meal.",onclick:"drag_food_tip",weight:0.5},{key:"refresh_meal",title:"Regenerate a meal",premium:!1,content:"Refresh a single meal to fine tune your meal plan.",onclick:"refresh_meal_tip",weight:0.5},{key:"customized_meal_types",title:"Customize your Meal Types",premium:!1,content:"You can set custom cook time filters, meal sizes, and number of family members by clicking on a meal's name.",
onclick:"customize_meal_type_tip",weight:1},{key:"edited_food_preferences",title:"Personalize your food preferences",premium:!1,content:"Set your food filters to exclude foods and ingredients that you don't like.",onclick:"customize_food_preferences_tip",weight:1},{key:"set_weight_goal",title:"Set a weight goal",premium:!1,content:"Stay motivated by setting a weight goal. Consistently log your weight to stay on track.",onclick:"set_weight_goal_tip",weight:0.5},{key:"favorite_food",title:"Favorite a food",
premium:!1,content:"Favoriting helps to fine tune the generator's results, and adds it to the Food Bank for easy access.",onclick:"favorite_food_tip",weight:0.5},{key:"block_food",title:"Block a food you don't like",premium:!1,content:"Blocking prevents a food from showing up again, improving your future meal suggestions.",onclick:"block_food_tip",weight:0.5},{key:"add_recurring_food",title:"Add a Recurring Food",premium:!1,content:"Add something that you like to eat every day as a Recurring Food and the generator will automatically add it for you (even if it's just your morning coffee).",
onclick:"add_recurring_food_tip",weight:1},{key:"view_custom_food_screen",title:"Check out the custom food screen",premium:!1,content:"If you can't find what you're looking for in the database, it's easy to add your own custom foods.",onclick:function(){ETM.sidebar_view.toggleFoodBank("open",function(){ETM.sidebar_view.showCustomFoods();setTimeout(function(){ETM.view_custom_food_screen.start()},30)})},weight:0.5},{key:"mark_meal_as_eaten",title:"Mark a meal as 'eaten' to log it",premium:!1,content:"This will help keep track of what you've actually eaten, and will help you compare what you planned to what you ate.",
onclick:"mark_eaten_tip",weight:1}];
ETM.ALL_PROFILE_TODOS=ETM.FREE_PROFILE_TODOS.concat([{key:"setup_weekly_layout",title:"Customize your Weekly Layout",premium:!0,content:"Personalize your meal layout to match your schedule. You can set up different workout/rest days, or different meals on the weekends.",onclick:"weekly_layout_tip",weight:1},{key:"setup_leftovers",title:"Set up a leftovers pattern",premium:!0,content:"Leftovers make it easy to cook once and enjoy a great meal all week. They also cut down on your grocery list length.",onclick:"setup_leftovers_tip",
weight:1},{key:"add_food_to_pantry",title:"Add what you already own to the Pantry",premium:!0,content:"Then regenerate your weekly plan - the generator will give priority to using up what you own.",onclick:"add_foods_to_pantry_tip",weight:1}]);
ETM.ProfileCompleteness=Backbone.AssociatedModel.extend({initialize:function(){},getCompletenessPercent:function(){var a=this,b=0,c=0;ETM.ALL_PROFILE_TODOS.forEach(function(d){d.premium?ETM.is_premium&&(b+=d.weight,!0===a.get(d.key)&&(c+=d.weight)):(b+=d.weight,!0===a.get(d.key)&&(c+=d.weight))});return roundNumber(100*c/b,0)}});ETM.ProfileCompletenessList=Backbone.Collection.extend({model:ETM.ProfileCompleteness,url:ROOT+"/profilecompleteness/"});
ETM.RecipeObject=Backbone.AssociatedModel.extend({remote:!0,urlRoot:ROOT+"/recipe/",relations:[{type:Backbone.Many,key:"ingredients",relatedModel:"ETM.IngredientObject",collectionType:"ETM.IngredientsList"},{type:Backbone.Many,key:"directions",relatedModel:"ETM.Direction",collectionType:"ETM.DirectionsList"}],initialize:function(){}});
ETM.RecurringFood=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/recurringfood/",defaults:{frequency:1,amount:1},relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodInfoObject",customSerialize:function(a){return a.attributes.resource_uri},map:mapFoodData}],initialize:function(){if(null==this.attributes.food||!(this.attributes.food instanceof ETM.FoodInfoObject))throw"Recurring food initialized without food info object";this.combineFoodInfoPointers();this.listenTo(this,"updateStats",this.calculateStats,
this);if(null==this.attributes.units||null==this.attributes.amount)this.attributes.units=this.attributes.food.attributes.default_units,this.attributes.amount=1;this.calculateStats()},combineFoodInfoPointers:function(){var a=ETM.food_info_object_list.get(this.attributes.food.id);a?this.attributes.food=a:ETM.food_info_object_list.add(this.attributes.food)},getServingAmount:function(){return 1==this.get("units")?this.attributes.amount:0==this.get("units")?this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].grams/
this.attributes.food.attributes.weights[1].grams:this.attributes.amount},validate:function(a,b){var c={},d=this.attributes.food;if(d){var d=ETM.recurring_foods_list.where({food:d,meal_type:a.meal_type}),e=d.indexOf(this);-1<e&&d.splice(e,1);0<d.length&&(d=ETM.meal_type_list.get(a.meal_type),c.meal_type={message:"This food is already recurring for "+d.attributes.title})}if(!$.isEmptyObject(c))return c},getStaticAmount:function(){return mixin.getFractionFromDecimal(roundNumber(this.attributes.amount*
this.attributes.food.attributes.weights[this.attributes.units].amount,5))},getStaticUnits:function(){return this.attributes.food.attributes.weights[this.attributes.units].description},updateFoodAmount:function(a){this.set({amount:a/this.attributes.food.attributes.weights[this.attributes.units].amount});this.trigger("updateStats");null!=this.url()&&this.save()},updateFoodUnits:function(a){this.set({amount:this.attributes.amount*this.attributes.food.attributes.weights[this.attributes.units].grams/this.attributes.food.attributes.weights[a].grams,
units:a});null!=this.url()&&this.save()},calculateStats:function(){var a=this;a.stats={};var b;_.has(a.attributes.food.attributes,"weights")?(b=a.attributes.food.attributes.weights[a.attributes.units].grams*a.attributes.amount,multiplier=b/100,ETM.NUTRIENT_LIST.forEach(function(b){null!=a.attributes.food.attributes.nutrition&&_.has(a.attributes.food.attributes.nutrition,b)?a.stats[b]=a.attributes.food.attributes.nutrition[b]*multiplier:a.stats[b]=0}),a.gram_amount=b):ETM.NUTRIENT_LIST.forEach(function(b){a.stats[b]=
0})}});ETM.RecurringFood.frequency_types=["often","always"];
ETM.RecurringFoodList=Backbone.Collection.extend({model:ETM.RecurringFood,url:ROOT+"/recurringfood/",useCustomAdd:function(a){return a.item.hasClass("foodbank_food")},initialize:function(){var a=this;this.listenTo(this,"add",function(b,c){_.has(a,"meal_type")&&b.get("meal_type")!==a.meal_type&&b.save({meal_type:a.meal_type},{patch:!0})},this)},byDishType:function(a){"main_dishes"===a?filtered=this.filter(function(a){return!0==a.get("food").get("main_dish")}):"side_dishes"===a&&(filtered=this.filter(function(a){return!1==
a.get("food").get("main_dish")}));return filtered},byMealType:function(a){filtered=this.filter(function(b){return b.get("meal_type")==a});return new ETM.RecurringFoodList(filtered)},byFoodId:function(a){return filtered=this.filter(function(b){return b.get("food").id==a})},customAdd:function(a){var b=a.find(".foodbank_food");if(ETM.recipe_editor&&ETM.recipe_editor.$el.hasClass("in"))b.remove();else{var c=b.attr("data-model-cid"),c=ETM.sidebar_view.active_view.find(c).attributes.food;ETM.food_info_object_list.add(c);
c=new ETM.RecurringFood({food:c,meal_type:this.meal_type,frequency:0});c.save(null,{success:function(a){ETM.recurring_foods_list.add(a);a.trigger("recurring_food_saved")}});a=a.children().index(b);b.remove();return(b=c.validate(c.attributes))?(this.trigger("dragError",b),!1):{modelToAdd:c,newIndex:a}}}});
ETM.RestaurantFoodAndMapData=function(a,b){this.restaurant_names=[];this.id_to_restaurant_map_result_dict={};this.restaurant_name_to_id_dict={};this.restaurant_name_to_color_dict={};this.only_show_restaurants_with_foods=b;var c=this;a.forEach(function(a){c.id_to_restaurant_map_result_dict[a.id]=a;var b=Helper.removePunctuationAndLowerCase(a.name);_.has(c.restaurant_name_to_id_dict,b)?c.restaurant_name_to_id_dict[b].push(a.id):(c.restaurant_name_to_id_dict[b]=[a.id],c.restaurant_names.push(a.name))});
this.addRestaurantMealData=function(a,b){c.restaurant_meals_dict=a;c.nutrition_sorted_meals=[];c.restaurant_name_sorted_meal_lists=[];null!=a&&"object"===typeof a&&$.each(a,function(a,d){if(0<d.length||!c.only_show_restaurants_with_foods){for(var h=0;h<d.length;h++){var l=d[h];if(0==c.nutrition_sorted_meals.length)c.nutrition_sorted_meals.push(l);else for(var m=0;m<c.nutrition_sorted_meals.length;m++)if(l.score<c.nutrition_sorted_meals[m].score){c.nutrition_sorted_meals.insert(m,l);break}else if(m==
c.nutrition_sorted_meals.length-1){c.nutrition_sorted_meals.push(l);break}}h=new ETM.MealList;h.restaurant_name=a;for(l=0;l<d.length;l++){m=d[l];m.restaurant_name=a;var p=new ETM.SimpleFoodList(m.foods);(0<p.length||!$(".only_show_restaurants_with_foods",c.el).is(":checked"))&&h.add(new ETM.MealObject({foods:p,meal_type:b,restaurant_name:a,score:m.score}))}c.restaurant_name_sorted_meal_lists.push(h)}})}};
ETM.SidebarRecipeList=ETM.FoodList.extend({url:ROOT+"/food/search/",initialize:function(a,b){this.food_info_object_list=new ETM.FoodInfoObjectList(a)},sync:function(a,b,c){if("read"===a){var d=this;$.ajax({type:"GET",url:d.url,data:c.data,success:function(a){a.objects.forEach(function(a){a=new ETM.FoodInfoObject(a,{parse:!0});d.food_info_object_list.add(a);a=new ETM.FoodObject({food:a,amount:1,units:a.attributes.default_units},{skip_global:!0});a.is_custom=!1;d.add(a)});c.success(d.models)},error:function(){console.log("error with fetch")}})}},
search:function(a,b){$(".recipe_list",this.el).hide();$.get("/sidebarsearch/recipes/?q="+encodeURIComponent(a),function(c){try{if(null!=c){var d=jQuery.parseJSON(c);b(d);return}}catch(e){_errs.meta.type_of_data=typeof c,_errs.meta.search_data=c,_errs.meta.search_query=a,_errs.push(e)}b([])})}});
ETM.SidebarBasicFoodList=ETM.FoodList.extend({initialize:function(a,b){this.structure={Proteins:{"Red Meats":[5423,1615,1797,5341,3773],Poultry:[453,582,561,934],Fish:[3458,3373,3341],"Dairy and Others":[65,67,70,73,5809,103,104,98,96,5811,15,3646]},Carbs:{Grains:[4802,4807,4846,1112,4879,4025,1006,4888],"Starchy Vegetables":[2313,2211,1947],Legumes:[2070,3506,3555,3721],Fruit:[1337,1300,1463,1416,1484,1558,1343,1547],Vegetables:[1885,1914,1927,1971,1869,2025,2440,2150,2013,2170,2226]},Fats:[2632,
3584,2684,266,3734,2700,1334,1,105],Beverages:[65,67,70,73,5812,1468,1419,3099]};var c=this.numberList(this.structure);this.fetch_complete=!1;this.food_info_object_list=new ETM.FoodInfoObjectList(c)},numberList:function(a){var b=[],c;for(c in a)if("[object Array]"===Object.prototype.toString.call(a[c]))_.each(a[c],function(a){b.push({id:a})});else for(var d in a[c])_.each(a[c][d],function(a){b.push({id:a})});return b},search:function(a,b,c){var d=encodeURIComponent(a)+"&"+$.param(b);$.get("/sidebarsearch/foods/?q="+
d,function(a){try{if(null!=a){var b=jQuery.parseJSON(a);c(b);return}}catch(g){_errs.meta.type_of_data=typeof a,_errs.meta.search_data=a,_errs.meta.search_query=d,_errs.push(g)}c([])})},fetchFoodInfoObjects:function(a){var b=this;this.fetch_complete?a():$.when(this.food_info_object_list.fetch()).done(function(){var c=[];b.food_info_object_list.forEach(function(a){var e=b.returnFoodObject(a);a.sidebar_food_object=e;c.push(e)});b.reset(c);b.fetch_complete=!0;a()})}});
ETM.SidebarPantryList=ETM.SidebarBasicFoodList.extend({search:function(a,b,c){$.get("/sidebarsearch/pantry/recipes/?q="+encodeURIComponent(a),function(b){try{if(null!=b){var e=jQuery.parseJSON(b);c(e);return}}catch(f){_errs.meta.type_of_data=typeof b,_errs.meta.search_data=b,_errs.meta.search_query=a,_errs.push(f)}c([])})}});
ETM.CustomFoodList=ETM.FoodList.extend({model:ETM.FoodObject,url:function(){return this.options.url},initialize:function(a,b){this.options=b;this.url=b.url;this.food_info_object_list=new ETM.FoodInfoObjectList(null!=a?a:[],b);var c=this;this.listenTo(this.food_info_object_list,"add",function(a,b){var f=c.returnFoodObject(a);f.is_custom=!0;var g=this.food_info_object_list.indexOf(a);c.add(f,{at:g})},this)},fetchFoodInfoObjects:function(a){var b=this;this.fetch_complete?a():$.when(this.food_info_object_list.fetch({reset:!0})).done(function(){var c=
[];b.food_info_object_list.forEach(function(a){a=b.returnFoodObject(a);a.is_custom=!0;c.push(a)});b.reset(c);b.fetch_complete=!0;a()})},returnFoodObject:function(a){return new ETM.FoodObject({food:a,amount:1,units:a.attributes.default_units,is_custom:!1},{skip_global:!1})}});ETM.CustomRecipeList=ETM.CustomFoodList.extend({});
ETM.SidebarFavoritesList=ETM.FoodList.extend({eventsInitialized:!1,initializeEvents:function(){if(!this.eventsInitialized){var a=this;this.listenTo(ETM.favorite_foods_list,"add",function(b,c){_errs.meta.add_fav_food=b.attributes.food;_errs.meta.add_fav_model=JSON.stringify(b);var d=ETM.food_info_object_list.get(b.attributes.food),d=a.returnFoodObject(d,b);d.is_favorite=!0;d.is_custom=!1;d.child=b;b.sidebar_food_object=d;a.add(d,{at:0});a.trigger("addFavorite")});this.listenTo(ETM.favorite_foods_list,
"remove",function(b,c){b.sidebar_food_object.trigger("deleteItem");a.trigger("removeFavorite")});this.eventsInitialized=!0}},fetchFoodInfoObjects:function(a){var b=this,c=[];this.fetch_complete?a():ETM.favorite_foods_list.loadFoodInfoObjects().done(function(){ETM.favorite_foods_list.forEach(function(a){try{var e=b.returnFoodObject(ETM.food_info_object_list.get(a.attributes.food),a);e.is_favorite=!0;e.is_custom=!1;e.child=a;a.sidebar_food_object=e;c.push(e)}catch(f){_errs.meta.fetch_fav_food=JSON.stringify(a),
_errs.push(f)}});b.reset(c);b.fetch_complete=!0;a()})}});ETM.Sidebar=Backbone.Model.extend({});ETM.SimilarRecipeList=Backbone.Collection.extend({model:ETM.FoodObject,url:ROOT+"/food/get_similar_recipes/",initialize:function(a,b){this.food_info_object_list=new ETM.FoodInfoObjectList(a)},sync:function(){return!1}});ETM.CuratorProfile=Backbone.Model.extend({initialize:function(){}});ETM.CuratorProfileList=Backbone.Collection.extend({model:ETM.CuratorProfile,url:ROOT+"/curator/"});
ETM.FoodObjectWithChanges=ETM.FoodObject.extend({urlRoot:ROOT+"/foodobjectwithchanges/",relations:[{type:Backbone.One,key:"food",relatedModel:"ETM.FoodWithChanges"}],initialize:function(a,b){this.initializeEvents();this.is_selected=!1;this.calculateStats()}});
ETM.FoodWithChanges=ETM.FoodInfoObject.extend({remote:!0,urlRoot:ROOT+"/foodwithchanges/",relations:[{type:Backbone.Many,key:"ingredients",relatedModel:"ETM.IngredientObject",collectionType:"ETM.IngredientsList"},{type:Backbone.Many,key:"directions",relatedModel:"ETM.Direction",collectionType:"ETM.DirectionsList"},{type:Backbone.Many,key:"images",relatedModel:"ETM.FoodImage",collectionType:"ETM.FoodImageList",customSerialize:function(a){a.models.forEach(function(a){delete a.attributes.resource_uri});
return a}},{type:Backbone.Many,key:"changes",relatedModel:"ETM.FoodChanges",collectionType:"ETM.FoodChangesList"}]});ETM.FoodWithChangesList=ETM.FoodInfoObjectList.extend({model:ETM.FoodWithChanges,remote:!0,urlRoot:ROOT+"/foodwithchanges/"});
ETM.FoodChanges=ETM.FoodInfoObject.extend({remote:!0,urlRoot:ROOT+"/foodchanges/",initialize:function(){this.schema.default_units={type:"Select",value_type:"Number",options:[]};for(var a=0;a<this.attributes.weights.length;a++){var b=this.attributes.weights[a];this.schema.default_units.options.push({val:a,label:b.amount+" "+b.description})}},relations:[{type:Backbone.Many,key:"mapped_meal_tags",relatedModel:"ETM.MealTag",collectionType:"ETM.MealTagList",map:function(a){var b=[];for(i=0;i<a.length;i++)if(1==
a[i]){var c=ETM.meal_tag_list.get(i);c&&b.push(c)}return b},customSerialize:function(a){var b="";for(i=0;64>i;i++)b+=a.get(i)?"1":"0";return b}}],addExtraFoodAttributesToChanges:function(a){this.attributes.serving_size_amount=a.get("food").attributes.weights[1].amount;this.attributes.serving_size_description=a.get("food").attributes.weights[1].description},schema:{food_name:"Text",description:"Text",breakfast:"Checkbox",single_serving:"Checkbox",keeps_well:"Checkbox",can_be_bulk:"Checkbox",is_snack:"Checkbox",
needs_blender:"Checkbox",needs_oven:"Checkbox",needs_stove:"Checkbox",needs_grill:"Checkbox",needs_slow_cooker:"Checkbox",needs_toaster:"Checkbox",needs_food_processor:"Checkbox",needs_microwave:"Checkbox",prep_time:{type:"PositiveNumber"},cook_time:{type:"PositiveNumber"},wait_time:{type:"PositiveNumber"},prep_day_before:"Checkbox",main_dish:{type:"SegmentedRadio",value_type:"Boolean",options:[{val:!1,label:"Side dish"},{val:!0,label:"Main dish"}]},category_id:{type:"Select",value_type:"Number",
options:[{val:1,label:"Appetizers"},{val:2,label:"Breakfast foods"},{val:3,label:"Desserts"},{val:4,label:"Drinks"},{val:5,label:"Mostly meat"},{val:6,label:"Protein shakes"},{val:7,label:"Salads"},{val:8,label:"Sandwiches"},{val:9,label:"Pasta"},{val:10,label:"Soups"},{val:11,label:"Other"}]},cuisine:"Text",tags:"Text",categories:"Text",number_servings:{type:"PositiveNumber"},blatantly_unhealthy:"Checkbox",curator_notes:"TextArea",rejection_notes:"TextArea",review_complete:"Checkbox",review_approved:"Checkbox",
review_rejected:"Checkbox",suggested_default_amount:{type:"PositiveNumber"},is_discrete:{type:"SegmentedRadio",value_type:"Boolean",options:[{val:!1,label:"Continuous"},{val:!0,label:"Discrete"}]},minimum_discrete_amount:{type:"PositiveNumber"},perishable:"Checkbox",expiration_time:{type:"PositiveNumber"},veggie_servings:{type:"PositiveNumber"},fruit_servings:{type:"PositiveNumber"},default_package_amount:{type:"PositiveNumber"},gram_weight_0:{type:"PositiveNumber"},gram_weight_0_amount:{type:"PositiveNumber"},
gram_weight_0_description:"Text",gram_weight_1:{type:"PositiveNumber"},gram_weight_1_amount:{type:"PositiveNumber"},gram_weight_1_description:"Text",gram_weight_2:{type:"PositiveNumber"},gram_weight_2_amount:{type:"PositiveNumber"},gram_weight_2_description:"Text",gram_weight_3:{type:"PositiveNumber"},gram_weight_3_amount:{type:"PositiveNumber"},gram_weight_3_description:"Text",gram_weight_4:{type:"PositiveNumber"},gram_weight_4_amount:{type:"PositiveNumber"},gram_weight_4_description:"Text",gram_weight_5:{type:"PositiveNumber"},
gram_weight_5_amount:{type:"PositiveNumber"},gram_weight_5_description:"Text",gram_weight_6:{type:"PositiveNumber"},gram_weight_6_amount:{type:"PositiveNumber"},gram_weight_6_description:"Text",gram_weight_7:{type:"PositiveNumber"},gram_weight_7_amount:{type:"PositiveNumber"},gram_weight_7_description:"Text",gram_weight_8:{type:"PositiveNumber"},gram_weight_8_amount:{type:"PositiveNumber"},gram_weight_8_description:"Text"}});
ETM.FoodChangesList=ETM.FoodInfoObjectList.extend({model:ETM.FoodChanges,url:ROOT+"/foodchanges/"});ETM.StripeInvoice=Backbone.Model.extend({remote:!0,urlRoot:"/payments/stripe-invoice-history/"});ETM.StripeInvoiceList=Backbone.Collection.extend({remote:!0,model:ETM.StripeInvoice,url:"/payments/stripe-invoice-history/"});
ETM.TemplateDiet=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/dailytemplate/",relations:[{type:Backbone.One,key:"diet",relatedModel:"ETM.Diet"},{type:Backbone.One,key:"user",relatedModel:"ETM.UserProfile",isTransient:!0}]});
ETM.TemplateDietList=Backbone.Collection.extend({model:ETM.TemplateDiet,url:ROOT+"/dailytemplate/",SINGLE_TEMPLATE_WEEKDAY:6,SINGLE_TEMPLATE_INDEX:0,clearLeftoversMealAttributes:function(){_.each(this.models,function(a){_.each(a.attributes.diet.attributes.meals.models,function(a){a.parent_leftovers_meal=!1;a.child_leftovers_meal=!1;delete a.chain_color_int})})},setLeftoversGroup:function(a,b,c){var d=a[0];d.parent_leftovers_meal=!0;d.chain_color_int=b.chain_color_int;d.number_leftovers_dishes=b.attributes.number_dishes;
d.leftovers_order=0;d.group_number=c;for(d=1;d<a.length;d++){var e=a[d];e.child_leftovers_meal=!0;e.chain_color_int=b.chain_color_int;e.number_leftovers_dishes=b.attributes.number_dishes;e.leftovers_order=d;e.group_number=c}},linkLeftoversMeals:function(a){var b=this;this.clearLeftoversMealAttributes();for(var c=ETM.current_user_profile.get("shopping_day"),d=[],e=[],f=0;7>f;f++){var g=(c+f+1)%7;d.push(g);e.push(b.findWhere({weekday:g}))}var h=0;_.each(a.models,function(a,c){a.meal_groups=[];var f=
a.get("days_to_save_leftovers"),g=a.get("parent_meal_type"),s=a.get("child_meal_types"),u=-1,v=0,q=0,r=0;a.attributes.repeat||(r=d.indexOf(a.attributes.start_day));for(var t=0;7>t;t++){var x=e[t],w=!1;if(!(t<r)){var y=t,B=_.find(x.attributes.diet.attributes.meals.models,function(a){if(!(a.attributes.meal_type.attributes.resource_uri!==g||a.parent_leftovers_meal||a.child_leftovers_meal||y===v&&a.attributes.meal_number<=u))return a});if(B){for(var q=t,w=!0,A=[B],z=t;z<=t+f;z++)e.length>z&&_.each(e[z].attributes.diet.attributes.meals.models,
function(a){-1===s.indexOf(a.attributes.meal_type.attributes.resource_uri)||a.parent_leftovers_meal||a.child_leftovers_meal||z===t&&a.attributes.meal_number<=B.attributes.meal_number||(A.push(a),u=a.attributes.meal_number,v=z)});1<A.length&&(b.setLeftoversGroup(A,a,h),a.meal_groups.push(A),h++)}if(w)if(a.attributes.repeat)r=q+f;else break}}})},buildSingleTemplateDietList:function(){for(var a=new ETM.TemplateDietList,b=this.findWhere({weekday:this.SINGLE_TEMPLATE_WEEKDAY}),c=0;7>c;c++){var d=b.clone();
Helper.clearIDs(d);var e=(6+c)%7;d.attributes.weekday=e;var f=d.attributes.diet;Helper.clearIDs(f);f.attributes.meals.each(function(a){Helper.clearIDs(a);a.attributes.diet_plan=e});a.add(d)}return a},getTemplateDietList:function(){return ETM.current_user_profile.attributes.single_template_diet?ETM.template_diet_list.buildSingleTemplateDietList():ETM.template_diet_list},getTemplateDietAtIndex:function(a){return ETM.current_user_profile.attributes.single_template_diet?ETM.template_diet_list.at(this.SINGLE_TEMPLATE_INDEX):
ETM.template_diet_list.at(a)},getTemplateDietForWeekday:function(a){return ETM.current_user_profile.attributes.single_template_diet?ETM.template_diet_list.at(this.SINGLE_TEMPLATE_INDEX):ETM.template_diet_list.findWhere({weekday:a})},getTemplateDietForResourceUri:function(a){return ETM.current_user_profile.attributes.single_template_diet?ETM.template_diet_list.at(this.SINGLE_TEMPLATE_INDEX):ETM.template_diet_list.get(a)}});
Date.prototype.stdTimezoneOffset=function(){var a=new Date(this.getFullYear(),0,1),b=new Date(this.getFullYear(),6,1);return Math.max(a.getTimezoneOffset(),b.getTimezoneOffset())};
function determine_utc_offset(){var a=(new Date).stdTimezoneOffset()/-60;return-11.5>a?"-12":-10.5>a?"-11":-9.5>a?"-10":-8.5>a?"-9":-7.5>a?"-8":-6.5>a?"-7":-5.5>a?"-6":-4.5>a?"-5":-3.75>a?"-4":-3.25>a?"-3.5":-2.5>a?"-3":-1.5>a?"-2":-0.5>a?"-1":0.5>a?"0":1.5>a?"1":2.5>a?"2":3.25>a?"3":3.75>a?"3.5":4.25>a?"4":4.75>a?"4.5":5.25>a?"5":5.65>a?"5.5":5.85>a?"5.75":6.5>a?"6":7.5>a?"7":8.5>a?"8":9.25>a?"9":9.75>a?"9.5":10.5>a?"10":11.5>a?"11":"12"}
ETM.UserProfile=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/userprofile/",defaults:{activity_level:null,age:null,bodyfat:null,todays_weight:null,weight_goal:null,weight_goal_date:Helper.convertDateToString(new Date((new Date).setMonth((new Date).getMonth()+8))),weight_goal_weekly_rate:null,custom_exclusions:"",daily_price_limit:10,exclusions:"",friend_signups:0,friend_successes:0,gender:null,goal:null,hide_gender:!0,limit_price:!1,link_clicks:0,months_saved_up:0,number_curated_recipes:0,preset_diet:"anything",
total_months_earned:0,units:"I",use_leftovers:!1,complexity_level:1,generator_focus:0,show_walkthrough_prompt:!0,single_template_diet:!0,timezone:determine_utc_offset(),shopping_day:5},schema:{goal:{type:"SegmentedRadio",validators:["required"],options:[{val:"L",label:"Lose weight"},{val:"M",label:"Maintain health"},{val:"G",label:"Gain weight"}]},units:{type:"SegmentedRadio",validators:["required"],options:[{val:"I",label:"Imperial"},{val:"M",label:"Metric"}]},gender:{type:"SegmentedRadio",validators:["required"],
options:[{val:"M",label:"Male"},{val:"F",label:"Female"}]},age:{type:"PositiveNumber"},weight:{type:"PositiveNumber"},bodyfat:{type:"SegmentedRadio",value_type:"Number",validators:["required"],options:[{val:10,label:"Low"},{val:20,label:"Medium"},{val:30,label:"High"}]},activity_level:{type:"Select",validators:["required"],options:[{val:"1.2",label:"Sedentary"},{val:"1.375",label:"Lightly Active"},{val:"1.55",label:"Moderately Active"},{val:"1.725",label:"Very Active"},{val:"1.9",label:"Extremely Active"}]},
shopping_day:{type:"Select",value_type:"Number",options:[{val:6,label:"Sunday"},{val:0,label:"Monday"},{val:1,label:"Tuesday"},{val:2,label:"Wednesday"},{val:3,label:"Thursday"},{val:4,label:"Friday"},{val:5,label:"Saturday"}]},timezone:{type:"Select",value_type:"Number",options:[{val:-12,label:"(GMT -12:00) Eniwetok, Kwajalein"},{val:-11,label:"(GMT -11:00) Midway Island, Samoa"},{val:-10,label:"(GMT -10:00) Hawaii"},{val:-9,label:"(GMT -9:00) Alaska"},{val:-8,label:"(GMT -8:00) Pacific Time (US &amp; Canada)"},
{val:-7,label:"(GMT -7:00) Mountain Time (US &amp; Canada)"},{val:-6,label:"(GMT -6:00) Central Time (US &amp; Canada), Mexico City"},{val:-5,label:"(GMT -5:00) Eastern Time (US &amp; Canada), Bogota, Lima"},{val:-4,label:"(GMT -4:00) Atlantic Time (Canada), Caracas, La Paz"},{val:-3.5,label:"(GMT -3:30) Newfoundland"},{val:-3,label:"(GMT -3:00) Brazil, Buenos Aires, Georgetown"},{val:-2,label:"(GMT -2:00) Mid-Atlantic"},{val:-1,label:"(GMT -1:00 hour) Azores, Cape Verde Islands"},{val:0,label:"(GMT) Western Europe Time, London, Lisbon, Casablanca"},
{val:1,label:"(GMT +1:00 hour) Brussels, Copenhagen, Madrid, Paris"},{val:2,label:"(GMT +2:00) Kaliningrad, South Africa"},{val:3,label:"(GMT +3:00) Baghdad, Riyadh, Moscow, St. Petersburg"},{val:3.5,label:"(GMT +3:30) Tehran"},{val:4,label:"(GMT +4:00) Abu Dhabi, Muscat, Baku, Tbilisi"},{val:4.5,label:"(GMT +4:30) Kabul"},{val:5,label:"(GMT +5:00) Ekaterinburg, Islamabad, Karachi, Tashkent"},{val:5.5,label:"(GMT +5:30) Bombay, Calcutta, Madras, New Delhi"},{val:5.75,label:"(GMT +5:45) Kathmandu"},
{val:6,label:"(GMT +6:00) Almaty, Dhaka, Colombo"},{val:7,label:"(GMT +7:00) Bangkok, Hanoi, Jakarta"},{val:8,label:"(GMT +8:00) Beijing, Perth, Singapore, Hong Kong"},{val:9,label:"(GMT +9:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk"},{val:9.5,label:"(GMT +9:30) Adelaide, Darwin"},{val:10,label:"(GMT +10:00) Eastern Australia, Guam, Vladivostok"},{val:11,label:"(GMT +11:00) Magadan, Solomon Islands, New Caledonia"},{val:12,label:"(GMT +12:00) Auckland, Wellington, Fiji, Kamchatka"}]}},weight_goal_schema:function(){return _.extend({},
this.schema,{todays_weight:{type:"ImperialNumber",current_units:ETM.current_user_profile.attributes.units,conversion:"lbs-kgs"},weight_goal:{type:"ImperialNumber",current_units:ETM.current_user_profile.attributes.units,conversion:"lbs-kgs"},weight_goal_date:{type:"Date",yearStart:(new Date).getFullYear(),yearEnd:(new Date).getFullYear()+5,formatValue:function(a,b,c){return Helper.convertDateToString(new Date(a,b,c))}},weight_goal_weekly_rate:{type:"ImperialNumber",current_units:ETM.current_user_profile.attributes.units,
conversion:"lbs-kgs",editorAttrs:{step:"0.1"}}})},premium_signup_schema:function(){return _.extend({},this.schema,{generator_focus:{type:"SegmentedRadio",value_type:"Number",options:[{val:0,label:"Balanced"},{val:1,label:"Variety"},{val:2,label:"Macros"},{val:3,label:"Groceries"}]}})},initialize:function(){this.get("timezone")&&"undefined"!==typeof this.get("timezone")||this.set("timezone",determine_utc_offset());if(null==this.complexity_level||isNaN(this.complexity_level))this.complexity_level=1;
if(null==this.daily_price_limit||isNaN(this.daily_price_limit))this.daily_price_limit=10;if(this.attributes.weight&&this.attributes.weight_goal&&this.attributes.weight_goal_date){var a=this.attributes.weight_goal-this.attributes.weight,b=Helper.days_between(Helper.parseDateString(this.attributes.weight_goal_date),new Date)/7;this.set({weight_goal_weekly_rate:roundNumber(a/b,1)})}},isSubscriber:function(){return null!=this.attributes.subscription&&-1!==this.attributes.subscription.plan.toLowerCase().indexOf("pro")},
isWebMonthly:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.plan.toLowerCase().indexOf("web_monthly")},isWebYearly:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.plan.toLowerCase().indexOf("web_yearly")},hasProSubscription:function(){return this.isSubscriber()&&"pro"===this.attributes.subscription.plan.toLowerCase()},hasManagerSubscription:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.plan.toLowerCase().indexOf("manager")},
hasIosSubscription:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.price.toLowerCase().indexOf("ios")},hasAndroidSubscription:function(){return this.isSubscriber()&&-1!==this.attributes.subscription.price.toLowerCase().indexOf("android")},isImperialUnits:function(){return"I"===this.attributes.units},generator_focus_toolip_text:function(){return'<strong>Balanced</strong><br/><p align="left">Default that focuses on variety, macros, and groceries evenly.</p><br /><strong>Variety</strong><br/><p align="left">Focuses on increasing variety in the plans as much as possible, at the expense of always hitting macros and keeping the grocery list short.</p><br /><strong>Macros</strong><br/><p align="left">Focuses on hitting the macro targets exactly, at the expense of variety and the grocery list.</p><br /><strong>Groceries</strong><br/><p align="left">Focuses on keeping the grocery list short and using up known package sizes of foods exactly, at the expense of variety and hitting macros.  Expect to see more identical or similar foods throughout the week.</p><br />'},
shopping_day_tooltip_text:function(){return"<p align=\"left\">Select when you can go grocery shopping. Your weekly plan will be sent the day before your shopping day, and the first meal plan will start the day after the shopping day (e.g. receive email on Saturday, go shopping on Sunday, meal plans start Monday).<br/><br/>As soon as you finish signing up, you will also receive an emailed meal plan for the days leading up to your first shopping day. If your shopping day is within the next 3 days, you'll receive next week's plan as well.</p>"},
regenerate_week_shopping_day_text:function(){return'<p align="left">Select when you can go grocery shopping. The meal plans start the day after your shopping day, so if you want to change which weeks you can generate, switch it here. If you want to generate a new week that starts today, switch your grocery shopping day to yesterday (this also lets you generate the next two full weeks of plans).<br/><br/>Changing the setting here will switch it in your profile as well, and the weekly generator will continue to automatically run the day before your grocery shopping day.</p>'},
activity_level_tooltip_text:function(){return'<strong>Sedentary</strong><br/><p align="left">Little or no exercise and desk job</p><br /><strong>Lightly Active</strong><br/><p align="left">Light daily activity & some exercise 1-3 days a week </p><br /><strong>Moderately Active</strong><br/><p align="left">Moderately active daily life & exercise 3-5 days a week</p><br /><strong>Very Active</strong><br/><p align="left">Physically demanding lifestyle & Hard exercise or sports 6-7 days a week</p><br /><strong>Extremely Active</strong><br/><p align="left">Hard daily exercise or sports and physical job</p><br />'},
bodyfat_tooltip_text:function(){return"<p align=\"left\">Body fat percentage is the total mass of fat divided by total body mass.  The typical bodyfat percentage is 18\u201324% for an average male and 25-31% for an average female according to wikipedia.  If you don't know yours it's not a big deal - we only use it to estimate your lean body mass and change the minimum amount of protein recommended in the nutrition calculator.</p>"},validationErrorsForCalculator:function(a){var b=!0,c=[];if((!app||
"undefined"!==typeof ANDROID_APP_VERSION&&1.99>ANDROID_APP_VERSION||"undefined"!==typeof IOS_APP_VERSION&&1.89>IOS_APP_VERSION)&&0<this.attributes.weight&&0<this.attributes.weight_goal&&null!=this.attributes.weight_goal_date){var d=new Date;if(+Helper.parseDateString(this.attributes.weight_goal_date)<=+d)c.push("Weight goal date must be in the future"),b=!1;else{var d=this.attributes.weight_goal-this.attributes.weight,e=Helper.days_between(Helper.parseDateString(this.attributes.weight_goal_date),
new Date)/7;this.set({weight_goal_weekly_rate:roundNumber(d/e,1)})}}0<!this.attributes.height&&(c.push("Height must be greater than zero"),b=!1);0<!this.attributes.weight&&(c.push("Weight must be greater than zero"),b=!1);0<!this.attributes.age&&(c.push("Age must be greater than zero"),b=!1);0<!this.attributes.bodyfat&&(c.push("Body fat must be greater than zero"),b=!1);b||null==a||a({valid:b,errors:c.join("\n")});return c},nutrition_calculator_schema:function(){var a=this.weight_goal_schema();delete a.shopping_day;
delete a.timezone;return a}});ETM.UserProfileList=Backbone.Collection.extend({model:ETM.UserProfile,url:ROOT+"/userprofile/"});ETM.WeightEntry=Backbone.AssociatedModel.extend({urlRoot:ROOT+"/weightentry/",getWeightForCurrentUnits:function(){return"M"==ETM.current_user_profile.attributes.units?0.453592*this.attributes.weight:this.attributes.weight}});
ETM.WeightEntryList=Backbone.Collection.extend({url:ROOT+"/weightentry/",model:ETM.WeightEntry,initialize:function(){this.listenTo(ETM.current_user_profile,"change:weight",function(a){var b=this.findWhere({date:Helper.convertDateToString(new Date)});null!=b?b.attributes.weight=a.attributes.weight:(b=new ETM.WeightEntry({date:Helper.convertDateToString(new Date),weight:a.attributes.weight}),this.add(b))},this)},comparator:function(a){return Helper.parseDateString(a.get("date")).getTime()},minWeightEntry:function(){if(0==
this.length)return null;var a=this.at(0);this.forEach(function(b){b.attributes.weight<a.attributes.weight&&(a=b)});return a},maxWeightEntry:function(){if(0==this.length)return null;var a=this.at(0);this.forEach(function(b){b.attributes.weight>a.attributes.weight&&(a=b)});return a}});var load_text_timer,global_food_pool;
function varyLoadingText(a){var b=[" Combobulating calories...; Frying fish...; Chopping onions...; Crying because of onions; Crying because of onions; Cleaning up...; Almost there...".split(";")," Sorting strawberries...;Massaging mushrooms...;Baking blue bananas...;Baking blue bananas...;Cleaning up...;Almost there...".split(";")," Combobulating calories...; Mincing macros...; Foraging for figs...; Foraging for figs...; Found some!; Cleaning up...; Almost there...".split(";")," Flipping four flapjacks...; Picking pickled peppers...; Picking pickled peppers...; Feeling like falafel...; Cleaning up...; Almost there...".split(";")],
c=b[Helper.randomNumber(b.length)];if("start"===a){$(".loading_text").html(" Loading foods...");clearTimeout(load_text_timer);var d=0,e=function(){$(".loading_text").html(c[d]);d++;d<c.length&&(load_text_timer=setTimeout(e,1E3))};load_text_timer=setTimeout(e,1E3)}else clearTimeout(load_text_timer)}
ETM.food_pool={loadFoodPool:function(a,b,c){current_scheme=ETM.food_pool.compileSchemeForDiet(a);ETM.scheme_validation_element.hide();if(ETM.food_pool.schemesAreEqual(ETM.last_scheme,current_scheme)&&!ETM.reload_food_pool){if(!ETM.food_pool.schemeIsValid(current_scheme,ETM.scheme_validation_element))return a.trigger("finishedGenerating"),ETM.currently_generating=!1;b()}else if(ETM.reload_food_pool=!1,ETM.recently_blocked=[],ETM.food_pool.schemeIsValid(current_scheme,ETM.scheme_validation_element)){$("#downloading_status").show();
$("#fixed_downloading_status").show();varyLoadingText("start");c=JSON.stringify(current_scheme);var d=[];ETM.food_info_object_list.each(function(a){d.push(a.attributes.id)});var e=JSON.stringify(d);$.post("/allfoods/returnpool/",{scheme_obj:c,existing_foods:e},function(c){try{var d=JSON.parse(c)}catch(e){throw _errs.meta.return_pool_null=null==c,_errs.meta.return_pool_length=c.length,_errs.meta.json_last_100=100<c.length?c.substr(c.length-100):c,e;}ETM.scheme_validation_element.hide();ETM.last_scheme=
$.extend(!0,{},current_scheme);add_food_info_objects(d.all_foods);ETM.food_pool.addToGlobalFoodPool(d.food_pool,a);varyLoadingText("stop");$("#downloading_status").hide();$("#fixed_downloading_status").hide();$(".tooltip.fade").hide();ETM.food_pool.returnPoolIsValid(a,current_scheme.num_meals,ETM.scheme_validation_element)?b():(a.trigger("finishedGenerating"),ETM.currently_generating=!1);return!1}).fail(function(b,c,d){_errs.meta.return_pool_msg=c;_errs.push(d);ETM.scheme_validation_element.html("<span class='glyphicon glyphicon-exclamation-sign'></span> There was an error while fetching food data. Refreshing the page should fix it, but if you see this error repeatedly, please send us an email at <a href='mailto:contact@eatthismuch.com'>contact@eatthismuch.com</a>");
ETM.scheme_validation_element.show();$("#downloading_status").hide();$("#fixed_downloading_status").hide();a.trigger("finishedGenerating");return ETM.currently_generating=!1})}else return a.trigger("finishedGenerating"),ETM.currently_generating=!1},addToGlobalFoodPool:function(a,b){global_food_pool={};for(var c=0;c<b.attributes.num_meals;c++){var d="meal_"+c,e=a[d];global_food_pool[d]={main_dishes:[],side_dishes:[]};try{ETM.food_pool.addDishesToFoodPool(e.main_dishes,c,"main_dishes",!1),ETM.food_pool.addDishesToFoodPool(e.side_dishes,
c,"side_dishes",!1)}catch(f){$.extend(_errs.meta,{meal_key:d,foods_json_null:null==e,num_meals:b.attributes.num_meals,meals_length:b.attributes.meals.length})}for(var d=b.meal(c).attributes.meal_type,d=ETM.recurring_foods_list.where({meal_type:d.id,frequency:0}),e=[],g=[],h=0;h<d.length;h++)d[h].get("food").get("main_dish")?e.push(d[h].get("food")):g.push(d[h].get("food"));ETM.food_pool.addDishesToFoodPool(e,c,"recurring_main_dishes",!0);ETM.food_pool.addDishesToFoodPool(g,c,"recurring_side_dishes",
!0);global_food_pool["meal_"+c].recurring_main_dishes.forEach(function(a){a.is_recurring=!0});global_food_pool["meal_"+c].recurring_side_dishes.forEach(function(a){a.is_recurring=!0})}},addDishesToFoodPool:function(a,b,c,d){global_food_pool.hasOwnProperty("meal_"+b)||(global_food_pool["meal_"+b]=[]);global_food_pool["meal_"+b].hasOwnProperty(c)||(global_food_pool["meal_"+b][c]=[]);for(var e=0;e<a.length;e++){var f;f=d?ETM.food_pool.convertFoodInfoObject(a[e]):ETM.food_pool.convertFoodObject(a[e]);
global_food_pool["meal_"+b][c].push(f)}},convertFoodObject:function(a){var b="string"===typeof a.food_id&&0==a.food_id.indexOf(ROOT)?ETM.food_info_object_list.get(a.food_id):ETM.food_info_object_list.get(ROOT+"/food/"+a.food_id+"/"),b=new ETM.GeneratorFoodObject({food:b,units:b.attributes.default_units,amount:1});b.weight=a.weight?a.weight:0;"M"===ETM.current_user_profile.attributes.units&&b.attributes.food.attributes.accurate_grams&&0!=b.attributes.food.attributes.default_units&&hasImperial(b.attributes.food.attributes.weights[b.attributes.food.attributes.default_units].description)?
(b.attributes.units=0,a=parseFloat(b.attributes.food.attributes.weights[b.attributes.food.attributes.default_units].grams)/100,b.attributes.amount=roundNumber(10*Math.round((a+4.9)/10)/100,1)):(b.attributes.amount=1,b.attributes.units=b.attributes.food.attributes.default_units);return b},convertFoodInfoObject:function(a){a=new ETM.GeneratorFoodObject({food:a,units:a.attributes.default_units,amount:1});a.weight=0;if("M"===ETM.current_user_profile.attributes.units&&a.attributes.food.attributes.accurate_grams&&
0!=a.attributes.food.attributes.default_units&&hasImperial(a.attributes.food.attributes.weights[a.attributes.food.attributes.default_units].description)){a.attributes.units=0;var b=parseFloat(a.attributes.food.attributes.weights[a.attributes.food.attributes.default_units].grams)/100;a.attributes.amount=roundNumber(10*Math.round((b+4.9)/10)/100,1)}else a.attributes.amount=1,a.attributes.units=a.attributes.food.attributes.default_units;return a},loadDietFoods:function(a,b){var c=[];a.meals.collection.each(function(a){a.foods.collection.each(function(a){"number"===
typeof a.attributes.food&&(_.has(ETM.food_pool.all_foods,a.attributes.food)||c.append(a.attributes.food))})})},downloadFoods:function(a,b){$.get(ROOT+"/foods/",a,function(a){JSON.parse(a).forEach(function(a){ETM.food_pool.all_foods[a.id]=a});b()})},validateNumMeals:function(a){_errs.meta.num_meals=a.attributes.num_meals;_errs.meta.meals_length=a.attributes.meals.length;a.attributes.num_meals>a.attributes.meals.length&&a.createMealsIfNeeded()},repairDietSettings:function(a){this.validateNumMeals(a);
null==a.attributes.nutrition_profile.attributes.max_carbs&&(a.attributes.nutrition_profile.attributes.max_carbs=1E3);null==a.attributes.nutrition_profile.attributes.max_fats&&(a.attributes.nutrition_profile.attributes.max_fats=1E3);null==a.attributes.nutrition_profile.attributes.max_proteins&&(a.attributes.nutrition_profile.attributes.max_proteins=1E3);null==a.attributes.nutrition_profile.attributes.min_carbs&&(a.attributes.nutrition_profile.attributes.min_carbs=0);null==a.attributes.nutrition_profile.attributes.min_fats&&
(a.attributes.nutrition_profile.attributes.min_fats=0);null==a.attributes.nutrition_profile.attributes.min_proteins&&(a.attributes.nutrition_profile.attributes.min_proteins=0);null==a.attributes.nutrition_profile.attributes.macro_scheme&&(a.attributes.nutrition_profile.attributes.macro_scheme="grams");if(null==a.attributes.nutrition_profile.attributes.calories||"undefined"===typeof a.attributes.nutrition_profile.attributes.calories)a.attributes.nutrition_profile.attributes.calories=2E3;a.attributes.meals.forEach(function(a,
c){null==a.attributes.meal_type.attributes.breakfast&&(a.attributes.meal_type.attributes.breakfast=1);null==a.attributes.meal_type.attributes.max_cooktime&&(a.attributes.meal_type.attributes.max_cooktime=30);null==a.attributes.meal_type.attributes.max_preptime&&(a.attributes.meal_type.attributes.max_preptime=30);null==a.attributes.meal_type.attributes.max_totaltime&&(a.attributes.meal_type.attributes.max_totaltime=30);null==a.attributes.meal_type.attributes.min_cooktime&&(a.attributes.meal_type.attributes.min_cooktime=
0);null==a.attributes.meal_type.attributes.min_preptime&&(a.attributes.meal_type.attributes.min_preptime=0);null!=a.attributes.meal_number&&a.attributes.meal_number==c||a.save({meal_number:c},{async:!1})})},compileSchemeForDiet:function(a){this.repairDietSettings(a);var b={};b.num_meals=a.attributes.num_meals;b.exclusions=ETM.current_user_profile.attributes.exclusions;b.preset_diet=ETM.current_user_profile.attributes.preset_diet;b.daily_price_limit=ETM.current_user_profile.attributes.daily_price_limit;
b.limit_price=ETM.current_user_profile.attributes.limit_price;b.use_leftovers=ETM.current_user_profile.attributes.use_leftovers;b.metric_default="M"===ETM.current_user_profile.attributes.units;$.extend(b,a.attributes.nutrition_profile.attributes);var c=!1;a.attributes.meals.forEach(function(a,e){b["meal_"+a.attributes.meal_number]=a.attributes.meal_type.attributes;null==b["meal_"+a.attributes.meal_number].id&&(c=!0)});ETM.is_logged_in&&(null==b.id||c)&&($.extend(_errs.meta,{local_storage_load_complete:ETM.current_user_profile.attributes.local_storage_load_complete,
local_storage:ETM.use_local_storage,local_storage_failed:ETM.local_storage_failed,model_local:Backbone.Model.prototype.local,model_remote:Backbone.Model.prototype.remote,collection_local:Backbone.Collection.prototype.local,collection_remote:Backbone.Collection.prototype.remote,missing_meal_id:c,scheme_obj:JSON.stringify(b)}),_errs.push(Error("Scheme object missing ids")));return b},macroTotals:function(a){if("grams"==a.macro_scheme)var b=[[a.min_carbs,a.max_carbs],[a.min_fats,a.max_fats],[a.min_proteins,
a.max_proteins]];else{var b=Math.ceil(a.calories*(a.percent_carbs/100))/4,c=Math.ceil(a.calories*(a.percent_fats/100))/9;a=Math.ceil(a.calories*(a.percent_proteins/100))/4;b=[[b-4,b+4],[c-2,c+2],[a-4,a+4]]}return b},schemesAreEqual:function(a,b){return JSON.stringify(a)===JSON.stringify(b)},returnPoolIsValid:function(a,b,c){a=[];for(var d=0;d<b;d++){var e=ETM.current_diet.attributes.meals.at(d).attributes.meal_type,f=global_food_pool["meal_"+d];try{(1>f.side_dishes.length&&1>f.main_dishes.length||
e.attributes.only_use_recurring&&0==ETM.recurring_foods_list.where({meal_type:e.id}).length)&&a.push(d+1)}catch(g){_errs.meta.meal_undefined=null==f;_errs.meta.global_food_pool_undefined=null==global_food_pool;for(var h in f)f.hasOwnProperty(h)&&(_errs.meta[h]=f[h].length);for(var l in global_food_pool)global_food_pool.hasOwnProperty(l)&&(_errs.meta["global_"+l]=!0);_errs.push(g)}}if(0<a.length){c.show();var m="";a.forEach(function(a){a=ETM.current_diet.attributes.meals.at(a-1).attributes.meal_type;
a.attributes.only_use_recurring&&0==ETM.recurring_foods_list.where({meal_type:a.id}).length||(m+='<button class="btn btn-default edit_meal_type" data-id="'+a.id+'" style="margin:5px 5px">Edit '+a.attributes.title+"</button>")});b="We don't have enough foods to match your filters for meal(s) "+a.join(", ")+". Try loosening your food preferences or "+m+"and then hit generate again.<br/>";c.html(b);return!1}c.hide();return!0},schemeIsValid:function(a,b,c){if(0<a.num_meals&&2300<a.calories/a.num_meals||
100>a.calories/a.num_meals||isNaN(a.calories))return b.show(),b.html("For "+a.num_meals+" meals"+(null!=c?" on "+c+"'s template":"")+", please enter between "+100*a.num_meals+" and "+2300*a.num_meals+" calories on nutrition profile "+a.title+" or change your number of meals."),!1;for(c=0;c<a.num_meals;c++){var d=a["meal_"+c];if(d.only_use_recurring&&0==ETM.recurring_foods_list.where({meal_type:d.resource_uri}).length)return b.show(),b.html("Meal "+(c+1).toString()+" ("+d.title+') is set to only use recurring foods but has none. Try adding some recurring foods or turn off "only use recurring foods".<br/>'),
!1}if("percents"==a.macro_scheme){if(100!=a.percent_fats+a.percent_proteins+a.percent_carbs)return b.show(),b.html("Your macro proportions must equal 100 (currently "+(a.percent_fats+a.percent_proteins+a.percent_carbs)+") on nutrition profile "+a.title+"."),!1}else{c=4*a.min_carbs+9*a.min_fats+4*a.min_proteins;d=4*a.max_carbs+9*a.max_fats+4*a.max_proteins;if(c>a.calories)return b.show(),b.html("Your macronutrient settings need at least "+c+" calories.<br/>Is this an error? <a onclick='Helper.resetMacroSettings()'>Click here to reset the preferences</a>."),
!1;if(d<a.calories)return b.show(),b.html("Your macronutrient settings accomodate for at most "+d+" calories.<br/>Is this an error? <a onclick='Helper.resetMacroSettings()'>Click here to reset the preferences</a>."),!1}b.hide();return!0}};
var Generator={run:function(a,b){function c(b){d+=30/num_meals;app?bridge.callHandler("singleDayGeneratorProgress",d):$("#progressbar").progressbar({value:d});var e=minMaxServings(a,m[p],l),f=e[0],e=e[1],g=compileMainIngredients(a),r=new PopObject;r.init(a,h["meal_"+m[p]],l,m[p],f,e,g);f=mealgorithm(a,r,l,h["meal_"+m[p]],m[p],f,e,g);e=[];f&&(f.main_dish&&null!==f.main_dish.attributes.food&&0<f.main_dish.attributes.amount&&e.push(convertToFoodObject(f.main_dish)),f.side_dish1&&null!==f.side_dish1.attributes.food&&
0<f.side_dish1.attributes.amount&&e.push(convertToFoodObject(f.side_dish1)),f.side_dish2&&null!==f.side_dish2.attributes.food&&0<f.side_dish2.attributes.amount&&e.push(convertToFoodObject(f.side_dish2)));_.each(e,function(b){a.meal(m[p]).attributes.foods.add(b,{silent:!0})});a.meal(m[p]).calculateStats();p++;if(p>=n+1&&15>=f.score||p==3*n)return app?bridge.callHandler("singleDayGeneratorProgress",d):$("#progressbar").progressbar({value:100}),a.combineUnlocked(),app||$("#progressbar").fadeOut(1E3,
"easeInCirc"),b(a),!1;null!=m[p]&&(p>=n&&(lap_num=2),a.clearMeal(m[p]),a.meal(m[p]).calculateStats(),a.calculateStats(),l["meal"+m[p]]=dietDiff(a.stats,l,m[p]));setTimeout(function(){c(b)},1)}user_diet=!1;lap_num=1;num_meals=a.attributes.num_meals;total_iterations=0;var d=5;app?bridge.callHandler("singleDayGeneratorProgress",d):($("#progressbar").css("display","block"),$("#progressbar").progressbar({value:d}));for(var e=global_food_pool,f=0;f<num_meals;f++){for(var g=0;g<e["meal_"+f].main_dishes.length;g++)e["meal_"+
f].main_dishes[g].attributes.food||console.log(e["meal_"+f].main_dishes[g].attributes.food);for(g=0;g<e["meal_"+f].side_dishes.length;g++)e["meal_"+f].side_dishes[g].attributes.food||console.log(e["meal_"+f].side_dishes[g].attributes.food)}recent_foods_queue.clearQueue("all");recent_foods_queue.last_meal_generated="all";for(var h=recent_foods_queue.updateQueueAndFilterFoods(a,e),f=0;f<num_meals;f++)a.meal(f).attributes.eaten||(a.clearMealExceptLeftovers(f),a.addRecurringLockedFoods(f));var l=returnConstraints(a),
m=a.randomGeneratorMealOrder(h);app?bridge.callHandler("singleDayGeneratorProgress",d):(d+=5,$("#progressbar").progressbar({value:d}));var p=0,e=a.numberLockedMeals(),n=num_meals-e;0===n?(app?bridge.callHandler("singleDayGeneratorProgress",d):$("#progressbar").progressbar({value:100}),a.combineUnlocked(),app||$("#progressbar").fadeOut(1E3,"easeInCirc"),b(a)):(l["meal"+m[p]]=dietDiff(a.stats,l,m[p]),0==p&&c(b))},foodRemix:function(a,b,c){var d=b.meal(c).attributes.meal_type,e=a.attributes.food.attributes.main_dish?
!0:!1,f={};f.main_dishes=shuffle(excludeRecentlyBlocked($.extend([],global_food_pool["meal_"+c].main_dishes)));f.side_dishes=shuffle(excludeRecentlyBlocked($.extend([],global_food_pool["meal_"+c].side_dishes)));f.recurring_main_dishes=shuffle($.extend([],global_food_pool["meal_"+c].recurring_main_dishes));f.recurring_side_dishes=shuffle($.extend([],global_food_pool["meal_"+c].recurring_side_dishes));recent_foods_queue.clearQueue(c);recent_foods_queue.last_meal_generated=c;recent_foods_queue.setQueueLength(f,
c,d.attributes.only_use_recurring);recent_foods_queue.addDishesToQueue([a],c);var f=recent_foods_queue.excludeDishes(f,c),g=returnConstraints(b,!0);addStatsToTargets(g,a.stats);copyDayConstraintsToMeal(g,c);lap_num=2;if(e){a=[3,0,0];var h=[1,0,0]}else a=[0,3,0],h=[0,1,0];for(var l=new MealObject,m=[],m=d.attributes.only_use_recurring?e?f.recurring_main_dishes:f.recurring_side_dishes:e?f.recurring_main_dishes.concat(f.main_dishes):f.recurring_side_dishes.concat(f.side_dishes),f=[999999999,{}],p=0;p<
m.length&&!(e?l.main_dish=m[p]:l.side_dish1=m[p],l.servingSearch(g,c,h,a,d,b),l.score<f[0]&&(f[0]=l.score,f[1].remix_dish=e?copyDish(l.main_dish):copyDish(l.side_dish1),5>l.score));p++);return f[1].remix_dish},mealRemix:function(a,b,c){if(!0!==a.meal(b).attributes.eaten){var d=a.meal(b).attributes.meal_type,e={};e.main_dishes=excludeRecentlyBlocked($.extend([],global_food_pool["meal_"+b].main_dishes));e.side_dishes=excludeRecentlyBlocked($.extend([],global_food_pool["meal_"+b].side_dishes));e.recurring_main_dishes=
$.extend([],global_food_pool["meal_"+b].recurring_main_dishes);e.recurring_side_dishes=$.extend([],global_food_pool["meal_"+b].recurring_side_dishes);recent_foods_queue.clearQueue(b);recent_foods_queue.last_meal_generated=b;recent_foods_queue.setQueueLength(e,b,d.attributes.only_use_recurring);80>Helper.randomNumber(100)?recent_foods_queue.addDishesToQueue(twoMainFoods(a,b),b):recent_foods_queue.addDishesToQueue([firstMainFood(a,b)],b);e=recent_foods_queue.excludeDishes(e,b);a.clearMealExceptLeftovers(b);
a.addRecurringLockedFoods(b);if(!a.meal(b).isLocked()){d=returnConstraints(a,!0);copyDayConstraintsToMeal(d,b);lap_num=2;var f=new PopObject,g=minMaxServings(a,b,d),h=g[0],g=g[1],l=compileMainIngredients(a);f.init(a,e,d,b,h,g,l);e=mealgorithm(a,f,d,e,b,h,g,l);d=[];e.main_dish&&null!=e.main_dish&&null!=e.main_dish.attributes.food&&0<e.main_dish.attributes.amount&&d.push(convertToFoodObject(e.main_dish));null!=e.side_dish1&&null!=e.side_dish1.attributes.food&&0<e.side_dish1.attributes.amount&&d.push(convertToFoodObject(e.side_dish1));
null!=e.side_dish2&&null!=e.side_dish2.attributes.food&&0<e.side_dish2.attributes.amount&&d.push(convertToFoodObject(e.side_dish2));!c&&0===d.length&&(0<recent_foods_queue["meal_"+b].main_dishes.length||0<recent_foods_queue["meal_"+b].side_dishes.length)?(recent_foods_queue.clearQueue(10),this.mealRemix(a,b,!0)):_.each(d,function(c){a.meal(b).attributes.foods.add(c,{silent:!0})})}}}};
function copyDayConstraintsToMeal(a,b){a["meal"+b]={};a["meal"+b].min_carbs=a.min_carbs;a["meal"+b].max_carbs=a.max_carbs;a["meal"+b].min_fats=a.min_fats;a["meal"+b].max_fats=a.max_fats;a["meal"+b].min_proteins=a.min_proteins;a["meal"+b].max_proteins=a.max_proteins;a["meal"+b].calories=a.calories;a["meal"+b].min_fiber=a.min_fiber;a["meal"+b].max_cholesterol=a.max_cholesterol;a["meal"+b].max_sodium=a.max_sodium;a["meal"+b].max_price=a.max_price}
firstMainFood=function(a,b){for(var c=a.meal(b).attributes.foods.models,d=0;d<c.length;d++)if(c[d].attributes.food.attributes.main_dish&&0<c[d].attributes.amount&&!c[d].isLocked())return c[d];for(d=0;d<c.length;d++)if(!c[d].attributes.food.attributes.main_dish&&0<c[d].attributes.amount&&!c[d].isLocked())return c[d];return!1};
twoMainFoods=function(a,b){for(var c=a.meal(b).attributes.foods.models,d=[],e=0;e<c.length;e++)if(c[e].attributes.food.attributes.main_dish&&0<c[e].attributes.amount){d.push(c[e]);break}for(e=c.length-1;0<=e;e--)if(!c[e].attributes.food.attributes.main_dish&&0<c[e].attributes.amount){d.push(c[e]);break}return d};
var recent_foods_queue={max_main_dish_queue_length:20,max_side_dish_queue_length:15,max_main_dish_day_queue_length:10,max_side_dish_day_queue_length:6,max_sides_removed_in_a_row:3,num_sides_removed_in_a_row:0,initialized:!1,last_meal_generated:0,meal_0:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,side_dish_queue_length:0},meal_1:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,side_dish_queue_length:0},meal_2:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,side_dish_queue_length:0},
meal_3:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,side_dish_queue_length:0},meal_4:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,side_dish_queue_length:0},meal_5:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,side_dish_queue_length:0},meal_6:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,side_dish_queue_length:0},meal_7:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,side_dish_queue_length:0},meal_8:{main_dishes:[],side_dishes:[],main_dish_queue_length:0,
side_dish_queue_length:0},initQueue:function(a){this.initialized=!0},addDishesToQueue:function(a,b){if(a&&0!=a.length)for(var c=0;c<a.length;c++){var d=a[c];d&&(d.attributes.food.attributes.main_dish?(this["meal_"+b].main_dishes.push(d.attributes.food.attributes.id),this["meal_"+b].main_dishes.length>this["meal_"+b].main_dish_queue_length&&this["meal_"+b].main_dishes.shift(),this.num_sides_removed_in_a_row=0):(this["meal_"+b].side_dishes.push(d.attributes.food.attributes.id),this["meal_"+b].side_dishes.length>
this["meal_"+b].side_dish_queue_length&&(this["meal_"+b].side_dishes.shift(),this.num_sides_removed_in_a_row++),this.num_sides_removed_in_a_row>this.max_sides_removed_in_a_row&&this["meal_"+b].main_dishes.shift()))}},randomlyDecayQueue:function(a){var b=Helper.randomNumber(100),c=Helper.randomNumber(100);10>b&&this["meal_"+a].main_dishes.shift();25>c&&this["meal_"+a].side_dishes.shift()},setQueueLength:function(a,b,c){c?(c=a.recurring_main_dishes.length,a=a.recurring_side_dishes.length):(c=a.main_dishes.length+
a.recurring_main_dishes.length,a=a.side_dishes.length+a.recurring_side_dishes.length);this["meal_"+b].main_dish_queue_length=c<=this.max_main_dish_queue_length?c-1:this.max_main_dish_queue_length;this["meal_"+b].side_dish_queue_length=a<=this.max_side_dish_queue_length?a-1:this.max_side_dish_queue_length},setDayQueueLength:function(a,b,c){c?(c=a.recurring_main_dishes.length,a=a.recurring_side_dishes.length):(c=a.main_dishes.length+a.recurring_main_dishes.length,a=a.side_dishes.length+a.recurring_side_dishes.length);
this["meal_"+b].main_dish_queue_length=c<=this.max_main_dish_day_queue_length?c-1:this.max_main_dish_day_queue_length;this["meal_"+b].side_dish_queue_length=a<=this.max_side_dish_day_queue_length?a-1:this.max_side_dish_day_queue_length},excludeDishes:function(a,b){var c=this["meal_"+b],d={};d.main_dishes=1<a.main_dishes.length&&0<c.main_dishes.length?filterExclusionsByID(a.main_dishes,c.main_dishes):a.main_dishes;d.recurring_main_dishes=0<a.recurring_main_dishes.length&&0<a.main_dishes.length&&0<
c.main_dishes.length?filterExclusionsByID(a.recurring_main_dishes,c.main_dishes):a.recurring_main_dishes;d.side_dishes=1<a.side_dishes.length&&0<c.side_dishes.length?filterExclusionsByID(a.side_dishes,c.side_dishes):a.side_dishes;d.recurring_side_dishes=0<a.recurring_side_dishes.length&&0<a.side_dishes.length&&0<c.side_dishes.length?filterExclusionsByID(a.recurring_side_dishes,c.side_dishes):a.recurring_side_dishes;return d},updateQueueAndFilterFoods:function(a,b){for(var c={},d=0;d<a.attributes.num_meals;d++){var e=
Helper.randomNumber(100);this.setDayQueueLength(b["meal_"+d],d,a.meal(d).attributes.meal_type.attributes.only_use_recurring);40<e?this.addDishesToQueue([firstMainFood(a,d)],d):this.addDishesToQueue(twoMainFoods(a,d),d);c["meal_"+d]=this.excludeDishes(b["meal_"+d],d);c["meal_"+d].main_dishes=excludeRecentlyBlocked(c["meal_"+d].main_dishes);c["meal_"+d].side_dishes=excludeRecentlyBlocked(c["meal_"+d].side_dishes);this.randomlyDecayQueue(d)}return c},clearQueueExceptMeal:function(a){for(var b=0;9>b;b++)b!==
a&&(this["meal_"+b]={main_dishes:[],side_dishes:[]})},clearQueue:function(a){if(this.last_meal_generated!==a)for(a=0;9>a;a++)this["meal_"+a].main_dishes=[],this["meal_"+a].side_dishes=[]}};function excludeRecentlyBlocked(a){if(0===ETM.recently_blocked.length)return a;var b=[];1<a.length&&(b=filterExclusionsByID(a,ETM.recently_blocked));return b}
function filterExclusions(a,b){for(var c=[],d=0;d<a.length;d++){for(var e=a[d],f=!1,g=0;g<b.length;g++)if(e.attributes.food.attributes.id===b[g].attributes.food.attributes.id){f=!0;break}f||c.push(e)}return c}function filterExclusionsByID(a,b){for(var c=[],d=0;d<a.length;d++){for(var e=a[d],f=!1,g=0;g<b.length;g++)if(e.attributes.food.attributes.id===b[g]){f=!0;break}f||c.push(e)}return c}var incomplete_prices=[];
function getMicroHTML(a){html_output="";for(var b=0;b<micronutrient_display_order.length;b++){var c=micronutrient_display_order[b];if("more_nutrients_header"==c)html_output+="<div class='micro_details_header'>Detailed Nutrition Info:</div>";else if("sugars_header"==c)html_output+="<div class='micro_details_header'>Sugars</div>";else if("fats_header"==c)html_output+="<div class='micro_details_header'>Fats</div>";else if("fatty_acids_header"==c)html_output+="<div class='micro_details_header'>Fatty Acids</div>";
else if("vitamins_and_minerals_header"==c)html_output+="<div class='micro_details_header'>Vitamins and Minerals</div>";else if("amino_acids_header"==c)html_output+="<div class='micro_details_header'>Amino Acids</div>";else{var d=nutrient_dictionary[c].daily_value,d=null==d||0==d?"N/A":Math.ceil(100*(a[c]/d))+"%";html_output=html_output+"<strong>"+nutrient_dictionary[c].display_name+"</strong>: "+Math.round(a[c]*Math.pow(10,1))/Math.pow(10,1)+""+nutrient_dictionary[c].units+"<div class='perc_daily_val'>"+
d+"</div><br />"}}return html_output}var micronutrient_display_order="more_nutrients_header fiber sodium potassium cholesterol sugars_header sugar sucrose glucose fructose lactose maltose galactose starch fats_header saturated_fats monounsaturated_fats polyunsaturated_fats trans_fats fatty_acids_header total_omega_3 total_omega_6 ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid vitamins_and_minerals_header caffeine theobromine calcium choline copper fluoride folate iron lycopene magnesium manganese niacin phosphorus retinol riboflavin selenium thiamine alpha_carotene beta_carotene pantothenic_acid vit_a vit_a_iu vit_b6 vit_b12 vit_c vit_d vit_d_iu vit_d2 vit_d3 vit_e vit_k zinc amino_acids_header tryptophan threonine isoleucine leucine lysine methionine cystine phenylalanine tyrosine valine arginine histidine alanine aspartic_acid glutamic_acid glycine proline serine hydroxyproline".split(" ");
function shuffle(a){for(var b=a.length,c,d;0!==b;)d=Math.floor(Math.random()*b),b-=1,c=a[b],a[b]=a[d],a[d]=c;return a}
minMaxServings=function(a,b,c){var d=[0,0,0],e=[0,0,0],f=0,g=0;a.meal(b).attributes.foods.each(function(a){a.attributes.food.attributes.main_dish?a.isLocked()&&f++:a.isLocked()&&g++});0==f&&1200<c["meal"+b].calories?(e[0]=1,d[0]=3):0==f&&800<c["meal"+b].calories?(e[0]=1,d[0]=2):0==f&&500<c["meal"+b].calories?(e[0]=1,d[0]=1):0==f?(e[0]=0,d[0]=1):1<=f&&1E3<c["meal"+b].calories&&(e[0]=0,d[0]=2);1>=g&&1E3<c["meal"+b].calories?(e[1]=1,d[1]=2,d[2]=2):1>=g&&700<c["meal"+b].calories?(d[1]=2,d[2]=1):1>=g&&
600<c["meal"+b].calories?(d[1]=1,d[2]=1):1>=g?(d[1]=1,d[2]=0):2<=g&&(d[1]=2,d[2]=0);return[e,d]};var lap_num=1,totalIterations=0,iteration=0;function MealObject(){this.side_dish2=this.side_dish1=this.main_dish=null;this.score=99999999999999}function isEmpty(a){a={};for(var b in a)if(a[b]!=a.constructor.prototype[b])return!1;return!0}
var all_serving_combos=[[[0,1,0],[0,0,1],[1,0,0],[1,1,0],[1,0,1],[0,1,1],[0,1,2],[0,2,1],[1,1,1],[1,2,0],[1,0,2],[1,2,1],[1,1,2],[2,2,0],[0,2,2],[2,0,2],[1,2,2],[2,2,1],[2,1,2],[2,2,2],[3,2,2],[3,1,1],[3,2,0],[3,0,2],[3,1,2],[3,2,1],[3,1,0],[3,0,1]]];
MealObject.prototype.servingSearch=function(a,b,c,d,e,f){var g=[999999999,{}],h=3,l=2,m=2,p=0,n=0,s=0;"undefined"!==typeof d&&(h=d[0],l=d[1],m=d[2],p=c[0],n=c[1],s=c[2]);try{e.attributes.only_use_recurring||(null!==this.main_dish&&this.main_dish.is_recurring&&0===p&&(p=1,0===h&&(h=1)),null!==this.side_dish1&&this.side_dish1.is_recurring&&0===n&&(n=1,0===l&&(l=1)))}catch(u){throw console.log(u),console.log(this),"dang!";}if("M"===ETM.current_user_profile.attributes.units&&this.side_dish1&&this.side_dish1.attributes.food.attributes.accurate_grams&&
0==this.side_dish1.attributes.units&&0!=this.side_dish1.attributes.food.attributes.default_units)var v=!0,q=parseInt(this.side_dish1.attributes.food.attributes.weights[this.side_dish1.attributes.food.attributes.default_units].grams),q=roundNumber(10*Math.round((q+4.9)/10)/100,2);if("M"===ETM.current_user_profile.attributes.units&&this.side_dish2&&this.side_dish2.attributes.food.attributes.accurate_grams&&0==this.side_dish2.attributes.units&&0!=this.side_dish2.attributes.food.attributes.default_units)var r=
!0,t=parseInt(this.side_dish2.attributes.food.attributes.weights[this.side_dish2.attributes.food.attributes.default_units].grams),t=roundNumber(10*Math.round((t+4.9)/10)/100,2);for(;p<=h;p++)for(this.main_dish&&(this.main_dish.attributes.amount=p),c=n;c<=l;c++)for(null!==this.side_dish1&&(this.side_dish1.attributes.amount=v?q*c:c),d=s;d<=m;d++)null!==this.side_dish2&&(this.side_dish2.attributes.amount=r?t*d:d),e=this.nutritionScore(a,b,f),e+=this.complexityAndWeightScore(ETM.current_diet.attributes.meals.at(b).attributes.meal_type.attributes.complexity),
e<g[0]&&(g[0]=e,this.main_dish&&(g[1].main_dish_amount=this.main_dish.attributes.amount),this.side_dish1&&(g[1].side_dish1_amount=this.side_dish1.attributes.amount),this.side_dish2&&(g[1].side_dish2_amount=this.side_dish2.attributes.amount));this.main_dish&&(this.main_dish.attributes.amount=g[1].main_dish_amount);this.side_dish1&&(this.side_dish1.attributes.amount=g[1].side_dish1_amount);this.side_dish2&&(this.side_dish2.attributes.amount=g[1].side_dish2_amount);this.score=g[0]};
MealObject.prototype.stats=function(){var a={};ETM.GENERATOR_NUTRIENTS.forEach(function(b){a[b]=0});a.weight=0;for(var b=["main_dish","side_dish1","side_dish2"],c=0;c<b.length;c++)if(this[b[c]]){var d=this[b[c]];d.calculateStats();ETM.GENERATOR_NUTRIENTS.forEach(function(b){a[b]+=d.stats[b]})}return a};
MealObject.prototype.emptyMealPenalty=function(){return this.main_dish&&0<this.main_dish.attributes.amount||this.side_dish1&&0<this.side_dish1.attributes.amount||this.side_dish2&&0<this.side_dish2.attributes.amount?0:2500};MealObject.prototype.blockedMealPenalty=function(a){return ETM.meal_rating_list.hasThumbsDownMeal(this.getMealHash(a))?2E3:0};
MealObject.prototype.getMealHash=function(a){var b=[];_.each(["main_dish","side_dish1","side_dish2"],function(a){this[a]&&0<this[a].attributes.amount&&b.push(this[a].attributes.food.attributes.id)},this);return Helper.generateMealRatingHash(b,a)};
MealObject.prototype.nutritionScore=function(a,b,c){c=c.attributes.nutrition_profile;var d=a["meal"+b].calories,e=a["meal"+b].min_carbs,f=a["meal"+b].min_proteins,g=a["meal"+b].min_fats,h=a["meal"+b].max_carbs,l=a["meal"+b].max_proteins,m=a["meal"+b].max_fats,p=a["meal"+b].min_fiber,n=a["meal"+b].max_fiber,s=a["meal"+b].max_cholesterol,u=a["meal"+b].max_sodium,v=a["meal"+b].max_price,q=0,r=this.stats(),t="percents"==c.attributes.macro_scheme?1.5:1;if(1==lap_num){b=a["meal"+b].calories/a.calories;
var x=b*a.min_carbs;x>h&&(x=h);var w=b*a.min_fats;w>m&&(w=m);var y=b*a.min_proteins;y>l&&(y=l)}1==lap_num?(r.carbs<x?q+=3*(x-r.carbs):r.carbs>h&&(q+=10*(r.carbs-h)),r.fats<w?q+=6*(w-r.fats):r.fats>m&&(q+=9*(r.fats-m)),r.proteins<y?q+=6*(y-r.proteins):r.proteins>l&&(q+=4*(r.proteins-l)),r.fiber>n&&(q+=2*(r.fiber-n)),!0==c.attributes.watch_cholesterol&&r.cholesterol>s&&(q+=r.cholesterol-s),!0==c.attributes.watch_sodium&&r.sodium>u&&(q+=r.sodium-u),!0==ETM.current_user_profile.attributes.limit_price&&
r.price>v&&(q+=30*(r.price-v)),r.weight>0.8*d&&(q+=r.weight-1.6*d),r.weight>1*d&&(q+=r.weight-3*d),r.weight>1.2*d&&(q+=r.weight-4.8*d),r.weight>1.5*d&&(q+=r.weight-7.5*d),0<q&&(q/=10),r.calories>d+30?q+=Math.abs(r.calories-d)/10:r.calories<d-50&&(q+=Math.abs(r.calories-d)/10)):(r.carbs<e?q+=4*(e-r.carbs)*t:r.carbs>h&&(q+=12*(r.carbs-h)*t),r.fats<g?q+=12*(g-r.fats)*t:r.fats>m&&(q+=9*(r.fats-m)*t),r.proteins<f?q+=6*(f-r.proteins)*t:r.proteins>l&&(q+=4*(r.proteins-l)*t),r.fiber<p?q+=4*(p-r.fiber):r.fiber>
n&&(q+=4*(r.fiber-n)),!0==c.attributes.watch_cholesterol&&r.cholesterol>s&&(q+=r.cholesterol-s),!0==c.attributes.watch_sodium&&r.sodium>u&&(q+=r.sodium-u),!0==ETM.current_user_profile.attributes.limit_price&&r.price>v&&(q+=100*(r.price-v)),r.weight>0.8*d&&(q+=r.weight-1.6*d),r.weight>1*d&&(q+=r.weight-3*d),r.weight>1.2*d&&(q+=r.weight-4.8*d),r.weight>1.5*d&&(q+=r.weight-7.5*d),0<q&&(q/=5),r.calories>d+30?q+=Math.abs(r.calories-d)/5:r.calories<d-50&&(q+=Math.abs(r.calories-d)/5));return q};
MealObject.prototype.numDishesScore=function(a){var b=0;this.main_dish&&0<this.main_dish.amount&&b++;this.side_dish1&&0<this.side_dish1.amount&&b++;this.side_dish2&&0<this.side_dish2.amount&&b++;if(0==a){if(2<b)return 100}else if(1==a&&2<b)return 50;return 0};
MealObject.prototype.complexityAndWeightScore=function(a){var b=0,c=0;complexity_object=[[0,3],[0,7],[0,11],[9,200]];this.main_dish&&0<this.main_dish.attributes.amount&&(c=this.main_dish.attributes.food.attributes.is_recipe?c+this.main_dish.attributes.food.attributes.complexity:c+1,this.main_dish.weight&&(b-=this.main_dish.weight));this.side_dish1&&0<this.side_dish1.attributes.amount&&(c=this.side_dish1.attributes.food.attributes.is_recipe?c+this.side_dish1.attributes.food.attributes.complexity:c+
1,this.side_dish1.weight&&(b-=this.side_dish1.weight));this.side_dish2&&0<this.side_dish2.attributes.amount&&(c=this.side_dish2.attributes.food.attributes.is_recipe?c+this.side_dish2.attributes.food.attributes.complexity:c+1,this.side_dish2.weight&&(b-=this.side_dish2.weight));try{c<complexity_object[a][0]?b+=5*(complexity_object[a][0]-c):c>complexity_object[a][1]&&(b+=5*(c-complexity_object[a][1]))}catch(d){throw _errs.meta.complexity=a,d;}return b};
MealObject.prototype.diversityScore=function(a){var b=[],c=0;this.main_dish&&0<this.main_dish.attributes.amount&&(b=b.concat(this.main_dish.attributes.food.attributes.major_ingredients.split(" ")));this.side_dish1&&0<this.side_dish1.attributes.amount&&(b=b.concat(this.side_dish1.attributes.food.attributes.major_ingredients.split(" ")));this.side_dish2&&0<this.side_dish2.attributes.amount&&(b=b.concat(this.side_dish2.attributes.food.attributes.major_ingredients.split(" ")));keyword_and_meal_array=
b.concat(minorKeywords(this));hasDuplicates(keyword_and_meal_array)&&(c+=100);a=b.concat(a);a=a.concat(majorKeywords(a));hasDuplicates(a)&&(c+=100);return c};
function minorKeywords(a){for(var b=["salad","sandwich","soup","stew"],c=[],d=0;d<b.length;d++)a.main_dish&&0<a.main_dish.amount&&-1!=a.main_dish.attributes.food.attributes.food_name.toLowerCase().indexOf(b[d])&&c.push(b[d]),a.side_dish1&&0<a.side_dish1.amount&&-1!=a.side_dish1.attributes.food.attributes.food_name.toLowerCase().indexOf(b[d])&&c.push(b[d]),a.side_dish2&&0<a.side_dish2.amount&&-1!=a.side_dish2.attributes.food.attributes.food_name.toLowerCase().indexOf(b[d])&&c.push(b[d]);return c}
function majorKeywords(a){for(var b=["shake","smoothie"],c=[],d=0;d<b.length;d++)for(var e=0;e<a.length;e++)-1!=a[e].indexOf(b[d])&&c.push("shake");return c}function PopObject(){this.population=[]}PopObject.prototype.init=function(a,b,c,d,e,f,g){this.population=[];this.combinations=[];this.pop_size=200;this.meal_type=a.meal(d).attributes.meal_type;this.diet_object=a;this.generateMealCombinations(b,d);this.setMealsAndScore(c,d,e,f,g);this.population=this.population.sort(sortPop);return!1};
PopObject.prototype.setMealsAndScore=function(a,b,c,d,e){for(i=0;i<this.combinations.length;i++){var f=new MealObject;f.main_dish=copyDish(this.combinations[i][0]);f.side_dish1=copyDish(this.combinations[i][1]);f.side_dish2=copyDish(this.combinations[i][2]);f.servingSearch(a,b,c,d,this.meal_type,this.diet_object);f.score+=f.diversityScore(e);f.score+=f.numDishesScore(ETM.current_diet.attributes.meals.at(b).attributes.meal_type.attributes.complexity);f.score+=f.emptyMealPenalty();f.score+=f.blockedMealPenalty(this.meal_type.attributes.id);
this.population.push(f)}};function copyMeal(a){var b=new MealObject;null!==a.main_dish&&(b.main_dish=copyDish(a.main_dish));null!==a.side_dish1&&(b.side_dish1=copyDish(a.side_dish1));null!==a.side_dish2&&(b.side_dish2=copyDish(a.side_dish2));b.score=a.score;return b}
PopObject.prototype.generateMealCombinations=function(a,b){var c=[],d=this,e=ETM.current_diet.attributes.meals.at(b).attributes.meal_type,f=a.main_dishes.length,g=a.side_dishes.length,h=a.recurring_main_dishes.length,l=a.recurring_side_dishes.length;0===f&&0<g&&0==h&&!e.attributes.only_use_recurring&&(a.main_dishes=a.side_dishes,f=g);var m=a.recurring_main_dishes.concat(a.recurring_side_dishes);if(e.attributes.only_use_recurring){var p=!1;if(0<h)for(e=1<l?returnCombos(l,2):1==l?[[0,0]]:[],g=0;g<h;g++)for(var n=
0;n<e.length;n++){var s=e[n];c.push([g,s[0],s[1]])}else c=returnCombos(l,3),p=!0;c.length>this.pop_size?(sampled_combos=_.sample(c,this.pop_size),sampled_combos.forEach(function(b){new_meal=p?[a.recurring_side_dishes[b[0]],a.recurring_side_dishes[b[1]],a.recurring_side_dishes[b[2]]]:[a.recurring_main_dishes[b[0]],a.recurring_side_dishes[b[1]],a.recurring_side_dishes[b[2]]];d.combinations.push(new_meal)})):0<c.length?c.forEach(function(b){new_meal=p?[a.recurring_side_dishes[b[0]],a.recurring_side_dishes[b[1]],
a.recurring_side_dishes[b[2]]]:[a.recurring_main_dishes[b[0]],a.recurring_side_dishes[b[1]],a.recurring_side_dishes[b[2]]];d.combinations.push(new_meal)}):2<m.length?(c=returnCombos(m.length,3),c.forEach(function(a){new_meal=[m[a[0]],m[a[1]],m[a[2]]];d.combinations.push(new_meal)})):(new_meal=2==m.length?[m[0],m[1],m[1]]:[m[0],m[0],m[0]],d.combinations.push(new_meal))}else{var c=4,n=0,s=this.pop_size,e=returnCombos(g,2),u=twoNumberCombos(f,g),g=m.length;0<g&&(n=parseInt(this.pop_size*(3>g?0.5:7>g?
0.75:1)),s=this.pop_size-n);combos_per_recurring_dish=n>g?n/g:1;for(g=0;g<h;g++)for(side_dish_combos=sampleList(e,combos_per_recurring_dish),n=0;n<side_dish_combos.length;n++)s=side_dish_combos[n],new_meal=[a.recurring_main_dishes[g],a.side_dishes[s[0]],a.side_dishes[s[1]]],d.combinations.push(new_meal);for(g=0;g<l;g++)for(main_and_side_dish_combos=sampleList(u,combos_per_recurring_dish),n=0;n<main_and_side_dish_combos.length;n++)h=main_and_side_dish_combos[n],new_meal=[a.main_dishes[h[0]],a.recurring_side_dishes[g],
a.side_dishes[h[1]]],d.combinations.push(new_meal);s=d.pop_size-d.combinations.length;if(20<s){l=s/c;h=[];if(l>f)for(l=f,c=s/l,g=0;g<l;g++)h.push(g);else{choose_from_main_dish_indices=[];for(g=0;g<f;g++)choose_from_main_dish_indices.push(g);h=sampleList(choose_from_main_dish_indices,l)}if(0==e.length)for(f=0;f<h.length;f++)l=h[f],new_meal=[a.main_dishes[l],null,null],d.combinations.push(new_meal);else for(f=0;f<h.length;f++)for(l=h[f],side_dish_combos=sampleList(e,c),g=0;g<side_dish_combos.length;g++)s=
side_dish_combos[g],new_meal=[a.main_dishes[l],a.side_dishes[s[0]],a.side_dishes[s[1]]],d.combinations.push(new_meal)}}};function returnCombos(a,b){var c=[];if(2==b)for(i=0;i<a;i++)for(j=i+1;j<a;j++)c.push([i,j]);else if(3==b)for(i=0;i<a;i++)for(j=i+1;j<a;j++)for(k=j+1;k<a;k++)c.push([i,j,k]);return c}function twoListCombos(a,b){var c=[];for(i=0;i<a.length;i++)for(j=0;j<b.length;j++)c.push([i,j]);return c}
function twoNumberCombos(a,b){var c=[];for(i=0;i<a;i++)for(j=0;j<b;j++)c.push([i,j]);return c}function sampleList(a,b){return a.length<=b?a:_.sample(a,b)}PopObject.prototype.pairsArray=function(){for(var a=[],b=[],c=0;c<this.population.length;c++)a.push(c);0!=a.length%2&&a.pop();num_pairs=a.length/2;for(c=0;c<num_pairs;c++){var d=[];d[0]=a.splice(Helper.randomNumber(a.length),1);d[1]=a.splice(Helper.randomNumber(a.length),1);b.push(d)}return b};
PopObject.prototype.scoreAll=function(a,b,c){for(var d=0;d<this.population.length;d++){var e=this.population[d];e.score=e.nutritionScore(a,b,this.diet_object);e.score+=e.diversityScore(c);e.score+=e.complexityAndWeightScore(ETM.current_diet.attributes.meals.at(b).attributes.meal_type.attributes.complexity);e.score+=e.numDishesScore(ETM.current_diet.attributes.meals.at(b).attributes.meal_type.attributes.complexity);e.score+=e.emptyMealPenalty();e.score+=e.blockedMealPenalty(this.meal_type.attributes.id)}return!1};
PopObject.prototype.tournament=function(){for(var a=this.pairsArray(),b=[],c=0;c<a.length;c++)this.population[a[c][0]].score>=this.population[a[c][1]].score?b.push(this.population[a[c][0]]):b.push(this.population[a[c][1]]);1<b.length&&(this.population=b);return!1};
PopObject.prototype.crossPop=function(a){a=0<a.recurring_main_dishes.length||0<a.recurring_side_dishes.length;for(var b=[],c=0;3>c;c++)for(var d=this.pairsArray(),e=0;e<d.length;e++){var f=this.population[d[e][0]],g=this.population[d[e][1]],h=new MealObject,l=new MealObject;if(a){var m=0;null!==f.main_dish&&null!==g.main_dish&&!f.main_dish.is_recurring&&!g.main_dish.is_recurring&&2>m?(h.main_dish=copyDish(g.main_dish),l.main_dish=copyDish(f.main_dish),m++):(h.main_dish=copyDish(f.main_dish),l.main_dish=
copyDish(g.main_dish));null!==f.side_dish1&&null!==g.side_dish1&&!f.side_dish1.is_recurring&&!g.side_dish1.is_recurring&&2>m?(h.side_dish1=copyDish(g.side_dish1),l.side_dish1=copyDish(f.side_dish1),m++):(h.side_dish1=copyDish(f.side_dish1),l.side_dish1=copyDish(g.side_dish1));null!==f.side_dish2&&null!==g.side_dish2&&!f.side_dish2.is_recurring&&!g.side_dish2.is_recurring&&2>m?(h.side_dish2=copyDish(g.side_dish2),l.side_dish2=copyDish(f.side_dish2)):(h.side_dish2=copyDish(f.side_dish2),l.side_dish2=
copyDish(g.side_dish2))}else h.main_dish=copyDish(f.main_dish),h.side_dish1=copyDish(f.side_dish1),h.side_dish2=copyDish(g.side_dish2),l.main_dish=copyDish(g.main_dish),l.side_dish1=copyDish(g.side_dish1),l.side_dish2=copyDish(f.side_dish2);b.push(h);b.push(l)}this.population=b;return!1};function copyDish(a){if(!a)return null;var b=new ETM.GeneratorFoodObject(a.attributes);b.weight=a.weight;return b}
function convertToFoodObject(a){var b=new ETM.FoodObject(a.attributes);b.weight=a.weight;return b}
PopObject.prototype.mutate=function(a,b,c,d,e){for(var f=0;f<this.population.length;f++)if(10>Helper.randomNumber(100)){var g=this.population[f],h=0,h=g.main_dish&&g.main_dish.is_recurring?Helper.randomNumber(2)+1:g.side_dish1&&g.side_dish1.is_recurring?2:Helper.randomNumber(3);0==h&&0<a.main_dishes.length&&(g.main_dish=copyDish(a.main_dishes[Helper.randomNumber(a.main_dishes.length)]));1==h&&0<a.side_dishes.length&&(g.side_dish1=copyDish(a.side_dishes[Helper.randomNumber(a.side_dishes.length)]));
2==h&&0<a.side_dishes.length&&(g.side_dish2=copyDish(a.side_dishes[Helper.randomNumber(a.side_dishes.length)]));g.servingSearch(b,c,d,e,this.meal_type,this.diet_object)}};
PopObject.prototype.separateElites=function(a){var b=new PopObject;b.diet_object=this.diet_object;a>this.population.length&&(a=this.population.length);for(var c=0;c<a;c++){var d=new MealObject,e=this.population[c];e.main_dish&&(d.main_dish=copyDish(e.main_dish));e.side_dish1&&(d.side_dish1=copyDish(e.side_dish1));e.side_dish2&&(d.side_dish2=copyDish(e.side_dish2));d.score=e.score;b.population.push(d)}return b};function sortPop(a,b){return a.score-b.score}
function mealgorithm(a,b,c,d,e,f,g,h){for(var l=99999999999999,m=new MealObject,p=5,n=0;l>p;){2==n&&(p=10);3==n&&(p=30);4==n&&(p=40);5==n&&(p=50);6==n&&(p=60);var s=new PopObject;s.meal_type=b.meal_type;s.diet_object=a;s.population=b.population.splice(0,40);var u=s.separateElites(5);s.tournament();s.crossPop(d);a.meal(e).attributes.meal_type.attributes.only_use_recurring||s.mutate(d,c,e,f,g);s.population=s.population.concat(u.population);s.scoreAll(c,e,h);s.population=s.population.sort(sortPop);destroyPopulation(b);
b.population=s.population;0<b.population.length&&(m=copyMeal(b.population[0]),l=m.score);n++;if(3<=n)break}destroyPopulation(b);return m}function destroyPopulation(a){iterator=0;a.population.forEach(function(a){iterator++;destroyFoodsInMeals(a)});a.population=[]}function destroyFoodsInMeals(a){null!==a.main_dish&&a.main_dish.destroy();delete a.main_dish;null!==a.side_dish1&&a.side_dish1.destroy();delete a.side_dish1;null!==a.side_dish2&&a.side_dish2.destroy();delete a.side_dish2}
function getMealConstraints(a,b){var c=a.returnDietStatsWithoutMeal(b),d=getMacroConstraints(a),e=a.attributes.nutrition_profile.attributes.fiber;e>d.max_carbs&&(e=d.max_carbs);var f=1.5*e;37.5>f&&(f=37.5);c.fiber>f&&(f=c.fiber);d=$.extend({},d,{calories:a.attributes.nutrition_profile.attributes.calories,max_sodium:a.attributes.nutrition_profile.attributes.sodium,max_cholesterol:a.attributes.nutrition_profile.attributes.cholesterol,max_price:ETM.current_user_profile.attributes.daily_price_limit,min_fiber:e,
max_fiber:f});lap_num=2;c=dietDiff(c,d,0);lap_num=1;return c}function cleanConstraints(a){for(var b in a)a.hasOwnProperty(b)&&(a[b]=0>a[b]?0:roundNumber(a[b],0))}
function returnConstraints(a,b){a.calculateAllStats();var c=a.stats,d=a.attributes.num_meals,e=a.numberLockedMeals(),e=d-e,f=getMacroConstraints(a),g=a.attributes.nutrition_profile.attributes.fiber;g>f.max_carbs&&(g=f.max_carbs);var h=1.5*g;37.5>h&&(h=37.5);c.fiber>h&&(h=c.fiber);h=$.extend({},f,{calories:a.attributes.nutrition_profile.attributes.calories,max_sodium:a.attributes.nutrition_profile.attributes.sodium,max_cholesterol:a.attributes.nutrition_profile.attributes.cholesterol,max_price:ETM.current_user_profile.attributes.daily_price_limit,
min_fiber:g,max_fiber:h});lap_num=2;c=dietDiff(c,h,0);lap_num=1;for(var l=0,f=0;f<d;f++)a.meal(f).isLocked()&&(g=a.meal(f).stats,l+=g.calories);h=(h.calories-l)/e;for(f=l=0;f<d;f++)a.meal(f).isLocked()||(l+=parseInt(a.meal(f).attributes.meal_type.attributes.size_slider));for(var m=0,f=0;f<d;f++)if(!a.meal(f).isLocked()){var g=a.meal(f).stats,p=parseInt(a.meal(f).attributes.meal_type.attributes.size_slider)/(l/e),p=h*p;g.calories<p&&(m+=p-g.calories)}for(f=0;f<d;f++)a.meal(f).isLocked()||(g=a.meal(f).stats,
c["meal"+f]={},p=parseInt(a.meal(f).attributes.meal_type.attributes.size_slider)/(l/e),p*=h,c["meal"+f].calories=g.calories<p?(p-g.calories)*(c.calories/m):0);if(!0!=b)for(f=0;f<d;f++)g=a.meal(f).stats,c.calories+=g.calories,c.min_carbs+=g.carbs,c.max_carbs+=g.carbs,c.min_fats+=g.fats,c.max_fats+=g.fats,c.min_proteins+=g.proteins,c.max_proteins+=g.proteins;return c}
function dietDiff(a,b,c){var d={};d.min_carbs=b.min_carbs-a.carbs;d.max_carbs=b.max_carbs-a.carbs;d.min_fats=b.min_fats-a.fats;d.max_fats=b.max_fats-a.fats;d.min_proteins=b.min_proteins-a.proteins;d.max_proteins=b.max_proteins-a.proteins;d.max_cholesterol=b.max_cholesterol-a.cholesterol;d.max_sodium=b.max_sodium-a.sodium;d.min_fiber=b.min_fiber-a.fiber;d.max_fiber=b.max_fiber-a.fiber;d.max_price=b.max_price-a.price;d.calories=1==lap_num?b["meal"+c].calories:b.calories-a.calories;return d}
function addStatsToTargets(a,b){a.min_carbs+=b.carbs;a.max_carbs+=b.carbs;a.min_fats+=b.fats;a.max_fats+=b.fats;a.min_proteins+=b.proteins;a.max_proteins+=b.proteins;a.max_cholesterol+=b.cholesterol;a.max_sodium+=b.sodium;a.min_fiber+=b.fiber;a.max_fiber+=b.fiber;a.max_price+=b.price;a.calories+=b.calories}function modifyConstraint(a,b){for(var c in b)b[c]+=a[c];return b}
Array.prototype.uniqueFoods=function(){for(var a=[],b=0;b<this.length;b++)0<this[b].attributes.amount&&a.push(this[b].attributes.food.attributes.id);return a.unique()};Array.prototype.unique=function(){var a={},b,c=this.length,d=[];for(b=0;b<c;b+=1)a[this[b]]=this[b];for(b in a)d.push(a[b]);return d.length};Array.prototype.uniqueIDs=function(){var a={},b,c=this.length,d=[];for(b=0;b<c;b+=1)a[this[b]]=this[b];for(b in a)d.push(a[b]);return d};
var macronutrients=["calories","carbs","fats","proteins","price"],nutrients="alanine alcohol arginine aspartic_acid betaine caffeine calcium calories carbs cholesterol choline copper cystine fats fiber fluoride folate fructose galactose glucose glutamic_acid glycine histidine hydroxyproline iron isoleucine lactose leucine lycopene lysine magnesium maltose manganese methionine monounsaturated_fats niacin phenylalanine phosphorus polyunsaturated_fats potassium proline proteins retinol riboflavin saturated_fats selenium serine sodium thiamine threonine trans_fats tryptophan tyrosine valine vit_a vit_b6 vit_b12 vit_c vit_d vit_d2 vit_d3 vit_e vit_k water zinc price alpha_carotene beta_carotene pantothenic_acid vit_a_iu vit_d_iu starch sucrose sugar theobromine ala_fatty_acid dha_fatty_acid epa_fatty_acid dpa_fatty_acid total_omega_3 total_omega_6".split(" "),
nutrient_names="Alanine;Alcohol;Arginine;Aspartic acid;Betaine;Caffeine;Calcium;Calories;Carbs;Cholesterol;Choline;Copper;Cystine;Fats;Fiber;Fluoride;Folate;Fructose;Galactose;Glucose;Glutamic acid;Glycine;Histidine;Hydroxyproline;Iron;Isoleucine;Lactose;Leucine;Lycopene;Lysine;Magnesium;Maltose;Manganese;Methionine;Monounsaturated fats;Niacin;Phenylalanine;Phosphorus;Polyunsaturated fats;Potassium;Proline;Proteins;Retinol;Riboflavin;Saturated fats;Selenium;Serine;Sodium;Thiamine;Threonine;Trans fats;Tryptophan;Tyrosine;Valine;Vit A;Vit B6;Vit B12;Vit C;Vit D;Vit D2;Vit D3;Vit E;Vit K;Water;Zinc;Price;Alpha Carotene;Beta Carotene;Pantothenic acid;Vitamin A IU;Vitamin D IU;Starch;Sucrose;Sugar;Theobromine;ALA;DHA;EPA;DPA;Total Omega 3;Total Omega 6".split(";"),
daily_rec=[0,0,0,0,0,0,1E3,0,0,0,550,2,0,0,25,0,400,0,0,0,0,0,0,0,8,0,0,0,0,0,350,0,2,0,0,20,0,1E3,0,0,0,0,0,1.7,0,70,0,2400,1.5,0,0,0,0,0,900,1.3,2.4,60,15,0,0,15,120,0,15,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0],micro_units="g;g;g;g;mg;mg;mg;kcal;g;mg;mg;mg;g;g;g;\u03bcg;\u03bcg;g;g;g;g;g;g;g;mg;g;g;g;\u03bcg;g;mg;g;mg;g;g;mg;g;mg;g;mg;g;g;\u03bcg;mg;g;\u03bcg;g;mg;mg;g;g;g;g;g;\u03bcg RAE;mg;\u03bcg;mg;\u03bcg;\u03bcg;\u03bcg;mg;\u03bcg;g;mg;USD;\u03bcg;\u03bcg;mg;IU;IU;g;g;g;mg;g;g;g;g;g;g".split(";");
function dailyRecommended(){for(var a=0;a<nutrients.length;a++)this[nutrients[a]]=daily_rec[a]}function hasDuplicates(a){for(var b={},c=0;c<a.length;++c){var d=a[c];if(Object.prototype.hasOwnProperty.call(b,d))return!0;b[d]=!0}return!1}
compileMainIngredients=function(a){for(var b=[],c=a.attributes.num_meals,d=0;d<c;d++){meal_foods=a.meal(d).attributes.foods.models;for(var e=0;e<meal_foods.length;e++){var f=[];0<meal_foods[e].attributes.amount&&null!=meal_foods[e].attributes.food.attributes.major_ingredients&&0<meal_foods[e].attributes.food.attributes.major_ingredients.length&&(f=meal_foods[e].attributes.food.attributes.major_ingredients.split(" "));b=b.concat(f)}}return b.uniqueIDs()};
var nutrient_dictionary={alanine:{display_name:"Alanine",daily_value:null,units:"g"},alcohol:{display_name:"Alcohol",daily_value:null,units:"g"},arginine:{display_name:"Arginine",daily_value:null,units:"g"},aspartic_acid:{display_name:"Aspartic acid",daily_value:null,units:"g"},betaine:{display_name:"Betaine",daily_value:null,units:"mg"},caffeine:{display_name:"Caffeine",daily_value:null,units:"mg"},calcium:{display_name:"Calcium",daily_value:1E3,units:"mg"},calories:{display_name:"Calories",daily_value:null,
units:"kcal"},carbs:{display_name:"Carbs",daily_value:null,units:"g"},cholesterol:{display_name:"Cholesterol",daily_value:null,units:"mg"},choline:{display_name:"Choline",daily_value:550,units:"mg"},copper:{display_name:"Copper",daily_value:2,units:"mg"},cystine:{display_name:"Cystine",daily_value:null,units:"g"},fats:{display_name:"Fats",daily_value:null,units:"g"},fiber:{display_name:"Fiber",daily_value:25,units:"g"},fluoride:{display_name:"Fluoride",daily_value:null,units:"\u03bcg"},folate:{display_name:"Folate",
daily_value:400,units:"\u03bcg"},fructose:{display_name:"Fructose",daily_value:null,units:"g"},galactose:{display_name:"Galactose",daily_value:null,units:"g"},glucose:{display_name:"Glucose",daily_value:null,units:"g"},glutamic_acid:{display_name:"Glutamic acid",daily_value:null,units:"g"},glycine:{display_name:"Glycine",daily_value:null,units:"g"},histidine:{display_name:"Histidine",daily_value:null,units:"g"},hydroxyproline:{display_name:"Hydroxyproline",daily_value:null,units:"g"},iron:{display_name:"Iron",
daily_value:8,units:"mg"},isoleucine:{display_name:"Isoleucine",daily_value:null,units:"g"},lactose:{display_name:"Lactose",daily_value:null,units:"g"},leucine:{display_name:"Leucine",daily_value:null,units:"g"},lycopene:{display_name:"Lycopene",daily_value:null,units:"\u03bcg"},lysine:{display_name:"Lysine",daily_value:null,units:"g"},magnesium:{display_name:"Magnesium",daily_value:350,units:"mg"},maltose:{display_name:"Maltose",daily_value:null,units:"g"},manganese:{display_name:"Manganese",daily_value:2,
units:"mg"},methionine:{display_name:"Methionine",daily_value:null,units:"g"},monounsaturated_fats:{display_name:"Monounsaturated fats",daily_value:null,units:"g"},niacin:{display_name:"Niacin",daily_value:20,units:"mg"},phenylalanine:{display_name:"Phenylalanine",daily_value:null,units:"g"},phosphorus:{display_name:"Phosphorus",daily_value:1E3,units:"mg"},polyunsaturated_fats:{display_name:"Polyunsaturated fats",daily_value:null,units:"g"},potassium:{display_name:"Potassium",daily_value:null,units:"mg"},
price:{display_name:"Price",daily_value:null,units:"USD"},proline:{display_name:"Proline",daily_value:null,units:"g"},proteins:{display_name:"Proteins",daily_value:null,units:"g"},retinol:{display_name:"Retinol",daily_value:null,units:"\u03bcg"},riboflavin:{display_name:"Riboflavin",daily_value:1.7,units:"mg"},saturated_fats:{display_name:"Saturated fats",daily_value:null,units:"g"},selenium:{display_name:"Selenium",daily_value:70,units:"\u03bcg"},serine:{display_name:"Serine",daily_value:null,units:"g"},
sodium:{display_name:"Sodium",daily_value:2400,units:"mg"},thiamine:{display_name:"Thiamine",daily_value:1.5,units:"mg"},threonine:{display_name:"Threonine",daily_value:null,units:"g"},trans_fats:{display_name:"Trans fats",daily_value:null,units:"g"},tryptophan:{display_name:"Tryptophan",daily_value:null,units:"g"},tyrosine:{display_name:"Tyrosine",daily_value:null,units:"g"},valine:{display_name:"Valine",daily_value:null,units:"g"},vit_a:{display_name:"Vit A",daily_value:900,units:"\u03bcg"},vit_b6:{display_name:"Vit B6",
daily_value:1.3,units:"mg"},vit_b12:{display_name:"Vit B12",daily_value:2.4,units:"\u03bcg"},vit_c:{display_name:"Vit C",daily_value:60,units:"mg"},vit_d:{display_name:"Vit D",daily_value:15,units:"\u03bcg"},vit_d2:{display_name:"Vit D2",daily_value:null,units:"\u03bcg"},vit_d3:{display_name:"Vit D3",daily_value:null,units:"\u03bcg"},vit_e:{display_name:"Vit E",daily_value:30,units:"mg"},vit_k:{display_name:"Vit K",daily_value:120,units:"\u03bcg"},water:{display_name:"Water",daily_value:null,units:"g"},
zinc:{display_name:"Zinc",daily_value:15,units:"mg"},alpha_carotene:{display_name:"Alpha carotene",daily_value:null,units:"\u03bcg"},beta_carotene:{display_name:"Beta carotene",daily_value:null,units:"\u03bcg"},pantothenic_acid:{display_name:"Pantothenic acid",daily_value:null,units:"mg"},vit_a_iu:{display_name:"Vit A IU",daily_value:null,units:"IU"},vit_d_iu:{display_name:"Vit D IU",daily_value:null,units:"IU"},starch:{display_name:"Starch",daily_value:null,units:"g"},sucrose:{display_name:"Sucrose",
daily_value:null,units:"g"},sugar:{display_name:"Sugar",daily_value:null,units:"g"},theobromine:{display_name:"Theobromine",daily_value:null,units:"mg"},ala_fatty_acid:{display_name:"ALA",daily_value:null,units:"g"},dha_fatty_acid:{display_name:"DHA",daily_value:null,units:"g"},epa_fatty_acid:{display_name:"EPA",daily_value:null,units:"g"},dpa_fatty_acid:{display_name:"DPA",daily_value:null,units:"g"},total_omega_3:{display_name:"Total omega 3",daily_value:null,units:"g"},total_omega_6:{display_name:"Total omega 6",
daily_value:null,units:"g"}};
function getMacroConstraints(a){var b=a.attributes.nutrition_profile;if("grams"==b.attributes.macro_scheme)a={min_carbs:b.attributes.min_carbs,max_carbs:b.attributes.max_carbs,min_fats:b.attributes.min_fats,max_fats:b.attributes.max_fats,min_proteins:b.attributes.min_proteins,max_proteins:b.attributes.max_proteins};else{a=Math.ceil(b.attributes.calories*(b.attributes.percent_carbs/100))/4;var c=Math.ceil(b.attributes.calories*(b.attributes.percent_fats/100))/9,b=Math.ceil(b.attributes.calories*(b.attributes.percent_proteins/
100))/4;a={min_carbs:a-4,max_carbs:a+4,min_fats:c-2,max_fats:c+2,min_proteins:b-4,max_proteins:b+4}}return a};
